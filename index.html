<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#001d25">
  <link rel="apple-touch-icon" href="medinova_ios.png">
  <link rel="icon" href="medinova.ico" type="image/x-icon" />
  <title>Medinova</title>

  <!-- ‚úÖ Externos -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- ‚úÖ Charts (Chart.js) -->
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
    }
  }
  </script>
  <!-- ‚úÖ Supabase (v2) -->
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    window.LOGS_ON = true;
    window.logx = function (tag, msg, obj) {
      if (!window.LOGS_ON) return;
      const line = `[${new Date().toISOString()}] ${tag} ${msg}`;
      (obj !== undefined) ? console.log(line, obj) : console.log(line);
    };

    window.ensureChartJS = function ensureChartJS() {
      const ok = !!window.Chart;
      window.logx?.("‚úÖ[Charts]", ok ? "Chart.js disponible" : "Chart.js NO disponible (revisa CDN)", { ok });
      return ok;
    };
    window.ensureChartJs = window.ensureChartJs || window.ensureChartJS;
    window.addEventListener("DOMContentLoaded", () => {
      // Validaci√≥n temprana: si Chart no est√°, las gr√°ficas de forecast no se pintar√°n.
      window.ensureChartJS?.();
    });

    window.SOL_DEBUG_HOVER = false;
    window.solDbg = (...args) => { if (window.SOL_DEBUG_HOVER) console.log("[SOL_HOVER]", ...args); };

    // ‚úÖ Config √∫nica
    window.SUPABASE_URL = "https://ldjrpfsbpcfninntffoj.supabase.co";
    window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MjcxNjYsImV4cCI6MjA2MjAwMzE2Nn0.vxPo7XXaeKPa-jDQRA2jvOJ7dvJZDHRNZB7blbONNZo"; // <-- deja la tuya


    // ‚úÖ getter √∫nico (evita dobles clientes)
    window.getSB = function getSB() {
      if (window.sb) return window.sb;
      if (!window.supabase?.createClient) return null;
      window.sb = window.supabase.createClient(window.SUPABASE_URL, (window.SUPABASE_ANON_KEY || window.ANON_KEY || window.API_KEY));
      return window.sb;
    };

    window.addEventListener("DOMContentLoaded", () => {
      const sb = window.getSB();
      if (!sb) {
        logx("‚ùå[Supabase]", "No existe supabase.createClient. Revisa CDN / orden.");
        return;
      }
      logx("‚úÖ[Supabase]", "Cliente listo", { hasSb: !!sb });
    });
  </script>

  <style>
    :root {
      --bg-0: #030b10;
      --bg-1: #06161d;

      --glass: rgba(0, 18, 22, .72);
      --panel-strong: rgba(0, 18, 22, .82);
      --panel: rgba(8, 26, 34, .58);
      --panel2: rgba(8, 26, 34, .72);
      --stroke: rgba(23, 162, 166, .30);
      --stroke-strong: rgba(23, 162, 166, .40);
      --stroke-soft: rgba(255, 255, 255, .10);
      --stroke2: rgba(255, 255, 255, .16);
      --stroke3: rgba(0, 229, 255, .18);
      --teal: #17a2a6;
      --blue: #1e40af;
      --cyan: #00e5ff;
      --amber: #ffb000;
      --txt: #eaf6f7;
      --muted: rgba(255, 255, 255, .72);

      --shadow: 0 25px 60px rgba(0, 0, 0, .55);
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, .35);
      --shadow2: 0 16px 38px rgba(0, 0, 0, .32);
      --r: 28px;
      --r2: 18px;
      --radius: 24px;
      --radius-sm: 16px;

      --glowCyan: 0 0 0 1px rgba(0, 229, 255, .12), 0 0 32px rgba(0, 229, 255, .10);
      --glowTeal: 0 0 0 1px rgba(23, 162, 166, .14), 0 0 34px rgba(23, 162, 166, .14);
      --glowAmber: 0 0 28px rgba(255, 176, 0, .18);

      /* ‚úÖ Compact HUD glass tuning */
      --glassBlur: 3px;
      --glassA: .015;
      --panelA: .12;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --ui: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      overscroll-behavior-y: none;
      /* Bloquea pull-to-refresh en Android (Chrome/Samsung) */
    }

    body {
      touch-action: pan-x pan-y;
      /* overflow-y: hidden;  <-- Opcional si el scroll lo maneja un div interno */
    }

    .dial {
      width: 140px;
      height: 140px;
      touch-action: none;
    }

    .dial svg {
      width: 100%;
      height: 100%;
      overflow: visible;
    }

    .dial .bg {
      stroke: rgba(255, 255, 255, 0.10);
    }

    .dial .track {
      stroke: rgba(2, 199, 202, 0.20);
    }

    .dial .value {
      stroke: rgba(204, 163, 0, 0.95);
      filter: drop-shadow(0 0 10px rgba(204, 163, 0, 0.25));
    }

    .dial .knob {
      fill: rgba(255, 255, 255, 0.85);
    }

    .dial .txt {
      fill: rgba(229, 231, 235, 0.9);
      font: 700 16px system-ui;
    }

    .dial .sub {
      fill: rgba(203, 213, 225, 0.65);
      font: 12px system-ui;
    }

    /* =========================
   Base
========================= */
    body {
      margin: 0;
      color: var(--txt);
      font-family: 'Segoe UI', sans-serif;
      background: url('bcg_centrum.png') no-repeat center center fixed;
      background-size: cover;
      background-color: #001d25;
    }

    @media (max-width: 767px) {
      body {
        background-position: top center;
        padding-top: env(safe-area-inset-top);
      }
    }

    /* =========================
   Glass Components
========================= */
    .space-panel {
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(23, 162, 166, .25), transparent 55%),
        radial-gradient(900px 500px at 90% 30%, rgba(30, 64, 175, .25), transparent 60%),
        var(--panel);
      border: 1px solid var(--stroke-strong);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .space-card {
      position: relative;
      border-radius: 18px;
      /* Borde sutil y premium */
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: var(--shadow-soft);
      /* Fondo base semitransparente unificado */
      background: rgba(8, 26, 34, 0.4);
      overflow: hidden;
      transition: all 0.3s ease;

      /* CLAVE: Overrides de overflow */
      .space-card--ov-visible {
        overflow: visible !important;
      }

      .sol-wrap-ov {
        overflow: visible !important;
      }

      .sol-wrap-ov svg {
        overflow: visible !important;
      }

      .svg-glow {
        overflow: visible !important;
      }
    }

    .space-card::before {
      content: "";
      position: absolute;
      inset: 0;
      z-index: 0;
      border-radius: inherit;
      /* ‚úÖ Heredar borde redondeado para casos con overflow: visible */

      /* ‚úÖ Blur unificado para elegancia (sin cortes ni m√°scaras raras) */
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);

      /* Sutil gradiente de luz superior */
      background: linear-gradient(180deg,
          rgba(255, 255, 255, 0.04) 0%,
          rgba(255, 255, 255, 0.0) 60%);
    }

    .space-card::after {
      content: "";
      position: absolute;
      inset: 0;
      z-index: 1;
      pointer-events: none;
      border-radius: inherit;

      /* Atm√≥sfera cian/azul sutil en extremos */
      background: linear-gradient(to bottom,
          rgba(23, 162, 166, 0.1) 0%,
          transparent 30%,
          transparent 70%,
          rgba(30, 64, 175, 0.1) 100%);

      /* Brillo interno borde superior (glass edge) */
      box-shadow: inset 0 1px 0 0 rgba(255, 255, 255, 0.12),
        inset 0 0 20px rgba(23, 162, 166, 0.05);
    }

    .space-card>* {
      position: relative;
      z-index: 2;
    }

    .space-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 14px;
      outline: none;

      background: rgba(0, 0, 0, .30);
      border: 1px solid rgba(255, 255, 255, .12);
      color: var(--txt);

      transition: box-shadow .12s ease, border-color .12s ease;
      color-scheme: dark;
      /* üëà inputs nativos dark (incluye number/date) */
    }

    .space-input::placeholder {
      color: rgba(255, 255, 255, .45);
    }

    .space-input:focus {
      border-color: rgba(23, 162, 166, .55);
      box-shadow: 0 0 0 2px rgba(23, 162, 166, .55);
    }

    /* ===== Caducidad: tabla glass bonita ===== */
    .cadu-table-wrap {
      overflow-x: auto;
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.10);
      background: rgba(0, 0, 0, 0.22);
    }

    .cadu-table {
      width: 100%;
      min-width: 640px;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 12.5px;
      color: rgba(255, 255, 255, 0.88);
    }

    .cadu-table thead th {
      position: sticky;
      top: 0;
      z-index: 1;
      text-transform: uppercase;
      letter-spacing: .08em;
      font-size: 11px;
      color: rgba(255, 255, 255, 0.70);
      background: rgba(255, 255, 255, 0.06);
      border-bottom: 1px solid rgba(255, 255, 255, 0.10);
      padding: 10px 12px;
    }

    .cadu-table tbody td {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      vertical-align: top;
    }

    .cadu-table tbody tr:nth-child(odd) {
      background: rgba(255, 255, 255, 0.02);
    }

    .cadu-table tbody tr:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .cadu-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 11px;
      border: 1px solid rgba(255, 255, 255, 0.10);
      background: rgba(255, 255, 255, 0.06);
    }

    .cadu-pill--danger {
      background: rgba(244, 63, 94, 0.14);
      border-color: rgba(244, 63, 94, 0.30);
      color: rgba(255, 255, 255, 0.92);
    }

    .cadu-pill--warn {
      background: rgba(245, 158, 11, 0.14);
      border-color: rgba(245, 158, 11, 0.30);
    }

    .cadu-pill--ok {
      background: rgba(16, 185, 129, 0.14);
      border-color: rgba(16, 185, 129, 0.30);
    }

    .cadu-sub {
      display: block;
      color: rgba(255, 255, 255, 0.58);
      font-size: 11px;
      margin-top: 2px;
    }

    .space-btn {
      border-radius: 18px;
      padding: 10px 14px;
      font-weight: 700;
      color: #fff;

      background: linear-gradient(90deg, rgba(30, 64, 175, .25), rgba(23, 162, 166, .25));
      border: 1px solid rgba(23, 162, 166, .25);
      box-shadow: 0 12px 30px rgba(0, 0, 0, .35);

      transition: transform .12s ease, opacity .12s ease;
    }

    .space-btn:hover {
      opacity: .95;
      transform: translateY(-1px);
    }

    .space-btn:active {
      transform: translateY(0);
    }

    .space-btn-ghost {
      border-radius: 18px;
      padding: 10px 14px;
      font-weight: 700;
      color: var(--txt);

      background: rgba(255, 255, 255, .06);
      border: 1px solid rgba(255, 255, 255, .10);

      transition: background .12s ease;
    }

    .space-btn-ghost:hover {
      background: rgba(255, 255, 255, .09);
    }

    /* =========================
   Backdrops / Modals
========================= */
    .space-modal-backdrop {
      background: rgba(0, 0, 0, .52);
      -webkit-backdrop-filter: blur(5px);
      backdrop-filter: blur(5px);
    }

    /* Modal system (el que est√°s usando ya) */
    .space-modal {
      position: fixed;
      inset: 0;
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 14px;
      background: rgba(0, 0, 0, .72);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
    }

    .space-modal.hidden {
      display: none !important;
    }

    .space-modal__panel {
      width: min(560px, 96vw);
      max-height: min(92dvh, 760px);
      overflow: auto;

      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(23, 162, 166, .25), transparent 55%),
        radial-gradient(900px 500px at 90% 30%, rgba(30, 64, 175, .25), transparent 60%),
        var(--panel-strong);

      border: 1px solid rgba(23, 162, 166, .35);
      border-radius: 22px;
      box-shadow: var(--shadow);
      color: var(--txt);
    }

    .space-modal__header {
      position: sticky;
      top: 0;
      z-index: 1;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255, 255, 255, .10);
      background: rgba(0, 18, 22, .72);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
    }

    .space-modal__body {
      padding: 16px;
    }

    /* Modal viejo (compat) */
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 18px;
      display: none;
      z-index: 10000;

      background:
        radial-gradient(900px 500px at 20% 20%, rgba(23, 162, 166, .22), transparent 60%),
        radial-gradient(700px 420px at 85% 40%, rgba(30, 64, 175, .22), transparent 65%),
        rgba(0, 18, 22, .85);

      border: 1px solid rgba(23, 162, 166, .35);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow);
      color: var(--txt);
      max-width: min(520px, 92vw);
    }

    /* =========================
   Special UI blocks
========================= */
    #mensajeQR {
      position: fixed;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 18px 22px;
      border-radius: 18px;
      font-weight: 700;
      font-size: 18px;
      text-align: center;
      display: none;
      z-index: 9999;
      max-width: min(680px, 86vw);

      background:
        radial-gradient(900px 500px at 15% 10%, rgba(23, 162, 166, .22), transparent 60%),
        radial-gradient(700px 420px at 90% 30%, rgba(30, 64, 175, .20), transparent 65%),
        rgba(0, 18, 22, .86);

      border: 1px solid rgba(23, 162, 166, .38);
      box-shadow: 0 22px 60px rgba(0, 0, 0, .55);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
    }

    .blur-fondo::before {
      content: "";
      position: fixed;
      inset: 0;
      z-index: -1;
      background: rgba(0, 0, 0, .70);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
    }

    .completada {
      background-color: rgba(16, 185, 129, .16);
      border-left: 3px solid rgba(16, 185, 129, .55);
    }

    #qr-reader {
      border: 1px solid rgba(23, 162, 166, .45);
      border-radius: 18px;
      overflow: hidden;
      background: rgba(0, 0, 0, .25);
      box-shadow: 0 18px 45px rgba(0, 0, 0, .35);
    }

    /* =========================
   Accessibility / Utils
========================= */
    .sr-only {
      position: absolute !important;
      width: 1px !important;
      height: 1px !important;
      padding: 0 !important;
      margin: -1px !important;
      overflow: hidden !important;
      clip: rect(0, 0, 0, 0) !important;
      white-space: nowrap !important;
      border: 0 !important;
    }

    /* File input styled */
    .space-file-wrap {
      display: grid;
      gap: 10px;
    }

    .space-file-input {
      position: absolute !important;
      width: 1px !important;
      height: 1px !important;
      padding: 0 !important;
      margin: -1px !important;
      overflow: hidden !important;
      clip: rect(0, 0, 0, 0) !important;
      white-space: nowrap !important;
      border: 0 !important;
    }

    .space-file-input:focus+label,
    .space-file-input:focus-visible+label {
      box-shadow: 0 0 0 2px rgba(23, 162, 166, .55);
      border-color: rgba(23, 162, 166, .55);
    }

    /* =========================
   Overrides: Cantidad compacto (number)
========================= */
    .input-cantidad {
      width: 72px !important;
      min-width: 64px !important;
      max-width: 80px !important;

      padding: 6px 8px !important;
      border-radius: 12px !important;
      text-align: right !important;
      font-variant-numeric: tabular-nums;

      background: rgba(0, 0, 0, .35) !important;
      color: var(--txt) !important;
      border: 1px solid rgba(255, 255, 255, .14) !important;

      outline: none !important;
      box-shadow: 0 10px 25px rgba(0, 0, 0, .25);
    }

    /* MATCHING STYLE FOR LOT INPUT */
    .input-lote-style {
      width: 72px !important;
      min-width: 64px !important;
      max-width: 80px !important;

      padding: 6px 8px !important;
      border-radius: 12px !important;
      text-align: right !important;
      font-variant-numeric: tabular-nums;

      background: rgba(0, 0, 0, .35) !important;
      color: var(--txt) !important;
      border: 1px solid rgba(255, 255, 255, .14) !important;

      outline: none !important;
      box-shadow: 0 10px 25px rgba(0, 0, 0, .25);
    }

    .input-lote-style::placeholder {
      color: rgba(255, 255, 255, .30) !important;
    }

    .input-lote-style:focus {
      border-color: rgba(23, 162, 166, .55) !important;
      box-shadow: 0 0 0 2px rgba(23, 162, 166, .45) !important;
    }

    .input-cantidad::placeholder {
      color: rgba(255, 255, 255, .45) !important;
    }

    .input-cantidad:focus {
      border-color: rgba(23, 162, 166, .55) !important;
      box-shadow: 0 0 0 2px rgba(23, 162, 166, .45) !important;
    }

    .input-cantidad::-webkit-outer-spin-button,
    .input-cantidad::-webkit-inner-spin-button {
      opacity: .65;
      filter: invert(1);
    }

    /* =========================
   Overrides: botones con salto en m√≥vil
========================= */
    .btn-wrap {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      text-align: center;
    }

    .btn-text {
      display: inline-block;
      line-height: 1.05;
      white-space: normal;
    }

    @media (max-width: 520px) {
      .btn-wrap {
        padding: 10px 12px !important;
      }

      .btn-text {
        max-width: 10.5ch;
        font-size: .92rem;
      }
    }

    /* =========================
   Fonts
========================= */
    @font-face {
      font-family: 'MagmaWave';
      src: url('MagmawaveCaps-Bold.woff2') format('woff2');
      font-weight: normal;
      font-style: normal;
    }

    .fuente-magma {
      font-family: 'MagmaWave', sans-serif;
    }

    .modo-basurero {
      background-image: url('blackhole.png');
      background-size: cover;
      background-position: center;
      transition: background 3s ease-in-out;
    }

    :root {
      --mx-green: #00a65a;
      --mx-red: #ce1126;
      --mx-white: rgba(255, 255, 255, 0.92);
    }

    .hud-glow-teal {
      filter: drop-shadow(0 0 10px rgba(23, 162, 166, .35));
    }

    .hud-glow-gold {
      filter: drop-shadow(0 0 10px rgba(204, 163, 0, .28));
    }
  </style>
</head>

<body class="min-h-screen flex flex-col items-center justify-center text-white px-3 py-6 sm:py-8 md:py-10">

  <!-- ‚úÖ Loader (space) -->
  <div id="loaderOverlay"
    class="fixed inset-0 z-[99999] hidden select-none flex items-center justify-center space-modal-backdrop">
    <div id="loaderPanel" class="space-panel p-6 flex items-center gap-4 w-[min(370px,92vw)]">
      <img src="loader.gif" alt="Cargando..." class="w-20 h-20 pointer-events-none">
      <div class="text-white/80 flex-1 min-w-0">
        <div class="fuente-magma tracking-widest text-lg">PROCESANDO</div>

        <div id="loaderStatus" class="text-xs text-white/60 block font-mono break-words leading-tight">
          Ejecutando operaci√≥n‚Ä¶
        </div>

        <div id="loaderTicker" class="hidden mt-3 text-[11px] bg-black/30 border border-white/10
                    rounded-xl p-2 space-y-1 max-h-36 min-h-[90px] overflow-y-auto font-mono">
        </div>
      </div>
    </div>
  </div>



  <!-- =========================
      MODAL QR draggable (space)
      ========================= -->
  <div id="modalQR" class="fixed top-5 right-4 z-[890] hidden cursor-move w-[280px] max-w-[90vw]">
    <div class="space-panel p-3" id="handleQR">
      <div class="flex items-center justify-between">
        <h2 class="text-center font-semibold text-sm text-white/80">Escanea un QR</h2>
        <button onclick="cerrarModalQR()" class="text-red-900 hover:text-red-600 font-bold text-xl px-2">√ó</button>
      </div>
      <div id="qr-reader" class="w-full mt-2 aspect-square overflow-hidden bg-black/50 rounded-lg"></div>
    </div>
  </div>

  <!-- LOGO CENTRUM ARRIBA DERECHA -->
  <div class="absolute top-4 right-4 flex-col items-center text-center hidden sm:flex">
    <h1 class="text-xs font-bold tracking-widest text-white/80 fuente-magma">In Collab with:</h1>
    <img src="centrum.png" alt="Logo Centrum" class="h-12 mt-1 md:h-10" />
  </div>

  <!-- PORTADA -->
  <div class="text-center mb-3 sm:mb-4 md:mb-5">
    <a href="https://instagram.com/medinova.cuu" target="_blank" rel="noopener noreferrer">
      <img src="Andromeda.png" alt="Logo Medinova"
        class="block mx-auto h-auto w-auto max-h-[clamp(9rem,18vw,11rem)] -mb-3 sm:-mb-2 md:-mb-1" />
    </a>
  </div>

  <!-- Modal selecci√≥n modo -->
  <!-- <div id="modalModo" class="fixed inset-0 z-50 hidden items-center justify-center space-modal-backdrop">
    <div class="space-panel p-6 w-[92%] max-w-sm text-center">
      <h2 class="text-lg font-bold mb-4 text-white/90">Selecciona el modo de operaci√≥n</h2>
      <div class="grid gap-3">
        <button onclick="seleccionarModo('entrada')" class="space-btn w-full">üì• Entrada</button>
        <button onclick="seleccionarModo('salida')"
          class="w-full rounded-2xl px-4 py-2 font-bold text-white bg-gradient-to-r from-rose-700 to-red-900 border border-red-400/20 shadow-lg hover:opacity-95">
          üì§ Salida
        </button>
      </div>
    </div>
  </div>

  <div id="mensajeQR"></div> -->

  <!-- Modal movimientos -->
  <div id="modalMovimientos" class="space-modal hidden">
    <div class="space-panel rounded-3xl p-6 w-[92%] max-w-4xl overflow-y-auto">
      <h2 class="text-lg font-bold mb-4 text-center text-white/90">üìã Movimientos del producto</h2>

      <div class="space-card p-4 mb-4">
        <div class="flex flex-col md:flex-row items-center justify-between gap-3">
          <div class="flex items-center gap-2">
            <label for="cantidadMovimientos" class="text-sm font-semibold text-white/80">Mostrar:</label>
            <select id="cantidadMovimientos" class="space-input !w-auto !py-2">
              <option value="20">√öltimos 20</option>
              <option value="50" selected>√öltimos 50</option>
              <option value="100">√öltimos 100</option>
              <option value="todos">Todos</option>
            </select>
          </div>

          <div class="flex items-center gap-2">
            <label class="text-sm font-semibold text-white/80" for="selectLote">Lote:</label>
            <select id="selectLote" class="space-input !w-auto !py-2 text-sm"
              onchange="verMovimientos(filtroReferenciaGlobal)">
              <option value="">Todos</option>
            </select>
          </div>

          <div class="flex flex-wrap items-center gap-2">
            <span class="text-sm font-semibold text-white/80">Entre:</span>
            <input id="fechaInicio" type="date" class="space-input !w-auto !py-2" title="Fecha de inicio" />
            <span class="text-sm text-white/70">y</span>
            <input id="fechaFin" type="date" class="space-input !w-auto !py-2" title="Fecha de fin" />
            <button onclick="verMovimientos(filtroReferenciaGlobal)" class="space-btn !px-3 !py-2 text-sm">üîç
              Filtrar</button>
          </div>
        </div>
      </div>

      <div id="movimientosContenido" class="max-h-64 overflow-y-auto text-sm text-white/80 space-card p-4"></div>

      <div class="text-center mt-4">
        <button onclick="document.getElementById('modalMovimientos').classList.add('hidden')"
          class="w-full md:w-auto rounded-2xl px-4 py-2 font-bold text-white bg-gradient-to-r from-rose-900 to-red-900 border border-red-400/20 shadow-lg hover:opacity-95">
          Cerrar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal cantidad -->
  <div id="modalCantidad" class="fixed inset-0 hidden z-50 items-center justify-center space-modal-backdrop">
    <div class="space-panel p-6 w-[92%] max-w-sm">
      <h2 class="text-xl font-bold mb-4 text-white text-center">¬øCu√°ntas piezas desea retirar?</h2>
      <input id="inputCantidadPiezas" type="number" min="1" class="space-input text-center text-lg font-mono"
        placeholder="Cantidad" />
      <div class="flex justify-between gap-3 mt-4">
        <button onclick="cerrarModalCantidad()" class="space-btn-ghost w-1/2">Cancelar</button>
        <button onclick="confirmarCantidad()" class="space-btn w-1/2">Aceptar</button>
      </div>
    </div>
  </div>

  <!-- Aviso -->
  <div id="modalAviso" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 hidden z-50 max-w-lg w-[92%]">
    <div class="space-panel p-5 text-center">
      <div class="fuente-magma tracking-widest text-xl text-rose-200">AVISO</div>
      <div id="modalAvisoTexto" class="mt-2 text-white/85"></div>
    </div>
  </div>

  <div id="overlayColor" class="fixed inset-0 z-40 hidden transition-opacity"></div>

  <!-- Modal inventario -->
  <div id="modalInventario" class="hidden fixed inset-0 z-50 items-center justify-center space-modal-backdrop">
    <div class="space-panel p-6 max-w-md w-[92%] text-center border border-rose-400/25">
      <h2 class="text-xl font-bold mb-4 text-rose-200">‚ö†Ô∏è ¬°CUIDADO!</h2>
      <p class="mb-6 leading-relaxed text-white/85">
        Al enviar los datos a Supabase esto<br>
        <strong class="block text-lg mt-1 text-white">REEMPLAZAR√Å LA BASE DE DATOS ACTUAL</strong><br>
        esta acci√≥n<br>
        <strong class="block text-lg text-white">NO SE PUEDE DESHACER</strong>
      </p>
      <div class="flex justify-center gap-3">
        <button onclick="document.getElementById('modalInventario').classList.add('hidden')"
          class="space-btn-ghost px-4 py-2">Cancelar</button>
        <button onclick="enviarModoInventario()"
          class="rounded-2xl px-4 py-2 font-bold text-white bg-gradient-to-r from-rose-900 to-red-900 border border-red-400/20 shadow-lg hover:opacity-95">Aceptar</button>
      </div>
    </div>
  </div>

  <!-- Modal PIN + unidad -->
  <div id="modalPinUnidad" class="fixed inset-0 z-50 hidden items-center justify-center p-4 space-modal-backdrop">
    <div class="space-panel rounded-3xl p-6 w-[92%] max-w-md relative space-y-4 max-h-[92dvh] overflow-y-auto">
      <button type="button" onclick="cerrarModalPin()"
        class="absolute top-3 right-4 text-red-900 text-2xl font-bold hover:text-red-600" aria-label="Cerrar">√ó</button>
      <h2 class="text-lg font-bold text-center text-white/90">Acceso requerido</h2>

      <div>
        <label for="inputNIP" class="block text-sm font-semibold mb-1 text-white/80">NIP:</label>
        <input id="inputNIP" type="password" maxlength="4" inputmode="numeric" autocomplete="one-time-code"
          title="Ingresa tu NIP" class="space-input" />
      </div>

      <div id="unidadDestinoGroup" class="hidden">
        <label for="inputUnidad" class="block text-sm font-semibold mb-1 text-white/80">Clave unidad destino:</label>
        <input id="inputUnidad" type="text" placeholder="Ej: C03128" title="Clave unidad destino" autocomplete="off"
          class="space-input uppercase" />
      </div>

      <div id="remisionGroup" class="hidden">
        <label for="inputRemision" class="block text-sm font-semibold mb-1 text-white/80">No. de remisi√≥n:</label>
        <input id="inputRemision" type="text" placeholder="Ej: 465131" title="N√∫mero de remisi√≥n" autocomplete="off"
          class="space-input uppercase" />
      </div>

      <div id="bloqueCargaRemision" class="hidden space-y-2">
        <label for="inputArchivoRemision" class="block text-sm font-semibold mb-1 text-white/80">Cargar archivo remisi√≥n
          SAP:</label>
        <div class="space-file-wrap">
          <input type="file" id="inputArchivoRemision" class="space-file-input" accept=".xlsx" />
          <label for="inputArchivoRemision" class="space-btn px-5 py-3 text-center">Elegir archivo</label>
        </div>
        <div class="flex justify-center">
          <button id="btnSubirRemision" type="button" class="space-btn px-6 py-3 text-base">üì§ Cargar archivo
            SAP</button>
        </div>
        <div id="resultadoCargaArchivo" class="text-center font-semibold text-sm text-white/80"></div>
      </div>

      <div id="pinError" class="text-sm text-rose-200 hidden">‚ùå NIP o unidad no v√°lidos.</div>

      <div class="flex flex-col gap-2 mt-4">
        <div class="flex justify-end gap-2">
          <button type="button" onclick="cerrarModalPin()" class="space-btn-ghost px-4 py-2">Cancelar</button>
          <button type="button" onclick="validarPinYUnidad()" class="space-btn px-4 py-2">Confirmar</button>
        </div>
        <button type="button" onclick="mostrarCambioNIP()"
          class="text-sm text-teal-200 underline hover:text-teal-100 text-center mt-2">üîë Cambiar NIP</button>
      </div>

      <div class="h-[env(safe-area-inset-bottom)]"></div>
    </div>
  </div>
  <!-- Modal preparaci√≥n (nuevo) -->
  <div id="modalPreparacion" class="fixed inset-0 z-50 hidden items-center justify-center p-4 space-modal-backdrop">
    <div class="space-panel rounded-3xl p-6 w-[92%] max-w-md relative space-y-4 max-h-[92dvh] overflow-y-auto">
      <button type="button" onclick="cerrarModalPreparacion()"
        class="absolute top-3 right-4 text-red-900 text-2xl font-bold hover:text-red-600" aria-label="Cerrar">√ó</button>

      <h2 class="text-lg font-bold text-center text-white/90">üß© Preparaci√≥n de pedido</h2>
      <div class="text-xs text-white/60 text-center">
        S√≥lo almacenistas / administradores ‚Ä¢ Validado por representaci√≥n
      </div>

      <div>
        <label for="inputEjecutivoPrep" class="block text-sm font-semibold mb-1 text-white/80">Ejecutivo
          (nombre):</label>
        <input id="inputEjecutivoPrep" type="text" placeholder="Ej: Jos√© P√©rez" autocomplete="off"
          class="space-input" />
        <div class="mt-1 text-[11px] text-white/55 font-mono">
          slot_key: <span id="slotKeyPreview">‚Äî</span>
        </div>
      </div>

      <div>
        <label for="inputRemisionPrep" class="block text-sm font-semibold mb-1 text-white/80">No. de remisi√≥n:</label>
        <input id="inputRemisionPrep" type="text" placeholder="Ej: 465131" autocomplete="off"
          class="space-input uppercase" />
        <div class="mt-1 text-[11px] text-white/55 font-mono">
          remisi√≥n_normalizada: <span id="remisionPreview">‚Äî</span>
        </div>
      </div>

      <div id="prepInfo" class="hidden space-card p-3 rounded-2xl text-sm text-white/80"></div>
      <div id="prepError" class="hidden text-sm text-rose-200">‚ùå Error.</div>

      <div class="flex justify-end gap-2 mt-2">
        <button type="button" onclick="cerrarModalPreparacion()" class="space-btn-ghost px-4 py-2">Cancelar</button>
        <button type="button" onclick="crearPedidoPreparacion()" class="space-btn px-4 py-2">Crear / Abrir</button>
      </div>

      <div class="h-[env(safe-area-inset-bottom)]"></div>
    </div>
  </div>
  <!-- Modal caducidad -->
  <div id="modalCaducidad" class="fixed inset-0 hidden flex z-[900] items-center justify-center space-modal-backdrop">
    <div class="space-panel w-[95%] max-w-5xl relative max-h-[80vh] overflow-y-auto p-6">
      <button onclick="cerrarModalCaducidad()"
        class="absolute top-3 right-4 text-red-900 text-2xl font-bold hover:text-red-600">√ó</button>
      <h2 class="text-xl font-bold mb-4 text-white/90">‚ö†Ô∏è Productos por caducar</h2>
      <div id="contenidoCaducidad" class="text-sm mb-4 text-white/80"></div>
    </div>
  </div>

  <!-- Modal QC Command (Supervisor de Calidad) -->
  <div id="modalQC" class="fixed inset-0 hidden z-[950] items-center justify-center space-modal-backdrop">
    <div class="space-panel w-[97%] max-w-6xl relative max-h-[92vh] overflow-y-auto p-6">
      <button onclick="cerrarModalQC()"
        class="absolute top-3 right-4 text-red-900 text-2xl font-bold hover:text-red-600">√ó</button>

      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <div class="fuente-magma tracking-widest text-2xl text-white/90">üõ∞Ô∏è Centro de Control QC </div>
          <div class="text-xs text-white/60 mt-1">Dashboard operativo para IQC / EQC ‚Ä¢ stock ‚Ä¢ caducidad ‚Ä¢ cobertura ‚Ä¢
            compra sugerida</div>
        </div>

        <div class="flex flex-wrap gap-2 justify-end">
          <button onclick="qc_refrescarDashboard()" class="space-btn px-4 py-2">üîÑ Refrescar</button>
          <button onclick="qc_exportarCSV()" class="space-btn-ghost px-4 py-2">‚¨áÔ∏è Exportar CSV</button>
        </div>
      </div>

      <!-- Filtros -->
      <div class="mt-4 space-card p-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-3">

          <div>
            <label class="block text-xs font-semibold text-white/70 mb-1">Tipo</label>
            <select id="qcTipo" class="space-input !py-2">
              <option value="ALL" selected>IQC + EQC</option>
              <option value="IQC">IQC (Interno)</option>
              <option value="EQC">EQC (Externo)</option>
            </select>
          </div>

          <div>
            <label class="block text-xs font-semibold text-white/70 mb-1">Almac√©n / Representaci√≥n</label>
            <select id="qcAlmacen" class="space-input !py-2">
              <option value="ALL" selected>Todos</option>
              <option value="CUU">Almac√©n Chihuahua (CUU)</option>
              <option value="65">Almac√©n Ju√°rez (65)</option>
              <option value="66">Almac√©n Parral (66)</option>
              <option value="BCS">Baja California Sur (BCS)</option>
              <option value="DUR">Durango (DUR)</option>
              <option value="NAY">Nayarit (NAY)</option>
              <option value="SIN">Sinaloa (SIN)</option>
              <option value="TAM">Tamaulipas (TAM)</option>
              <option value="COA">Coahuila (COA)</option>
              <option value="CHP">Chiapas (CHP)</option>
              <option value="OAX">Oaxaca (OAX)</option>
              <option value="TAB">Tabasco (TAB)</option>
              <option value="CAM">Campeche (CAM)</option>
              <option value="QROO">Quintana Roo (QROO)</option>
              <option value="GRO">Guerrero (GRO)</option>
              <option value="EDOMEX">Edo. de M√©xico (EDOMEX)</option>
              <option value="HGO">Hidalgo (HGO)</option>
            </select>
          </div>

          <div class="lg:col-span-2">
            <label class="block text-xs font-semibold text-white/70 mb-1">Unidad m√©dica</label>
            <select id="qcUnidad" class="space-input !py-2">
              <option value="ALL" selected>Todas</option>
            </select>
          </div>

          <div>
            <label class="block text-xs font-semibold text-white/70 mb-1">Rango (inicio)</label>
            <input id="qcDesde" type="date" class="space-input !py-2" />
          </div>

          <div>
            <label class="block text-xs font-semibold text-white/70 mb-1">Rango (fin)</label>
            <input id="qcHasta" type="date" class="space-input !py-2" />
          </div>

        </div>

        <div class="mt-3 flex flex-wrap gap-2 items-center justify-between">
          <div class="flex flex-wrap gap-2">
            <label class="inline-flex items-center gap-2 text-xs text-white/70">
              <input id="qcSoloCriticos" type="checkbox" class="accent-teal-400" />
              S√≥lo cr√≠ticos (caducidad/cobertura)
            </label>
            <label class="inline-flex items-center gap-2 text-xs text-white/70">
              <input id="qcIncluirCentral" type="checkbox" class="accent-teal-400" checked />
              Incluir central
            </label>
          </div>
          <button onclick="qc_refrescarDashboard()" class="space-btn !px-4 !py-2 text-sm">Aplicar</button>
        </div>
      </div>

      <!-- KPIs -->
      <div id="qcKPIs" class="mt-4 grid grid-cols-2 md:grid-cols-5 gap-3"></div>
      <!-- ‚òÄÔ∏è Sol Log√≠stico Nacional (SVG) -->
      <div class="mt-4 space-card p-4">
        <div class="flex flex-wrap items-center justify-between gap-2">
          <div>
            <div class="text-sm font-bold text-white/85">Abasto Nacional</div>
            <div id="solSubtitulo" class="text-xs text-white/55 mt-0.5">Vista por representaci√≥n ‚Ä¢ m√©trica: Stock</div>
          </div>

          <div class="flex gap-2">
            <button id="btnMetricStock" class="space-btn px-3 py-2 text-xs">üì¶ Stock</button>
            <button id="btnMetricValor" class="space-btn-ghost px-3 py-2 text-xs opacity-60">üí∞ Valor</button>
          </div>
        </div>

        <div class="mt-3 rounded-2xl border border-white/10 bg-black/20 overflow-hidden sol-wrap-ov">
          <div class="relative sol-wrap-ov">
            <svg id="solNacional" viewBox="0 0 900 900" class="w-full h-[420px] block svg-glow"></svg>

            <div id="solTooltip" class="hidden absolute z-10 pointer-events-none px-3 py-2 rounded-2xl
                        bg-black/70 border border-white/10 text-[12px] text-white/90
                        shadow-2xl backdrop-blur-xl">
              <div class="font-bold" id="solTipTitle">‚Äî</div>
              <div class="text-white/70" id="solTipSub">‚Äî</div>
            </div>
          </div>
        </div>

        <!-- Drilldown -->
        <div id="solDrillWrap" class="hidden mt-4">
          <div class="flex items-center justify-between gap-2 mb-2">
            <div id="solDrillTitle" class="text-sm font-bold text-white/85">üè• Drilldown</div>
            <button id="btnCerrarDrill" class="space-btn-ghost px-3 py-2 text-xs">Cerrar</button>
          </div>
          <div class="rounded-2xl border border-white/10 bg-black/20 overflow-hidden">
            <svg id="solDrill" viewBox="0 0 900 900" class="w-full h-[360px] block"></svg>
          </div>
        </div>

        <!-- <div class="mt-3 text-[11px] text-white/60 space-card p-3">
          <div class="font-mono whitespace-pre-wrap" id="solLogs"></div>
        </div> -->
      </div>
      <!-- Charts -->
      <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-3">
        <div class="space-card p-4">
          <div class="text-sm font-bold text-white/85 mb-2">Consumo mensual</div>
          <div class="h-[240px]"><canvas id="qcChartConsumo"></canvas></div>
        </div>
        <div class="space-card p-4">
          <div class="text-sm font-bold text-white/85 mb-2">Cobertura (d√≠as) por almac√©n</div>
          <div class="h-[240px]"><canvas id="qcChartCobertura"></canvas></div>
        </div>
        <div class="space-card p-4">
          <div class="text-sm font-bold text-white/85 mb-2">Caducidades (ventanas)</div>
          <div class="h-[240px]"><canvas id="qcChartCaducidad"></canvas></div>
        </div>
      </div>

      <!-- Tablas -->
      <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-3">
        <div class="space-card p-4">
          <div class="flex items-center justify-between gap-2 mb-2">
            <div class="text-sm font-bold text-white/85">Cr√≠ticos QC</div>
            <div class="text-xs text-white/55">caducidad < 30d ‚Ä¢ cobertura baja</div>
            </div>
            <div id="qcTablaCriticos" class="cadu-table-wrap"></div>
          </div>
          <div class="space-card p-4">
            <div class="flex items-center justify-between gap-2 mb-2">
              <div class="text-sm font-bold text-white/85">Compra sugerida</div>
              <div class="text-xs text-white/55">(consumo + buffer) ‚àí stock</div>
            </div>
            <div id="qcTablaCompra" class="cadu-table-wrap"></div>
          </div>
        </div>

        <!-- <div class="mt-4 text-xs text-white/60 space-card p-3">
        <div class="font-mono whitespace-pre-wrap" id="qcLogs"></div>
      </div> -->

        <div class="h-[env(safe-area-inset-bottom)]"></div>
      </div>
    </div>

    <!-- Modal cambio NIP -->
    <div id="modalCambioNIP" class="fixed inset-0 z-50 hidden items-center justify-center space-modal-backdrop">
      <div class="space-panel p-6 w-[92%] max-w-md space-y-4">
        <h2 class="text-lg font-bold text-center text-white/90">Cambiar NIP</h2>
        <div>
          <label for="nipAntiguo" class="block text-sm font-semibold mb-1 text-white/80">NIP actual:</label>
          <input id="nipAntiguo" type="password" maxlength="4" class="space-input" />
        </div>
        <div>
          <label for="nipNuevo" class="block text-sm font-semibold mb-1 text-white/80">NIP nuevo:</label>
          <input id="nipNuevo" type="password" maxlength="4" class="space-input" />
        </div>
        <div>
          <label for="nipConfirmar" class="block text-sm font-semibold mb-1 text-white/80">Confirmar nuevo NIP:</label>
          <input id="nipConfirmar" type="password" maxlength="4" class="space-input" />
        </div>

        <div id="cambioNipError" class="text-sm text-rose-200 hidden">‚ùå Error en los datos ingresados.</div>

        <div class="flex justify-end gap-2 mt-2">
          <button onclick="cerrarCambioNIP()" class="space-btn-ghost px-4 py-2">Cancelar</button>
          <button onclick="guardarNuevoNIP()" class="space-btn px-4 py-2">Guardar</button>
        </div>
      </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div id="mainUI" class="w-full max-w-2xl mt-2 sm:mt-3 md:mt-4">
      <div class="space-panel rounded-[28px] p-6 md:p-7 shadow-2xl pt-5">

        <div class="flex flex-wrap justify-center gap-3 mt-2">
          <button onclick="solicitarNIP()" class="fuente-magma text-lg space-btn px-5 py-3 rounded-2xl btn-wrap">
            <span class="btn-text">Capturar Datos</span>
          </button>
          <button onclick="abrirModalReporteMensual()"
            class="fuente-magma text-lg space-btn px-5 py-3 rounded-2xl btn-wrap">
            <span class="btn-text">Generar <wbr>reporte</span>
          </button>
        </div>

        <div class="mt-6">
          <label for="refBusqueda" class="sr-only">Buscar por referencia</label>
          <input type="text" id="refBusqueda" placeholder="Buscar por referencia..."
            class="space-input w-full text-center"
            oninput="document.getElementById('resultadoBusqueda')?.classList.remove('hidden'); buscarReferencia(this.value)"
            autocomplete="off" />
          <div id="resultadoBusqueda" class="text-sm text-white/80 mt-3 max-h-[50vh] overflow-y-auto custom-scrollbar">
          </div>
        </div>

        <div id="estadoUsuario" onclick="mostrarMenuModo()"
          class="mt-4 cursor-pointer space-card p-4 rounded-2xl hover:bg-white/10 transition" role="button"
          tabindex="0">
          <div class="text-base flex items-center justify-center gap-2">
            <span id="usuarioActivo" class="text-lg font-extrabold ml-2 text-white/90">Selecciona un modo para
              iniciar</span>
          </div>
          <div class="mt-2 text-center">
            <span id="modoLabel"
              class="inline-block font-bold px-3 py-1 rounded-2xl text-white bg-white/10 border border-white/10 text-sm">INACTIVO</span>
          </div>
        </div>

        <div id="contenedorQR" class="relative w-full mb-4 hidden mt-4">
          <label for="inputQR" class="sr-only">Escanea el c√≥digo QR</label>
          <input type="text" id="inputQR" placeholder="Escanea el c√≥digo QR"
            class="space-input w-full text-center pr-12" autocomplete="off" />
          <button type="button" onclick="abrirModalQR()" aria-label="Escanear QR con c√°mara"
            class="absolute right-2 top-1/2 -translate-y-1/2 rounded-full p-2 text-2xl bg-white/5 hover:bg-white/10 border border-white/10 transition">üì∑</button>
        </div>

        <div id="tablaRemisionSAP" class="hidden mt-6">
          <div class="flex justify-between items-center mb-3">
            <h2 class="font-bold text-sm text-white/90">üßæ Avance remisi√≥n SAP:</h2>
            <button id="btnToggleFilasValidadas" class="text-sm text-teal-200 hover:text-teal-100 underline">Ocultar
              validados</button>
          </div>

          <div class="space-card rounded-2xl overflow-hidden border border-white/10">
            <table class="w-full text-sm">
              <thead>
                <tr class="bg-white/5 text-center text-white/80">
                  <th class="p-2">Referencia</th>
                  <th class="p-2">Descripci√≥n</th>
                  <th class="p-2">Lote</th>
                  <th class="p-2">Escaneados</th>
                </tr>
              </thead>
              <tbody id="bodyRemisionSAP" class="text-white/85"></tbody>
            </table>
          </div>
        </div>
        <button id="btnEnviarSupabase" onclick="enviarSupabase()"
          class="hidden mt-4 w-full bg-teal-900 text-white py-2 rounded-2xl">
          Enviar a Base de Datos
        </button>


        <div id="resumenEscaneos" class="hidden mt-6 space-card p-3 rounded-2xl text-sm text-white/85"></div>

        <div id="tablaContenedora" class="hidden opacity-0 transition-opacity duration-300 mt-4">
          <div class="space-card rounded-2xl overflow-hidden border border-white/10">
            <table class="min-w-full text-sm text-left" id="tablaRegistros">
              <thead>
                <tr class="bg-white/5 text-white/80">
                  <th class="p-2">Referencia</th>
                  <th class="p-2">Lote</th>
                  <th class="p-2">Estado</th>
                  <th class="p-2 text-center">Eliminar</th>
                </tr>
              </thead>
              <tbody id="tablaRegistrosBody"></tbody>
            </table>
          </div>
        </div>

        <div class="text-center mt-6 space-y-3">
          <button id="btnAlertasCaducidad" class="space-btn px-5 py-3 rounded-2xl">
            Pr√≥ximos a caducar
          </button>
          <button id="btnQC" type="button" onclick="abrirModalQC()" class="space-btn px-5 py-3 rounded-2xl">
            Centro de Mando QC
          </button>
          <button type="button" onclick="abrirModalHipotesis()" class="space-btn px-5 py-3 rounded-2xl">
            Hip√≥tesis
          </button>


        </div>

      </div>
    </div>

    <!-- BOT√ìN CERRAR SESI√ìN -->
    <button id="btnCerrarSesion" onclick="cerrarSesion()"
      class="hidden fixed bottom-4 left-4 z-50 rounded-2xl px-4 py-2 text-sm font-semibold bg-white/10 border border-white/15 shadow-lg hover:bg-white/15 transition">
      üîí Cerrar sesi√≥n
    </button>

    <!-- BOT√ìN OPCIONES USUARIO -->
    <button onclick="mostrarOpcionesAdmin()"
      class="fixed bottom-4 right-4 z-50 rounded-full px-4 py-3 text-sm font-semibold bg-white/10 border border-white/15 shadow-lg hover:bg-white/15 transition">
      ‚öôÔ∏è Opciones de usuario
    </button>

    <!-- MODAL REPORTE MENSUAL -->
    <div id="modalReporteMensual"
      class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 space-modal-backdrop">
      <div class="space-panel rounded-3xl p-6 w-[92%] max-w-md relative">
        <button onclick="cerrarModalReporteMensual()"
          class="absolute top-3 right-4 text-red-900 text-2xl font-bold hover:text-red-700">√ó</button>
        <h2 class="text-xl font-bold text-center mb-6 text-white/90">üìä Generar reporte mensual</h2>

        <div class="mb-6">
          <div class="flex gap-2">
            <div class="flex-1">
              <label for="inputMesMes" class="block text-sm font-semibold mb-1 text-white/80">Mes</label>
              <select id="inputMesMes" class="space-input w-full !py-2 text-base">
                <option value="">Mes</option>
                <option value="01">Enero</option>
                <option value="02">Febrero</option>
                <option value="03">Marzo</option>
                <option value="04">Abril</option>
                <option value="05">Mayo</option>
                <option value="06">Junio</option>
                <option value="07">Julio</option>
                <option value="08">Agosto</option>
                <option value="09">Septiembre</option>
                <option value="10">Octubre</option>
                <option value="11">Noviembre</option>
                <option value="12">Diciembre</option>
              </select>
            </div>

            <div class="w-28">
              <label for="inputMesAnio" class="block text-sm font-semibold mb-1 text-white/80">A√±o</label>
              <select id="inputMesAnio" class="space-input w-full !py-2 text-base"></select>
            </div>
          </div>
        </div>

        <div class="flex justify-end gap-3">
          <button onclick="cerrarModalReporteMensual()" class="space-btn-ghost px-4 py-2 rounded-2xl">Cancelar</button>
          <button onclick="generarReporteMensual()" class="space-btn px-4 py-2 rounded-2xl">Generar Excel</button>
        </div>
      </div>
    </div>

    <!-- MODAL OPCIONES ADMIN -->
    <div id="modalOpcionesAdmin"
      class="fixed inset-0 z-50 hidden flex items-center justify-center space-modal-backdrop">
      <div class="space-panel p-6 rounded-3xl w-[92%] max-w-md space-y-4">
        <h2 class="text-lg font-bold text-center text-white/90">‚öôÔ∏è Opciones de Usuario</h2>
        <div class="flex flex-col space-y-3">
          <button onclick="cerrarModalOpcionesAdmin(); mostrarCambioNIP()" class="space-btn w-full py-3 rounded-2xl">üîë
            Cambiar NIP</button>

          <button id="btnModificarUnidades" onclick="cerrarModalOpcionesAdmin(); mostrarModalAsignarUnidades()"
            class="space-btn w-full py-3 rounded-2xl hidden">
            üè• Modificar Unidades
          </button>

          <button id="btnRestablecerNIP" onclick="restablecerNIPUsuario()"
            class="w-full rounded-2xl py-3 font-semibold text-white bg-gradient-to-r from-rose-900 to-red-900 border border-red-400/20 shadow-lg hover:opacity-95 hidden">
            üîÅ Restablecer NIP de Usuario
          </button>

          <button id="btnBloqueoRemision" onclick="cargarEstadoBloqueo()"
            class="w-full rounded-2xl py-3 font-semibold text-white bg-gradient-to-r from-purple-900 to-indigo-900 border border-white/10 shadow-lg hover:opacity-95 hidden">
            üîí Cargar estado de bloqueo
          </button>

          <button id="btnVerPinDinamico" onclick="abrirModalPinDinamico()"
            class="w-full rounded-2xl py-3 font-semibold text-white bg-gradient-to-r from-pink-900 to-rose-900 border border-white/10 shadow-lg hover:opacity-95 hidden">
            üìü Ver PIN Din√°mico
          </button>
        </div>

        <div class="text-center mt-5">
          <button onclick="cerrarModalOpcionesAdmin()" class="space-btn-ghost w-full py-3 rounded-2xl">‚ùå Cerrar</button>
        </div>
      </div>
    </div>

    <!-- MODAL PIN DIN√ÅMICO -->
    <div id="modalPinDinamico" class="fixed inset-0 z-50 hidden items-center justify-center space-modal-backdrop">
      <div class="space-panel rounded-3xl p-6 max-w-sm w-[92%] text-center">
        <h2 class="text-xl font-bold mb-4 text-white/90">üìü PIN Din√°mico</h2>
        <p class="text-sm text-white/70 mb-2">V√°lido por:</p>
        <div id="contadorPin" class="text-lg font-semibold text-teal-200 mb-4">--:--</div>
        <p class="text-sm text-white/70">PIN actual:</p>
        <div id="valorPinDinamicoSolo" class="text-4xl font-mono text-emerald-200 my-2 tracking-widest">------</div>
        <button onclick="cerrarModalPinDinamico()" class="space-btn-ghost w-full py-2 rounded-2xl mt-4">Cerrar</button>
      </div>
    </div>

    <!-- MODAL PIN EXCESO -->
    <div id="modalPINExceso" class="hidden fixed inset-0 z-[9990] items-center justify-center space-modal-backdrop">
      <div class="space-panel p-6 rounded-3xl w-[92%] max-w-[380px] text-sm">
        <div id="contenidoPINExceso" class="space-y-3 text-white/85"></div>

        <div class="mt-4">
          <label for="nipdinamico" class="block text-sm font-semibold mb-1 text-white/80">NIP de autorizaci√≥n:</label>
          <input id="nipdinamico" name="pin_temporal" type="text" inputmode="text" pattern="[0-9A-Fa-f]{6}"
            maxlength="6" minlength="6" autocomplete="off"
            class="space-input text-center font-mono text-xl tracking-widest" placeholder="######" />
          <p id="pinErrorExceso" class="text-rose-200 text-xs mt-2 hidden">‚ùå PIN incorrecto</p>
        </div>

        <div class="flex justify-between gap-3 mt-5">
          <button id="btnCancelarPIN" class="space-btn-ghost w-1/2 py-2 rounded-2xl">Cancelar</button>
          <button id="btnConfirmarPin" class="space-btn w-1/2 py-2 rounded-2xl">Confirmar PIN</button>
        </div>
      </div>
    </div>

    <!-- NOTIFICACI√ìN -->
    <div id="notificacion" class="modal text-center font-bold"></div>

    <!-- MODAL ASIGNAR UNIDADES -->
    <div id="modalAsignarUnidades" class="fixed inset-0 z-50 hidden items-center justify-center space-modal-backdrop">
      <div class="space-panel rounded-3xl p-6 w-[92%] max-w-xl shadow-2xl">
        <h2 class="text-lg font-bold text-center mb-4 text-white/90">üè• Asignar unidades a usuario</h2>

        <label for="selectUsuario" class="block text-sm font-semibold mb-2 text-white/80">Selecciona un usuario:</label>
        <select id="selectUsuario" class="space-input w-full mb-4"></select>

        <div class="grid grid-cols-2 gap-2 max-h-64 overflow-y-auto mb-4" id="listaUnidades"></div>

        <div id="unidadAsignarError" class="text-sm text-rose-200 hidden mb-2">‚ùå Error al guardar unidades.</div>

        <div class="flex justify-end gap-2">
          <button onclick="cerrarModalAsignarUnidades()" class="space-btn-ghost px-4 py-2 rounded-2xl">Cancelar</button>
          <button onclick="guardarUnidadesAsignadas()" class="space-btn px-4 py-2 rounded-2xl">Guardar</button>
        </div>
      </div>
    </div>

    <!-- MODAL NIP -->
    <div id="modalNIP" class="space-modal hidden">
      <div class="space-modal__panel">
        <div class="space-modal__header flex items-center justify-between">
          <h2 class="text-lg font-bold">üîê Ingresa tu NIP</h2>
          <button onclick="cerrarModalNIP()" class="text-red-900 hover:text-red-700 text-2xl font-bold">√ó</button>
        </div>

        <div class="space-modal__body">
          <label for="nipInput" class="sr-only">NIP</label>
          <input id="nipInput" type="password" placeholder="NIP" class="space-input w-full mb-3"
            onkeydown="if(event.key==='Enter'){ validarNIP(); }" />
          <button onclick="validarNIP()" class="space-btn w-full py-3 rounded-2xl">Ingresar</button>
          <p id="nipError" class="text-red-900 text-sm mt-2 hidden">‚ùå NIP inv√°lido.</p>
        </div>
      </div>
    </div>

    <!-- MODAL CAPTURA -->
    <!-- ================= MODAL CAPTURA (COMPLETO) ================= -->
    <div id="modalCaptura" class="fixed inset-0 hidden flex z-50 items-center justify-center blur-fondo">
      <div class="space-panel rounded-3xl p-4 md:p-6 w-[95%] max-w-6xl max-h-[95vh] overflow-auto shadow-2xl">

        <!-- HEADER COMPACTO: T√≠tulo + Controles Contexto -->
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 border-b border-white/10 pb-4">
          <div class="flex items-center justify-between w-full md:w-auto">
            <h2 class="text-xl font-bold text-white/90">üìã Captura de Inventario</h2>
            <button onclick="cerrarModalCaptura()" class="md:hidden text-red-900 font-bold text-2xl px-2">√ó</button>
          </div>

          <!-- Controles de Contexto: Modo + Unidad -->
          <div
            class="flex items-center justify-between md:justify-start gap-2 bg-white/5 rounded-2xl p-1.5 md:p-2 md:pr-4 border border-white/10 w-full md:w-auto">

            <!-- Toggle Modo -->
            <div class="flex items-center gap-1.5 pl-1 md:pl-2 border-r border-white/10 pr-2 md:pr-4 shrink-0">
              <span id="modoTexto"
                class="font-bold text-xs uppercase tracking-wide text-emerald-900 w-[70px] text-center"
                style="text-shadow: 1px 0 0 rgba(255, 255, 255, 0.8), 0 1px 0 rgba(255, 255, 255, 0.8), -1px 0 0 rgba(255, 255, 255, 0.8), 0 -1px 0 rgba(255, 255, 255, 0.8);">Inventario</span>
              <label for="modoToggle" class="inline-flex items-center cursor-pointer relative">
                <input type="checkbox" id="modoToggle" class="sr-only peer" onchange="actualizarModoCaptura()" />
                <div
                  class="w-8 h-5 md:w-10 md:h-6 bg-emerald-500/60 rounded-full peer-checked:bg-rose-500/60 transition-colors border border-white/20">
                </div>
                <div
                  class="absolute left-1 top-1 w-3 h-3 md:w-4 md:h-4 bg-white rounded-full shadow-sm transition-transform peer-checked:translate-x-3 md:peer-checked:translate-x-4">
                </div>
              </label>
              <input type="hidden" id="modoCaptura" value="inventario">
            </div>

            <!-- Selector Unidad -->
            <div class="flex items-center gap-2 shrink-0 flex-grow justify-end md:justify-start">
              <label for="unidadCaptura"
                class="text-xs font-semibold text-white/60 uppercase hidden xs:block">Unidad:</label>
              <select id="unidadCaptura"
                class="bg-transparent text-sm font-bold text-white outline-none border-b border-transparent focus:border-teal-500 transition-colors max-w-[120px] md:max-w-none text-right md:text-left"
                onchange="mostrarReferenciasUnidad()">
              </select>
            </div>
          </div>

          <button onclick="cerrarModalCaptura()"
            class="hidden md:block text-red-900 font-bold text-2xl hover:text-red-500 transition-colors">√ó</button>
        </div>

        <!-- GRID PRINCIPAL -->
        <!-- INPUT ROW UNIFICADO -->
        <div
          class="space-card space-card--ov-visible p-4 rounded-2xl border border-white/10 bg-white/5 relative z-20 mt-4"
          style="overflow: visible !important;">
          <label class="block text-xs font-semibold text-white/50 mb-2 uppercase tracking-widest">Nueva Entrada</label>

          <div class="flex flex-col md:flex-row items-stretch md:items-end gap-3">

            <!-- Referencia (Grow) -->
            <div class="relative flex-grow group min-w-[140px]">
              <div class="flex gap-2">
                <div class="relative w-full">
                  <input id="inputReferencia"
                    class="space-input w-full pl-3 pr-10 py-3 text-lg font-mono tracking-wide placeholder:font-sans placeholder:text-base placeholder:text-white/30 !bg-black/40 !border-white/10 focus:!border-teal-500/50 focus:!bg-black/60 transition-all rounded-xl"
                    placeholder="Ref..."
                    onkeydown="if(event.key==='Enter'){ document.getElementById('inputCantidad').focus(); }"
                    autocomplete="off" />
                </div>

                <button type="button" id="btnQrInventario" onclick="abrirModalQRInventario?.()"
                  class="shrink-0 w-12 rounded-xl border border-white/10 bg-white/5 hover:bg-teal-500/20 hover:border-teal-500/40 hover:text-teal-400 transition-all grid place-items-center text-xl"
                  title="Escanear (C√°mara)">
                  üì∑
                </button>
              </div>

              <!-- Selected Name Display -->
              <div id="nombreSeleccionado"
                class="text-xs text-teal-300 mt-1 ml-1 font-semibold truncate hidden max-w-[200px]"></div>

              <!-- Sugerencias (Dropdown Absolute) -->
              <div id="sugerenciasReferencia"
                class="absolute left-0 right-0 top-full mt-2 hidden rounded-xl border border-white/10 bg-[#0f151a] shadow-2xl z-[100] max-h-60 overflow-y-auto">
              </div>
            </div>

            <!-- Controls Row (Qty + Lot + Btn) -->
            <div class="flex flex-row items-stretch gap-2 w-full md:w-auto justify-between md:justify-start">

              <!-- Cantidad (Small) -->
              <div class="w-20 shrink-0">
                <input id="inputCantidad" type="number" step="0.1" min="0" max="999.9" inputmode="decimal"
                  class="cantidad-input input-cantidad !w-full !text-center !text-lg !py-3 !rounded-xl !bg-black/40 !border-white/10 focus:!border-teal-500/50 focus:!bg-black/60"
                  placeholder="Cant."
                  onkeydown="if(event.key==='Enter'){ document.getElementById('inputLoteManual').focus(); }" />
              </div>

              <!-- Lote (Flexible on mobile) -->
              <div class="flex-grow md:w-28 md:flex-none min-w-[80px]">
                <input id="inputLoteManual" type="text"
                  class="input-lote-style !w-full !text-center !text-lg !py-3 !rounded-xl !bg-black/40 !border-white/10 focus:!border-teal-500/50 focus:!bg-black/60"
                  placeholder="Lote" onkeydown="if(event.key==='Enter'){ agregarFilaCaptura(); }" />
              </div>

              <!-- Bot√≥n Agregar -->
              <button id="btnAgregarCaptura" onclick="agregarFilaCaptura?.()"
                class="shrink-0 py-3 px-4 rounded-xl flex items-center justify-center gap-2 font-bold uppercase tracking-wider text-sm shadow-lg shadow-emerald-900/40 bg-gradient-to-r from-emerald-900 to-teal-700 hover:from-emerald-700 hover:to-teal-500 text-white transition-all transform hover:scale-[1.02] active:scale-[0.98]">
                <span class="hidden sm:inline">Agregar</span>
                <span class="text-lg leading-none">+</span>
              </button>
            </div>
          </div>
        </div>

        <!-- TOOLBAR: Filtros y Acciones Secundarias -->
        <div
          class="flex flex-col sm:flex-row items-center justify-between gap-4 text-sm mt-auto border-t border-white/10 pt-4">

          <!-- Grupo: Fecha + Archivo -->
          <div class="flex flex-wrap items-center gap-3 w-full sm:w-auto justify-center sm:justify-start">
            <!-- Toggle Tipo (Inicial vs Validacion) -->
            <div class="flex items-center gap-2 bg-white/5 rounded-lg px-2 py-1 border border-white/10">
              <input type="checkbox" id="toggleTipoCaptura" class="hidden" onchange="actualizarTextoTipoCaptura?.()">
              <label for="toggleTipoCaptura"
                class="cursor-pointer text-xs font-semibold text-white/70 hover:text-white transition-colors uppercase tracking-wider"
                id="textoTipoCaptura">
                Inicial
              </label>
              <!-- Indicador visual simple -->
              <!-- Indicador visual simple -->
              <div id="indicadorTipoCaptura" class="w-2 h-2 rounded-full bg-teal-600 transition-colors duration-300">
              </div>
            </div>
            <div class="flex items-center bg-white/5 rounded-lg border border-white/10 px-3 py-1.5 gap-2">
              <select id="mesCaptura" class="bg-transparent outline-none font-semibold text-white/90"></select>
              <span class="text-white/20">/</span>
              <select id="anioCaptura" class="bg-transparent outline-none font-semibold text-white/90"></select>
            </div>

            <div id="divPrecargarArchivo" class="relative hidden">
              <input type="file" id="archivoCaptura" accept=".csv, .xlsx, .xls" class="hidden"
                onchange="precargarArchivoCaptura()" />
              <label for="archivoCaptura"
                class="cursor-pointer text-rose-700 hover:text-rose-300 font-semibold flex items-center gap-1 transition-colors">
                <span class="underline decoration-rose-500/30 underline-offset-4">Precargar Archivo</span>
                <span id="archivoCapturaNombre"
                  class="text-white/40 font-normal no-underline max-w-[100px] truncate block"></span>
              </label>
            </div>
          </div>

          <!-- Grupo: Config + Enviar -->
          <div class="flex items-center gap-4 w-full sm:w-auto justify-between sm:justify-end">
            <!-- Toggle Ocultar Completadas -->
            <label
              class="flex items-center gap-2 cursor-pointer text-white/60 hover:text-white transition-colors text-xs select-none">
              <input type="checkbox" id="checkboxFilas"
                class="accent-teal-500 w-4 h-4 rounded border-white/20 bg-white/5" onchange="aplicarFiltrosTabla()" />
              Ocultar Cant.
            </label>

            <!-- Toggle Ocultar Completos (Cant + Lote) -->
            <label
              class="flex items-center gap-2 cursor-pointer text-white/60 hover:text-white transition-colors text-xs select-none ml-4">
              <input type="checkbox" id="checkboxFilasLote"
                class="accent-teal-500 w-4 h-4 rounded border-white/20 bg-white/5" onchange="aplicarFiltrosTabla()" />
              Ocultar Cant.+Lote
            </label>



            <button id="btnEnviarCaptura" onclick="enviarCapturaBase?.()"
              class="!py-2 !px-5 rounded-lg text-sm font-bold shadow-lg shadow-blue-500/30 bg-gradient-to-r from-teal-600 to-blue-600 hover:from-teal-500 hover:to-blue-500 text-white active:translate-y-0.5 transform transition-all tracking-wide border border-white/10 uppercase">
              ENVIAR DATOS ‚ûî
            </button>
          </div>
        </div>

        <!-- TABLA RESULTADOS (Hidden by default, shown by JS) -->
        <div id="contenedorTabla" class="hidden mt-2 w-full flex-grow overflow-hidden flex flex-col min-h-[120px]">
          <div class="space-card rounded-xl overflow-hidden border border-white/10 flex-grow relative flex flex-col">
            <div class="overflow-y-auto custom-scrollbar flex-grow max-h-[40vh]"> <!-- Scroll interno -->
              <table class="w-full text-sm text-left" id="tablaCaptura">
                <thead id="tablaEncabezado"
                  class="sticky top-0 z-10 bg-[#06161d] shadow-sm text-white/60 text-xs uppercase tracking-wider backdrop-blur-sm">
                  <tr>
                    <th class="w-12 p-3 text-center border-b border-white/5"></th> <!-- (+) -->
                    <th class="w-20 p-3 text-center border-b border-white/5">Cant.</th>
                    <th id="thLote" class="hidden w-24 p-3 border-b border-white/5">Lote</th>
                    <th class="w-32 p-3 text-right border-b border-white/5">Ref.</th>
                    <th class="p-3 border-b border-white/5">Nombre Producto</th>
                    <th class="w-12 p-3 text-center border-b border-white/5"></th> <!-- (x) -->
                  </tr>
                </thead>
                <tbody class="divide-y divide-white/5 text-white/90 font-medium"></tbody>
              </table>
            </div>

            <!-- Empty State (visual placeholder si quieres) -->
            <div id="tablaEmptyState"
              class="hidden absolute inset-0 flex items-center justify-center text-white/20 pointer-events-none">
              <div class="text-center">
                <span class="text-4xl block mb-2">üì•</span>
                <span class="text-sm">Agrega items para comenzar</span>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
    <!-- ================= FIN MODAL CAPTURA ================= -->

    <!-- ================= MODAL LABORATORIO DE HIP√ìTESIS ================= -->
    <div id="modalHipotesis" class="space-modal hidden">
      <div
        class="space-modal__panel w-[96%] max-w-5xl rounded-3xl text-white shadow-2xl max-h-[92dvh] overflow-hidden border border-white/10">
        <div class="flex items-start justify-between gap-4 p-5 border-b border-white/10">
          <div class="min-w-0">
            <h2 class="text-2xl font-bold fuente-magma tracking-wider">Laboratorio de Hip√≥tesis</h2>
            <p class="text-sm text-white/70 mt-1 break-words">Pregunta libre ‚Üí IA / Plan cient√≠fico ‚Üí evidencia +
              conclusi√≥n auditable.</p>
          </div>

          <button type="button" onclick="cerrarModalHipotesis()"
            class="shrink-0 w-10 h-10 grid place-items-center rounded-2xl bg-white/5 border border-white/10 text-red-900 hover:text-red-700 text-2xl font-bold"
            aria-label="Cerrar">√ó</button>
        </div>

        <div class="p-5 overflow-y-auto max-h-[calc(92dvh-84px)]">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">

            <div class="rounded-2xl p-4 bg-white/5 border border-white/10">
              <label class="text-sm font-semibold text-white/80">Pregunta / hip√≥tesis</label>

              <textarea id="hipotesisPregunta"
                class="mt-2 w-full min-h-[140px] p-3 rounded-2xl bg-black/30 border border-white/10 focus:outline-none focus:ring-2 focus:ring-teal-500"
                placeholder="Ej: En invierno se incrementan las pruebas efectivas en C03128 vs resto del a√±o."></textarea>

              <div class="mt-3 flex gap-2">
                <button type="button" onclick="ejecutarPreguntaLibreIA()"
                  class="flex-1 px-4 py-2 rounded-2xl bg-white/10 hover:bg-white/15 border border-white/10 font-semibold">üí¨
                  Preguntar</button>
              </div>

              <div class="grid grid-cols-2 gap-3 mt-4">
                <div>
                  <label class="text-xs text-white/70" for="hipotesisLab">Unidad (opcional)</label>
                  <input id="hipotesisLab" class="mt-1 w-full p-2 rounded-xl bg-black/30 border border-white/10"
                    placeholder="C03128" />
                </div>
                <div>
                  <label class="text-xs text-white/70" for="hipotesisRef">Referencia (opcional)</label>
                  <input id="hipotesisRef" class="mt-1 w-full p-2 rounded-xl bg-black/30 border border-white/10"
                    placeholder="GLU-001" />
                </div>
              </div>

              <div class="grid grid-cols-2 gap-3 mt-3">
                <div>
                  <label for="hipotesisDesde" class="text-xs text-white/70">Desde</label>
                  <input id="hipotesisDesde" type="date"
                    class="mt-1 w-full p-2 rounded-xl bg-black/30 border border-white/10" />
                </div>
                <div>
                  <label for="hipotesisHasta" class="text-xs text-white/70">Hasta</label>
                  <input id="hipotesisHasta" type="date"
                    class="mt-1 w-full p-2 rounded-xl bg-black/30 border border-white/10" />
                </div>
              </div>

              <div class="flex items-center justify-between mt-4">
                <label class="text-xs text-white/70 flex items-center gap-2">
                  <input id="hipotesisDemo" type="checkbox" class="accent-teal-500">
                  Modo demo
                </label>
                <div id="hipotesisStatus" class="text-xs text-white/70"></div>
              </div>
            </div>

            <div class="lg:col-span-2 rounded-2xl p-4 bg-white/5 border border-white/10">
              <div id="hipotesisSalida" class="space-y-4">
                <div class="text-white/60 text-sm">
                  Aqu√≠ se mostrar√° el chat libre o el reporte cient√≠fico (H0/H1, m√©todo, supuestos, etc.).
                </div>
              </div>
            </div>

          </div>

          <div class="h-[env(safe-area-inset-bottom)]"></div>
        </div>
      </div>
    </div>


    </script>


    <!-- ================= Scripts locales ================= -->
    <script>
      //#region constantes
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MjcxNjYsImV4cCI6MjA2MjAwMzE2Nn0.vxPo7XXaeKPa-jDQRA2jvOJ7dvJZDHRNZB7blbONNZo";
      const API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MjcxNjYsImV4cCI6MjA2MjAwMzE2Nn0.vxPo7XXaeKPa-jDQRA2jvOJ7dvJZDHRNZB7blbONNZo";
      const VALIDAR_URL = "https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/validar_qr";
      const API_URL = "https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/registrar_qr";
      const SONIDO_BLOQUEADO = "https://github.com/RicardoCentrum/centrum/raw/main/losiento.mp3";
      let modo = "entrada";
      let qrsPendientes = [];  // lo que se ha validado pero a√∫n no enviado
      let estaProcesandoSalida = false;
      let filtroReferenciaGlobal = null;
      let fraccionesEscaneadas = []; // cada item: { timestamp, cantidad_restante, lote }
      let cantidadFaltante = 0;
      let referenciasCache = [];
      let usuario = null;                 // Se debe asignar al seleccionar usuario
      let unidadSeleccionada = null;      // Se asigna desde la selecci√≥n de unidad m√©dica
      let modoSeleccionado = null;
      let esAdmin = false;
      let UNIDAD_DESTINO = null;          // Se usa en modo salida para fraccionados
      let REF_GLOBAL = null;
      let modoExtraccionFraccionableActivo = false;
      let referenciaActual = null;
      let loteActual = null;
      let ultimoContenidoEscaneado = null;
      let datosCaptura = [], usuarioActivo = "", unidadesAsignadas = [], referenciasPorUnidad = [];
      let remisionGlobal = null;
      let remisionActual = null; // nueva variable global
      let remision = null;
      let callbackSobrescribir = null;
      let remisionActiva = "";
      let avanceRemision = {}; // { '10309546||252450': { nombre, lote, escaneados, total } }
      let ocultarValidados = false;
      let intervaloPin = null;
      let intervaloCuentaRegresiva = null;
      let scannerActivo = false, qrScanner = null;
      let modoScannerQR = "movimientos"; // "movimientos" | "inventario"
      let inventarioDetallado = {};
      window.autorizacionesExceso = window.autorizacionesExceso || {};
      window.FORECAST_DEFAULT_HORIZON = 6;  // üëà Default 6 meses
      window.FORECAST_DEFAULT_MERMA_PCT = 10; // üëà Merma default
      window.FORECAST_DEFAULT_MODELO = "auto"; // auto | arimax | xgboost | ensemble
      const unidadesDestino = {
        "C03442": "C.S. GALEANA", "C03441": "C.S. HIDALGO", "C03438": "C.S. NUEVO CASAS GRANDES", "C03443": "CAAPS ANAPRA", "C03439": "CESSA COLINAS", "C03440": "CESSA ZARAGOZA", "C03435": "H.C. NUEVO CASAS GRANDES", "C03436": "HIE JUAREZ",
        "C03420": "HOSPITAL DE LA MUJER CD JUAREZ", "C03419": "HOSPITAL GENERAL CD JUAREZ", "C03127": "HGZ 6", "C03131": "HGS 22", "C03135": "HGR 02", "C03133": "HGZ UMAA 35", "C03134": "HGR 66", "C03448": "C.S. GUACHOCHI", "C03447": "C.S. JIMENEZ", "C03446": "H. GPE Y CALVO", "C03132": "H.G.Z.M.F. 23", "C03122": "H.R.O. No. 26", "C03124": "H.R.O. No. 36", "C03445": "HOSPITAL CAMARGO", "C03421": "HOSPITAL DE JIMENEZ", "C03422": "HOSPITAL GINECOLOGIA PARRAL", "C03444": "HOSPITAL PARRAL", "C03451": "CESSA ALDAMA", "C03433": "CESSA MADERA",
        "C03415": "HOSPITAL CENTRAL", "C03424": "HG CUAUHTEMOC", "C03416": "HGO CUAUHTEMOC", "C03432": "CESSA TIERRA NUEVA", "C03431": "CS CREEL", "C03428": "CS TEMORIS", "C03123": "HRO No. 18 SAN JUANITO", "C03430": "C.S. DELICIAS", "C03425": "H.C. OJINAGA", "C03417": "H.R. DELICIAS", "C03434": "C.S. SANTA ISABEL", "C03429": "CAAPS NOGALES", "C03427": "C.S. SAN FELIPE", "C03426": "H.C. GOMEZ FARIAS", "C03418": "HIE CHIHUAHUA", "C03423": "H.G. DR. SALVADOR ZUBIRAN", "C03128": "H.G.Z.M.F. 11", "C03130": "H.G.Z.M.F. 16", "C03129": "HGO No. 15", "C03126": "HGR No. 1", "66": "ALMACEN PARRAL", "65": "ALMACEN JUAREZ", "CUU": "ALMACEN CHIHUAHUA"
      };
      const unidadesFijas = {
        "C03442": "CS Galeana", "C03441": "C.S. HIDALGO", "C03438": "CS Casas Grandes", "C03443": "CAAPS ANAPRA", "C03439": "CESSA Colinas", "C03440": "CESSA Zaragoza", "C03435": "HC Casas Grandes", "C03436": "HIE Cd. Juarez",
        "C03420": "hospital de la mujer", "C03419": "hg cd. juarez", "C03127": "HGZ 6", "C03131": "HGS 22", "C03135": "HGR 02", "C03133": "HGZ UMAA 35", "C03134": "HGR 66", "C03448": "CAAPS Guachochi", "C03447": "CS Jimenez", "C03446": "HC Guadalupe y Calvo", "C03132": "H.G.Z.M.F. 23", "C03122": "H.R.O. No. 26", "C03124": "H.R.O. No. 36", "C03445": "HG Camargo", "C03421": "hr jimenez", "C03422": "Ginecologia Parral", "C03444": "HG Parral", "C03451": "CESSA Aldama", "C03433": "CESSA Madera",
        "C03415": "hospital central", "C03424": "HG Cuauhtemoc", "C03416": "Ginecologia Cuauhtemoc", "C03432": "CESSA Tierra Nueva", "C03431": "CS Creel", "C03428": "CS Temoris", "C03123": "HRO No. 18 SAN JUANITO", "C03430": "CS Delicias", "C03425": "HC Ojinaga", "C03417": "hr delicias", "C03434": "CS Sta. Isabel", "C03429": "CAAPS Nogales", "C03427": "CS San Felipe", "C03426": "HC Gomez Farias", "C03418": "hie chihuahua", "C03423": "HG Chihuahua", "C03128": "H.G.Z.M.F. 11", "C03130": "H.G.Z.M.F. 16", "C03129": "HGO No. 15", "C03126": "HGR No. 1", "66": "ALMACEN PARRAL", "65": "ALMACEN JUAREZ", "CUU": "ALMACEN CHIHUAHUA"
      };
      const anioSelect = document.getElementById('anioSelect');
      const timestampsEscaneadosInventario = new Set();
      // ‚úÖ sort s√∫per defensivo para Chart.js v4
      const safeLegendSort = (a, b, third) => {
        // Chart.js v4 llama sort(a,b,chart) o sort(a,b,data) seg√∫n contexto,
        // as√≠ que lo detectamos sin asumir nada.
        const chart =
          third?.chart ||               // a veces viene envuelto
          third?.$context?.chart ||     // algunos plugins
          third;                        // a veces es el chart directo

        const ds = chart?.data?.datasets || [];

        const oa = ds?.[a?.datasetIndex]?.order ?? a?.datasetIndex ?? 0;
        const ob = ds?.[b?.datasetIndex]?.order ?? b?.datasetIndex ?? 0;

        return oa - ob;
      };
      if (anioSelect) {
        const thisYear = new Date().getFullYear();
        anioSelect.innerHTML = '<option value="">A√±o</option>';
        for (let y = thisYear - 2; y <= thisYear + 8; y++) {
          anioSelect.innerHTML += `<option value="${y}">${y}</option>`;
        }
      }


      //#endregion Constanes==============================================================================================================

      //#region funciones auxiliares =====================================================================================================
      function mostrarLoader(show = true, msg = null) {
        const el = document.getElementById("loaderOverlay");
        const status = document.getElementById("loaderStatus");
        if (!el) return;

        if (show) {
          if (status) {
            status.textContent = msg || "Ejecutando operaci√≥n‚Ä¶";
          }
          el.classList.remove("hidden");
        } else {
          el.classList.add("hidden");
        }
      }
      function ocultarLoader() { const o = document.getElementById("loaderOverlay"); o && o.classList.add("hidden"); document.body.style.overflow = ""; window.removeEventListener("keydown", bloquearTeclas, true); window.removeEventListener("mousedown", bloquearClicks, true); }
      function bloquearTeclas(e) { if (!(e.key === "F5" || e.key === "Escape")) { e.stopPropagation(); e.preventDefault(); } }
      function bloquearClicks(e) { e.stopPropagation(); e.preventDefault(); }
      function escapeHtml(str) {
        return String(str ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }
      function normalizarSlotNombre(input) {
        return String(input ?? "")
          .trim()
          .toUpperCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")   // quita acentos
          .replace(/[^A-Z0-9]/g, "");        // quita espacios y s√≠mbolos
      }

      function normalizarRemision(input) {
        return String(input ?? "")
          .trim()
          .replace(/\s+/g, "")
          .toUpperCase();
      }
      function loaderReset() {
        const ticker = document.getElementById("loaderTicker");
        const status = document.getElementById("loaderStatus");

        if (status) {
          status.textContent = "Ejecutando operaci√≥n‚Ä¶";
        }

        if (ticker) {
          ticker.innerHTML = "";
          ticker.classList.add("hidden"); // üëà vuelve a modo cl√°sico
        }
      }
      function loaderPush(message) {
        const ticker = document.getElementById("loaderTicker");
        if (!ticker) return;

        // üî• Primera vez que se usa ‚Üí expandimos loader
        if (ticker.classList.contains("hidden")) {
          ticker.classList.remove("hidden");
        }

        const line = document.createElement("div");
        line.textContent = "‚Ä¢ " + message;
        ticker.appendChild(line);

        ticker.scrollTop = ticker.scrollHeight;
      }
      function loaderSetStatus(text) {
        const el = document.getElementById("loaderStatus");
        if (el) el.textContent = text;
      }
      function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
      function startLoaderProgress(steps, delayMs = 900) {
        let stopped = false;

        (async () => {
          for (const step of steps) {
            if (stopped) break;

            // step puede ser string o {status, push}
            if (typeof step === "string") {
              loaderPush(step);
            } else {
              if (step.status) loaderSetStatus(step.status);
              if (step.push) loaderPush(step.push);
            }

            await sleep(delayMs);
          }

          // Si sigue vivo y se acabaron steps, deja un ‚Äúheartbeat‚Äù suave
          let dots = 0;
          while (!stopped) {
            dots = (dots + 1) % 4;
            loaderSetStatus(`üß† Procesando${".".repeat(dots)}`);
            await sleep(700);
          }
        })();

        return () => { stopped = true; };
      }
      function startLoaderStatusFlow(steps, msStep = 850) {
        // steps: [{text, mode}] mode: "once" | "dots"
        let i = 0;
        let dotsTimer = null;
        let stepTimer = null;
        let cancelled = false;

        const stopDots = () => {
          if (dotsTimer) clearInterval(dotsTimer);
          dotsTimer = null;
        };

        const setDots = (base) => {
          stopDots();
          let k = 0;
          loaderSetStatus(base);
          dotsTimer = setInterval(() => {
            if (cancelled) return;
            k = (k + 1) % 4; // "", ".", "..", "..."
            loaderSetStatus(base + ".".repeat(k));
          }, 350);
        };

        const runStep = () => {
          if (cancelled) return;
          stopDots();

          const s = steps[i] || steps[steps.length - 1];
          if (!s) return;

          if (s.mode === "dots") setDots(s.text);
          else loaderSetStatus(s.text);

          i++;
          if (i < steps.length) {
            stepTimer = setTimeout(runStep, msStep);
          }
        };

        runStep();

        return () => {
          cancelled = true;
          stopDots();
          if (stepTimer) clearTimeout(stepTimer);
          stepTimer = null;
        };
      }
      function startThinkingTicker(statusEl) {
        const t0 = Date.now();
        const msgs = [
          "üß† Analizando evidencia‚Ä¶",
          "üìä Cruzando consumos vs pruebas‚Ä¶",
          "üß™ Evaluando hip√≥tesis‚Ä¶",
          "üßæ Redactando conclusi√≥n‚Ä¶"
        ];
        let i = 0;

        statusEl.textContent = msgs[0];
        const id = setInterval(() => {
          const s = Math.floor((Date.now() - t0) / 1000);
          statusEl.textContent = `${msgs[i % msgs.length]} (${s}s)`;
          i++;
        }, 1200);

        return () => clearInterval(id);
      }
      function sanitizeHipotesisOutputForUser(text) {
        let s = String(text ?? "");

        // Caso 1: bloque de markdown json
        s = s.replace(/```json[\s\S]*?```/gi, "").trim();

        // Caso 2: desde "5) JSON final" hasta el final
        s = s.replace(/\n?5\)\s*JSON\s*final[\s\S]*$/i, "").trim();

        // Caso 3: desde "JSON final" hasta el final (por si cambia numeraci√≥n)
        s = s.replace(/\n?JSON\s*final[\s\S]*$/i, "").trim();

        return s;
      }
      //#endregion funciones auxiliares
      //88888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
      //#region preparaci√≥n
      // =====================
      // üß© PREPARACI√ìN (nuevo)
      // =====================
      let usuarioMeta = null;       // { nip, nombre, rol, es_admin, representacion }
      let ejecutivosCache = null;   // { rep, rows }

      function seleccionarModoPreparacion() {
        modo = "preparacion";
        modoSeleccionado = "preparacion";

        // Cierra modal de selecci√≥n de modo
        const modalModo = document.getElementById("modalModo");
        if (modalModo) modalModo.classList.add("hidden");
        const menuDinamico = document.querySelector(".modal-modo");
        if (menuDinamico) menuDinamico.remove();

        // UI label
        const modoLabel = document.getElementById("modoLabel");
        const usuarioActivoEl = document.getElementById("usuarioActivo");
        if (modoLabel) {
          modoLabel.textContent = "PREPARACI√ìN";
          modoLabel.className =
            "inline-block font-bold px-3 py-1 rounded-2xl text-white bg-white/10 border border-white/10 text-sm";
        }
        if (usuarioActivoEl) usuarioActivoEl.textContent = "Modo preparaci√≥n";

        // === Configura modal PIN para PREPARACI√ìN ===
        const unidadGroup = document.getElementById("unidadDestinoGroup");
        const remisionGroup = document.getElementById("remisionGroup");
        const bloqueCargaRemision = document.getElementById("bloqueCargaRemision");

        // En preparaci√≥n NO se pide unidad
        unidadGroup?.classList.add("hidden");

        // En preparaci√≥n S√ç se pide remisi√≥n
        remisionGroup?.classList.remove("hidden");
        bloqueCargaRemision?.classList.remove("hidden"); // si quieres permitir cargar Excel aqu√≠ tambi√©n

        // Limpia/ajusta inputs
        const elUnidad = document.getElementById("inputUnidad");
        if (elUnidad) {
          elUnidad.value = "";
          elUnidad.disabled = true;           // por si el input existe y alguien lo enfoca
          elUnidad.classList.add("opacity-40");
        }

        const elRem = document.getElementById("inputRemision");
        if (elRem) {
          elRem.disabled = false;
          elRem.classList.remove("opacity-40");
        }

        // Abre modal PIN/Remisi√≥n
        const modalPin = document.getElementById("modalPinUnidad");
        if (modalPin) {
          modalPin.classList.remove("hidden");
          modalPin.classList.add("flex");
        }

        // üî• CLAVE: NO ABRAS modalPreparacion aqu√≠
        // abrirModalPreparacion();
      }

      function abrirModalPreparacion() {
        const modalModo = document.getElementById("modalModo");
        if (modalModo) modalModo.classList.add("hidden");

        const menuDinamico = document.querySelector(".modal-modo");
        if (menuDinamico) menuDinamico.remove();

        const m = document.getElementById("modalPreparacion");
        if (!m) return;

        m.classList.remove("hidden");
        m.classList.add("flex");

        const inpE = document.getElementById("inputEjecutivoPrep");
        const inpR = document.getElementById("inputRemisionPrep");

        const prevS = document.getElementById("slotKeyPreview");
        const prevR = document.getElementById("remisionPreview");

        const err = document.getElementById("prepError");
        const info = document.getElementById("prepInfo");

        err?.classList.add("hidden");
        info?.classList.add("hidden");
        if (prevS) prevS.textContent = "‚Äî";
        if (prevR) prevR.textContent = "‚Äî";

        // üî• Fuente √∫nica de remisi√≥n para Excel + validarPinYUnidad
        const inpRemGlobal = document.getElementById("inputRemision");

        const syncRemision = () => {
          const r = normalizarRemision(inpR?.value);
          if (inpRemGlobal) inpRemGlobal.value = r;
          if (prevR) prevR.textContent = r || "‚Äî";
        };

        const updatePrev = () => {
          if (prevS) prevS.textContent = normalizarSlotNombre(inpE?.value) || "‚Äî";
          syncRemision();
        };

        // evita listeners duplicados si abren/cerran varias veces
        inpE?.addEventListener("input", updatePrev, { once: false });
        inpR?.addEventListener("input", updatePrev, { once: false });

        updatePrev();
        setTimeout(() => inpE?.focus(), 50);
      }

      function cerrarModalPreparacion() {
        const m = document.getElementById("modalPreparacion");
        if (!m) return;
        m.classList.add("hidden");
        m.classList.remove("flex");
      }

      async function getUsuarioMetaActual() {
        if (usuarioMeta?.nip) return usuarioMeta;

        const sb = window.getSB?.();
        if (!sb) return null;

        const nip = String(window.usuarioNip ?? usuario ?? "").trim();
        if (!nip) return null;

        const { data, error } = await sb
          .from("usuarios")
          .select("nip,nombre,rol,es_admin,representacion")
          .eq("nip", nip)
          .maybeSingle();

        if (error) {
          console.warn("[PREP] Error leyendo usuario meta:", error.message);
          return null;
        }
        if (!data) return null;

        usuarioMeta = data;
        return usuarioMeta;
      }

      async function getEjecutivosMismaRepresentacion(rep) {
        if (!rep) return [];
        if (ejecutivosCache?.rep === rep && Array.isArray(ejecutivosCache?.rows)) return ejecutivosCache.rows;

        const sb = window.getSB?.();
        if (!sb) return [];

        const { data, error } = await sb
          .from("usuarios")
          .select("nip,nombre,rol,representacion")
          .eq("representacion", rep)
          .eq("rol", "ejecutivo");

        if (error) {
          console.warn("[PREP] Error leyendo ejecutivos por representaci√≥n:", error.message);
          return [];
        }

        const rows = data || [];
        ejecutivosCache = { rep, rows };
        return rows;
      }

      async function crearPedidoPreparacion() {
        const errEl = document.getElementById("prepError");
        const infoEl = document.getElementById("prepInfo");

        const setErr = (msg) => {
          if (errEl) {
            errEl.innerHTML = "‚ùå " + msg;
            errEl.classList.remove("hidden");
          }
          infoEl?.classList.add("hidden");
        };

        const setInfo = (html) => {
          if (infoEl) {
            infoEl.innerHTML = html;
            infoEl.classList.remove("hidden");
          }
          errEl?.classList.add("hidden");
        };

        const sb = window.getSB?.();
        if (!sb) return setErr("Supabase no disponible.");

        const meta = await getUsuarioMetaActual();
        if (!meta) return setErr("No pude identificar tu usuario. Revalida NIP.");

        const rol = String(meta.rol || "").toLowerCase();
        const isAdmin = !!meta.es_admin;
        const isAlmacenista = rol === "almacenista";

        if (!isAdmin && !isAlmacenista) {
          return setErr("Acceso denegado: s√≥lo almacenistas o administradores.");
        }

        const rep = meta["representacion"];
        if (!rep) return setErr("Tu usuario no tiene representacion asignada.");

        const ejecutivoDisplay = String(document.getElementById("inputEjecutivoPrep")?.value ?? "").trim();
        const slotKey = normalizarSlotNombre(ejecutivoDisplay);

        const remisionNorm = normalizarRemision(document.getElementById("inputRemisionPrep")?.value);

        if (slotKey.length < 4) return setErr("Nombre de ejecutivo muy corto.");
        if (remisionNorm.length < 4) return setErr("N√∫mero de remisi√≥n inv√°lido.");

        // ‚úÖ Resolver ejecutivo dentro de la misma representaci√≥n
        const ejecutivos = await getEjecutivosMismaRepresentacion(rep);
        const match = ejecutivos
          .map(u => ({ ...u, slot_key: normalizarSlotNombre(u.nombre) }))
          .find(u => u.slot_key === slotKey);

        if (!match) {
          const sug = ejecutivos
            .map(u => ({ ...u, slot_key: normalizarSlotNombre(u.nombre) }))
            .filter(u => u.slot_key.includes(slotKey) || slotKey.includes(u.slot_key))
            .slice(0, 5);

          if (sug.length) {
            const html = sug.map(s => `‚Ä¢ ${escapeHtml(s.nombre)} <span class="text-white/50">(${escapeHtml(s.slot_key)})</span>`).join("<br>");
            return setErr("No encontr√© un ejecutivo exacto en tu representaci√≥n. Sugerencias:<br>" + html);
          }
          return setErr("No encontr√© ese ejecutivo en tu representaci√≥n.");
        }

        // ‚úÖ Si ya existe pedido abierto para esa remisi√≥n, no permitas choque de ejecutivo
        const { data: existing, error: errSel } = await sb
          .from("pedidos_activos")
          .select("id,numero_remision,slot_key,estado,ejecutivo_nip")
          .eq("numero_remision", remisionNorm)
          .maybeSingle();

        if (errSel) console.warn("[PREP] Error buscando pedido existente:", errSel.message);

        if (existing && existing.estado && !["CERRADO", "CANCELADO"].includes(String(existing.estado).toUpperCase())) {
          if (String(existing.ejecutivo_nip || "") !== String(match.nip || "")) {
            return setErr(`La remisi√≥n ${escapeHtml(remisionNorm)} ya est√° abierta para otro ejecutivo.`);
          }

          // Reusar pedido
          window.prepPedidoActual = existing;

          // sincroniza con tu UI existente (remisi√≥n)
          remisionActiva = remisionNorm;
          remisionGlobal = remisionNorm;
          remisionActual = remisionNorm;
          const inputRem = document.getElementById("inputRemision");
          if (inputRem) inputRem.value = remisionNorm;

          return setInfo(
            `‚úÖ Pedido ya abierto.<br>
            <span class="text-white/70">Remisi√≥n:</span> <b>${escapeHtml(remisionNorm)}</b><br>
            <span class="text-white/70">Ejecutivo:</span> <b>${escapeHtml(match.nombre)}</b><br>
            <span class="text-white/70">Representaci√≥n:</span> <b>${escapeHtml(rep)}</b>`
          );
        }

        // ‚úÖ Crear / abrir pedido (upsert por numero_remision)
        const payload = {
          numero_remision: remisionNorm,
          slot_key: slotKey,
          slot_qr: slotKey,                   // (si luego usas QR f√≠sico por slot, lo cambias por el QR real)
          ejecutivo_nip: match.nip,
          ejecutivo_display: ejecutivoDisplay || match.nombre,
          estado: "NUEVO",
          created_by_nip: meta.nip,
          created_at: new Date().toISOString()
        };

        const { data: up, error: errUp } = await sb
          .from("pedidos_activos")
          .upsert(payload, { onConflict: "numero_remision" })
          .select("id,numero_remision,slot_key,estado,ejecutivo_nip")
          .maybeSingle();

        if (errUp) {
          console.error("[PREP] Error upsert pedido:", errUp.message);
          return setErr("No se pudo crear/abrir el pedido.");
        }

        window.prepPedidoActual = up;

        // sincroniza con tu UI existente (remisi√≥n)
        remisionActiva = remisionNorm;
        remisionGlobal = remisionNorm;
        remisionActual = remisionNorm;
        const inputRem = document.getElementById("inputRemision");
        if (inputRem) inputRem.value = remisionNorm;

        setInfo(
          `‚úÖ Pedido creado/abierto.<br>
          <span class="text-white/70">Remisi√≥n:</span> <b>${escapeHtml(remisionNorm)}</b><br>
          <span class="text-white/70">Ejecutivo:</span> <b>${escapeHtml(match.nombre)}</b><br>
          <span class="text-white/70">Representaci√≥n:</span> <b>${escapeHtml(rep)}</b>`
        );
      }

      //#endregion preparaci√≥n


      //#region Modulo Hipotesis
      function abrirModalHipotesis() {
        console.log("üß™ [HIPOTESIS] abrirModalHipotesis()");
        const m = document.getElementById("modalHipotesis");
        if (!m) return console.error("‚ùå [HIPOTESIS] No existe #modalHipotesis");

        m.classList.remove("hidden");

        const rect = m.getBoundingClientRect();
        console.log("‚úÖ [HIPOTESIS] Modal abierto rect:", rect);

        const textarea = document.getElementById("hipotesisPregunta");
        textarea?.focus();
      }

      function cerrarModalHipotesis() {
        console.log("‚ùå [HIPOTESIS] cerrarModalHipotesis()");
        const m = document.getElementById("modalHipotesis");
        if (!m) return console.error("‚ùå [HIPOTESIS] No existe #modalHipotesis");
        m.classList.add("hidden");
      }

      async function ejecutarPreguntaLibreIA() {
        const status = document.getElementById("hipotesisStatus");
        const out = document.getElementById("hipotesisSalida");
        const pregunta = document.getElementById("hipotesisPregunta")?.value?.trim();

        if (!pregunta) {
          status.textContent = "‚ö†Ô∏è Escribe una pregunta primero.";
          return;
        }

        const requestId = crypto.randomUUID();

        const contextObj = {
          lab_id: document.getElementById("hipotesisLab")?.value?.trim() || null,
          referencia: document.getElementById("hipotesisRef")?.value?.trim() || null,
          desde: document.getElementById("hipotesisDesde")?.value || null,
          hasta: document.getElementById("hipotesisHasta")?.value || null,
          demo: !!document.getElementById("hipotesisDemo")?.checked
        };

        const payload = {
          mode: "chat",
          question: pregunta,
          context: JSON.stringify(contextObj),
          ui_request_id: requestId
        };

        // ‚úÖ Estas son las √öNICAS que se detienen en finally
        let stopLoaderFlow = null;
        let stopTicker = null;

        try {
          mostrarLoader(true);
          loaderReset();

          const flow = [
            { text: "üß† Analizando hip√≥tesis", mode: "once" },
            { text: "üìå Validando contexto", mode: "once" },
            { text: contextObj.lab_id ? `üè• Unidad ${contextObj.lab_id}` : "üè• Unidad no especificada", mode: "once" },
            { text: contextObj.referencia ? `üßæ Ref ${contextObj.referencia}` : "üßæ Ref no especificada", mode: "once" },
            { text: "üîé Consultando Supabase", mode: "once" },
            { text: "üìä Armando evidencia", mode: "once" },
            { text: "üß© Preparando prompt auditable", mode: "once" },
            { text: "üöÄ Enviando a IA", mode: "once" },
            { text: "ü§ñ Esperando respuesta de la IA", mode: "dots" },
          ];

          // ‚úÖ OJO: NO uses "let" aqu√≠. Solo asigna.
          stopLoaderFlow = startLoaderStatusFlow(flow, 850);

          // ‚úÖ Si quieres, deja este ticker SOLO en el status del modal (no el loader)
          stopTicker = startThinkingTicker(status);

          out.classList.add("opacity-50");
          status.textContent = "üí¨ Consultando IA‚Ä¶";

          const ansRaw = await preguntarIA(payload);
          if (!ansRaw) {
            status.textContent = "‚ùå No hubo respuesta.";
            return;
          }

          const ansUser = sanitizeHipotesisOutputForUser(ansRaw);
          status.textContent = "‚úÖ Listo.";

          out.innerHTML = `
      <div class="rounded-2xl p-4 bg-black/25 border border-white/10">
        <div class="text-xs text-white/60 mb-2">üßë‚Äçüíª T√∫</div>
        <div class="text-sm text-white/90 whitespace-pre-wrap">${escapeHtml(pregunta)}</div>
      </div>

      <div class="rounded-2xl p-4 bg-white/5 border border-white/10">
        <div class="text-xs text-white/60 mb-2">ü§ñ IA</div>
        <div class="text-sm text-white/90 whitespace-pre-wrap">${escapeHtml(ansUser)}</div>
      </div>
    `;

        } catch (err) {
          console.error(err);
          status.textContent = "‚ùå Error al procesar la hip√≥tesis.";
        } finally {
          // ‚úÖ Det√©n loops SIEMPRE
          if (typeof stopTicker === "function") stopTicker();
          if (typeof stopLoaderFlow === "function") stopLoaderFlow();

          // ‚úÖ Cierra tu loader como siempre
          ocultarLoader();

          out.classList.remove("opacity-50");
          localStorage.removeItem("hyp_pending");
        }
      }


      function uiLog(requestId, stage, meta = {}, level = "info") {
        const entry = { ts: new Date().toISOString(), requestId, scope: "UI", stage, level, meta };
        console[level === "error" ? "error" : "log"]("[AUDIT]", entry);

        // Opcional: persistir logs UI en localStorage para debug r√°pido
        const key = "audit_ui_logs";
        const arr = JSON.parse(localStorage.getItem(key) || "[]");
        arr.push(entry);
        localStorage.setItem(key, JSON.stringify(arr.slice(-300))); // guarda √∫ltimos 300
      }

      async function preguntarIA(payload) {
        const requestId = payload?.ui_request_id || crypto.randomUUID();
        const t0 = performance.now();

        try {
          mostrarModal("üß† Procesando‚Ä¶", "#0ea5e9");

          uiLog(requestId, "HYP_API_HTTP_SEND", {
            url: "https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/new_hipotesis",
            payload_preview: {
              mode: payload.mode,
              question_len: (payload.question || "").length,
              context_len: (payload.context || "").length
            }
          });

          const r = await fetch(
            "https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/new_hipotesis",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "apikey": SUPABASE_ANON_KEY,
                "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
                "X-Client-Request-Id": requestId
              },
              body: JSON.stringify(payload),
            }
          );

          const data = await r.json().catch(() => ({}));

          uiLog(requestId, "HYP_API_HTTP_RECV", {
            status: r.status,
            ok: r.ok,
            ms: Math.round(performance.now() - t0),
            keys: Object.keys(data || {})
          });

          if (!r.ok || data?.error) {
            uiLog(requestId, "HYP_API_ERROR", {
              status: r.status,
              error: data?.error || "Error al consultar IA",
              raw: data
            }, "error");

            mostrarModal(`‚ùå ${data?.error || "Error al consultar IA"}`, "#B00042");
            return null;
          }

          // ‚úÖ modo chat: esperamos data.answer (texto)
          const answer = data?.answer ?? null;

          uiLog(requestId, "HYP_API_OK", {
            ms: Math.round(performance.now() - t0),
            answer_len: (answer || "").length
          });

          return answer;
        } catch (e) {
          uiLog(requestId, "HYP_API_EXCEPTION", { message: e?.message }, "error");
          mostrarModal("‚ùå Error de red / servidor", "#B00042");
          return null;
        }
      }

      async function ejecutarHipotesisIA() {
        const status = document.getElementById("hipotesisStatus");
        const out = document.getElementById("hipotesisSalida");
        const pregunta = document.getElementById("hipotesisPregunta").value.trim();

        if (!pregunta) {
          status.textContent = "‚ö†Ô∏è Escribe una hip√≥tesis primero.";
          return;
        }

        const requestId = crypto.randomUUID();

        const payload = {
          mode: "reporte",
          question: pregunta,
          context: JSON.stringify({
            lab_id: document.getElementById("hipotesisLab").value.trim() || null,
            referencia: document.getElementById("hipotesisRef").value.trim() || null,
            desde: document.getElementById("hipotesisDesde").value || null,
            hasta: document.getElementById("hipotesisHasta").value || null,
            demo: document.getElementById("hipotesisDemo").checked
          }),
          ui_request_id: requestId
        };

        try {
          mostrarLoader();
          status.textContent = "üß™ Generando reporte cient√≠fico‚Ä¶";
          out.innerHTML = "";

          const res = await fetch(
            "https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/new_hipotesis",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "apikey": SUPABASE_ANON_KEY,
                "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
                "X-Client-Request-Id": requestId
              },
              body: JSON.stringify(payload)
            }
          );

          const data = await res.json();

          if (!res.ok || data?.error) {
            throw new Error(data?.error || "Error generando reporte");
          }

          status.textContent = "‚úÖ Reporte generado.";
          out.innerHTML = renderHipotesisReporte(data.reporte);

        } catch (err) {
          console.error(err);
          status.textContent = "‚ùå " + (err.message || "Error");
        } finally {
          ocultarLoader();
        }
      }

      function renderHipotesisReporte(r) {
        // r = { plan, evidencia, resultados, conclusion, warnings }
        const esc = (s) => String(s ?? "").replaceAll("<", "&lt;").replaceAll(">", "&gt;");
        const pill = (t) => `<span class="px-2 py-1 rounded-full bg-teal-500/15 border border-teal-400/30 text-teal-100 text-xs">${esc(t)}</span>`;

        return `
    <div class="rounded-2xl p-4 bg-black/25 border border-white/10">
      <div class="flex flex-wrap gap-2 items-center">
        ${pill(r?.plan?.metodo || "m√©todo")}
        ${pill("Œ±=" + (r?.plan?.alpha ?? 0.05))}
        ${r?.plan?.metric ? pill("m√©trica: " + r.plan.metric) : ""}
      </div>

      <h3 class="text-lg font-bold mt-3">Hip√≥tesis</h3>
      <p class="text-sm text-white/80 mt-1"><b>H0:</b> ${esc(r?.plan?.H0)}</p>
      <p class="text-sm text-white/80 mt-1"><b>H1:</b> ${esc(r?.plan?.H1)}</p>

      <h3 class="text-lg font-bold mt-4">Evidencia (resumen)</h3>
      <pre class="text-xs bg-black/40 border border-white/10 rounded-2xl p-3 overflow-auto">${esc(JSON.stringify(r?.evidencia, null, 2))}</pre>

      <h3 class="text-lg font-bold mt-4">Resultados</h3>
      <pre class="text-xs bg-black/40 border border-white/10 rounded-2xl p-3 overflow-auto">${esc(JSON.stringify(r?.resultados, null, 2))}</pre>

      <h3 class="text-lg font-bold mt-4">Conclusi√≥n</h3>
      <p class="text-sm text-white/85 mt-1">${esc(r?.conclusion)}</p>

      ${r?.warnings?.length ? `
        <h3 class="text-lg font-bold mt-4 text-amber-200">Warnings</h3>
        <ul class="list-disc pl-5 text-sm text-amber-100/90">
          ${r.warnings.map(w => `<li>${esc(w)}</li>`).join("")}
        </ul>` : ""
          }
    </div>
  `;
      }
      window.abrirModalHipotesis = abrirModalHipotesis;
      window.cerrarModalHipotesis = cerrarModalHipotesis;
      window.ejecutarPreguntaLibreIA = ejecutarPreguntaLibreIA;
      window.ejecutarHipotesisIA = ejecutarHipotesisIA;
      window.addEventListener("beforeunload", (e) => {
        const pending = localStorage.getItem("hyp_pending");
        if (!pending) return;
        e.preventDefault();
        e.returnValue = "";
      });
      //#endregion Modulo Hipotesis
      // Permitir arrastrar la ventana del lector QR
      function hacerDraggable(idElemento) {
        const el = document.getElementById(idElemento);
        let offsetX = 0, offsetY = 0, mouseX = 0, mouseY = 0;

        const handle = document.getElementById("handleQR") || el;

        handle.onmousedown = function (e) {
          e.preventDefault();
          mouseX = e.clientX;
          mouseY = e.clientY;
          document.onmouseup = detenerArrastre;
          document.onmousemove = moverElemento;
        };

        function moverElemento(e) {
          e.preventDefault();
          offsetX = mouseX - e.clientX;
          offsetY = mouseY - e.clientY;
          mouseX = e.clientX;
          mouseY = e.clientY;

          const rect = el.getBoundingClientRect();
          el.style.top = (rect.top - offsetY) + "px";
          el.style.left = (rect.left - offsetX) + "px";
          el.style.bottom = "auto";
          el.style.right = "auto";
          el.style.position = "fixed";
        }

        function detenerArrastre() {
          document.onmouseup = null;
          document.onmousemove = null;
        }
      }

      // Activar cuando se abra el lector
      function abrirModalQR(modo = "movimientos") {
        // Define si el esc√°ner trabajar√° para movimientos o inventario
        modoScannerQR = modo;

        const modal = document.getElementById("modalQR");
        const visor = document.getElementById("qr-reader");

        if (!modal || !visor) return;

        modal.classList.remove("hidden");
        hacerDraggable("modalQR");  // üëà activa drag al abrir
        iniciarScannerQR();
      }

      function cerrarModalQR() {
        console.log("üõë cerrarModalQR() llamado");
        const modal = document.getElementById("modalQR");

        if (!modal) {
          console.error("‚ùå No se encontr√≥ el elemento #modalQR para cerrar");
          return;
        }

        modal.classList.add("hidden");
        detenerScannerQR();
        console.log("‚úÖ Modal QR oculto");
      }

      function iniciarScannerQR() {
        console.log("üîÑ iniciarScannerQR() llamado");

        if (scannerActivo) {
          console.warn("‚ö†Ô∏è Esc√°ner ya activo, evitando duplicaci√≥n");
          return;
        }

        const visor = document.getElementById("qr-reader");
        if (!visor) {
          console.error("‚ùå No se encontr√≥ el visor QR con id #qr-reader");
          return;
        }

        try {
          console.log("üöÄ Iniciando Html5Qrcode...");
          scannerActivo = true;
          qrScanner = new Html5Qrcode("qr-reader");

          let ultimaLectura = "";
          let tiempoUltimaLectura = 0;

          qrScanner.start(
            { facingMode: "environment" },
            {
              fps: 10,
              // Force square relative to the smaller dimension of the camera feed
              qrbox: (viewfinderWidth, viewfinderHeight) => {
                const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
                const size = Math.floor(minEdge * 0.7); // 70% of the smaller edge
                return { width: size, height: size };
              },
              aspectRatio: 1.0
            },
            qrCodeMessage => {
              const ahora = Date.now();
              if (qrCodeMessage === ultimaLectura && ahora - tiempoUltimaLectura < 2000) {
                // Ignora duplicados muy recientes
                return;
              }

              ultimaLectura = qrCodeMessage;
              tiempoUltimaLectura = ahora;

              console.log("‚úÖ QR detectado (bruto):", qrCodeMessage, " | modo:", modoScannerQR);

              if (modoScannerQR === "inventario") {
                manejarEscaneoInventario(qrCodeMessage);
              } else {
                const inputQR = document.getElementById("inputQR");
                if (inputQR) inputQR.value = qrCodeMessage;
                procesarQR(qrCodeMessage);
              }
            },
            errorMsg => {
              console.log("üîç Esperando QR v√°lido...", errorMsg);
            }
          ).catch(err => {
            console.error("‚ùå Error al iniciar esc√°ner:", err);
            mostrarModal("Error al acceder a la c√°mara", "#b00042");
            scannerActivo = false;
            cerrarModalQR();
          });

        } catch (e) {
          console.error("‚ùå Excepci√≥n en iniciarScannerQR():", e);
          scannerActivo = false;
          cerrarModalQR();
        }
      }

      function abrirModalQRInventario() {
        const modo = document.getElementById("modoCaptura")?.value;
        if (modo !== "inventario") {
          mostrarModal("‚ö†Ô∏è El lector QR de inventario solo funciona cuando el modo est√° en INVENTARIO.", "#d99b00");
          return;
        }
        abrirModalQR("inventario");
      }

      function detenerScannerQR() {
        console.log("üîß detenerScannerQR() llamado");

        if (!qrScanner) {
          console.warn("‚ö†Ô∏è qrScanner no definido a√∫n");
          return;
        }

        qrScanner.stop().then(() => {
          console.log("üõë Esc√°ner detenido correctamente");
          scannerActivo = false;
          qrScanner.clear();
        }).catch(err => {
          console.error("‚ùå Error al detener esc√°ner:", err);
          scannerActivo = false;
        });
      }


      //88888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888

      function inicializarSelectorMesAnio() {
        const anioSelect = document.getElementById('inputMesAnio');
        if (anioSelect) {
          const thisYear = new Date().getFullYear();
          anioSelect.innerHTML = '';
          for (let y = thisYear - 2; y <= thisYear + 8; y++) {
            anioSelect.innerHTML += `<option value="${y}">${y}</option>`;
          }
        }
      }
      const INTERVALO_MINUTOS = 10; // Puedes cambiar a 5, 15, etc.
      const listaAdmins = ["Silvia", "Luis", "Aida", "Ricardo", "Alex", "Adrian"];

      function enfocarInputQR() {
        const contenedor = document.getElementById("contenedorQR");
        const input = document.getElementById("inputQR");

        if (contenedor) contenedor.classList.remove("hidden");

        if (input) {
          input.classList.remove("hidden");

          // üîÅ Espera breve para asegurar render antes de enfocar
          setTimeout(() => {
            input.value = "";
            input.focus();
            input.select();
            console.log("üéØ Enfocado inputQR (con delay)");
          }, 100); // Ajustable si es necesario
        } else {
          console.warn("‚ö†Ô∏è No se encontr√≥ el inputQR");
        }
      }


      function desbloquearEscaneoCritico() {
        window.escaneoBloqueado = false;
        if (typeof reanudarEscaneo === "function") reanudarEscaneo();
        const inputQR = document.getElementById("inputQR");
        if (inputQR) inputQR.disabled = false;
      }

      let audioBloqueo;
      document.addEventListener("DOMContentLoaded", function () {
        audioBloqueo = new Audio(SONIDO_BLOQUEADO);
      });
      function bloquearEscaneoCritico(opciones = {}) {
        window.escaneoBloqueado = true;
        if (typeof detenerEscaneo === "function") detenerEscaneo();
        const inputQR = document.getElementById("inputQR");
        if (inputQR) {
          // inputQR.disabled = true; // üëà NO lo hagas
          inputQR.value = "";        // Limpia el input, pero no lo bloquees
          inputQR.blur();            // Puedes dejar el blur si quieres evitar focus
        }
        const sonido = opciones.sonido || SONIDO_BLOQUEADO;
        if (sonido) {
          try { new Audio(sonido).play(); } catch (e) { }
        }
        if (opciones.vibrar && window.navigator.vibrate) {
          window.navigator.vibrate([200, 100, 200]);
        }
      }



      async function validarPinYUnidad() {
        const TAG = "[PIN]";

        const elNip = document.getElementById("inputNIP");
        const elUnidad = document.getElementById("inputUnidad");
        const elRemision = document.getElementById("inputRemision");
        const elPinError = document.getElementById("pinError");
        const modalPin = document.getElementById("modalPinUnidad");

        const nip = (elNip?.value || "").trim();
        nipAdmin = nip;

        const unidad = (elUnidad?.value || "").trim().toUpperCase();

        const esSalida = (modoSeleccionado === "salida");
        const esPreparacion = (modoSeleccionado === "preparacion");
        const esRemisionMode = (esSalida || esPreparacion);

        const remisionRaw = (elRemision?.value || "").trim().toLowerCase();
        const unidadRaw = (elUnidad?.value || "").trim().toLowerCase();
        const esBasurero = (modoSeleccionado === "salida" && unidadRaw === "eliminar" && remisionRaw === "etiqueta");

        console.log(`${TAG} iniciar`, { modoSeleccionado, esSalida, esPreparacion, nipLen: nip.length, unidad, remisionRaw });

        // Limpia error visible
        if (elPinError) {
          elPinError.classList.add("hidden");
          elPinError.textContent = "";
        }

        // ========== MODO BASURERO ==========
        if (esBasurero) {
          console.log(`${TAG} modo basurero ACTIVADO`);

          usuario = "Basurero";
          unidadSeleccionada = "Eliminar";
          modo = "salida";
          remisionActual = "Etiqueta";

          if (modalPin) {
            modalPin.classList.add("hidden");
            modalPin.classList.remove("flex");
          }

          const usuarioActivoEl = document.getElementById("usuarioActivo");
          if (usuarioActivoEl) {
            usuarioActivoEl.innerHTML = `
              üï≥Ô∏è <strong>MODO ELIMINACI√ìN ACTIVADO</strong><br>
              <strong>Eliminar</strong><br>
              <strong>Etiqueta</strong>
            `;
          }

          actualizarBotonModo("Salida", "bg-black", "üï≥Ô∏è");
          document.body.classList.add("modo-basurero");

          const contenedorQR = document.getElementById("contenedorQR");
          const btnEnviar = document.getElementById("btnEnviarSupabase");
          const inputQR = document.getElementById("inputQR");

          contenedorQR?.classList.remove("hidden");
          btnEnviar?.classList.remove("hidden");

          if (inputQR) {
            inputQR.classList.remove("hidden");
            inputQR.value = "";
            inputQR.focus();
          }

          document.getElementById("btnCerrarSesion")?.classList.remove("hidden");
          return;
        }

        // ========== VALIDACIONES PREVIAS (SALIDA / PREPARACI√ìN) ==========
        let remision = null;

        if (esRemisionMode) {
          remision = (elRemision?.value || "").trim();
          console.log(`${TAG} remisionMode -> remision`, { modoSeleccionado, remision });

          // ‚úÖ Bloqueo puede aplicar tambi√©n en PREPARACI√ìN si est√° activo
          const bloqueoActivo = await consultarEstadoBloqueo();
          console.log(`${TAG} bloqueoActivo`, { bloqueoActivo, modoSeleccionado });

          if (bloqueoActivo && !remision) {
            if (elPinError) {
              elPinError.textContent = "‚ùå Debes cargar la remisi√≥n para continuar.";
              elPinError.classList.remove("hidden");
            }
            return;
          }
        }

        remisionActual = remision;

        // ========== SI HAY REMISI√ìN, INTENTA CARGAR PENDIENTE (SALIDA / PREPARACI√ìN) ==========
        if (esRemisionMode && remision) {
          try {
            console.log(`${TAG} buscando remisi√≥n pendiente`, remision);

            const resPendiente = await fetch(
              `https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/remisiones_pendientes?select=*`,
              {
                headers: {
                  apikey: API_KEY,
                  Authorization: `Bearer ${API_KEY}`
                }
              }
            );

            const todasRemisiones = await resPendiente.json();
            console.log(`${TAG} remisiones encontradas`, (todasRemisiones || []).map(r => r.numero_remision));

            const remisionNormalizada = remision.trim();
            const datosPendientes = (todasRemisiones || []).filter(r =>
              (r.numero_remision || "").replaceAll('"', "").trim() === remisionNormalizada
            );

            console.log(`${TAG} remision buscada`, remisionNormalizada);
            console.log(`${TAG} pendientes match`, datosPendientes);

            if (datosPendientes.length > 0) {
              avanceRemision = {};

              const campoAvance = (modoSeleccionado === "preparacion") ? "cantidad_preparada" : "cantidad_escaneada";

              for (const item of datosPendientes) {
                const clave = `${item.referencia}||${item.lote}`;
                const esc = Number(item?.[campoAvance] ?? 0);

                avanceRemision[clave] = {
                  ...item,
                  escaneados: Number.isFinite(esc) ? esc : 0,
                  nombre: item.descripcion || ""
                };
              }

              console.log(`${TAG} avanceRemision cargado`, avanceRemision);
              actualizarTablaRemisionSAP();
              mostrarModal("üì§ Remisi√≥n cargada autom√°ticamente", "#0ea5e9");
            }
          } catch (err) {
            console.error(`${TAG} error al cargar remisi√≥n previa`, err);
          }
        }

        // ========== VALIDAR NIP (SUPABASE FUNCTION) ==========
        try {
          console.log(`${TAG} validando nip...`);

          const res = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/validar_nip", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ nip })
          });

          const data = await res.json();
          console.log(`${TAG} respuesta validar_nip`, data);

          const unidadesLista = typeof data?.unidades === "string"
            ? data.unidades.split(",").map(u => u.trim().toUpperCase())
            : Array.isArray(data?.unidades)
              ? data.unidades.map(u => String(u).trim().toUpperCase())
              : [];

          // ‚úÖ En SALIDA s√≠ validas unidad; en PREPARACI√ìN no dependes de unidad (tu regla real es representacion)
          const unidadValidaParaSalida = !esSalida || unidadesLista.includes(unidad);

          if (!data || !data.nombre || !unidadValidaParaSalida) {
            if (elPinError) {
              elPinError.textContent = "‚ùå Verifica NIP o unidad.";
              elPinError.classList.remove("hidden");
            }
            console.warn(`${TAG} acceso denegado`, { tieneNombre: !!data?.nombre, unidadValidaParaSalida, unidad, unidadesLista });
            return;
          }

          // Set globals
          usuario = data.nombre;
          window.usuario = usuario;

          esAdmin = data.es_admin;
          usuarioAdmin = (esAdmin === true);
          window.usuarioEsAdmin = usuarioAdmin;

          if (usuarioAdmin) {
            window.nombreAdmin = usuario;
            console.log(`${TAG} admin detectado`, window.nombreAdmin);
          } else {
            window.nombreAdmin = null;
          }

          unidadSeleccionada = esSalida ? unidad : null; // preparaci√≥n no depende de unidad
          modo = modoSeleccionado;

          if (modalPin) {
            modalPin.classList.add("hidden");
            modalPin.classList.remove("flex");
          }

          // UI estado usuario
          const usuarioActivoEl = document.getElementById("usuarioActivo");
          const nombreUnidad = (typeof unidadesDestino === "object" && unidadesDestino?.[unidad]) ? unidadesDestino[unidad] : "Unidad desconocida";

          if (usuarioActivoEl) {
            if (modoSeleccionado === "entrada") {
              usuarioActivoEl.textContent = usuario;

            } else if (modoSeleccionado === "salida") {
              usuarioActivoEl.innerHTML = `
                ${usuario} ‚Üí ${unidad} ${nombreUnidad}<br>
                No. de Remisi√≥n: <strong>${remisionActual || "‚Äî"}</strong>
              `;

            } else if (modoSeleccionado === "preparacion") {
              usuarioActivoEl.innerHTML = `
                ${usuario} ‚Üí <strong>PREPARACI√ìN</strong><br>
                No. de Remisi√≥n: <strong>${remisionActual || "‚Äî"}</strong>
              `;

            } else {
              usuarioActivoEl.textContent = "Selecciona un modo para iniciar";
            }
          }

          // Bot√≥n inventario
          const btnInventario = document.querySelector('button[onclick="confirmarModoInventario()"]');
          if (modo === "entrada") btnInventario?.classList.remove("hidden");
          else btnInventario?.classList.add("hidden");

          // Bot√≥n modo (color/icono prep)
          const texto = modo;
          const color = (modo === "entrada") ? "bg-green-700"
            : (modo === "salida") ? "bg-red-900"
              : (modo === "preparacion") ? "bg-sky-900"
                : "bg-gray-500";

          const icono = (modo === "entrada") ? "üì•"
            : (modo === "salida") ? "üì§"
              : (modo === "preparacion") ? "üß©"
                : "üîí";

          actualizarBotonModo(texto.charAt(0).toUpperCase() + texto.slice(1), color, icono);

          console.log(`${TAG} modo activado`, { usuario, modo, unidadSeleccionada, remisionActual });
          notificar(`Modo ${modo.toUpperCase()} activado`, "#003f40");

        } catch (e) {
          console.error(`${TAG} error conexi√≥n validar_nip`, e);
          if (elPinError) {
            elPinError.textContent = "‚ùå Error de conexi√≥n.";
            elPinError.classList.remove("hidden");
          }
          return;
        } finally {
          const contenedorQR = document.getElementById("contenedorQR");
          const btnEnviar = document.getElementById("btnEnviarSupabase");
          const btnCerrar = document.getElementById("btnCerrarSesion");

          const activo = !!modo && modo !== "inactivo";
          console.log(`${TAG} finally UI`, { activo, modo });

          if (!activo) {
            contenedorQR?.classList.add("hidden");
            btnEnviar?.classList.add("hidden");
            btnCerrar?.classList.add("hidden");
          } else {
            contenedorQR?.classList.remove("hidden");
            btnEnviar?.classList.remove("hidden");
            btnCerrar?.classList.remove("hidden");
            if (typeof enfocarInputQR === "function") enfocarInputQR();
          }
        }
      }


      function abrirModalPinDinamico() {
        document.getElementById("modalPinDinamico").classList.remove("hidden");
        actualizarPinYContador(); // Primera carga
        intervaloCuentaRegresiva = setInterval(actualizarPinYContador, 1000); // Actualiza cada segundo
      }

      function cerrarModalPinDinamico() {
        document.getElementById("modalPinDinamico").classList.add("hidden");
        clearInterval(intervaloCuentaRegresiva);
      }

      async function sha256(text) {
        const encoder = new TextEncoder();
        const data = encoder.encode(text);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      }

      async function generarPinDinamico(usuarioAdmin) {
        if (!nombreAdmin || typeof nombreAdmin !== "string") {
          console.error("‚ùå No se proporcion√≥ un nombreAdmin v√°lido a generarPinDinamico");
          return "------";
        }

        const clave = "medinova-secreto-2025";
        const ahora = new Date();
        const yyyy = ahora.getUTCFullYear();
        const mm = String(ahora.getUTCMonth() + 1).padStart(2, "0");
        const dd = String(ahora.getUTCDate()).padStart(2, "0");
        const hora = String(ahora.getUTCHours()).padStart(2, "0");
        const bloque = Math.floor(ahora.getUTCMinutes() / 10);

        const base = `${nombreAdmin.toLowerCase()}::${yyyy}-${mm}-${dd}-${hora}-${bloque}::${clave}`;
        const hash = await sha256(base);
        return hash.substring(0, 6).toUpperCase();
      }


      async function actualizarPinYContador() {
        if (!window.nombreAdmin) {
          console.warn("‚ö†Ô∏è No hay admin logueado, no se puede generar PIN");
          return;
        }

        const pin = await generarPinDinamico(window.nombreAdmin);
        const elValor = document.getElementById("valorPinDinamicoSolo");
        if (elValor) elValor.textContent = pin;

        const ahora = new Date();
        const minutos = ahora.getUTCMinutes();
        const segundos = ahora.getUTCSeconds();
        const minutosRestantes = INTERVALO_MINUTOS - (minutos % INTERVALO_MINUTOS) - 1;
        const segundosRestantes = 59 - segundos;

        const mm = minutosRestantes.toString().padStart(2, "0");
        const ss = segundosRestantes.toString().padStart(2, "0");

        const elContador = document.getElementById("contadorPin");
        if (elContador) elContador.textContent = `${mm}:${ss}`;
      }

      async function mostrarOpcionesAdmin() {
        document.getElementById("modalOpcionesAdmin").classList.remove("hidden");

        if (usuarioAdmin) {
          document.getElementById("btnModificarUnidades")?.classList.remove("hidden");
          document.getElementById("btnRestablecerNIP")?.classList.remove("hidden");
          document.getElementById("btnBloqueoRemision")?.classList.remove("hidden");
          document.getElementById("btnVerPinDinamico")?.classList.remove("hidden");

          await mostrarPinDinamicoAdmin(); // Recomendado con await
        }
      }

      function cerrarModalOpcionesAdmin() {
        document.getElementById("modalOpcionesAdmin")?.classList.add("hidden");
      }

      function eliminarFila(boton) {
        const fila = boton.closest("tr");
        const index = parseInt(fila.dataset.index);

        if (!isNaN(index)) {
          console.log(`üóëÔ∏è Eliminando fila ${index} de qrsPendientes`);
          qrsPendientes.splice(index, 1); // Eliminar del arreglo
          actualizarTablaRegistros();     // Volver a renderizar tabla
        } else {
          console.warn("‚ö†Ô∏è No se pudo determinar el √≠ndice de la fila a eliminar.");
        }
      }


      function extraerDatosQR(qr) {
        if (window.escaneoBloqueado) {
          try {
            if (audioBloqueo) { audioBloqueo.currentTime = 0; audioBloqueo.play(); }
            else { new Audio(SONIDO_BLOQUEADO).play(); }
          } catch (e) { }
          mostrarModal(
            "üö´ El sistema est√° temporalmente bloqueado.<br>Completa o cierra la operaci√≥n cr√≠tica antes de escanear.",
            "#B00042"
          );
          // Limpia el input, pero no lo deshabilites
          const input = document.getElementById("inputQR");
          if (input) input.value = "";
          return;
        }

        const limpio = qr.trim().replace(/\s+/g, '');
        let partes = null;

        // üìå Formato solicitado: **{ref}//{lote}--{caducidad}|T:{timestamp}
        const nuevoFormato = /^\*\*\{(.+?)\}\/\/\{(.+?)\}--\{(.+?)\}\|T:(.+)$/;
        const matchNuevo = limpio.match(nuevoFormato);
        if (matchNuevo) {
          return {
            referencia: matchNuevo[1]?.trim() || null,
            lote: matchNuevo[2]?.trim() || null,
            caducidad: matchNuevo[3]?.trim() || null,
            timestamp: matchNuevo[4]?.trim() || null
          };
        }

        // üìå NUEVO formato Israel (mejorado) ‚Äî acepta asteriscos especiales y guion largo
        const nuevoFormatoV2 = /^[\*\u2217\u2731]{2}\{(.+?)\}\/\/\{(.+?)\}(?:--|‚Äî)\{(.+?)\}\|T:(.+)$/;
        const matchNuevoV2 = limpio.match(nuevoFormatoV2);
        if (matchNuevoV2) {
          return {
            referencia: matchNuevoV2[1]?.trim() || null,
            lote: matchNuevoV2[2]?.trim() || null,
            caducidad: matchNuevoV2[3]?.trim() || null,
            timestamp: matchNuevoV2[4]?.trim() || null
          };
        }

        // üìå Formato tipo R:xxx|L:xxx|C:xxx|T:xxx
        if (limpio.includes('|') && limpio.includes(':')) {
          partes = Object.fromEntries(
            limpio.split('|').map(p => p.split(':')).filter(p => p.length === 2)
          );
        }

        // üìå Formato m√≥vil tipo R>xxx`L>xxx`C>xxx`T>xxx
        else if (limpio.includes('`') && limpio.includes('>')) {
          partes = Object.fromEntries(
            limpio.split('`').map(p => p.split('>')).filter(p => p.length === 2)
          );
        }

        // üìå Formato m√≥vil tipo R√ëxxx√áL√ëxxx√áC√ëxxx√áT√ëxxx
        //  else if (limpio.includes('√á') && limpio.includes('√ë')) {
        //   partes = Object.fromEntries(
        //    limpio.split('√á').map(p => p.split('√ë')).filter(p => p.length === 2)
        //);
        //}

        // üìå Formato m√≥vil tipo R√ëxxx]L√ëxxx]C√ëxxx]T√ëxxx
        else if (limpio.includes(']') && limpio.includes('√ë')) {
          partes = Object.fromEntries(
            limpio.split(']').map(p => p.split('√ë')).filter(p => p.length === 2)
          );
        }

        if (!partes) return null;

        return {
          referencia: partes["R"]?.trim() || null,
          lote: partes["L"]?.trim() || null,
          caducidad: partes["C"]?.trim() || null,
          timestamp: partes["T"]?.trim() || null
        };
      }


      function verificarCaducidadYMostrarModal(caducidadStr) {
        console.log("üß™ Verificando caducidad:", caducidadStr);

        if (!caducidadStr || caducidadStr.toLowerCase() === "s/c") {
          console.warn("‚è© Caducidad vac√≠a o sin control (S/C)");
          return;
        }

        const hoy = new Date();
        const fecha = new Date(caducidadStr);

        if (isNaN(fecha)) {
          console.error("‚ùå Fecha inv√°lida:", caducidadStr);
          return;
        }

        const diff = Math.ceil((fecha - hoy) / (1000 * 60 * 60 * 24));
        console.log(`üìÜ D√≠as hasta caducidad: ${diff}`);

        if (diff < 5) {
          console.warn("‚ö†Ô∏è Producto caduco o pr√≥ximo a caducar");

          if (modo === "entrada") {
            // ‚ö° Aviso r√°pido, sin bloqueo
            setTimeout(() => {
              mostrarModal("üíÄ Producto caduco o pr√≥ximo a caducar", "#304000");
            }, 600);

          } else if (modo === "salida") {
            // üö® Modal interactivo con bot√≥n ‚ÄúEntendido‚Äù
            const overlay = document.createElement("div");
            overlay.style.position = "fixed";
            overlay.style.top = "0";
            overlay.style.left = "0";
            overlay.style.width = "100vw";
            overlay.style.height = "100vh";
            overlay.style.background = "rgba(48, 64, 0, 0.4)";
            overlay.style.backdropFilter = "blur(10px)";
            overlay.style.webkitBackdropFilter = "blur(10px)";
            overlay.style.zIndex = "998";

            const modal = document.createElement("div");
            modal.style.position = "fixed";
            modal.style.top = "50%";
            modal.style.left = "50%";
            modal.style.transform = "translate(-50%, -50%)";
            modal.style.background = "rgba(255, 255, 255, 0.25)";
            modal.style.border = "2px solid rgba(255, 255, 255, 0.6)";
            modal.style.boxShadow = "0 4px 30px rgba(0, 0, 0, 0.2)";
            modal.style.borderRadius = "16px";
            modal.style.padding = "24px 32px";
            modal.style.textAlign = "center";
            modal.style.color = "#000";
            modal.style.fontWeight = "bold";
            modal.style.fontSize = "20px";
            modal.style.zIndex = "999";

            modal.innerHTML = `
        <div style="font-size: 3rem; margin-bottom: 1rem;">üíÄ</div>
        <div>Producto caduco o pr√≥ximo a caducar</div>
        <div style="margin-top: 1rem;">
          <button id="btnEntendidoCaducidad"
            style="margin-top: 1.5rem; padding: 0.5rem 1.5rem; font-size: 1rem; border: none; background-color: #333; color: white; border-radius: 12px; cursor: pointer;">
            Entendido
          </button>
        </div>
      `;

            document.body.appendChild(overlay);
            document.body.appendChild(modal);

            // üéØ Cerrar modal al hacer clic en "Entendido"
            document.getElementById("btnEntendidoCaducidad").addEventListener("click", () => {
              modal.remove();
              overlay.remove();
            });
          }
        }
      }



      // Mostrar mensajes temporales
      let timeoutAviso = null;
      function mostrarModal(mensaje, color) {
        const modal = document.getElementById("modalAviso");
        const overlay = document.getElementById("overlayColor");

        if (timeoutAviso) clearTimeout(timeoutAviso);

        // üéØ Estilo del modal (efecto vidrio con borde brillante)
        modal.textContent = mensaje;
        modal.style.background = "rgba(255, 255, 255, 0.25)";   // m√°s transparente para que el glass sea real
        modal.style.color = "#000";                             // texto oscuro
        modal.style.backdropFilter = "blur(10px)";
        modal.style.webkitBackdropFilter = "blur(10px)";
        modal.style.border = "2px solid rgba(255, 255, 255, 0.6)";  // üî• Borde brillante estilo glass
        modal.style.boxShadow = "0 4px 30px rgba(0, 0, 0, 0.2)";    // sombra suave para flotar
        modal.style.borderRadius = "16px";
        modal.style.padding = "24px 32px";
        modal.style.zIndex = "999";
        modal.style.display = "block";
        modal.style.textAlign = "center";
        modal.style.fontWeight = "bold";
        modal.style.fontSize = "20px";

        if (overlay) {
          // ‚úÖ Convertimos el color s√≥lido en transl√∫cido
          let colorRGBA = color;
          if (!color.includes("rgba") && color.startsWith("#")) {
            const hex = color.replace("#", "");
            const r = parseInt(hex.substring(0, 2), 16);
            const g = parseInt(hex.substring(2, 4), 16);
            const b = parseInt(hex.substring(4, 6), 16);
            colorRGBA = `rgba(${r}, ${g}, ${b}, 0.5)`; // üî• un poco menos opaco para ver el blur
          } else if (!color.includes("rgba") && color.startsWith("rgb")) {
            colorRGBA = color.replace("rgb", "rgba").replace(")", ", 0.5)");
          }

          // üé® Fondo con color + transparencia
          overlay.style.backgroundColor = colorRGBA;
          overlay.style.display = "block";
          overlay.style.zIndex = "998";

          // ü™ü Blur real del fondo
          overlay.style.backdropFilter = "blur(10px)";
          overlay.style.webkitBackdropFilter = "blur(10px)";

          // üîß Aseguramos que cubra toda la pantalla
          overlay.style.position = "fixed";
          overlay.style.top = "0";
          overlay.style.left = "0";
          overlay.style.width = "100vw";
          overlay.style.height = "100vh";
        }

        timeoutAviso = setTimeout(() => {
          modal.style.display = "none";
          if (overlay) {
            overlay.style.display = "none";
            overlay.style.backdropFilter = "";
            overlay.style.webkitBackdropFilter = "";
          }
          timeoutAviso = null;
        }, 1500);
      }



      async function mostrarPrevisualizacionDesdeQR(contenido) {
        const ref = extraerReferenciaDesdeQR(contenido);
        if (!ref) return;

        try {
          const res = await fetch(`https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/buscar_referencia?ref=${encodeURIComponent(ref)}`);
          const data = await res.json();

          if (!data || !data.nombre) return;

          const lote = (() => {
            const partes = contenido.trim().split("|");
            for (let parte of partes) {
              if (parte.startsWith("L:")) return parte.slice(2).trim();
            }
            return "";
          })();

          const producto = {
            nombre: data.nombre,
            fabricante: data.fabricante,
            lote: lote,
            referencia: ref
          };

          mostrarVentanaPrevisualizacion(producto); // <-- esta l√≠nea faltaba
        } catch (err) {
          console.warn("No se pudo mostrar previsualizaci√≥n:", err);
        }
      }



      //======================================================================================


      function intentoMuestreoDeCalidad(producto) {
        console.log("üß™ Ejecutando intentoMuestreoDeCalidad");
        console.log("üß™ Producto recibido:", producto);

        const probabilidad = 1 / 30; // Cambia a 1/30 en producci√≥n
        const aleatorio = Math.random();
        console.log("üß™ N√∫mero aleatorio generado:", aleatorio);

        if (aleatorio > probabilidad) {
          console.log("üß™ Muestreo NO activado por probabilidad");
          return;
        }

        console.log("üß™ Muestreo ACTIVADO - generando modal");

        // Modal centrado y responsive
        const modal = document.createElement("div");
        modal.className = "muestreo-calidad";
        modal.style.position = "fixed";
        modal.style.top = "0";
        modal.style.left = "0";
        modal.style.width = "100vw";
        modal.style.height = "100vh";
        modal.style.backgroundColor = "rgba(0, 0, 0, 0.5)";
        modal.style.backdropFilter = "blur(8px)";
        modal.style.webkitBackdropFilter = "blur(8px)"; // Safari/iOS
        modal.style.display = "flex";
        modal.style.justifyContent = "center";
        modal.style.alignItems = "center";
        modal.style.zIndex = "9000";
        modal.style.padding = "1rem";
        modal.style.boxSizing = "border-box";

        const contenido = document.createElement("div");
        contenido.style.backgroundColor = "white";
        contenido.style.padding = "1.5rem";
        contenido.style.borderRadius = "1rem";
        contenido.style.boxShadow = "0 0 20px rgba(0,0,0,0.3)";
        contenido.style.width = "100%";
        contenido.style.maxWidth = "500px";
        contenido.style.boxSizing = "border-box";
        contenido.innerHTML = `
    <h2 style="font-size: 1.25rem; font-weight: bold; text-align: center; color: #B00042; margin-bottom: 1rem;">üß™ Muestreo de Calidad</h2>
    <p style="margin-bottom: 0.5rem; color: #B00042; font-weight: bold;">
      ‚ö†Ô∏è <b>IMPORTANTE:</b> NO uses la etiqueta. 
      Ingresa los datos impresos directamente en el envase o empaque original del producto.
    </p>
    <label style="color: black;"><b>Referencia:</b> Escribe la clave o n√∫mero como aparece en el empaque.</label>
    <input id="input_ref_validar" type="text" placeholder="Ej: 547321" style="width: 100%; color: black; padding: 0.5rem; margin-bottom: 0.5rem;">
    <label style="color: black;"><b>Lote:</b> Captura el lote visible en el producto (no en la etiqueta).</label>
    <input id="input_lote_validar" type="text" placeholder="Ej: A23B56" style="width: 100%; color: black; padding: 0.5rem; margin-bottom: 0.5rem;">
    <label style="color: black;"><b>Caducidad:</b> Ingresa la fecha como viene impresa, o marca "Sin caducidad" si aplica.</label>
    <input id="input_cad_validar" type="date" style="width: 100%; color: black; padding: 0.5rem; margin-bottom: 0.5rem;">
    <div style="display:flex; align-items:center; margin-bottom: 1rem;">
      <input id="cad_no_aplica" type="checkbox" style="margin-right: 0.5rem;" onchange="toggleCaducidadInput(this)">
      <label for="cad_no_aplica" style="color:black; margin:0;">Sin caducidad / No aplica</label>
    </div>
    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
      <button onclick="validarMuestreo('${producto.referencia}','${producto.lote}','${producto.caducidad}')" style="padding: 0.5rem; background-color: #15803d; color: white; font-weight: bold; border: none; border-radius: 5rem;">Validar</button>
      <button onclick="cancelarMuestreo()" style="padding: 0.5rem; background-color: #B00042; color: white; font-weight: bold; border: none; border-radius: 5rem;">Omitir</button>
    </div>
  `;

        modal.appendChild(contenido);
        // üö´ Bloquea escaneo cuando se activa el muestreo
        bloquearEscaneoCritico({
          sonido: "https://github.com/RicardoCentrum/centrum/raw/main/losiento.mp3",
          vibrar: true
        });
        document.body.appendChild(modal);
        console.log("üß™ Modal de muestreo insertado en el DOM");
      }

      // Permitir desactivar el input de caducidad si es "no aplica"
      function toggleCaducidadInput(checkbox) {
        const inputCad = document.getElementById('input_cad_validar');
        if (checkbox.checked) {
          inputCad.disabled = true;
          inputCad.value = "";
        } else {
          inputCad.disabled = false;
        }
      }

      function sonCaducidadesEquivalentes(a, b) {
        const equivalentes = ["0", "S/C", "SC", "SIN CADUCIDAD", "N/A", "NA", "", null, undefined];

        // Si ambos son equivalentes "sin caducidad", acepta
        const upperA = (a === null || a === undefined) ? "" : String(a).trim().toUpperCase();
        const upperB = (b === null || b === undefined) ? "" : String(b).trim().toUpperCase();
        if (equivalentes.includes(upperA) && equivalentes.includes(upperB)) {
          console.log("üü¢ Ambos valores equivalentes a 'sin caducidad':", upperA, upperB);
          return true;
        }

        // Funci√≥n interna para normalizar cualquier fecha a ISO (YYYY-MM-DD)
        function fechaExcelANormal(fecha) {
          if (!fecha) return "";
          // Detecta si es un n√∫mero Excel v√°lido
          if (!isNaN(Number(fecha)) && Number(fecha) > 10000 && Number(fecha) < 60000) {
            const serial = Number(fecha);
            // Excel usa 1899-12-30 como d√≠a 0
            const msPerDay = 24 * 60 * 60 * 1000;
            const excelEpoch = Date.UTC(1899, 11, 30);
            const dateMs = excelEpoch + serial * msPerDay;
            // Siempre toma la fecha en UTC, as√≠ no afecta la zona horaria local
            const date = new Date(dateMs);
            return date.toISOString().split("T")[0];
          }
          // YYYY-MM-DD
          if (/^\d{4}-\d{2}-\d{2}$/.test(fecha)) return fecha;
          // YYYY/MM/DD
          if (/^\d{4}\/\d{2}\/\d{2}$/.test(fecha)) return fecha.replace(/\//g, '-');
          // DD/MM/YYYY
          if (/^\d{2}\/\d{2}\/\d{4}$/.test(fecha)) {
            const [d, m, y] = fecha.split("/");
            return `${y}-${m}-${d}`;
          }
          // Si es string y parece fecha
          if (!isNaN(Date.parse(fecha))) {
            return new Date(fecha).toISOString().split("T")[0];
          }
          return String(fecha).trim().toUpperCase();
        }

        const fa = fechaExcelANormal(a);
        const fb = fechaExcelANormal(b);

        console.log("üîé Caducidad A normalizada:", fa, "| original:", a);
        console.log("üîé Caducidad B normalizada:", fb, "| original:", b);

        // Si alguna era "S/C" o "0", ya fue cubierto arriba.
        // Ahora comparamos fechas normalizadas.
        const resultado = fa === fb;
        if (resultado) {
          console.log("‚úÖ Caducidades equivalentes:", fa, fb);
        } else {
          console.log("‚ùå Caducidades diferentes:", fa, fb);
        }
        return resultado;
      }


      function validarMuestreo(refEsperada, loteEsperado, cadEsperada) {
        console.log("üß™ Validando muestreo:", { refEsperada, loteEsperado, cadEsperada });
        const ref = document.getElementById("input_ref_validar").value.trim();
        const lote = document.getElementById("input_lote_validar").value.trim();
        let cad = document.getElementById("input_cad_validar")
          ? document.getElementById("input_cad_validar").value
          : null;

        // Si el checkbox est√° marcado, la caducidad es "S/C"
        if (document.getElementById("cad_no_aplica")?.checked) {
          cad = "S/C";
        }

        console.log("üß™ Valores ingresados:", { ref, lote, cad });

        const nip = typeof usuario !== "undefined" ? usuario : "SIN_NIP";
        const nombre = localStorage.getItem("nombreUsuario") || "Anonimo";

        // Si la caducidad esperada es "vac√≠a" o equivalente, acepta cualquier valor en caducidad:
        const equivalentes = ["0", "S/C", "SC", "SIN CADUCIDAD", "N/A", "NA", "", null, undefined];
        const cadEsperadaVac√≠a = equivalentes.includes(
          cadEsperada === undefined || cadEsperada === null ? "" : String(cadEsperada).trim().toUpperCase()
        );

        let validacionOK = false;
        if (cadEsperadaVac√≠a) {
          validacionOK = ref === refEsperada && lote === loteEsperado;
        } else {
          validacionOK =
            ref === refEsperada &&
            lote === loteEsperado &&
            sonCaducidadesEquivalentes(cad, cadEsperada);
        }

        // SIEMPRE registra el intento, aunque falte referencia/lote/cad
        fetch("https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/registro_errores", {
          method: "POST",
          headers: {
            "apikey": API_KEY,
            "Authorization": `Bearer ${API_KEY}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            usuario: nombre,
            referencia: refEsperada,
            lote: loteEsperado,
            fecha: new Date().toISOString(),
            motivo: validacionOK ? "muestreo validado" : "muestreo error",
            modo: "muestreo",
            pin_ingresado: nip,
            valido: validacionOK,
            // OPCIONAL: guarda lo que el usuario captur√≥
            ref_ingresada: ref,
            lote_ingresado: lote,
            caducidad_ingresada: cad
          })
        });

        if (validacionOK) {
          mostrarModal("Validaci√≥n exitosa ‚úÖ", "#22c55e");
        } else {
          mostrarModal("‚ùå Error de validaci√≥n. Notificado a administradores.", "#B00042");
        }

        desbloquearEscaneoCritico();
        cerrarModalMuestreo();
      }




      function cancelarMuestreo() {
        console.warn("üö® Muestreo omitido por el usuario");

        // Sonido advertencia
        const SONIDO_ADVERTENCIA = "https://github.com/RicardoCentrum/centrum/raw/main/advertencia%20muestreo%20calidad.mp3";
        try { new Audio(SONIDO_ADVERTENCIA).play(); } catch (e) { }

        // Modal de confirmaci√≥n especial
        const modalConfirm = document.createElement("div");
        modalConfirm.style.position = "fixed";
        modalConfirm.style.top = "0";
        modalConfirm.style.left = "0";
        modalConfirm.style.width = "100vw";
        modalConfirm.style.height = "100vh";
        modalConfirm.style.background = "rgba(200,0,60,0.55)";
        modalConfirm.style.backdropFilter = "blur(8px)";
        modalConfirm.style.webkitBackdropFilter = "blur(8px)";
        modalConfirm.style.zIndex = "99999";
        modalConfirm.style.display = "flex";
        modalConfirm.style.justifyContent = "center";
        modalConfirm.style.alignItems = "center";

        const contenido = document.createElement("div");
        contenido.style.background = "rgba(255,255,255,0.75)"; // Fondo glass
        contenido.style.backdropFilter = "blur(10px)";
        contenido.style.webkitBackdropFilter = "blur(10px)";
        contenido.style.border = "2px solid rgba(255,255,255,0.6)";
        contenido.style.boxShadow = "0 4px 30px rgba(0,0,0,0.2)";
        contenido.style.borderRadius = "16px";
        contenido.style.padding = "2rem";
        contenido.style.textAlign = "center";
        contenido.style.color = "#B00042";
        contenido.style.fontWeight = "bold";
        contenido.style.maxWidth = "420px";
        contenido.style.margin = "0 auto";

        // El resto de tu contenido HTML:
        contenido.innerHTML = `
    <div style="font-size: 2rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
    <div style="font-size: 1.15rem; margin-bottom: 1.25rem; color:#B00042;">
      ¬øTe rehusas a participar en el <b>muestreo aleatorio de calidad</b>?
    </div>
    <div style="display:flex; justify-content:center; gap:1rem;">
      <button id="btnOmitirMuestreo" style="background:#B00042; color:white; border:none; border-radius:5rem; padding:0.75rem 2rem; font-size:1rem; font-weight:bold; box-shadow:0 2px 10px #B0004233; cursor:pointer;">
        S√≠, omitir muestreo
      </button>
      <button id="btnCancelarOmitir" style="background:#e5e7eb; color:#B00042; border:none; border-radius:5rem; padding:0.75rem 2rem; font-size:1rem; font-weight:bold; box-shadow:0 2px 10px #B0004222; cursor:pointer;">
        Cancelar
      </button>
    </div>
  `;

        modalConfirm.appendChild(contenido);
        document.body.appendChild(modalConfirm);

        // Acci√≥n al aceptar (omitir realmente)
        contenido.querySelector("#btnOmitirMuestreo").onclick = () => {
          const nombre = localStorage.getItem("nombreUsuario") || "Anonimo";
          const nip = typeof usuario !== "undefined" ? usuario : "-";
          fetch("https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/registro_errores", {
            method: "POST",
            headers: {
              "apikey": API_KEY,
              "Authorization": `Bearer ${API_KEY}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              usuario: nombre,
              referencia: "-",
              lote: "-",
              fecha: new Date().toISOString(),
              motivo: "muestreo omitido",
              modo: "muestreo",
              pin_ingresado: nip,
              valido: false
            })
          });
          desbloquearEscaneoCritico();
          cerrarModalMuestreo();
          modalConfirm.remove();
          mostrarModal("üö® Muestreo omitido. Notificado a administradores.", "#B00042");
        };

        // Acci√≥n al cancelar (volver al muestreo)
        contenido.querySelector("#btnCancelarOmitir").onclick = () => {
          modalConfirm.remove();
          // ¬°El muestreo original sigue abierto y el escaneo sigue bloqueado!
          try { document.getElementById("input_ref_validar").focus(); } catch (e) { }
        };
      }



      function cerrarModalMuestreo() {
        const modal = document.querySelector(".muestreo-calidad");
        desbloquearEscaneoCritico()
        if (modal) modal.remove();
        inputQR?.focus();
      }




      //888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888





      async function procesarQR(contenido) {
        try {
          console.log("üì• QR recibido:", contenido);
          const datos = extraerDatosQR(contenido);
          console.log("üîç Datos extra√≠dos del QR:", datos);

          if (!datos || !datos.referencia || !datos.timestamp) {
            mostrarModal("*Ô∏è‚É£ QR incompleto o ilegible", "#6b7280");
            return;
          }

          if (!datos.lote) {
            mostrarModal("*Ô∏è‚É£ QR sin lote", "#6b7280");
            return;
          }

          const remision = document.getElementById("inputRemision")?.value.trim().toLowerCase();
          const unidad = unidadSeleccionada?.toLowerCase();
          const esBasurero = modo === "salida" && unidad === "eliminar" && remision === "etiqueta";

          if (esBasurero) {
            await procesarBasurero(datos);
            return;
          }

          if (datos.lote.includes('|')) {
            datos.lote = datos.lote.split('|')[0];
          }

          if (!usuario || !modo || modo === "inactivo") {
            mostrarModal("‚ö†Ô∏è Selecciona un modo y un usuario", "#d99b00");
            return;
          }

          if (modo === "salida" && !unidadSeleccionada) {
            mostrarModal("‚ö†Ô∏è Selecciona una unidad m√©dica", "#d99b00");
            return;
          }

          if (qrsPendientes.some(q => q.timestamp === datos.timestamp)) {
            mostrarModal("üì¶ Ya escaneado localmente", "#0284c7");
            return;
          }

          const tsCheckRes = await fetch(
            `https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/TimeStamps?or=(timestamp.eq.${datos.timestamp},ts_eliminado.eq.${datos.timestamp})&select=timestamp,ts_eliminado,usuario,unidad_destino,fecha_salida_str`,
            { headers: { "apikey": API_KEY, "Authorization": `Bearer ${API_KEY}` } }
          );
          console.log("üåê [FETCH] Consulta enviada a Supabase con timestamp:", datos.timestamp);

          const tsData = await tsCheckRes.json();
          console.log("üîç [TS DEBUG] Respuesta completa de Supabase:", tsData);

          const registro = tsData[0] || null;
          console.log("üì¶ [TS DEBUG] Registro procesado:", registro);

          if (modo === "entrada" && registro?.timestamp) {
            mostrarModal("üì¶ Ya escaneado anteriormente", "#0284c7");
            return;
          }

          if (modo === "salida" && registro?.ts_eliminado) {
            console.log("üö© [TS DEBUG] Producto marcado como eliminado, generando historial...");

            // ‚úÖ Funci√≥n auxiliar para armar historial completo
            function construirHistorial(usuarioStr, unidadStr, remisionStr, fechaStr) {
              const usuarios = usuarioStr ? usuarioStr.split(",") : [];
              const unidades = unidadStr ? unidadStr.split(",") : [];
              const remisiones = remisionStr ? remisionStr.split(",") : [];
              const fechas = fechaStr ? fechaStr.split(",") : [];

              const historial = [];
              for (let i = 0; i < usuarios.length; i++) {
                historial.push(
                  `${usuarios[i] || "-"} ‚Üí ${unidades[i] || "-"} ` +
                  `(Remisi√≥n: ${remisiones[i] || "-"}) en ${fechas[i] || "-"}`
                );
              }
              return historial.join("\n");
            }

            // ‚úÖ Construimos el historial con los campos concatenados del backend
            const historial = construirHistorial(
              registro.usuario,
              registro.unidad_destino,
              registro.remision,
              registro.fecha_salida_str
            );

            // ‚úÖ Mostrar historial en un modal amarillo
            const msg = `‚ö†Ô∏è Este producto ya fue retirado anteriormente:\n\n${historial}`;
            console.log("üì¢ [TS DEBUG] Mostrando historial completo:\n" + historial);
            mostrarModal(msg, "#facc15");
            return;
          } else {
            console.log("‚úÖ [TS DEBUG] No se encontr√≥ registro eliminado o el modo no es salida.");
          }


          if (modo === "salida" && !registro?.timestamp && !registro?.ts_eliminado) {
            mostrarModal("‚ùå Este c√≥digo no ha sido registrado previamente en modo entrada.\nNo se encontr√≥ el timestamp en la base de datos.", "#B00042");
            return;
          }
          if (modo === "salida") {
            const inputRemision = document.getElementById("inputNumeroRemision");
            const numeroRemision = inputRemision ? inputRemision.value.trim() : "";
            if (numeroRemision) {
              const remisionValida = await validarContraRemision(datos.referencia, datos.lote, numeroRemision);
              if (!remisionValida) return;
            }
          }

          mostrarModal("üì§ Procesando QR...", "#0ea5e9");

          const urlMultip = `https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/multiplicadores?select=fraccionable,referencia,referencia_unidad,multiplicador&or=(referencia.eq.${datos.referencia},referencia_unidad.eq.${datos.referencia})`;
          const fraccionableRes = await fetch(urlMultip, {
            headers: { "apikey": API_KEY, "Authorization": `Bearer ${API_KEY}` }
          });
          const fraccionableData = await fraccionableRes.json();
          const entry = fraccionableData[0];
          const esFraccionable = entry?.fraccionable === true;

          // ‚úÖ UNIDAD FRACCIONABLE
          if (entry?.referencia_unidad === datos.referencia) {
            const qrUnidad = {
              ...datos,
              modo,
              usuario,
              unidad: unidadSeleccionada,
              tipo: "unidad",
              remision: document.getElementById("inputRemision")?.value.trim() || null
            };
            qrsPendientes.push(qrUnidad);
            intentoMuestreoDeCalidad(qrUnidad);
            actualizarTablaRegistros();
            mostrarModal("‚úÖ Unidad escaneada", "#22c55e");
            return;
          }

          // ‚úÖ CAJA FRACCIONABLE
          if (esFraccionable && modo === "entrada") {
            const qrCaja = {
              ...datos,
              modo,
              usuario,
              unidad: unidadSeleccionada,
              tipo: "fraccion",
              remision: document.getElementById("inputRemision")?.value.trim() || null
            };
            qrsPendientes.push(qrCaja);
            intentoMuestreoDeCalidad(qrCaja);
            actualizarTablaRegistros();
            mostrarModal("‚úÖ Caja escaneada", "#22c55e");
            return;
          }

          // üîÑ SALIDA FRACCIONABLE
          if (esFraccionable && modo === "salida") {
            abrirModalCantidadFraccionable(datos.referencia, datos.lote, contenido);
            return;
          }

          // ‚úÖ Producto normal
          if (modo === "salida") {
            const permitido = await procesarExtraccionConValidacion(datos.referencia, unidadSeleccionada, 1, usuario, remisionActual);
            if (!permitido) return;
          }

          const historicoRes = await fetch(
            `https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/historicos?select=referencia,nombre,fabricante`,
            { headers: { "apikey": API_KEY, "Authorization": `Bearer ${API_KEY}` } }
          );
          const historico = await historicoRes.json();
          const normalizar = str => str.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
          const refLimpiada = normalizar(datos.referencia);
          const match = historico.find(h => normalizar(h.referencia) === refLimpiada);
          const nombre = match?.nombre || "SIN NOMBRE";
          const fabricante = match?.fabricante || "SIN FABRICANTE";

          let caducidadFinal = "S/C";
          if (datos.caducidad && !isNaN(datos.caducidad)) {
            inputQR?.focus();
            try {
              const fechaExcel = new Date((Number(datos.caducidad) - 25569) * 86400 * 1000);
              caducidadFinal = fechaExcel.toISOString().split("T")[0];
            } catch {
              caducidadFinal = "S/C";
            }
          } else if (typeof datos.caducidad === "string") {
            caducidadFinal = datos.caducidad;
          }

          verificarCaducidadYMostrarModal(caducidadFinal);

          const qrPendiente = {
            ...datos,
            modo,
            usuario,
            unidad: unidadSeleccionada,
            nombre,
            fabricante,
            caducidad: caducidadFinal,
            remision: document.getElementById("inputRemision")?.value.trim() || null

          };

          qrsPendientes.push(qrPendiente);
          intentoMuestreoDeCalidad(qrPendiente);
          actualizarTablaRegistros();
          mostrarModal("‚úÖ Producto escaneado", "#22c55e");

        } catch (error) {
          console.error("‚ùå Error en procesarQR:", error);
          mostrarModal("‚ùå Error inesperado", "#B00042");
        }
      }




      // === Funciones auxiliares ===
      function prepararEventoCantidadFraccionable() {
        const input = document.getElementById("inputCantidadFraccionable");
        if (!input) return;

        // Primero eliminamos cualquier listener previo (por seguridad)
        input.replaceWith(input.cloneNode(true));

        const nuevoInput = document.getElementById("inputCantidadFraccionable");
        nuevoInput.addEventListener("keyup", function (e) {
          if (e.key === "Enter") confirmarCantidadFraccionable();
        });
      }

      function iniciarExtraccionFraccionableFrontend(ref, lote, cantidad) {
        fraccionesEscaneadas = [];
        cantidadFaltante = cantidad;
        referenciaActual = ref;
        loteActual = lote;
        referenciaFraccionable = ref; // ‚úÖ Definir referencia esperada
        loteFraccionable = lote;       // ‚úÖ Definir lote esperado
        mostrarModal("üîÑ Escanea la primera caja...", "#6b7280");
      }

      function reenfocarInputFraccionable() {
        const input = document.getElementById("inputEscaneoFraccionable");
        if (input) {
          setTimeout(() => input.focus(), 50);
        }
      }


      async function procesarCajaFraccionable(contenidoQR) {
        const datos = extraerDatosQR(contenidoQR);
        const ts = datos.timestamp;

        if (!ts || !datos.referencia || !datos.lote) {
          mostrarModal("‚ö†Ô∏è QR incompleto", "#d99b00");
          return;
        }

        if (datos.referencia !== referenciaFraccionable || datos.lote !== loteFraccionable) {
          mostrarModal("‚ö†Ô∏è Caja/Unidad no coincide con referencia o lote esperado", "#d99b00");
          reenfocarInputFraccionable();
          return;
        }

        if (fraccionesEscaneadas.some(f => f.timestamp === ts)) {
          mostrarModal("‚ö†Ô∏è Esta caja/unidad ya fue escaneada", "#d99b00");
          reenfocarInputFraccionable();
          return;
        }

        try {
          // üîç Buscar si el timestamp corresponde a una fracci√≥n en Supabase
          const res = await fetch(
            `https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/fracciones?timestamp=eq.${ts}`,
            {
              headers: {
                "apikey": API_KEY,
                "Authorization": `Bearer ${API_KEY}`
              }
            }
          );

          if (!res.ok) throw new Error(`‚ùå Error HTTP: ${res.status}`);

          const [fraccion] = await res.json();
          console.log("üì¶ Caja/Unidad procesada:", fraccion);

          if (!fraccion || fraccion.cantidad_restante <= 0) {
            mostrarModal("‚ùå Caja/Unidad vac√≠a o no encontrada", "#B00042");
            reenfocarInputFraccionable();
            return;
          }

          // ‚úÖ Detectar si es unidad fraccionable o caja fraccionable
          const esUnidad = datos.referencia.endsWith("U");
          // si prefieres algo m√°s robusto, puedes validar contra la tabla "multiplicadores"

          const usado = Math.min(fraccion.cantidad_restante, cantidadFaltante);
          cantidadFaltante = Math.max(0, cantidadFaltante - usado);

          // ‚úÖ Guardar en fraccionesEscaneadas con tipo correcto
          console.log("üì• Caja/Unidad a√±adida a fraccionesEscaneadas:", {
            ts,
            lote: datos.lote,
            usado,
            tipo: esUnidad ? "unidad" : "fraccion",
            remision: document.getElementById("inputRemision")?.value.trim() || null
          });

          fraccionesEscaneadas.push({
            timestamp: ts,
            lote: datos.lote,
            usado,
            tipo: esUnidad ? "unidad" : "fraccion",
            remision: document.getElementById("inputRemision")?.value.trim() || null
          });

          actualizarModalFraccionable();

          if (cantidadFaltante > 0) {
            mostrarModal(
              `üì¶ Se usaron ${usado}. Faltan ${cantidadFaltante} piezas. Escanea otra caja o unidad...`,
              "#0ea5e9"
            );
            reenfocarInputFraccionable();
          } else {
            mostrarModal("‚úÖ Todo listo. Enviando informaci√≥n...", "#22c55e");
            cerrarModalFraccionable();
            modoExtraccionFraccionableActivo = false;

            // ‚úÖ Ahora fraccionesEscaneadas puede contener mezcla de cajas y unidades
            fraccionesEscaneadas.forEach(f => {
              qrsPendientes.push({
                referencia: referenciaFraccionable,
                lote: f.lote,
                timestamp: f.timestamp,
                cantidad: f.usado,
                usuario,
                unidad: unidadSeleccionada,
                tipo: f.tipo,
                remision: f.remision || null,
                modo: "salida"
              });
            });
            actualizarTablaRegistros();

          }
        } catch (error) {
          console.error("‚ùå Error al consultar fracci√≥n:", error);
          mostrarModal("*Ô∏è‚É£ Error al verificar la caja", "#6b7280");
          reenfocarInputFraccionable();
        }
      }


      async function registrarExtraccionConjunta(elementos, referencia, usuario, unidad) {
        let errores = 0;
        const procesados = new Set();

        for (const [i, f] of elementos.entries()) {
          try {
            // üîë Usamos un identificador √∫nico (timestamp o ‚Äúunidad‚Äù si no tiene)
            const key = `${referencia}-${f.lote}-${f.timestamp || 'unidad'}`;
            if (procesados.has(key)) continue;
            procesados.add(key);

            // üì¶ Construir el objeto base para Supabase
            const registro = {
              referencia,
              lote: f.lote,
              timestamp: f.timestamp || null,   // ‚úÖ cajas tienen timestamp, unidades pueden no tener
              cantidad: f.usado,
              usuario,
              modo: "salida",
              unidad,
              remision: f.remision || null
            };

            // üîë Si hay PIN de autorizaci√≥n, lo agregamos
            if (window.pinAutorizadoPor && window.pinAutorizadoPor !== usuario) {
              registro.pin_autorizado_por = window.pinAutorizadoPor;
            }

            // üåê Escoger endpoint correcto seg√∫n tipo
            const url = f.tipo === "fraccion"
              ? "https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/registrar_qr_fraccionable"
              : "https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/registrar_qr_unidad";

            console.log("üîµ [registrarExtraccionConjunta] Enviando:", url, registro);

            const res = await fetch(url, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ registros: [registro] })
            });

            if (!res.ok) throw new Error(`‚ùå Error HTTP: ${res.status}`);

            const result = await res.json();
            const r = result.resultados?.[0];

            console.log("üì§ [registrarExtraccionConjunta] Respuesta Supabase:", result);

            // ‚úÖ Si Supabase confirma el registro
            if (r?.status === "ok") {
              // ‚úÖ Guardamos en qrsPendientes para registro local
              const registroQR = {
                referencia,
                lote: f.lote,
                timestamp: f.timestamp || null,
                cantidad: f.usado,
                modo: "salida",
                usuario,
                unidad,
                tipo: f.tipo,
                remision: f.remision || null

              };

              if (registro.pin_autorizado_por) {
                registroQR.pin_autorizado_por = registro.pin_autorizado_por;
              }

              // Evitar duplicados en qrsPendientes
              const yaExiste = qrsPendientes.find(q =>
                q.referencia === referencia &&
                q.lote === f.lote &&
                q.timestamp === f.timestamp
              );

              if (!yaExiste) qrsPendientes.push(registroQR);

              mostrarModal(`‚úÖ Elemento ${i + 1} procesado (${f.usado} piezas, tipo: ${f.tipo})`, "#22c55e");

            } else {
              // ‚ö†Ô∏è Si Supabase devuelve warning/error
              errores++;
              mostrarModal(`‚ö†Ô∏è Elemento ${i + 1} fall√≥: ${r?.mensaje || "desconocido"}`, "#d99b00");
            }

          } catch (err) {
            console.error(`‚ùå [registrarExtraccionConjunta] Error al registrar elemento ${i + 1}:`, err);
            errores++;
            mostrarModal(`‚ùå Error de red al registrar elemento ${i + 1}`, "#B00042");
          }

          // ‚è≥ Pausa ligera para evitar saturar el backend
          await new Promise(resolve => setTimeout(resolve, 200));
        }

        // üéâ Resultado final
        if (errores === 0) {
          mostrarModal("üéâ Todas las cajas y unidades registradas con √©xito", "#4ade80");
        } else {
          mostrarModal(`‚ö†Ô∏è ${errores} de ${elementos.length} elementos fallaron`, "#d99b00");
        }
      }



      //88888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888


      async function validarContraRemision(referencia, lote, numeroRemision) {
        const res = await fetch(
          `https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/remisiones_pendientes?referencia=eq.${referencia}&lote=eq.${lote}&numero_remision=eq.${numeroRemision}`,
          {
            headers: {
              "apikey": API_KEY,
              "Authorization": `Bearer ${API_KEY}`
            }
          }
        );

        const data = await res.json();

        if (data.length === 0) {
          mostrarModal("‚ö†Ô∏è Producto no pertenece a la remisi√≥n cargada", "#d99b00");
          return false;
        }

        const campoAvance = (modoSeleccionado === "preparacion")
          ? "cantidad_preparada"
          : "cantidad_escaneada";

        const actual = Number(data[0]?.[campoAvance] ?? 0);
        const pendiente = Number(data[0].cantidad_solicitada) - (Number.isFinite(actual) ? actual : 0);

        if (pendiente <= 0) {
          mostrarModal("üö´ Cantidad ya completa para este producto", "#b00042");
          return false;
        }

        await fetch(
          `https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/remisiones_pendientes?id=eq.${data[0].id}`,
          {
            method: "PATCH",
            headers: {
              "apikey": API_KEY,
              "Authorization": `Bearer ${API_KEY}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              [campoAvance]: (Number.isFinite(actual) ? actual : 0) + 1
            })
          }
        );

        return true;
      }

      function abrirModalCantidadFraccionable(referencia, lote, contenidoQR) {
        const existente = document.getElementById("modalFraccionable");
        if (existente) existente.remove();

        // Variables globales
        window.referenciaFraccionable = referencia;
        window.loteFraccionable = lote;
        window.ultimoContenidoEscaneado = contenidoQR;
        window.fraccionesEscaneadas = [];
        window.cantidadFaltante = 0;
        window.modoExtraccionFraccionableActivo = false;

        const modal = document.createElement("div");
        modal.id = "modalFraccionable";
        modal.className = "fixed inset-0 z-950 backdrop-blur-sm bg-black/40 flex items-center justify-center";

        modal.innerHTML = `
    <div class="bg-white text-gray-800 rounded-xl p-6 w-[92%] max-w-md shadow-xl relative animate-fade-in overflow-y-auto max-h-[90vh] space-y-4">
      <button onclick="cerrarModalFraccionable()" class="absolute top-2 right-3 text-2xl font-bold text-red-600 hover:text-red-800">√ó</button>
      <h2 class="text-xl font-bold text-center">üì¶ Producto fraccionable</h2>
      <p class="text-sm text-center">Referencia: <b>${referencia}</b></p>
      <p class="text-sm text-center">Lote: <b>${lote}</b></p>

      <div class="mt-2">
        <label class="block text-sm font-semibold">Cantidad total a retirar:</label>
        <input id="inputCantidadFraccionable" type="number" min="1"
          class="w-full px-4 py-2 mt-1 rounded-md border border-gray-300 text-center text-lg font-bold focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="Ej. 10" autofocus />
      </div>

      <div class="flex justify-between mt-4">
        <button onclick="cerrarModalFraccionable()" class="bg-gray-300 hover:bg-gray-400 text-sm px-4 py-2 rounded-md">Cancelar</button>
          <button id="btnConfirmarCantidadFraccionable" onclick="(async () => {
          const cantidad = parseInt(document.getElementById('inputCantidadFraccionable').value.trim());
          if (!cantidad || cantidad <= 0) {
            mostrarModal('‚ö†Ô∏è Ingresa una cantidad v√°lida', '#d99b00');
            return;
          }

          const permitido = await procesarExtraccionConValidacion('${referencia}', '${unidadSeleccionada}', cantidad, usuario, remisionActual);
          if (!permitido) {
            mostrarModal('‚ùå Operaci√≥n cancelada por exceso de dotaci√≥n', '#B00042');
            cerrarModalFraccionable();
            return;
          }

          confirmarCantidadFraccionable();  // ‚Üê si pasa validaci√≥n
        })()"
        class="bg-green-600 hover:bg-green-700 text-white text-sm px-4 py-2 rounded-md">Aceptar</button>

      </div>

      <div id="seccionFracciones" class="hidden mt-4 space-y-3">
        <div>
          <label class="block text-sm font-semibold">üì∑ Escanea o ingresa caja:</label>
          <input id="inputEscaneoFraccionable" type="text"
            class="w-full px-4 py-2 rounded-md border border-gray-300 text-center font-mono text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="Escanea aqu√≠..." />
        </div>

        <div class="text-sm text-gray-800">
          <p><b>Piezas restantes:</b> <span id="faltanFracciones">-</span></p>
          <p><b>Cajas escaneadas:</b></p>
          <ul id="listaFracciones" class="list-disc list-inside text-gray-700 mt-1"></ul>
        </div>
      </div>
    </div>
  `;

        document.body.appendChild(modal);

        setTimeout(() => {
          const input = document.getElementById("inputCantidadFraccionable");
          const btnAceptar = document.getElementById("btnConfirmarCantidadFraccionable");

          if (input && btnAceptar) {
            input.focus();
            input.value = "";
            input.addEventListener("keyup", function (e) {
              if (e.key === "Enter") btnAceptar.click();
            }, { once: true });

            btnAceptar.onclick = async () => {
              const cantidadSolicitada = parseInt(input.value);
              if (!cantidadSolicitada || cantidadSolicitada < 1) return;

              const claveRemision = `${referencia}::${unidadSeleccionada}::${document.getElementById("inputRemision")?.value.trim() || "sin_remision"}`;

              if (window.autorizacionesExceso[claveRemision]?.validado) {
                console.log("üîì PIN ya autorizado previamente para esta remisi√≥n. No se pedir√° de nuevo.");
              } else {
                const permitido = await procesarExtraccionConValidacion(referencia, unidadSeleccionada, cantidadSolicitada, usuario, remisionActual);

                if (!permitido) return;
              }

              cerrarModalFraccionable();
              iniciarModoExtraccionFraccionable(referencia, lote, contenidoQR, cantidadSolicitada);
            };
          }
        }, 100);
      }


      function actualizarModalFraccionable() {
        const modal = document.getElementById("modalFraccionable");
        if (!modal) return;

        // Mostrar resumen de cajas escaneadas
        let info = document.getElementById("infoFracciones");
        let lista = document.getElementById("listaFracciones");
        let faltan = document.getElementById("faltanFracciones");

        if (!info || !lista || !faltan) {
          // Si no existen a√∫n, crearlos dentro del modal
          const contenedor = document.createElement("div");
          contenedor.id = "infoFracciones";
          contenedor.className = "mt-4";

          contenedor.innerHTML = `
      <p class="text-sm mb-1 font-semibold text-center">üì¶ Cajas escaneadas:</p>
      <ul id="listaFracciones" class="text-sm list-disc list-inside text-gray-700"></ul>
      <p class="text-sm mt-2 text-center"><b>Faltan: <span id="faltanFracciones">-</span> piezas</b></p>
    `;

          modal.querySelector("div.bg-white").appendChild(contenedor);

          info = contenedor;
          lista = contenedor.querySelector("#listaFracciones");
          faltan = contenedor.querySelector("#faltanFracciones");
        }

        // Limpiar lista
        lista.innerHTML = "";

        // Agregar elementos escaneados
        fraccionesEscaneadas.forEach((f, i) => {
          const li = document.createElement("li");
          li.textContent = `Caja ${i + 1} ‚Üí ${f.usado} piezas (ID ${f.timestamp})`;
          lista.appendChild(li);
        });

        // Actualizar faltantes
        const piezasAcumuladas = fraccionesEscaneadas.reduce((sum, f) => sum + f.usado, 0);
        const piezasRestantes = Math.max(0, cantidadFaltante);
        faltan.textContent = piezasRestantes;
      }


      function cerrarModalFraccionable() {
        const modal = document.getElementById("modalFraccionable");
        if (modal) modal.remove();
      }

      async function procesarQRFraccionableSalida(referencia, lote, cantidad) {
        const payload = {
          registros: [{
            referencia,
            lote,
            cantidad,
            usuario,
            modo: "salida",
            unidad: unidadSeleccionada || null
          }]
        };
        try {
          console.log("üü† [procesarQRFraccionableSalida] Enviando fetch a registrar_qr_fraccionable:", payload);
          const res = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/registrar_qr_fraccionable", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          const result = await res.json();
          const r = result.resultados?.[0];
          console.log("üì§ [procesarQRFraccionableSalida] Respuesta Supabase:", result);
          if (r?.status === "ok") {
            qrsPendientes.push({ referencia, lote, cantidad, modo: "salida", usuario, unidad: unidadSeleccionada });
            actualizarTablaRegistros();
            mostrarModal("‚úÖ Retiro fraccionado exitoso", "#22c55e");
          } else if (r?.status === "extraido_previo") {
            mostrarModal(`‚ö†Ô∏è Producto ya fue retirado\nüë§ ${res.usuario}\nüè• ${res.unidad_destino}\nüìÖ ${res.fecha_str}`, "#d99b00");
          } else if (r?.mensaje) {
            mostrarModal(`‚ö†Ô∏è ${r.mensaje}`, "#6b7280");
          } else {
            mostrarModal("‚ùå Error en el retiro", "#6b7280");
          }
        } catch (err) {
          console.error("‚ùå [procesarQRFraccionableSalida] Error:", err);
          mostrarModal("‚ùå Error de conexi√≥n", "#6b7280");
        }
      }

      function confirmarCantidadFraccionable() {
        const input = document.getElementById("inputCantidadFraccionable");
        const cantidad = Number(input.value?.trim());

        if (isNaN(cantidad) || cantidad <= 0) {
          mostrarModal("‚ö†Ô∏è Ingresa una cantidad v√°lida", "#d99b00");
          return;
        }

        modoExtraccionFraccionableActivo = true;
        cantidadFaltante = cantidad;
        fraccionesEscaneadas = [];

        // Mostrar secci√≥n de escaneo
        setTimeout(() => {
          const seccion = document.getElementById("seccionFracciones");
          const lista = document.getElementById("listaFracciones");
          const faltan = document.getElementById("faltanFracciones");
          const escaneo = document.getElementById("inputEscaneoFraccionable");

          if (!seccion || !lista || !faltan || !escaneo) {
            mostrarModal("‚ùå Error interno en el modal", "#B00042");
            return;
          }

          seccion.classList.remove("hidden");
          lista.innerHTML = "";
          faltan.textContent = cantidad;

          escaneo.focus();
          escaneo.addEventListener("keyup", function (e) {
            if (e.key === "Enter") {
              procesarCajaFraccionable(escaneo.value.trim());
              escaneo.value = "";
            }
          }, { once: false });

          if (ultimoContenidoEscaneado) {
            procesarCajaFraccionable(ultimoContenidoEscaneado);
            ultimoContenidoEscaneado = null;
          }
        }, 0);
      }



      //========================================================================================================


      async function procesarExtraccionConValidacion(ref, unidadDestino, cantidadSolicitada, usuario, numeroRemision = null) {
        console.log("üîç Iniciando validaci√≥n de dotaci√≥n para:", { ref, unidadDestino, cantidadSolicitada, numeroRemision });

        const fecha = new Date();
        const mes = fecha.getMonth() + 1;
        const anio = fecha.getFullYear();
        const mesAnterior = mes === 1 ? 12 : mes - 1;
        const anioAnterior = mes === 1 ? anio - 1 : anio;

        const colA = `25_${mesAnterior}_${anioAnterior}`;
        const colB = `10_${mes}_${anio}`;

        console.log("üìÖ Columnas a consultar:", colA, colB);

        const claveRemision = `${ref}||${unidadDestino}||${numeroRemision || "sin_remision"}`;
        // Validar si ya est√° autorizada en memoria
        if (window.autorizacionesExceso?.[claveRemision]) {
          console.log("üîì PIN ya validado anteriormente para esta remisi√≥n. Se permite continuar.");
          return true;
        }

        // Validar si ya estaba autorizada en Supabase
        if (numeroRemision) {
          const resCheck = await fetch(`https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/remisiones_pendientes?select=nip_verificado&numero_remision=eq.${numeroRemision}`, {
            headers: {
              apikey: API_KEY,
              Authorization: `Bearer ${API_KEY}`
            }
          });

          const remisionInfo = await resCheck.json();
          const algunaVerificada = remisionInfo?.some(r => r.nip_verificado === true);

          if (algunaVerificada) {
            console.log("üîì PIN ya estaba verificado en Supabase para esta remisi√≥n:", remisionActual);
            window.autorizacionesExceso = window.autorizacionesExceso || {};
            window.autorizacionesExceso[claveRemision] = true;
            return true;
          }
        }

        const urlConsumos = `https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/consumos_mensuales?select=*&referencia=eq.${ref}&unidad_medica=eq.${unidadDestino}`;
        const resConsumos = await fetch(urlConsumos, {
          headers: { apikey: API_KEY, Authorization: `Bearer ${API_KEY}` }
        });
        const registros = await resConsumos.json();
        const consumos = registros?.[0] || {};

        console.log("üì¶ Registro de consumos encontrado:", consumos);

        const consumoActual = (parseInt(consumos[colA]) || 0) + (parseInt(consumos[colB]) || 0);
        console.log("üìà Consumo actual calculado:", consumoActual);

        const urlDotacion = `https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/dotaciones?select=*&referencia=eq.${ref}&unidad=eq.${unidadDestino}`;
        const resDot = await fetch(urlDotacion, {
          headers: { apikey: API_KEY, Authorization: `Bearer ${API_KEY}` }
        });
        const dotacionData = await resDot.json();

        console.log("üìã Datos de dotaci√≥n encontrados:", dotacionData);

        const cantidadPermitida = parseInt(dotacionData?.[0]?.cantidad) || 0;

        const escaneadosLocalmente = qrsPendientes.filter(q =>
          q.referencia === ref && q.unidad === unidadDestino
        ).length;

        console.log("üìä Escaneados localmente:", escaneadosLocalmente);

        const consumoProyectado = consumoActual + escaneadosLocalmente + cantidadSolicitada;

        console.log("üìä Comparaci√≥n:", {
          cantidadPermitida,
          consumoActual,
          cantidadSolicitada,
          consumoProyectado
        });

        if (consumoProyectado > cantidadPermitida) {
          const modal = document.getElementById("modalPINExceso");
          const contenido = document.getElementById("contenidoPINExceso");

          // BLOQUEA ESCANEO AL ABRIR EL MODAL PIN
          bloquearEscaneoCritico({
            sonido: "https://github.com/RicardoCentrum/centrum/raw/main/losiento.mp3",
            vibrar: true
          });

          console.log("üß™ usuario en generar PIN:", usuario);
          const pinGenerado = await generarPinDinamico();
          console.log("üîê PIN din√°mico actual:", pinGenerado);

          contenido.innerHTML = `
      <p class="text-red-800 font-semibold">‚ö†Ô∏è La cantidad solicitada excede la dotaci√≥n autorizada:</p>
      <ul class="list-disc ml-6 text-sm mt-2">
        <li><strong>Referencia:</strong> ${ref}</li>
        <li><strong>Unidad destino:</strong> ${unidadDestino}</li>
        <li><strong>Dotaci√≥n mensual:</strong> ${cantidadPermitida}</li>
        <li><strong>Consumido actual:</strong> ${consumoActual}</li>
        <li><strong>Solicitado ahora:</strong> ${cantidadSolicitada}</li>
        <li class="text-red-900"><strong>Total proyectado:</strong> ${consumoProyectado} (excede)</li>
      </ul>
      <p class="mt-3 text-sm">üîê Se ha generado un PIN din√°mico. Solic√≠talo a un administrador para continuar.</p>
    `;

          console.log("üö™ Mostrando modalPINExceso");
          modal.classList.remove("hidden");
          document.getElementById("nipdinamico").value = "";
          document.getElementById("pinError").classList.add("hidden");
          document.getElementById("nipdinamico").focus();

          return new Promise((resolve) => {
            const btnConfirmar = document.getElementById("btnConfirmarPin");
            const btnCancelar = document.getElementById("btnCancelarPIN");
            const input = document.getElementById("nipdinamico");

            if (!btnConfirmar || !btnCancelar || !input) {
              console.error("‚ùå Elementos del modal no encontrados.");
              desbloquearEscaneoCritico();
              return resolve(false);
            }

            input.focus();
            input.select();

            const confirmarListener = async () => {
              try {
                const pinIngresado = input.value.trim().toUpperCase();
                console.log("üë§ Usuario actual:", usuario);
                console.log("üîê PIN ingresado:", pinIngresado);

                if (pinIngresado.length !== 6 || !/^[0-9A-F]{6}$/.test(pinIngresado)) {
                  const msg = "‚ö†Ô∏è El PIN debe tener 6 caracteres hexadecimales.";
                  console.warn(msg);
                  document.getElementById("pinError").textContent = msg;
                  document.getElementById("pinError").classList.remove("hidden");
                  return;
                }

                if (!usuario) {
                  console.error("‚ùå 'usuario' no est√° definido al verificar PIN.");
                  document.getElementById("pinError").textContent = "‚ùå No se pudo validar el PIN. Usuario no definido.";
                  document.getElementById("pinError").classList.remove("hidden");
                  return;
                }

                console.log("üîç Verificando PIN para usuario:", usuario);
                const generadoPor = await detectarAdminDesdePIN(pinIngresado);
                console.log("üïµÔ∏è‚Äç‚ôÄÔ∏è PIN generado por:", generadoPor);

                const valido = !!generadoPor;
                console.log("‚úÖ Resultado de verificarPin:", valido);

                if (valido) {
                  mostrarModal("‚úîÔ∏è PIN correcto. Puedes continuar.", "#16a34a");
                  limpiarListeners();
                  desbloquearEscaneoCritico();
                  modal.classList.add("hidden");

                  // Marcar como autorizado en memoria
                  window.autorizacionesExceso = window.autorizacionesExceso || {};
                  window.autorizacionesExceso[claveRemision] = true;
                  console.log("‚úÖ Autorizaci√≥n por PIN guardada para:", claveRemision);

                  // Actualizar Supabase si es una remisi√≥n v√°lida
                  if (numeroRemision) {
                    await fetch(`https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/remisiones_pendientes?numero_remision=eq.${numeroRemision}`, {
                      method: "PATCH",
                      headers: {
                        apikey: API_KEY,
                        Authorization: `Bearer ${API_KEY}`,
                        "Content-Type": "application/json",
                        Prefer: "return=minimal"
                      },
                      body: JSON.stringify({ nip_verificado: true })
                    });
                    console.log("üì• Supabase actualizado: remisi√≥n marcada como verificada");
                  }

                  window.pinAutorizadoPor = generadoPor;
                  resolve(true);
                } else {
                  console.warn("‚ùå PIN incorrecto.");
                  document.getElementById("pinError").textContent = "‚ùå PIN incorrecto. Solicita uno nuevo a un administrador.";
                  document.getElementById("pinError").classList.remove("hidden");
                  input.value = "";
                  input.focus();
                }

              } catch (err) {
                console.error("‚ùå Error en confirmarListener:", err);
                document.getElementById("pinError").textContent = "‚ùå Ocurri√≥ un error inesperado.";
                document.getElementById("pinError").classList.remove("hidden");
              }
            };

            const cancelarListener = () => {
              limpiarListeners();
              desbloquearEscaneoCritico();
              modal.classList.add("hidden");
              resolve(false);
            };

            const keyListener = (e) => {
              if (e.key === "Enter") confirmarListener();
              if (e.key === "Escape") cancelarListener();
            };

            function limpiarListeners() {
              btnConfirmar.removeEventListener("click", confirmarListener);
              btnCancelar.removeEventListener("click", cancelarListener);
              document.removeEventListener("keydown", keyListener);
            }

            btnConfirmar.addEventListener("click", confirmarListener);
            btnCancelar.addEventListener("click", cancelarListener);
            document.addEventListener("keydown", keyListener);
          });
        }

        console.log("‚úÖ Validaci√≥n superada. Se permite continuar.");
        desbloquearEscaneoCritico();
        return true;
      }


      async function validarDotacionAntesDeExtraer(ref, unidadDestino, cantidadSolicitada, usuario) {
        console.log("üîé Validando dotaci√≥n previa para:", { ref, unidadDestino, cantidadSolicitada });

        const fecha = new Date();
        const mes = fecha.getMonth() + 1;
        const anio = fecha.getFullYear();
        const mesAnterior = mes === 1 ? 12 : mes - 1;
        const anioAnterior = mes === 1 ? anio - 1 : anio;

        const colA = `25_${mesAnterior}_${anioAnterior}`;
        const colB = `10_${mes}_${anio}`;

        const urlConsumos = `https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/consumos_mensuales?select=*&referencia=eq.${ref}&unidad_medica=eq.${unidadDestino}`;
        const resConsumos = await fetch(urlConsumos, {
          headers: { apikey: API_KEY, Authorization: `Bearer ${API_KEY}` }
        });
        const registros = await resConsumos.json();
        const consumos = registros?.[0] || {};

        console.log("üì¶ Registro de consumos encontrado:", consumos);

        const sumaConsumos = (parseInt(consumos[colA]) || 0) + (parseInt(consumos[colB]) || 0);

        const urlDotacion = `https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/dotaciones?select=*&referencia=eq.${ref}&unidad=eq.${unidadDestino}`;
        const resDot = await fetch(urlDotacion, {
          headers: { apikey: API_KEY, Authorization: `Bearer ${API_KEY}` }
        });
        const dotacionData = await resDot.json();

        console.log("üìã Datos de dotaci√≥n encontrados:", dotacionData);

        const cantidadPermitida = parseInt(dotacionData?.[0]?.cantidad) || 0;

        console.log("üìä Comparaci√≥n:", {
          cantidadPermitida,
          sumaConsumos,
          cantidadSolicitada,
          total: sumaConsumos + cantidadSolicitada
        });

        if (sumaConsumos + cantidadSolicitada > cantidadPermitida) {
          const pin = await obtenerPin(usuario);
          mostrarModal("üîê Se requiere PIN especial para continuar", "#f87171");
          return false;
        }

        console.log("‚úÖ Dotaci√≥n dentro del l√≠mite permitido.");
        return true;
      }


      async function solicitarPinSilviaSiNecesario(ref, unidadDestino, cantidadSolicitada) {
        const pin = await obtenerPin(usuario, ref, unidadDestino);
        if (!autorizado) return;
        // continuar extracci√≥n normal

        // Mostrar modal e instrucci√≥n
        mostrarModal("üîê Se requiere autorizaci√≥n especial. un administrador debe proporcionarte un CODIGO para continuar.", "#f87171");
        document.getElementById("nipdinamico").value = "";
        document.getElementById("nipdinamico").focus();

        return new Promise((resolve) => {
          // Asumimos que el modal tiene un bot√≥n "Confirmar PIN" con id="btnConfirmarPin"
          const btn = document.getElementById("btnConfirmarPin");

          const listener = async () => {
            const pinIngresado = document.getElementById("nipdinamico").value.trim();
            const valido = await verificarPin(usuario, pinIngresado);

            if (valido) {
              notificar("‚úîÔ∏è PIN correcto. Autorizaci√≥n concedida.", "#16a34a");
              btn.removeEventListener("click", listener);
              document.getElementById("modalPinUnidad").classList.add("hidden");
              resolve(true);
            } else {
              document.getElementById("pinError").textContent = "‚ùå PIN incorrecto. Solicita uno nuevo a Silvia.";
              document.getElementById("pinError").classList.remove("hidden");
              document.getElementById("nipdinamico").value = "";
              document.getElementById("nipdinamico").focus();
            }
          };

          btn.addEventListener("click", listener);
        });
      }


      async function verificarPin(pinIngresado) {
        const admins = ["Silvia", "Luis", "Aida", "Ricardo", "Alex", "Adrian"];
        const ahora = new Date();
        const clave = "medinova-secreto-2025";

        for (const admin of admins) {
          const yyyy = ahora.getUTCFullYear();
          const mm = String(ahora.getUTCMonth() + 1).padStart(2, "0");
          const dd = String(ahora.getUTCDate()).padStart(2, "0");
          const hh = String(ahora.getUTCHours()).padStart(2, "0");
          const bloque = Math.floor(ahora.getUTCMinutes() / 10);
          const base = `${admin.toLowerCase()}::${yyyy}-${mm}-${dd}-${hh}-${bloque}::${clave}`;
          const hash = await sha256(base);
          const generado = hash.substring(0, 6).toUpperCase();

          if (generado === pinIngresado) {
            console.log("‚úÖ PIN verificado. Generado por:", admin);
            desbloquearEscaneoCritico();
            return { valido: true, generadoPor: admin };
          }
        }

        console.warn("‚ùå PIN no coincide con ning√∫n admin");
        return { valido: false, generadoPor: null };
      }


      //==========================================================================================================



      // Nueva funci√≥n independiente
      async function cargarReferencias() {
        const res = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/productos?select=referencia,nombre,fabricante,lote,caducidad,cantidad", {
          headers: {
            "apikey": API_KEY,
            "Authorization": `Bearer ${API_KEY}`
          }
        });
        referenciasCache = await res.json();
      }

      let catalogoUnidadesMap = {};
      async function cargarCatalogoUnidades() {
        try {
          const res = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/representaciones?select=unidad_medica,unidad_nombre", {
            headers: {
              "apikey": API_KEY,
              "Authorization": `Bearer ${API_KEY}`
            }
          });
          const data = await res.json();
          if (Array.isArray(data)) {
            data.forEach(item => {
              catalogoUnidadesMap[item.unidad_medica] = item.unidad_nombre;
            });
            console.log("‚úÖ Cat√°logo de unidades cargado:", Object.keys(catalogoUnidadesMap).length);
          }
        } catch (e) {
          console.error("‚ùå Error cargando cat√°logo de unidades:", e);
        }
      }


      // ‚úÖ Esta es la funci√≥n que estaba faltando
      function buscarReferencia(valor) {
        const cont = document.getElementById("resultadoBusqueda");
        if (!valor || !referenciasCache?.length) {
          cont.innerHTML = "";
          return;
        }

        mostrarResultadosCoincidencias(valor.toLowerCase(), referenciasCache, cont);
      }
      function normalizarFechaExcel(fechaOriginal) {
        if (!fechaOriginal) return "S/C";

        // Si es un n√∫mero (fecha Excel)
        if (typeof fechaOriginal === "number" || !isNaN(Number(fechaOriginal))) {
          const valor = Number(fechaOriginal);
          if (valor > 10000 && valor < 60000) { // valores v√°lidos de Excel
            const baseDate = new Date(Date.UTC(1899, 11, 30));
            baseDate.setDate(baseDate.getDate() + valor);
            return baseDate.toISOString().split("T")[0];
          }
        }

        // Si ya es string tipo fecha
        const fecha = new Date(fechaOriginal);
        if (!isNaN(fecha.getTime())) {
          return fecha.toISOString().split("T")[0];
        }

        return "S/C";
      }


      async function mostrarResultadosCoincidencias(ref, referenciasCache, cont) {
        const q = String(ref || "").trim().toLowerCase();

        const coincidencias = (referenciasCache || []).filter(p =>
          String(p.referencia || "").toLowerCase().includes(q) ||
          String(p.nombre || "").toLowerCase().includes(q)
        );

        if (!coincidencias.length) {
          cont.innerHTML = `
      <div class="space-card rounded-2xl p-4 border border-white/10 bg-white/5">
        <p class="text-sm text-rose-200 font-semibold">‚ùå Producto no encontrado</p>
        <p class="text-xs text-white/60 mt-1">Intenta otra referencia o parte del nombre.</p>
      </div>
    `;
          return;
        }

        // Agrupa por referencia real
        const agrupadas = {};
        coincidencias.forEach(p => {
          const key = String(p.referencia || "").trim();
          if (!agrupadas[key]) agrupadas[key] = [];
          agrupadas[key].push(p);
        });

        let html = "";

        Object.entries(agrupadas).forEach(([refReal, lotes]) => {
          const data = lotes[0] || {};
          const nombre = String(data.nombre || "");
          const fabricante = String(data.fabricante || "");

          // ‚úÖ Ubi segura (evita ReferenceError si no existe)
          const ubi = String(data.ubi || data.ubicacion || data.ubicaci√≥n || "");

          html += `
      <div id="grupo-${escapeHtml(refReal)}" class="space-card rounded-2xl p-4 border border-white/10 bg-white/5 shadow-xl mb-4">
        
        <!-- Header clickable -->
        <div
          class="rounded-2xl px-3 py-3 hover:bg-white/10 transition cursor-pointer flex items-start justify-between gap-3"
            onclick="MAP3D_UI.openFromSearch({referencia:'${escapeJs(refReal)}', nombre:'${escapeJs(nombre)}', fabricante:'${escapeJs(fabricante)}', ubi:'${escapeJs((data.ubi ?? data.ubicacion ?? data.UBI ?? data.ubi_exacta ?? ''))}'})"          role="button"
          tabindex="0"
        >
          <div class="min-w-0 text-left">
            <div class="font-extrabold text-base text-white/90 break-words">
              ${escapeHtml(refReal)}
              <span class="font-bold text-white/70">(${escapeHtml(nombre)})</span>
            </div>
            <div class="text-xs text-white/60 mt-0.5">
              Fabricante: <span class="text-white/80">${escapeHtml(fabricante || "‚Äî")}</span>
            </div>
          </div>

          <!-- Acciones (NO disparan el click del header) -->
          <div class="flex items-center gap-2 shrink-0">
            <button
              type="button"
              onclick="event.stopPropagation(); verMovimientos('${escapeJs(refReal)}')"
              title="Ver movimientos"
              class="space-btn px-3 py-2 rounded-2xl bg-white/5 border border-white/10 hover:bg-white/10 text-white/90"
            >üìö</button>

            <button
              type="button"
              onclick="event.stopPropagation(); verForecast('${escapeJs(refReal)}', '${escapeJs(nombre)}', '${escapeJs(fabricante)}')"
              title="Ver historial de consumo"
              class="space-btn px-3 py-2 rounded-2xl bg-white/5 border border-white/10 hover:bg-white/10 text-white/90"
            >üìä</button>
          </div>
        </div>

        <!-- Tabla -->
        <div class="mt-3 rounded-2xl overflow-hidden border border-white/10">
          <table class="w-full text-xs text-left">
            <thead class="bg-black/30 text-white/90">
              <tr>
                <th class="p-2">Lote</th>
                <th class="p-2 text-right">Cantidad</th>
                <th class="p-2">Caducidad</th>
                <th class="p-2 text-center">‚ö†Ô∏è</th>
              </tr>
            </thead>
            <tbody class="bg-white/5 text-white/85">
              ${lotes.map(l => {
            const dias = calcularDiasRestantes(l.caducidad);
            let icono = "‚ùó";
            let badge = "bg-amber-400/15 text-amber-100 border-amber-300/20";
            if (dias <= 30) { icono = "‚ùó‚ùó‚ùó"; badge = "bg-rose-500/15 text-rose-100 border-rose-300/20"; }
            else if (dias <= 60) { icono = "‚ùó‚ùó"; badge = "bg-amber-500/15 text-amber-100 border-amber-300/20"; }
            else { badge = "bg-emerald-500/10 text-emerald-100 border-emerald-300/20"; }

            return `
                  <tr class="border-t border-white/10">
                    <td class="p-2">${escapeHtml(l.lote ?? "")}</td>
                    <td class="p-2 text-right">${Number(l.cantidad ?? 0)}</td>
                    <td class="p-2">${escapeHtml(normalizarFechaExcel(l.caducidad))}</td>
                    <td class="p-2 text-center">
                      <span class="inline-flex items-center justify-center px-2 py-1 rounded-xl border ${badge}"
                            title="D√≠as restantes: ${Number.isFinite(dias) ? dias : "‚Äî"}">
                        ${icono}
                      </span>
                    </td>
                  </tr>
                `;
          }).join("")}
            </tbody>
          </table>
        </div>

      </div>
    `;
        });

        cont.innerHTML = html;
      }

      /** Helpers seguros */
      function escapeHtml(str) {
        return String(str ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function escapeJs(str) {
        // Para meter strings dentro de atributos onclick='...'
        return String(str ?? "")
          .replaceAll("\\", "\\\\")
          .replaceAll("'", "\\'")
          .replaceAll('"', '\\"')
          .replaceAll("\n", "\\n")
          .replaceAll("\r", "\\r");
      }

      // =============================
      // ‚úÖ MAPHUD fallback (no rompe si MAPHUD no existe)
      // =============================
      window.MAPHUD = window.MAPHUD || {};

      // Si ya tienes MAPHUD.openFromSearch definido en otra parte, este NO lo pisa
      if (typeof window.MAPHUD.openFromSearch !== "function") {
        window.MAPHUD.openFromSearch = function ({ referencia, nombre = "", fabricante = "", ubi = "" } = {}) {
          try {
            console.log("[MAPHUD] openFromSearch fallback", { referencia, nombre, fabricante, ubi });

            // Si existe tu handler real de MAPA3D, √∫salo
            if (typeof window.abrirMapa3DDesdeReferencia === "function") {
              window.abrirMapa3DDesdeReferencia(referencia, ubi);
              return;
            }

            // Si no existe, al menos no truena
            console.warn("[MAPHUD] No existe abrirMapa3DDesdeReferencia(). Implementa el show/hide del m√≥dulo MAPA3D.");
          } catch (err) {
            console.error("[MAPHUD] Error en fallback openFromSearch", err);
          }
        };
      }
      // ‚úÖ Al cargar la p√°gina, carga los productos
      window.addEventListener("DOMContentLoaded", cargarReferencias);

      function ajustarMesLogico(timestamp) {
        const fecha = new Date(Number(timestamp));
        const mes = fecha.getMonth();
        return fecha.getDate() >= 25 ? mes + 1 : mes;
      }

      function agregarFila(ref, lote, estado) {
        const tabla = document.getElementById("tablaRegistros");
        const contenedor = document.getElementById("tablaContenedora");

        // Asegura que el contenedor est√© visible
        contenedor.classList.remove("hidden");
        setTimeout(() => contenedor.classList.remove("opacity-0"), 10);

        // Crea la fila
        const fila = document.createElement("tr");
        fila.innerHTML = `
      <td class='p-1'>${ref}</td>
      <td class='p-1'>${lote}</td>
      <td class='p-1'>${estado}</td>
      <td class='p-1 text-center'><button onclick='eliminarFila(this)' class='text-red-600'>‚úñ</button></td>
    `;
        tabla.appendChild(fila);
      }


      function mostrarMenuModo() {
        // Evitar duplicados
        const existente = document.querySelector(".modal-modo");
        if (existente) existente.remove();

        const contenedor = document.createElement("div");
        contenedor.className = "modal-modo fixed inset-0 z-50 flex items-center justify-center blur-fondo";

        contenedor.innerHTML = `
    <div class="panel-hipotesis rounded-3xl p-6 w-[90%] max-w-sm text-white shadow-2xl">
      
      <div class="flex justify-between items-start mb-4">
        <h2 class="fuente-magma text-xl tracking-wider">
          Selecciona el modo
        </h2>
        <button
          onclick="this.closest('.modal-modo').remove()"
          class="text-red-900 hover:text-red-600 text-xl font-bold">
          √ó
        </button>
      </div>

      <div class="flex flex-col gap-3">

        <!-- ENTRADA -->
        <button
          onclick="solicitarPinModo('entrada', this)"
          class="rounded-2xl py-3 font-semibold text-white shadow-lg
                 bg-gradient-to-r from-green-900/80 to-emerald-700/60
                 hover:from-green-700/80 hover:to-emerald-900/60
                 transition backdrop-blur">
          üì• Modo Entrada
        </button>

        <button 
          onclick="seleccionarModoPreparacion()"
          class="rounded-2xl py-3 font-semibold text-white shadow-lg
                 bg-gradient-to-r from-sky-900/80 to-blue-700/60
                 hover:from-sky-700/80 hover:to-blue-900/60
                 transition backdrop-blur">
          üì¶ Modo Preparaci√≥n
        </button>

        <!-- SALIDA -->
        <button
          onclick="solicitarPinModo('salida', this)"
          class="rounded-2xl py-3 font-semibold text-white shadow-lg
                 bg-gradient-to-r from-red-900/80 to-rose-700/60
                 hover:from-red-900/80 hover:to-rose-900/60
                 transition backdrop-blur">
          üì§ Modo Salida
        </button>

        <!-- CANCELAR -->
        <button
          onclick="this.closest('.modal-modo').remove()"
          class="rounded-2xl py-2 text-sm font-semibold
                 bg-white/10 hover:bg-white/20
                 border border-white/10 transition">
          Cancelar
        </button>

      </div>
    </div>
  `;

        document.body.appendChild(contenedor);

        // Cerrar al hacer click fuera
        contenedor.addEventListener("click", (e) => {
          if (e.target === contenedor) contenedor.remove();
        });
      }


      let nipAdmin = null;

      function solicitarPinModo(tipo, boton) {
        // --- LOGS ---
        console.log("[UI][modo] solicitarPinModo()", { tipo });

        // Cierra el men√∫ flotante de modo (si existe)
        const modalAnterior = boton?.closest?.(".modal-modo");
        if (modalAnterior) modalAnterior.remove();

        // Estado
        modoSeleccionado = tipo;
        unidadSeleccionada = null;

        // Inputs
        const inputNIP = document.getElementById("inputNIP");
        const inputUnidad = document.getElementById("inputUnidad");
        const inputRemision = document.getElementById("inputRemision");
        const pinError = document.getElementById("pinError");

        if (inputNIP) inputNIP.value = "";
        if (inputUnidad) inputUnidad.value = "";
        if (inputRemision) inputRemision.value = "";
        if (pinError) pinError.classList.add("hidden");

        // Grupos
        const unidadGroup = document.getElementById("unidadDestinoGroup");
        const remisionGroup = document.getElementById("remisionGroup");
        const bloqueCargaRemision = document.getElementById("bloqueCargaRemision");

        const esSalida = (tipo === "salida");
        if (unidadGroup) unidadGroup.classList.toggle("hidden", !esSalida);
        if (remisionGroup) remisionGroup.classList.toggle("hidden", !esSalida);
        if (bloqueCargaRemision) bloqueCargaRemision.classList.toggle("hidden", !esSalida);

        // Mostrar modal SIEMPRE centrado (hidden -> flex)
        const modal = document.getElementById("modalPinUnidad");
        if (!modal) {
          console.warn("[UI][modo] No existe #modalPinUnidad");
          return;
        }

        modal.classList.remove("hidden");
        modal.classList.add("flex"); // ‚úÖ CLAVE para que items-center/justify-center funcionen

        // Focus seguro (despu√©s de pintar)
        requestAnimationFrame(() => {
          inputNIP?.focus?.();
          console.log("[UI][modo] modalPinUnidad abierto", { esSalida });
        });
      }



      // üîë Manejador general de Enter para todos los campos:
      ["inputNIP", "inputUnidad", "inputRemision"].forEach(id => {
        document.getElementById(id).addEventListener("keydown", function (e) {
          if (e.key === "Enter") {
            if (id === "inputNIP") {
              const unidadGroup = document.getElementById("unidadDestinoGroup");
              if (!unidadGroup.classList.contains("hidden")) {
                document.getElementById("inputUnidad").focus();
              } else {
                validarPinYUnidad();
              }
            } else if (id === "inputUnidad") {
              const remisionGroup = document.getElementById("remisionGroup");
              if (!remisionGroup.classList.contains("hidden")) {
                document.getElementById("inputRemision").focus();
              } else {
                validarPinYUnidad();
              }
            } else {
              validarPinYUnidad();
            }
          }
        });
      });

      function cerrarModalPin() {
        document.getElementById("modalPinUnidad").classList.add("hidden");
      }



      async function enviarModoInventario() {
        try {
          const res = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/modo_inventario", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ usuario })  // env√≠as solo el usuario
          });

          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Error en modo inventario");

          mostrarModal("üì¶ Modo INVENTARIO completado correctamente", "#22c55e");
        } catch (e) {
          console.error("‚ùå Error en modo inventario:", e);
          mostrarModal("‚ùå Error al ejecutar modo INVENTARIO", "#B00042");
        }

        document.getElementById("modalInventario").classList.add("hidden");
      }

      function mostrarCambioNIP() {
        cerrarModalOpcionesAdmin(); // Asegura que el anterior se cierre
        document.getElementById("modalCambioNIP").classList.remove("hidden");
      }

      function cerrarCambioNIP() {
        document.getElementById("modalCambioNIP").classList.add("hidden");
      }
      async function guardarNuevoNIP() {
        const nipAntiguo = document.getElementById("nipAntiguo").value.trim();
        const nipNuevo = document.getElementById("nipNuevo").value.trim();
        const confirmar = document.getElementById("nipConfirmar").value.trim();
        const error = document.getElementById("cambioNipError");

        if (!nipAntiguo || !nipNuevo || nipNuevo !== confirmar) {
          error.textContent = "‚ùå Los NIPs no coinciden o est√°n vac√≠os.";
          error.classList.remove("hidden");
          return;
        }

        if (nipAntiguo === nipNuevo) {
          error.textContent = "‚ùå El nuevo NIP no puede ser igual al actual.";
          error.classList.remove("hidden");
          return;
        }

        try {
          const payload = {
            nip_admin: nipAntiguo,
            nombre: usuario,
            nuevo_nip: nipNuevo,
            nuevas_unidades: []  // No se cambia ninguna unidad aqu√≠
          };

          const res = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/actualizar_nip", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          if (res.ok) {
            notificar("‚úÖ NIP actualizado correctamente", "#047857");
            cerrarCambioNIP();
          } else {
            error.textContent = "‚ùå Error al actualizar NIP.";
            error.classList.remove("hidden");
          }
        } catch (e) {
          error.textContent = "‚ùå Error de red al guardar NIP.";
          error.classList.remove("hidden");
        }
      }
      async function restablecerNIPUsuario() {
        const nombreUsuario = prompt("Nombre EXACTO del usuario que deseas restablecer:");
        if (!nombreUsuario) {
          notificar("‚ùå Debes ingresar un nombre", "#B00042");
          return;
        }

        const nipAdmin = prompt("NIP del administrador que autoriza:");
        if (!nipAdmin) {
          notificar("‚ùå NIP de administrador requerido", "#B00042");
          return;
        }

        const nuevoNip = prompt("Nuevo NIP para ese usuario:");
        if (!nuevoNip || nuevoNip.length !== 4) {
          notificar("‚ùå NIP inv√°lido (debe ser de 4 d√≠gitos)", "#B00042");
          return;
        }

        const payload = {
          nip_admin: nipAdmin,
          nombre: nombreUsuario,
          nuevo_nip: nuevoNip,
          nuevas_unidades: [] // sin cambios de unidades
        };

        try {
          const res = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/actualizar_nip", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          if (res.ok) {
            notificar("‚úÖ NIP restablecido correctamente", "#16a34a");
          } else {
            const json = await res.json();
            notificar("‚ùå Error al restablecer: " + json.error, "#B00042");

          }
        } catch (err) {
          notificar("‚ùå Error de red", "#B00042");
        }
      }
      function actualizarBotonModo(texto, claseColor, icono) {
        const modo = (texto || "").toLowerCase();

        const btn = document.getElementById("btnModo");
        const contenedor = document.getElementById("estadoUsuario");
        const label = document.getElementById("modoLabel");
        const usuarioTxt = document.getElementById("usuarioActivo"); // <-- este s√≠ existe en tu HTML

        // ====== helpers ======
        const resetBtn = () => {
          if (!btn) return;
          btn.className =
            "px-4 py-2 rounded-2xl text-white text-sm font-semibold shadow-lg " +
            "border border-white/10 bg-white/5 hover:bg-white/10 transition " +
            "backdrop-blur-xl";
        };

        const resetContenedor = () => {
          if (!contenedor) return;
          contenedor.className =
            "cursor-pointer mb-2 px-4 py-4 rounded-2xl text-center shadow-xl transition " +
            "border border-white/10 bg-white/5 hover:bg-white/10 backdrop-blur-xl";
        };

        const resetLabel = () => {
          if (!label) return;
          label.className =
            "inline-flex items-center gap-2 font-bold px-3 py-1 rounded-2xl text-white text-sm " +
            "border border-white/10 backdrop-blur-xl";
        };

        // Siempre resetea a estilo espacial base
        resetBtn();
        resetContenedor();
        resetLabel();

        // Si existe btnModo, aplica texto
        if (btn) btn.innerHTML = `${icono || "üîí"} Modo ${texto || "Inactivo"}`;

        // Si faltan elementos, sal
        if (!contenedor || !label) return;

        // ====== Aplica estilos por modo ======
        if (modo === "entrada") {
          // Bot√≥n superior (si lo usas)
          if (btn) {
            btn.classList.add(
              "bg-gradient-to-r", "from-emerald-900/80", "to-teal-800/60",
              "hover:from-emerald-800/80", "hover:to-teal-700/60",
              "shadow-emerald-500/20"
            );
          }

          // Tarjeta estadoUsuario
          contenedor.classList.add(
            "bg-gradient-to-r", "from-emerald-800/35", "to-teal-900/20",
            "hover:from-emerald-900/45", "hover:to-teal-900/30",
            "text-emerald-100"
          );

          // Label
          label.classList.add(
            "bg-emerald-500/15",
            "border-emerald-400/25",
            "text-emerald-100"
          );

          label.textContent = "ENTRADA";
          if (usuarioTxt && (!usuarioTxt.textContent || usuarioTxt.textContent.includes("Selecciona"))) {
            usuarioTxt.textContent = "Modo activo: Entrada";
          }
          return;
        }

        if (modo === "salida") {
          if (btn) {
            btn.classList.add(
              "bg-gradient-to-r", "from-rose-900/80", "to-red-800/60",
              "hover:from-rose-800/80", "hover:to-red-900/60",
              "shadow-rose-500/20"
            );
          }

          contenedor.classList.add(
            "bg-gradient-to-r", "from-rose-900/35", "to-red-900/20",
            "hover:from-rose-900/45", "hover:to-red-900/30",
            "text-rose-100"
          );

          label.classList.add(
            "bg-rose-500/15",
            "border-rose-400/25",
            "text-rose-100"
          );

          label.textContent = "SALIDA";
          if (usuarioTxt && (!usuarioTxt.textContent || usuarioTxt.textContent.includes("Selecciona"))) {
            usuarioTxt.textContent = "Modo activo: Salida";
          }
          return;
        }

        // ====== INACTIVO ======
        if (btn) {
          btn.classList.add(
            "bg-gradient-to-r", "from-slate-900/70", "to-gray-800/50",
            "hover:from-slate-800/70", "hover:to-gray-700/50",
            "shadow-white/10"
          );
          btn.innerHTML = `üîí Modo Inactivo`;
        }

        contenedor.classList.add(
          "bg-gradient-to-r", "from-white/8", "to-white/4",
          "hover:from-white/10", "hover:to-white/6",
          "text-white/85"
        );

        label.classList.add(
          "bg-white/10",
          "border-white/15",
          "text-white/90"
        );

        label.textContent = "INACTIVO";
        if (usuarioTxt) usuarioTxt.textContent = "Selecciona un modo para iniciar";
      }

      function agregarFila(ref, lote, estado) {
        const tabla = document.getElementById("tablaRegistros");
        const contenedor = document.getElementById("tablaContenedora");

        // Asegura que el contenedor est√© visible
        contenedor.classList.remove("hidden");
        setTimeout(() => contenedor.classList.remove("opacity-0"), 10);

        // Crea la fila
        const fila = document.createElement("tr");
        fila.innerHTML = `
      <td class='p-1'>${ref}</td>
      <td class='p-1'>${lote}</td>
      <td class='p-1'>${estado}</td>
      <td class='p-1 text-center'><button onclick='eliminarFila(this)' class='text-red-600'>‚úñ</button></td>
    `;
        tabla.appendChild(fila);
      }

    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js">function agregarFila(ref, lote, estado) {
        const tabla = document.getElementById("tablaRegistros");
        const contenedor = document.getElementById("tablaContenedora");

        // Asegura que el contenedor est√© visible
        contenedor.classList.remove("hidden");
        setTimeout(() => contenedor.classList.remove("opacity-0"), 10);

        // Crea la fila
        const fila = document.createElement("tr");
        fila.innerHTML = `
      <td class='p-1'>${ref}</td>
      <td class='p-1'>${lote}</td>
      <td class='p-1'>${estado}</td>
      <td class='p-1 text-center'><button onclick='eliminarFila(this)' class='text-red-600'>‚úñ</button></td>
    `;
        tabla.appendChild(fila);
      }

    </script>
    <script>
      //#region 888888888888888888888888888888888888888888888888888888888888888888 FORECAST 88888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
      // ====================== REGRESI√ìN + FORECAST (CORREGIDO Y COHERENTE) ======================

      // ‚úÖ EDITA AQU√ç el horizonte default (6 meses)
      // window.FORECAST_DEFAULT_HORIZON = 6;  // üëà Default 6 meses
      // window.FORECAST_DEFAULT_MERMA_PCT = 5; // üëà Merma default
      // window.FORECAST_DEFAULT_MODELO = "auto"; // auto | arimax | xgboost | ensemble
      // Instancias globales de charts
      //window[instanceKey] = window[instanceKey] || null;
      window.graficaForecastProInstance = window.graficaForecastProInstance || null;
      window.graficaEscenarioCompareInstance = window.graficaEscenarioCompareInstance || null;

      // ---------- Utils ----------
      function escapeHtml(str) {
        return String(str ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function wait2Frames() {
        return new Promise((r) => requestAnimationFrame(() => requestAnimationFrame(r)));
      }

      async function ensureChartJs() {
        if (window.Chart) return true;
        await new Promise((resolve, reject) => {
          const s = document.createElement("script");
          s.src = "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js";
          s.onload = resolve;
          s.onerror = reject;
          document.head.appendChild(s);
        });
        return !!window.Chart;
      }
      function syncVol(v) {
        let val = Number(v);

        // permite escribir "-" temporalmente sin romper
        if (Number.isNaN(val)) return;

        val = Math.max(-100, Math.min(300, val));

        const r = document.getElementById("factorVolForecast");
        const n = document.getElementById("factorVolForecastNum");

        if (r) r.value = String(val);
        if (n) n.value = String(val);
      }

      function fixCanvasSize(id, h = 320) {
        const c = document.getElementById(id);
        if (!c) return;
        c.style.display = "block";
        c.style.width = "100%";
        c.style.height = `${h}px`;
        c.height = h;
      }

      // ---------- UI: Modal Forecast PRO ----------
      function verForecast(referencia, nombre = "", fabricante = "") {
        const anterior = document.getElementById("modalForecast");
        if (anterior) anterior.remove();

        document.documentElement.classList.add("overflow-hidden");
        document.body.classList.add("overflow-hidden");

        const modal = document.createElement("div");
        modal.id = "modalForecast";
        modal.className =
          "fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/70 backdrop-blur-sm";

        modal.innerHTML = `
    <div class="
      panel-hipotesis
      w-[96%] sm:w-[95%] sm:max-w-6xl
      rounded-t-3xl sm:rounded-3xl
      p-4 sm:p-6
      text-white shadow-2xl
      max-h-[92dvh] sm:max-h-[95vh]
      overflow-hidden
      relative
    ">

      <!-- Header -->
      <div class="flex items-start justify-between gap-4 pb-3 border-b border-white/10">
        <div class="min-w-0">
          <h2 class="text-xl sm:text-2xl font-bold fuente-magma tracking-wider">
            Forecast PRO
          </h2>
          <p class="text-xs sm:text-sm text-white/70 mt-1 break-words">
            <span class="text-white/90 font-semibold">${escapeHtml(nombre || referencia)}</span>
            ${fabricante ? `<span class="text-white/50"> ‚Ä¢ ${escapeHtml(fabricante)}</span>` : ""}
          </p>
        </div>

        <button type="button" id="btnCerrarForecast"
          class="shrink-0 w-10 h-10 grid place-items-center rounded-2xl
                 bg-white/5 border border-white/10
                 text-red-900 hover:text-red-700 text-2xl font-bold">
          √ó
        </button>
      </div>

      <!-- Tabs -->
      <div class="mt-3 sticky top-0 z-20 bg-black/60 backdrop-blur-md rounded-2xl border border-white/10">
        <div class="flex gap-2 p-2 overflow-x-auto">
          ${["resumen", "modelos", "escenarios", "evidencia", "entregas", "logs"].map((k, i) => `
            <button type="button"
              class="tab-btn ${i === 0 ? "bg-white/10 text-white" : "bg-white/5 text-white/70"} px-3 py-2 rounded-2xl border border-white/10 hover:bg-white/10 whitespace-nowrap"
              data-tab="${k}">
              ${({
            resumen: "üìå Resumen",
            modelos: "üß† Modelos",
            escenarios: "üß™ Escenarios",
            evidencia: "üßæ Evidencia",
            entregas: "üì¶ Entregas",
            logs: "üß∑ Logs"
          })[k]}
            </button>
          `).join("")}
        </div>
      </div>

      <!-- Body -->
      <div class="pt-4 overflow-y-auto pr-1 max-h-[calc(92dvh-150px)] sm:max-h-[calc(95vh-170px)]">

        <!-- Controls (comunes) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 sm:gap-4 items-end">
          <div class="rounded-2xl p-4 bg-white/5 border border-white/10">
            <label class="block text-sm font-semibold text-white/80">Unidad</label>
            <select id="unidadForecast"
              class="mt-2 w-full px-3 py-2 rounded-2xl bg-black/30 border border-white/10
                     text-white focus:outline-none focus:ring-2 focus:ring-teal-500">
              <option value="TOTAL">Total (suma de consumo)</option>
            </select>
            <p class="text-xs text-white/50 mt-2">Cambia unidad para recalcular.</p>
          </div>

          <div class="rounded-2xl p-4 bg-white/5 border border-white/10">
            <label class="block text-sm font-semibold text-white/80">Horizonte</label>
            <select id="horizonForecast"
              class="mt-2 w-full px-3 py-2 rounded-2xl bg-black/30 border border-white/10 text-white">
              <option value="3">3 meses</option>
              <option value="6" selected>6 meses</option>
              <option value="12">12 meses</option>
            </select>
            <p class="text-xs text-white/50 mt-2">Default: ${Number(window.FORECAST_DEFAULT_HORIZON ?? 6)} meses.</p>
          </div>

          <div class="rounded-2xl p-4 bg-white/5 border border-white/10">
            <label class="block text-sm font-semibold text-white/80">Modelo</label>
            <select id="modeloForecast"
              class="mt-2 w-full px-3 py-2 rounded-2xl bg-black/30 border border-white/10 text-white">
              <option value="auto" selected>Auto (recomendado)</option>
              <option value="arimax">ARIMAX</option>
              <option value="xgboost">XGBoost</option>
              <option value="ensemble">Ensemble</option>
            </select>
            <p class="text-xs text-white/50 mt-2">Puedes comparar sin romper nada.</p>
          </div>
        </div>

        <div id="alertaForecast"
          class="hidden mt-4 rounded-2xl p-3 text-sm text-center
                 bg-black/30 border border-amber-300/30 text-amber-100">
        </div>

        <!-- TAB: RESUMEN -->
        <section id="tab-resumen" class="tab-section mt-4">
          <div id="kpisForecast" class="grid grid-cols-2 lg:grid-cols-6 gap-3"></div>

          <div class="mt-4 grid grid-cols-1 gap-4">
            <div class="rounded-2xl p-4 bg-white/5 border border-white/10">
              <p class="text-sm text-white/70 mb-2">üìä Consumo hist√≥rico</p>
              <div class="relative w-full h-[260px] sm:h-[320px]">
                <canvas id="graficaForecast" class="block w-full h-full"></canvas>
              </div>
            </div>

            <div class="rounded-2xl p-4 bg-white/5 border border-white/10">
              <p class="text-sm text-white/70 mb-2">üîÆ Pron√≥stico (p10 - p50 - p90)</p>
              <div class="relative w-full h-[300px] sm:h-[360px]">
                <canvas id="graficaForecastPro" class="block w-full h-full"></canvas>
              </div>
            </div>

            <div id="accionForecast" class="rounded-2xl p-4 bg-black/30 border border-white/10"></div>
          </div>
        </section>

        <!-- TAB: MODELOS -->
        <section id="tab-modelos" class="tab-section mt-4 hidden">
          <div class="rounded-2xl p-4 bg-white/5 border border-white/10">
            <p class="text-sm text-white/70 mb-2">üìà M√©tricas</p>
            <div id="metricasForecast" class="grid grid-cols-1 sm:grid-cols-3 gap-3"></div>
            <div class="mt-4 text-xs text-white/60" id="explicabilidadForecast"></div>
          </div>
        </section>

        <!-- TAB: ESCENARIOS -->
          <section id="tab-escenarios" class="tab-section mt-4 hidden">

            <!-- Simulaci√≥n -->
            <div class="rounded-2xl p-4 bg-white/5 border border-white/10">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <p class="text-sm text-white/70 mb-1">üß™ Simulaci√≥n (Live)</p>
                  <p class="text-xs text-white/50">
                    Ajusta sliders y ver√°s el impacto <span class="text-white/80 font-semibold">Base vs Escenario</span> en esta pesta√±a y en Resumen.
                  </p>
                </div>

                <button type="button" id="btnVerImpactoResumen"
                  class="shrink-0 px-3 py-2 rounded-2xl bg-white/5 border border-white/10 hover:bg-white/10 text-xs text-white/85">
                  üëÄ Ver impacto en Resumen
                </button>
              </div>

              <!-- CONTROLES (grid) -->
              <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-3">

                
                <!-- MERMA radial -->
                <div class="rounded-2xl p-3 bg-black/20 border border-white/10">
                  <div class="flex items-center justify-between">
                    <label class="text-xs text-white/60">Merma (%)</label>
                    <input id="mermaForecastNum" type="number" value="10" min="0" max="50" step="1"
                      class="w-20 px-2 py-1 rounded-xl bg-black/30 border border-white/5 text-white text-xs text-right" />
                  </div>

                  <div class="mt-3 grid place-items-center">
                    <div id="dialMerma" class="dial" data-min="0" data-max="50" data-step="1" data-value="10"></div>
                  </div>
                </div>

                <!-- VOLUMEN radial -->
                <div class="rounded-2xl p-3 bg-black/20 border border-white/10">
                  <div class="flex items-center justify-between">
                    <label class="text-xs text-white/60">Volumen de Entrega (%)</label>
                    <input id="factorVolForecastNum" type="text" inputmode="numeric" value="0"
                      class="w-24 px-2 py-1 rounded-xl bg-black/30 border border-white/5 text-white text-xs text-right" />
                  </div>

                  <div class="mt-3 grid place-items-center">
                    <div id="dialVol" class="dial" data-min="-100" data-max="300" data-step="1" data-value="0"></div>
                  </div>
                </div>

                <!-- Hint -->
                <div class="flex items-end">
                  <div id="scenarioLiveHint"
                    class="w-full px-4 py-2 rounded-2xl bg-white/5 border border-white/10 text-xs text-white/70 text-center">
                    ‚ö° Live: ajusta sliders y se recalcula solo
                  </div>
                </div>

              </div><!-- /grid -->

              <p class="text-xs text-white/50 mt-3">
                *Ej. Volumen de Entrega: -35 = recorte presupuestal 35%. 0 = entrega completa.
              </p>
            </div>

            <!-- Impacto -->
            <div class="mt-4 rounded-2xl p-4 bg-black/30 border border-white/10">
              <div class="flex items-center justify-between gap-3">
                <p class="text-sm text-white/80 font-semibold">üìå Impacto del escenario</p>
                <span id="scenarioBadge" class="text-xs text-white/60">Base vs Escenario</span>
              </div>

              <div id="scenarioImpactCards" class="mt-3 grid grid-cols-2 lg:grid-cols-4 gap-3"></div>

              <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div class="rounded-2xl p-3 bg-white/5 border border-white/10">
                  <p class="text-xs text-white/60 mb-2">üìâ Mini forecast comparativo (p50)</p>
                  <div class="relative w-full h-[260px]">
                    <canvas id="graficaEscenarioCompare" class="block w-full h-full"></canvas>
                  </div>
                  <div class="mt-4 rounded-2xl p-3">
                    <p class="text-xs text-white/60 mb-2">üîÆ Pron√≥stico completo (p10‚Äìp50‚Äìp90) ‚Ä¢ (Escenarios)</p>
                    <div class="relative w-full h-[260px]">
                      <canvas id="graficaForecastProEscenarios" class="block w-full h-full"></canvas>
                    </div>
                    </div>
                </div>

                <div class="rounded-2xl p-3 bg-white/5 border border-white/10">
                  <p class="text-xs text-white/60 mb-2">üß† Reglas activadas</p>
                  <div id="scenarioRules" class="text-sm text-white/80"></div>

                  <div class="mt-3 rounded-2xl bg-black/30 border border-white/10 p-3">
                    <p class="text-xs text-white/60 mb-2">üìä Estad√≠sticos del escenario</p>
                    <div id="scenarioStats" class="text-xs text-white/70 whitespace-pre-wrap"></div>
                  </div>
                </div>
              </div>
            </div>

          </section>

        <!-- TAB: EVIDENCIA -->
        <section id="tab-evidencia" class="tab-section mt-4 hidden">
          <div class="rounded-2xl p-4 bg-white/5 border border-white/10">
            <p class="text-sm text-white/70 mb-3">üßæ Evidencia usada</p>
            <div id="evidenciaForecast" class="space-y-3"></div>
          </div>
        </section>

        <!-- TAB: ENTREGAS -->
        <section id="tab-entregas" class="tab-section mt-4 hidden">
          <div class="rounded-2xl p-4 bg-white/5 border border-white/10">
            <p class="text-sm text-white/70 mb-3">üì¶ Plan de entrega</p>
            <div id="tablaEntregasForecast" class="text-sm"></div>
          </div>
        </section>

        <!-- TAB: LOGS -->
        <section id="tab-logs" class="tab-section mt-4 hidden">
          <div class="rounded-2xl p-4 bg-white/5 border border-white/10">
            <p class="text-sm text-white/70 mb-3">üß∑ Logs</p>
            <div id="logsForecast" class="text-xs text-white/70 whitespace-pre-wrap"></div>
          </div>
        </section>

        <div class="h-[env(safe-area-inset-bottom)]"></div>
      </div>
    </div>
  `;

        document.body.appendChild(modal);

        const cerrar = () => {
          modal.remove();
          document.removeEventListener("keydown", handleEsc);
          document.documentElement.classList.remove("overflow-hidden");
          document.body.classList.remove("overflow-hidden");
        };

        modal.querySelector("#btnCerrarForecast")?.addEventListener("click", cerrar);
        function handleEsc(e) { if (e.key === "Escape") cerrar(); }
        document.addEventListener("keydown", handleEsc);
        modal.addEventListener("click", (e) => { if (e.target === modal) cerrar(); });

        // Tabs handler
        modal.querySelectorAll(".tab-btn").forEach(btn => {
          btn.addEventListener("click", () => {
            const tab = btn.dataset.tab;
            modal.querySelectorAll(".tab-btn").forEach(b => {
              b.classList.remove("bg-white/10", "text-white");
              b.classList.add("bg-white/5", "text-white/70");
            });
            // ‚úÖ Si el tab contiene charts, fuerza resize/update
            setTimeout(() => {
              try { window[instanceKey]?.resize(); window[instanceKey]?.update(); } catch { }
              try { window.graficaForecastProInstance?.resize(); window.graficaForecastProInstance?.update(); } catch { }
              try { window.graficaEscenarioCompareInstance?.resize(); window.graficaEscenarioCompareInstance?.update(); } catch { }
              try { window.graficaForecastProEscenariosInstance?.resize(); window.graficaForecastProEscenariosInstance?.update(); } catch { }
            }, 80);

            btn.classList.add("bg-white/10", "text-white");
            btn.classList.remove("bg-white/5", "text-white/70");

            modal.querySelectorAll(".tab-section").forEach(sec => sec.classList.add("hidden"));
            modal.querySelector(`#tab-${tab}`)?.classList.remove("hidden");
          });
        });
        // Ir a Resumen desde Escenarios
        modal.querySelector("#btnVerImpactoResumen")?.addEventListener("click", () => {
          modal.querySelector('.tab-btn[data-tab="resumen"]')?.click();
        });

        // Init defaults
        const horizonSel = modal.querySelector("#horizonForecast");
        if (horizonSel) horizonSel.value = String(Number(window.FORECAST_DEFAULT_HORIZON ?? 6));

        const selectUnidad = modal.querySelector("#unidadForecast");
        const selectModelo = modal.querySelector("#modeloForecast");

        const mermaRange = modal.querySelector("#mermaForecast");
        const mermaNum = modal.querySelector("#mermaForecastNum");
        const volRange = modal.querySelector("#factorVolForecast");
        const volNum = modal.querySelector("#factorVolForecastNum");

        const hint = modal.querySelector("#scenarioLiveHint");

        const refreshNow = async () => {
          if (hint) hint.textContent = "‚ö° Recalculando‚Ä¶";
          await cargarForecastPro(referencia);
          if (hint) hint.textContent = "‚úÖ Listo (live)";
        };
        const refresh = debounce(refreshNow, 450);

        // Sync merma
        const syncMerma = (v) => {
          const val = Math.max(0, Math.min(50, Number(v || 0)));
          if (mermaRange) mermaRange.value = String(val);
          if (mermaNum) mermaNum.value = String(val);
        };

        // Sync volumen  ‚úÖ (DECL√ÅRALA ANTES)
        const VOL_MIN = -100;
        const VOL_MAX = 300;

        const syncVol = (raw, { commit = false } = {}) => {
          const s = String(raw ?? "").trim();

          // permite estados intermedios mientras escribe
          if (!commit && (s === "" || s === "-" || s === "-0")) {
            if (volNum) volNum.value = s;
            return;
          }

          // al confirmar, normaliza vac√≠os a 0
          if (commit && (s === "" || s === "-")) {
            if (volNum) volNum.value = "0";
            if (volRange) volRange.value = "0";
            return;
          }

          const valNum = Number(s);
          if (!Number.isFinite(valNum)) return;

          const val = Math.max(VOL_MIN, Math.min(VOL_MAX, valNum));

          if (volRange) volRange.value = String(val);
          if (volNum) volNum.value = String(val);
        };

        // ====== Diales (despu√©s de syncVol) ======
        const dialMermaEl = modal.querySelector("#dialMerma");
        const dialVolEl = modal.querySelector("#dialVol");

        const mermaDial = createRadialDial(dialMermaEl, {
          label: "Merma",
          min: 0, max: 50, step: 1,
          unit: "%",
          colorMode: "fixed",
          onInput: (v) => { syncMerma(v); refresh(); },
          onCommit: (v) => { syncMerma(v); refreshNow(); }
        });

        const volDial = createRadialDial(dialVolEl, {
          label: "Volumen",
          min: -100, max: 300, step: 1,
          unit: "%",
          colorMode: "auto", // negativos teal / positivos dorado
          onInput: (v) => { syncVol(v, { commit: true }); refresh(); },
          onCommit: (v) => { syncVol(v, { commit: true }); refreshNow(); }
        });

        // Input manual mueve dial
        mermaNum?.addEventListener("input", (e) => {
          syncMerma(e.target.value);
          mermaDial?.set(Number(e.target.value || 0));
          refresh();
        });

        if (volNum) {
          // ‚úÖ que el teclado permita "-"
          volNum.setAttribute("inputmode", "text"); // mejor que numeric para permitir "-"
          volNum.setAttribute("autocomplete", "off");
          volNum.setAttribute("spellcheck", "false");

          // ‚úÖ filtro: solo un "-" y solo al inicio
          volNum.addEventListener("beforeinput", (e) => {
            if (e.data == null) return; // borrado, etc.
            const data = e.data;

            // permite d√≠gitos
            if (/^\d$/.test(data)) return;

            // permite "-" SOLO si quedar√° al inicio
            if (data === "-") {
              const start = volNum.selectionStart ?? 0;
              const end = volNum.selectionEnd ?? 0;
              const next = volNum.value.slice(0, start) + "-" + volNum.value.slice(end);

              // v√°lido si "-" est√° solo al inicio y solo una vez
              if (!/^-?\d*$/.test(next)) e.preventDefault();
              return;
            }

            // bloquea todo lo dem√°s
            e.preventDefault();
          });

          // Live mientras escribe
          volNum.addEventListener("input", (e) => {
            syncVol(e.target.value, { commit: false });
            const n = Number(e.target.value);
            if (Number.isFinite(n)) volDial?.set(n);
            refresh();
          });

          // Enter = commit inmediato
          volNum.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              syncVol(volNum.value, { commit: true });
              const n = Number(volNum.value);
              if (Number.isFinite(n)) volDial?.set(n);
              refreshNow();
              volNum.blur();
            }
          });

          // Blur = commit s√≠ o s√≠
          volNum.addEventListener("blur", () => {
            syncVol(volNum.value, { commit: true });
            const n = Number(volNum.value);
            if (Number.isFinite(n)) volDial?.set(n);
            refreshNow();
          });

          // Change fallback
          volNum.addEventListener("change", () => {
            syncVol(volNum.value, { commit: true });
            const n = Number(volNum.value);
            if (Number.isFinite(n)) volDial?.set(n);
            refreshNow();
          });
        }

        // Range volumen mueve dial
        volRange?.addEventListener("input", (e) => {
          syncVol(e.target.value, { commit: true });
          volDial?.set(Number(e.target.value));
          refresh();
        });

        // Load
        (async () => {
          const ok = await ensureChartJs();
          if (!ok) {
            const alerta = document.getElementById("alertaForecast");
            if (alerta) {
              alerta.classList.remove("hidden");
              alerta.textContent = "‚ùå No se pudo cargar Chart.js.";
            }
            return;
          }
          await wait2Frames();
          fixCanvasSize("graficaForecast", 320);
          fixCanvasSize("graficaForecastPro", 360);
          fixCanvasSize("graficaEscenarioCompare", 260);
          fixCanvasSize("graficaForecastProEscenarios", 320);

          await cargarForecastPro(referencia);
        })().catch((err) => {
          console.error("Forecast PRO error:", err);
          const alerta = document.getElementById("alertaForecast");
          if (alerta) {
            alerta.classList.remove("hidden");
            alerta.textContent = "‚ùå Error al cargar forecast: " + (err?.message || err);
          }
        });
      }
      window.verForecast = verForecast;
      // ===== Cache para comparar Base vs Escenario =====
      window.__forecastBaseCache = window.__forecastBaseCache || {}; // key -> data (respuesta completa)
      // ===== Cache + Anti-race (si no existen arriba, d√©jalos tambi√©n) =====
      window.__forecastBaseCache = window.__forecastBaseCache || {}; // key -> respuesta completa
      window.__forecastReqId = window.__forecastReqId || 0;

      /**
       * Forecast PRO (base + escenario live)
       * - Base: merma default + vol 0 (cacheado)
       * - Escenario: merma slider + vol slider (live)
       * - Renderiza Resumen y Escenarios (incluye gr√°ficas)
       */
      async function cargarForecastPro(ref) {
        window.__forecastBaseCache = window.__forecastBaseCache || {};
        window.__forecastReqId = window.__forecastReqId || 0;
        console.groupCollapsed("üìä [Forecast PRO] cargarForecastPro");
        console.log("ref =", ref);

        const selectUnidad = document.getElementById("unidadForecast");
        const alerta = document.getElementById("alertaForecast");

        // Controles
        const horizon = Number(
          document.getElementById("horizonForecast")?.value ??
          (window.FORECAST_DEFAULT_HORIZON ?? 6)
        );

        const modelo = String(
          document.getElementById("modeloForecast")?.value ??
          (window.FORECAST_DEFAULT_MODELO ?? "auto")
        );

        // Inputs escenario (usa los NUM para evitar jitter)
        const mermaPct = Number(
          document.getElementById("mermaForecastNum")?.value ??
          (window.FORECAST_DEFAULT_MERMA_PCT ?? 10)
        );

        const factorVol = Number(
          document.getElementById("factorVolForecastNum")?.value ?? 0
        );

        if (!selectUnidad || !alerta) {
          console.warn("‚ö†Ô∏è [Forecast PRO] faltan elementos del DOM");
          console.groupEnd();
          return;
        }

        const unidad = (selectUnidad.value || "TOTAL").trim();
        const myReqId = ++window.__forecastReqId;

        try {
          alerta.classList.add("hidden");
          alerta.textContent = "";

          // =========================
          // 1) BASE (cacheada)
          // =========================
          const baseKey = `${ref}__${unidad}__h${horizon}__m${modelo}__base`;

          if (!window.__forecastBaseCache[baseKey]) {
            const baseParams = {
              unidad,
              horizon,
              modelo,
              merma_pct: (window.FORECAST_DEFAULT_MERMA_PCT ?? 10), // base estable
              factor_vol_pct: 0
            };

            const baseData = await fetchForecastProData(ref, baseParams);
            window.__forecastBaseCache[baseKey] = baseData;
          }

          const baseData = window.__forecastBaseCache[baseKey];
          const basePro = baseData?.pro || null;

          // =========================
          // 2) ESCENARIO (live)
          // =========================
          const scenParams = {
            unidad,
            horizon,
            modelo,
            merma_pct: mermaPct,
            factor_vol_pct: factorVol
          };

          const data = await fetchForecastProData(ref, scenParams);
          console.log("respuesta escenario =", data);

          // anti-race: ignora respuestas viejas
          if (myReqId !== window.__forecastReqId) {
            console.warn("‚è≠Ô∏è Respuesta vieja ignorada", { myReqId, latest: window.__forecastReqId });
            console.groupEnd();
            return;
          }

          // Logs crudos (√∫tiles para auditar)
          const logsEl = document.getElementById("logsForecast");
          if (logsEl) {
            logsEl.innerHTML = `<pre class="whitespace-pre-wrap bg-white/5 border border-white/10 rounded-2xl p-3">
${escapeHtml(JSON.stringify(data, null, 2))}
</pre>`;
          }

          if (data?.msg) {
            alerta.textContent = String(data.msg);
            alerta.classList.remove("hidden");
          }

          if (data?.error) throw new Error(data.error);

          const pro = data?.pro || null;
          if (!pro) {
            alerta.textContent = "‚ö†Ô∏è Respuesta sin bloque PRO. Revisa backend.";
            alerta.classList.remove("hidden");
            console.groupEnd();
            return;
          }

          // =========================
          // 3) Aplicar Volumen de Entrega (visual/escenario)
          // =========================
          // Nota: NO alteramos hist; solo p10/p50/p90 para simular el evento sobre la demanda/entrega.
          const seriesEsc = aplicarFactorVolumenSeries(pro.series, factorVol);
          const scenPro = { ...pro, series: seriesEsc };

          // =========================
          // 4) Render global (Resumen + dem√°s tabs)
          // =========================
          renderKpisForecast(scenPro);
          renderGraficaConsumo(scenPro);

          // ‚úÖ Pron√≥stico completo en Resumen
          renderGraficaForecastPro(scenPro.series, "graficaForecastPro");

          // ‚úÖ Pron√≥stico completo en Escenarios (mismo motor, canvas distinto)
          renderGraficaForecastPro(scenPro.series, "graficaForecastProEscenarios");

          renderAccionForecast(scenPro);
          renderMetricasYExplicabilidad(scenPro);
          renderEvidenciaForecast(scenPro);
          renderEntregasForecast(scenPro);
          renderLogsForecast(scenPro);

          // =========================
          // 5) Render especial: Escenarios (Base vs Escenario)
          if (window.volDial) {
            // Base = sin simulaci√≥n ‚Üí normalmente 0%
            const baseFactorVol = 0;

            // Escenario = lo que el usuario est√° simulando
            const escenarioFactorVol = factorVol;

            window.volDial.setBoth({
              base: baseFactorVol,
              scenario: escenarioFactorVol
            });
          }

          if (basePro) {
            // Importante: basePro no lleva factorVol del escenario
            renderEscenariosTab({
              basePro,
              scenPro,
              params: { unidad, horizon, modelo, mermaPct, factorVol }
            });
          } else {
            document.getElementById("scenarioImpactCards")?.replaceChildren();
            const rules = document.getElementById("scenarioRules");
            if (rules) rules.innerHTML = `<div class="text-white/60">Sin base para comparar.</div>`;
          }

        } catch (err) {
          console.error("‚ùå [Forecast PRO] Error:", err);
          if (alerta) {
            alerta.textContent = "‚ùå Error al cargar forecast: " + (err?.message || err);
            alerta.classList.remove("hidden");
          }

          // opcional: reset charts si fall√≥ duro
          try { window[instanceKey]?.destroy(); } catch { }
          try { window.graficaForecastProInstance?.destroy(); } catch { }
          try { window.graficaEscenarioCompareInstance?.destroy(); } catch { }
          try { window.graficaForecastProEscenariosInstance?.destroy(); } catch { }

          window[instanceKey] = null;
          window.graficaForecastProInstance = null;
          window.graficaEscenarioCompareInstance = null;
          window.graficaForecastProEscenariosInstance = null;

        } finally {
          console.groupEnd();
        }
      }

      // (por compat, si lo ocupas en otro lado)
      window.cargarForecastPro = cargarForecastPro;
      window.cargarDatosForecastEdge = async (ref) => cargarForecastPro(ref);

      // Helper: arma URL y trae JSON
      async function fetchForecastProData(ref, params) {
        const url =
          `https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/forecast_producto` +
          `?ref=${encodeURIComponent(ref)}` +
          `&unidad=${encodeURIComponent(params.unidad || "TOTAL")}` +
          `&horizon=${encodeURIComponent(params.horizon || (window.FORECAST_DEFAULT_HORIZON ?? 6))}` +
          `&modelo=${encodeURIComponent(params.modelo || "auto")}` +
          `&merma_pct=${encodeURIComponent(params.merma_pct ?? (window.FORECAST_DEFAULT_MERMA_PCT ?? 5))}` +
          `&factor_vol_pct=${encodeURIComponent(params.factor_vol_pct ?? 0)}`;

        const res = await fetch(url);
        if (!res.ok) {
          const txt = await res.text().catch(() => "");
          throw new Error(`HTTP ${res.status}: ${txt || "sin cuerpo"}`);
        }
        return await res.json().catch(() => ({}));
      }
      // ===== Debounce + Anti-race =====
      function debounce(fn, wait = 450) {
        let t = null;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), wait);
        };
      }
      function createRadialDial(el, {
        min, max, step,
        value,                 // escenario (principal)
        baseValue = null,      // base (comparaci√≥n)
        onChange,              // compat: lo llamo en commit con value
        onInput,               // live mientras arrastra
        onCommit,              // al soltar (ideal para refreshNow)
        label = "",
        unit = "",             // e.g. "%"
        formatValue,           // (v)=> string
        colorMode = "auto",    // auto | fixed
      } = {}) {
        if (!el) return;

        // Config desde data-attrs si no lo pasan
        min = (min ?? Number(el.dataset.min ?? 0));
        max = (max ?? Number(el.dataset.max ?? 100));
        step = (step ?? Number(el.dataset.step ?? 1));
        value = (value ?? Number(el.dataset.value ?? min));
        if (baseValue == null && el.dataset.base != null) baseValue = Number(el.dataset.base);

        const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
        const snap = (v) => Math.round(v / step) * step;

        // Dial: arco de 270¬∞ (start=-225 => 135¬∞, end=45¬∞)
        const startDeg = -225, endDeg = 45;

        // SVG
        const size = 152, cx = 76, cy = 76, r = 56;
        const strokeW = 12;

        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.setAttribute("viewBox", `0 0 ${size} ${size}`);
        svg.style.width = "148px";
        svg.style.height = "148px";
        svg.style.touchAction = "none"; // üëà importante en m√≥vil

        // defs: glow
        const defs = document.createElementNS(svg.namespaceURI, "defs");
        defs.innerHTML = `
    <filter id="dialGlow" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur stdDeviation="2.8" result="blur"/>
      <feMerge>
        <feMergeNode in="blur"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>
  `;
        svg.appendChild(defs);

        const mkCircle = (cls) => {
          const c = document.createElementNS(svg.namespaceURI, "circle");
          c.setAttribute("class", cls);
          c.setAttribute("cx", cx);
          c.setAttribute("cy", cy);
          c.setAttribute("r", r);
          c.setAttribute("fill", "none");
          c.setAttribute("stroke-width", strokeW);
          c.setAttribute("stroke-linecap", "round");
          return c;
        };

        // Back plate (opcional)
        const plate = document.createElementNS(svg.namespaceURI, "circle");
        plate.setAttribute("cx", cx);
        plate.setAttribute("cy", cy);
        plate.setAttribute("r", r + 18);
        plate.setAttribute("fill", "rgba(255,255,255,0.03)");
        plate.setAttribute("stroke", "rgba(255,255,255,0.06)");
        plate.setAttribute("stroke-width", "1");

        const bgTrack = mkCircle("bgTrack");    // pista tenue
        const baseArc = mkCircle("baseArc");    // base (comparaci√≥n)
        const valueArc = mkCircle("valueArc");   // escenario (principal)

        // knob
        const knob = document.createElementNS(svg.namespaceURI, "circle");
        knob.setAttribute("class", "knob");
        knob.setAttribute("r", 5.5);

        // texto central
        const tVal = document.createElementNS(svg.namespaceURI, "text");
        tVal.setAttribute("class", "txt");
        tVal.setAttribute("x", cx);
        tVal.setAttribute("y", cy + 6);
        tVal.setAttribute("text-anchor", "middle");

        const tSub = document.createElementNS(svg.namespaceURI, "text");
        tSub.setAttribute("class", "sub");
        tSub.setAttribute("x", cx);
        tSub.setAttribute("y", cy + 28);
        tSub.setAttribute("text-anchor", "middle");
        tSub.textContent = label;

        svg.appendChild(plate);
        svg.appendChild(bgTrack);
        svg.appendChild(baseArc);
        svg.appendChild(valueArc);
        svg.appendChild(knob);
        svg.appendChild(tVal);
        svg.appendChild(tSub);

        el.innerHTML = "";
        el.appendChild(svg);

        // stroke-dash para recortar c√≠rculo a 270¬∞
        const circ = 2 * Math.PI * r;
        const arc = circ * (270 / 360);
        const gap = circ - arc;

        const prepArc = (c) => {
          c.style.strokeDasharray = `${arc} ${gap}`;
          c.style.strokeDashoffset = `${circ * ((360 - 270) / 360)}`;
          c.style.transformOrigin = "50% 50%";
          c.style.transform = "rotate(-135deg)";
        };
        [bgTrack, baseArc, valueArc].forEach(prepArc);

        // estilos default (puedes moverlos a CSS si quieres)
        bgTrack.style.stroke = "rgba(255,255,255,0.18)";

        baseArc.style.stroke = "rgba(2,199,202,0.35)"; // teal base
        baseArc.style.filter = "none";

        valueArc.style.stroke = "rgba(204,163,0,1)";   // dorado escenario default
        valueArc.style.filter = "url(#dialGlow)";

        knob.style.fill = "rgba(255,255,255,0.85)";
        knob.style.stroke = "rgba(0,0,0,0.35)";
        knob.style.strokeWidth = "1";

        tVal.style.fill = "rgba(255,255,255,0.92)";
        tVal.style.fontSize = "20px";
        tVal.style.fontWeight = "800";
        tVal.style.fontFamily = "system-ui, -apple-system, Segoe UI, Roboto";

        tSub.style.fill = "rgba(255,255,255,0.55)";
        tSub.style.fontSize = "11px";
        tSub.style.fontWeight = "600";

        // helpers
        const pct = (v) => (v - min) / (max - min || 1);

        const colorFor = (v) => {
          if (colorMode === "fixed") return { arc: "rgba(204,163,0,1)", fill: "rgba(204,163,0,0.08)" };
          // auto: negativos teal, positivos dorado, cero gris
          if (v < 0) return { arc: "rgba(2,199,202,1)", fill: "rgba(2,199,202,0.10)" };
          if (v > 0) return { arc: "rgba(204,163,0,1)", fill: "rgba(204,163,0,0.10)" };
          return { arc: "rgba(255,255,255,0.55)", fill: "rgba(255,255,255,0.06)" };
        };

        const fmt = (v) => {
          if (typeof formatValue === "function") return formatValue(v);
          const s = (v > 0 ? `+${v}` : String(v));
          return unit ? `${s}${unit}` : s;
        };

        const setArcDash = (circleEl, v) => {
          const p = clamp(pct(v), 0, 1);
          const dash = arc * p;
          circleEl.style.strokeDasharray = `${dash} ${circ - dash}`;
        };

        const setKnobPos = (v) => {
          const p = clamp(pct(v), 0, 1);
          const deg = startDeg + p * (endDeg - startDeg);
          const rad = (deg * Math.PI) / 180;
          knob.setAttribute("cx", cx + Math.cos(rad) * r);
          knob.setAttribute("cy", cy + Math.sin(rad) * r);
        };

        const applyVisual = () => {
          // base
          if (baseValue != null && Number.isFinite(baseValue)) setArcDash(baseArc, baseValue);
          else baseArc.style.strokeDasharray = `0 ${circ}`; // oculta

          // value
          setArcDash(valueArc, value);
          setKnobPos(value);

          const c = colorFor(value);
          valueArc.style.stroke = c.arc;
          tVal.textContent = fmt(value);
        };

        const setByValue = (v, emit = true, mode = "input") => {
          v = snap(clamp(v, min, max));
          value = v;
          el.dataset.value = String(v);

          applyVisual();

          if (!emit) return;

          if (mode === "input" && typeof onInput === "function") onInput(v);
          if (mode === "commit") {
            if (typeof onCommit === "function") onCommit(v);
            if (typeof onChange === "function") onChange(v); // compat
          }
        };

        const valueFromPointer = (clientX, clientY) => {
          const rect = svg.getBoundingClientRect();
          const x = clientX - rect.left - rect.width / 2;
          const y = clientY - rect.top - rect.height / 2;

          let ang = Math.atan2(y, x) * 180 / Math.PI; // -180..180
          const within = (deg) => {
            const d = (deg + 360) % 360;
            return (d >= 135 && d <= 360) || (d >= 0 && d <= 45);
          };

          let a = ang;
          if (!within(a)) {
            const d = ((a + 360) % 360);
            const distToStart = Math.min(Math.abs(d - 135), Math.abs(d - (135 + 360)));
            const distToEnd = Math.min(Math.abs(d - 45), Math.abs(d - (45 + 360)));
            a = distToStart < distToEnd ? startDeg : endDeg;
          }

          const d = ((a + 360) % 360);
          let prog;
          if (d >= 135) prog = (d - 135) / 270;
          else prog = (d + 225) / 270;

          prog = clamp(prog, 0, 1);
          return min + prog * (max - min);
        };

        // drag handling
        let dragging = false;

        const onDown = (e) => {
          dragging = true;
          svg.setPointerCapture?.(e.pointerId);
          setByValue(valueFromPointer(e.clientX, e.clientY), true, "input");
        };

        const onMove = (e) => {
          if (!dragging) return;
          setByValue(valueFromPointer(e.clientX, e.clientY), true, "input");
        };

        const onUp = () => {
          if (!dragging) return;
          dragging = false;
          setByValue(value, true, "commit");
        };

        svg.addEventListener("pointerdown", onDown);
        svg.addEventListener("pointermove", onMove);
        window.addEventListener("pointerup", onUp);

        // init
        value = snap(clamp(value, min, max));
        if (baseValue != null) baseValue = snap(clamp(baseValue, min, max));
        applyVisual();

        return {
          set: (v) => setByValue(v, false),
          get: () => value,
          setBase: (v) => { baseValue = snap(clamp(v, min, max)); el.dataset.base = String(baseValue); applyVisual(); },
          setScenario: (v) => setByValue(v, false),
          setBoth: ({ base, scenario }) => {
            if (base != null) { baseValue = snap(clamp(base, min, max)); el.dataset.base = String(baseValue); }
            if (scenario != null) value = snap(clamp(scenario, min, max));
            el.dataset.value = String(value);
            applyVisual();
          }
        };
      }

      // id incremental para ignorar respuestas viejas
      window.__forecastReqId = window.__forecastReqId || 0;
      // ====== Escenarios: aplicar factor volumen SOLO al forecast (p10/p50/p90) ======
      function aplicarFactorVolumenSeries(series, factorVolPct) {
        const f = 1 + (Number(factorVolPct || 0) / 100);
        if (!Number.isFinite(f) || f <= 0) return series;

        const mult = (arr) =>
          Array.isArray(arr) ? arr.map(v => (v == null ? v : Math.round(Number(v) * f * 100) / 100)) : arr;

        return {
          ...series,
          // hist√≥rico NO lo tocamos; solo el forecast para simular evento
          p10: mult(series?.p10),
          p50: mult(series?.p50),
          p90: mult(series?.p90),
        };
      }

      function n(v, fallback = null) {
        const x = Number(v);
        return Number.isFinite(x) ? x : fallback;
      }

      function fmtDelta(a, b, digits = 2) {
        const A = n(a), B = n(b);
        if (A == null || B == null) return "‚Äî";
        const d = B - A;
        const sign = d > 0 ? "+" : "";
        const val = Math.round(d * Math.pow(10, digits)) / Math.pow(10, digits);
        return `${sign}${val}`;
      }

      function firstForecastP50(series) {
        const p50 = series?.p50;
        if (!Array.isArray(p50) || !p50.length) return null;
        return n(p50[0], null);
      }

      // ====== Render: Escenarios tab (cards + chart p50 base vs escenario) ======
      function renderEscenariosTab({ basePro, scenPro, params }) {
        const cards = document.getElementById("scenarioImpactCards");
        const rules = document.getElementById("scenarioRules");
        const stats = document.getElementById("scenarioStats");
        const badge = document.getElementById("scenarioBadge");

        if (badge) {
          badge.textContent = `Base vs Escenario ‚Ä¢ Merma ${params.mermaPct}% ‚Ä¢ Vol ${params.factorVol}%`;
        }

        // -------- Cards (deltas) --------
        if (cards) {
          const bK = basePro?.kpis || {};
          const sK = scenPro?.kpis || {};

          const bP50 = firstForecastP50(basePro?.series);
          const sP50 = firstForecastP50(scenPro?.series);

          const chip = (title, baseVal, scenVal, suffix = "") => `
      <div class="rounded-2xl p-3 bg-white/5 border border-white/10">
        <p class="text-xs text-white/60">${escapeHtml(title)}</p>
        <div class="mt-1 flex items-baseline justify-between gap-2">
          <p class="text-sm text-white/70">Base: <span class="text-white/90 font-semibold">${escapeHtml(baseVal ?? "‚Äî")}${suffix}</span></p>
          <p class="text-sm text-white/70">Esc: <span class="text-white/90 font-semibold">${escapeHtml(scenVal ?? "‚Äî")}${suffix}</span></p>
        </div>
        <p class="mt-2 text-xs text-white/60">Œî ${escapeHtml(fmtDelta(baseVal, scenVal))}${suffix}</p>
      </div>
    `;

          cards.innerHTML = [
            chip("Forecast p50 (pr√≥x mes)", bP50, sP50, ""),
            chip("Entrega sugerida", bK.entrega_sugerida_prox_mes, sK.entrega_sugerida_prox_mes, ""),
            chip("Cobertura (meses)", bK.cobertura_meses, sK.cobertura_meses, " m"),
            chip("Confianza", bK.confianza, sK.confianza, "/100"),
          ].join("");
        }

        // -------- Rules + stats --------
        if (rules) {
          const bAcc = basePro?.recomendacion?.accion ?? "‚Äî";
          const sAcc = scenPro?.recomendacion?.accion ?? "‚Äî";
          const bRisk = basePro?.recomendacion?.riesgo?.nivel ?? "‚Äî";
          const sRisk = scenPro?.recomendacion?.riesgo?.nivel ?? "‚Äî";

          rules.innerHTML = `
      <div class="rounded-2xl bg-black/30 border border-white/10 p-3">
        <p class="text-xs text-white/60 mb-2">Acci√≥n / Riesgo</p>
        <p class="text-sm text-white/80">Base: <span class="text-white font-semibold">${escapeHtml(bAcc)}</span> ‚Ä¢ Riesgo: <span class="text-white font-semibold">${escapeHtml(bRisk)}</span></p>
        <p class="text-sm text-white/80 mt-1">Esc: <span class="text-white font-semibold">${escapeHtml(sAcc)}</span> ‚Ä¢ Riesgo: <span class="text-white font-semibold">${escapeHtml(sRisk)}</span></p>
      </div>
    `;
        }

        if (stats) {
          const out = {
            params,
            base: {
              p50_next: firstForecastP50(basePro?.series),
              kpis: basePro?.kpis,
            },
            escenario: {
              p50_next: firstForecastP50(scenPro?.series),
              kpis: scenPro?.kpis,
            },
          };
          stats.textContent = JSON.stringify(out, null, 2);
        }

        // -------- Chart p50 compare --------
        renderGraficaEscenarioCompare(basePro?.series, scenPro?.series);
      }

      // ‚ö†Ô∏è Mant√©n compatibilidad por si en alg√∫n lado llamas a cargarDatosForecastEdge
      window.cargarDatosForecastEdge = async (ref) => cargarForecastPro(ref);
      async function cargarDatosForecastEdge(ref, opts = {}) {
        console.groupCollapsed("üìä [Forecast PRO] cargarDatosForecastEdge");
        console.log("ref =", ref, "opts =", opts);

        const alerta = document.getElementById("alertaForecast");
        const selectUnidad = document.getElementById("unidadForecast");
        const canvas = document.getElementById("graficaForecastPro");

        // Elementos PRO
        const kpisEl = document.getElementById("kpisForecast");
        const accionEl = document.getElementById("accionForecast");
        const tablaEl = document.getElementById("tablaForecast");
        const evidenciaEl = document.getElementById("evidenciaForecast");
        const metricasEl = document.getElementById("metricasForecast");
        const expEl = document.getElementById("expForecast");
        const entregasEl = document.getElementById("tablaEntregasForecast");
        const logsEl = document.getElementById("logsForecast");

        console.log("DOM check =", {
          alerta: !!alerta,
          selectUnidad: !!selectUnidad,
          canvas: !!canvas,
          kpisEl: !!kpisEl,
          accionEl: !!accionEl,
          tablaEl: !!tablaEl,
          evidenciaEl: !!evidenciaEl,
          metricasEl: !!metricasEl,
          expEl: !!expEl,
          entregasEl: !!entregasEl,
          logsEl: !!logsEl
        });

        if (!alerta || !selectUnidad || !canvas) {
          console.warn("‚ö†Ô∏è [Forecast PRO] faltan elementos base del DOM");
          console.groupEnd();
          return;
        }

        alerta.classList.add("hidden");
        alerta.textContent = "";

        // Limpia secciones para que notes que se est√° re-renderizando
        if (kpisEl) kpisEl.innerHTML = "";
        if (accionEl) accionEl.innerHTML = "";
        if (tablaEl) tablaEl.innerHTML = "";
        if (evidenciaEl) evidenciaEl.innerHTML = "";
        if (metricasEl) metricasEl.innerHTML = "";
        if (expEl) expEl.innerHTML = "";
        if (entregasEl) entregasEl.innerHTML = "";

        const ctx = canvas.getContext("2d");

        // Destroy chart anterior
        if (window[instanceKey]) {
          try { window[instanceKey].destroy(); } catch { }
          window[instanceKey] = null;
        }

        // Params
        const unidad = opts.unidad ?? (selectUnidad.value || "TOTAL");
        const horizon = Number(opts.horizon ?? (window.FORECAST_DEFAULT_HORIZON ?? 6));
        const merma_pct = Number(opts.merma_pct ?? (window.FORECAST_DEFAULT_MERMA_PCT ?? 5));
        const modelo = String(opts.modelo ?? (window.FORECAST_DEFAULT_MODELO ?? "auto"));

        const esc = opts.escenario;
        const escTipo = esc?.tipo ?? "";
        const escFactor = Number(esc?.factor ?? 0);

        const url =
          `https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/forecast_producto` +
          `?ref=${encodeURIComponent(ref)}` +
          `&unidad=${encodeURIComponent(unidad)}` +
          `&horizon=${encodeURIComponent(horizon)}` +
          `&modelo=${encodeURIComponent(modelo)}` +
          `&merma_pct=${encodeURIComponent(merma_pct)}` +
          (esc ? `&esc_tipo=${encodeURIComponent(escTipo)}&esc_factor=${encodeURIComponent(escFactor)}` : "");

        console.log("fetch =", url);

        try {
          const res = await fetch(url);

          if (!res.ok) {
            const txt = await res.text().catch(() => "");
            throw new Error(`HTTP ${res.status}: ${txt || "sin cuerpo"}`);
          }

          const data = await res.json().catch(() => ({}));
          console.log("respuesta =", data);

          // Logs SIEMPRE
          if (logsEl) {
            logsEl.innerHTML = `<pre class="whitespace-pre-wrap bg-white/5 border border-white/10 rounded-2xl p-3">
${escapeHtml(JSON.stringify(data, null, 2))}
</pre>`;
          }

          if (data?.msg) {
            alerta.textContent = String(data.msg);
            alerta.classList.remove("hidden");
          }

          if (data?.error) throw new Error(data.error);

          // Poblar unidades desde consumo (compat)
          if (data?.consumo && typeof data.consumo === "object") {
            const unidades = Object.keys(data.consumo).sort();

            selectUnidad.innerHTML = "";
            const optTotal = document.createElement("option");
            optTotal.value = "TOTAL";
            optTotal.textContent = "TOTAL (suma consumo)";
            selectUnidad.appendChild(optTotal);

            unidades.forEach((u) => {
              const datosUnidad = data.consumo?.[u] || {};
              const tiene = Object.values(datosUnidad).some((v) => v !== 0 && v != null);
              if (tiene) {
                const opt = document.createElement("option");
                opt.value = u;
                opt.textContent = u;
                selectUnidad.appendChild(opt);
              }
            });

            // asegura valor
            if ([...selectUnidad.options].some(o => o.value === unidad)) {
              selectUnidad.value = unidad;
            }
          }

          const pro = data?.pro;

          // Si no hay PRO, muestra algo visible
          if (!pro) {
            alerta.textContent = "‚ö†Ô∏è Respuesta sin bloque PRO. Revisa backend.";
            alerta.classList.remove("hidden");
            console.groupEnd();
            return;
          }

          // ====== KPIs (pinta aunque falle todo lo dem√°s) ======
          if (kpisEl) {
            const k = pro.kpis || {};
            const chip = (label, value) => `
        <div class="rounded-2xl p-3 bg-white/5 border border-white/10">
          <p class="text-xs text-white/60">${escapeHtml(label)}</p>
          <p class="text-lg font-bold text-white">${escapeHtml(value)}</p>
        </div>
      `;

            kpisEl.innerHTML =
              chip("Consumo prom 6M", (k.consumo_prom_6m ?? "‚Äî")) +
              chip("Tendencia", (k.tendencia_pct != null ? `${k.tendencia_pct}%` : "‚Äî")) +
              chip("Stock actual", (k.stock_actual ?? "‚Äî")) +
              chip("Cobertura", (k.cobertura_meses != null ? `${k.cobertura_meses} meses` : "‚Äî")) +
              chip("Entrega sugerida", (k.entrega_sugerida_prox_mes ?? "‚Äî")) +
              chip("Confianza", (k.confianza != null ? `${k.confianza}/100` : "‚Äî"));
          }

          // ====== Gr√°fica ======
          try { if (ctx) renderGraficaForecastPro(ctx, pro.series); }
          catch (e) { console.error("‚ùå gr√°fica PRO fall√≥:", e); }

          // ====== Acci√≥n ======
          if (accionEl) {
            const r = pro.recomendacion || {};
            const nivel = r?.riesgo?.nivel || "‚Äî";
            const motivos = Array.isArray(r.motivos)
              ? r.motivos.map(m => `‚Ä¢ ${escapeHtml(m.text || m)}`).join("<br/>")
              : "‚Äî";

            accionEl.innerHTML = `
        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
          <div>
            <p class="text-sm text-white/60">Acci√≥n recomendada</p>
            <p class="text-xl font-bold text-white mt-1">${escapeHtml(r.accion || "‚Äî")}</p>
            <p class="text-sm text-white/80 mt-2">Entrega sugerida: <span class="font-semibold">${escapeHtml(r.entrega_sugerida ?? "‚Äî")}</span></p>
            <p class="text-sm text-white/80 mt-1">Riesgo: <span class="font-semibold">${escapeHtml(nivel)}</span></p>
          </div>
          <div class="text-sm text-white/70 bg-white/5 border border-white/10 rounded-2xl p-3 sm:max-w-[50%]">
            <p class="text-xs text-white/60 mb-2">Motivos</p>
            ${motivos}
          </div>
        </div>
      `;
          }

          // ====== Tabla / Evidencia / Entregas ======
          try { if (tablaEl) tablaEl.innerHTML = renderTablaForecast(pro.series); }
          catch (e) { console.error("‚ùå tabla fall√≥:", e); }

          try { if (evidenciaEl) evidenciaEl.innerHTML = renderEvidencia(pro.evidencia); }
          catch (e) { console.error("‚ùå evidencia fall√≥:", e); }

          try {
            if (metricasEl) {
              const b = pro.backtest || {};
              metricasEl.innerHTML = `
        <div class="rounded-2xl p-3 bg-white/5 border border-white/10">
          <p class="text-xs text-white/60">MAPE</p><p class="text-lg font-bold text-white">${escapeHtml(b.mape != null ? b.mape + "%" : "‚Äî")}</p>
        </div>
        <div class="rounded-2xl p-3 bg-white/5 border border-white/10">
          <p class="text-xs text-white/60">MAE</p><p class="text-lg font-bold text-white">${escapeHtml(b.mae ?? "‚Äî")}</p>
        </div>
        <div class="rounded-2xl p-3 bg-white/5 border border-white/10">
          <p class="text-xs text-white/60">RMSE</p><p class="text-lg font-bold text-white">${escapeHtml(b.rmse ?? "‚Äî")}</p>
        </div>
      `;
            }
          } catch (e) { console.error("‚ùå m√©tricas fall√≥:", e); }

          try {
            if (expEl) {
              const top = pro.explain?.top_features;
              expEl.innerHTML = Array.isArray(top)
                ? `<ul class="list-disc pl-5">${top.map(x => `<li>${escapeHtml(String(x))}</li>`).join("")}</ul>`
                : `<div class="text-white/60">‚Äî</div>`;
            }
          } catch (e) { console.error("‚ùå explain fall√≥:", e); }

          try { if (entregasEl) entregasEl.innerHTML = renderEntregas(pro.entregas); }
          catch (e) { console.error("‚ùå entregas fall√≥:", e); }

        } catch (err) {
          console.error("‚ùå [Forecast PRO] Error:", err);
          if (ctx) ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
          alerta.textContent = "‚ùå Error al cargar forecast: " + (err?.message || err);
          alerta.classList.remove("hidden");
        } finally {
          console.groupEnd();
        }
      }

      function renderKpisForecast(pro) {
        const wrap = document.getElementById("kpisForecast");
        if (!wrap) return;

        const k = pro?.kpis || {};
        const items = [
          ["Consumo prom 6M", k.consumo_prom_6m],
          ["Tendencia", k.tendencia_pct != null ? `${k.tendencia_pct}%` : null],
          ["Stock actual (almac√©n)", k.stock_actual],
          ["Cobertura", k.cobertura_meses != null ? `${k.cobertura_meses} meses` : null],
          ["Entrega sugerida", k.entrega_sugerida_prox_mes],
          ["Confianza", k.confianza != null ? `${k.confianza}/100` : null],
        ];

        wrap.innerHTML = items.map(([t, v]) => `
    <div class="rounded-2xl p-3 bg-white/5 border border-white/10">
      <p class="text-xs text-white/60">${escapeHtml(t)}</p>
      <p class="text-lg font-bold text-white">${escapeHtml(v ?? "‚Äî")}</p>
    </div>
  `).join("");
      }

      function renderGraficaConsumo(pro, canvasId = "graficaForecast") {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;

        const isHUD = (canvasId === "graficaForecastHUD");

        // Tama√±o
        canvas.style.display = "block";
        canvas.style.width = "100%";

        const HUD_H = 140;
        const FULL_H = 360;
        const targetH = isHUD ? HUD_H : FULL_H;

        canvas.style.height = `${targetH}px`;
        canvas.height = targetH;

        const ctx = canvas.getContext("2d");
        if (!ctx) return;

        const histL = pro?.series?.hist_labels || [];
        const histV = (pro?.series?.hist_values || []).map(v => Number(v) || 0);
        if (!histL.length) return;

        const instanceKey = isHUD ? "graficaForecastHUDInstance" : "graficaForecastInstance";

        if (window[instanceKey]) {
          const ch = window[instanceKey];
          ch.data.labels = histL;
          ch.data.datasets[0].data = histV;
          ch.update();
          return;
        }

        window[instanceKey] = new Chart(ctx, {
          type: "line",
          data: {
            labels: histL,
            datasets: [{
              label: isHUD ? "" : "Consumo",
              data: histV,
              fill: true,
              borderColor: "#02c7ca",
              backgroundColor: "rgba(2, 199, 202, 0.10)",
              tension: 0.3,
              pointRadius: isHUD ? 0 : 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 450, easing: "easeOutQuart" },
            plugins: {
              legend: { display: !isHUD, labels: { color: "#E5E7EB" } },
              title: { display: !isHUD, text: "Consumo mensual", color: "#E5E7EB" }
            },
            scales: {
              x: {
                ticks: {
                  color: "#CBD5E1",
                  maxRotation: isHUD ? 0 : 45,
                  minRotation: isHUD ? 0 : 30,
                  font: isHUD ? { size: 10 } : undefined,
                  autoSkip: true,
                  maxTicksLimit: isHUD ? 6 : 12
                },
                grid: { color: "rgba(255,255,255,0.08)" }
              },
              y: {
                beginAtZero: true,
                ticks: { color: "#CBD5E1" },
                grid: { color: "rgba(255,255,255,0.08)" }
              }
            }
          }
        });
      }
      function fadeAlpha(index, total, { min = 0.18, max = 1, power = 1.35 } = {}) {
        if (total <= 1) return max;
        const t = Math.max(0, Math.min(1, index / (total - 1)));
        const eased = Math.pow(t, power);
        return min + (max - min) * eased;
      }
      function renderGraficaForecastPro(series, canvasId = "graficaForecastPro") {
        try {
          const canvas = document.getElementById(canvasId);
          if (!canvas) return;
          const isHUD = (canvasId === "graficaForecastProHUD");
          if (!window.Chart) {
            console.warn("‚ö†Ô∏è Chart.js no est√° cargado");
            return;
          }

          // Tama√±o (si tab estaba hidden)
          canvas.style.display = "block";
          canvas.style.width = "100%";
          canvas.style.height = "360px";
          canvas.height = 360;

          const ctx = canvas.getContext("2d");
          if (!ctx) return;

          const histLabels = [...(series?.hist_labels || [])];
          const histValues = (series?.hist_values || []).map(v => toNum(v));

          const fcLabels = [...(series?.fc_labels || [])];
          const p10F = (series?.p10 || []).map(v => toNum(v));
          const p50F = (series?.p50 || []).map(v => toNum(v));
          const p90F = (series?.p90 || []).map(v => toNum(v));
          // ‚úÖ SOLO HUD: recorta a √∫ltimos 5 hist + pr√≥ximos 3 forecast
          if (isHUD) {
            const HIST_KEEP = 5;
            const FC_KEEP = 3;

            // 1) Hist: √∫ltimos 5
            const hStart = Math.max(0, histLabels.length - HIST_KEEP);
            histLabels.splice(0, hStart);
            histValues.splice(0, hStart);

            // 2) Forecast: primeros 3
            fcLabels.splice(FC_KEEP);
            p10F.splice(FC_KEEP);
            p50F.splice(FC_KEEP);
            p90F.splice(FC_KEEP);
          }
          if (!histLabels.length) {
            console.warn("‚ö†Ô∏è Sin hist_labels");
            return;
          }

          const histLen = histLabels.length;
          const futLen = fcLabels.length;

          // Labels globales
          let labels = [...histLabels, ...fcLabels];

          // ‚úÖ SOLO HUD: mostrar MM/YY (ej: 08/28)
          // - Si llega "2028-08" o "2028-08-10" -> "08/28"
          // - Si llega algo raro -> lo deja igual
          const formatHudLabel = (s) => {
            const str = String(s ?? "").trim();

            // YYYY-MM o YYYY-MM-DD
            const m = str.match(/^(\d{4})-(\d{2})(?:-(\d{2}))?$/);
            if (m) {
              const yy = m[1].slice(2);   // "28"
              const mm = m[2];            // "08"
              return `${mm}/${yy}`;       // "08/28"
            }

            // Si ya viene como "2028-8" (sin cero) -> normaliza
            const m2 = str.match(/^(\d{4})-(\d{1,2})$/);
            if (m2) {
              const yy = m2[1].slice(2);
              const mm = String(m2[2]).padStart(2, "0");
              return `${mm}/${yy}`;
            }

            return str;
          };

          if (isHUD) labels = labels.map(formatHudLabel);
          // Serie real
          const realFull = [...histValues, ...Array(futLen).fill(null)];

          // ===== FITTED HIST√ìRICO =====
          const ma = (arr, i, w) => {
            const a = arr.slice(Math.max(0, i - w + 1), i + 1);
            return a.length ? mean(a) : null;
          };

          const fittedHist = histValues.map((v, i) => {
            if (i >= 12) return histValues[i - 12];
            const m = ma(histValues, i, 6);
            return m == null ? histValues[i] : m;
          });

          // Banda hist√≥rica: usa ancho promedio del forecast futuro
          const wUp = mean(p90F.map((v, i) => v - (p50F[i] ?? 0)).filter(isFiniteNum)) || 0;
          const wDn = mean(p50F.map((v, i) => (p50F[i] ?? 0) - (p10F[i] ?? 0)).filter(isFiniteNum)) || 0;

          const fittedP50Hist = fittedHist.map(x => round2(x));
          const fittedP10Hist = fittedHist.map(x => round2(Math.max(0, x - wDn)));
          const fittedP90Hist = fittedHist.map(x => round2(Math.max(0, x + wUp)));

          // Full (hist fitted + futuro)
          const p50Full = [...fittedP50Hist, ...p50F.map(round2)];
          const p10Full = [...fittedP10Hist, ...p10F.map(round2)];
          const p90Full = [...fittedP90Hist, ...p90F.map(round2)];

          // ===== Fade solo en hist√≥rico =====
          const alphaFor = (idx, { min, max, power }) => {
            if (idx >= histLen) return max; // futuro full visible
            return fadeAlpha(idx, histLen, { min, max, power });
          };

          // Instancia por canvas
          const instanceKey =
            canvasId === "graficaForecastProEscenarios"
              ? "graficaForecastProEscenariosInstance"
              : canvasId === "graficaForecastProHUD"
                ? "graficaForecastProHUDInstance"
                : "graficaForecastProInstance";

          // ‚úÖ MORPH
          if (window[instanceKey]) {
            const ch = window[instanceKey];
            const oldCanvas = ch?.canvas;

            if (!oldCanvas || !oldCanvas.isConnected || oldCanvas.id !== canvasId) {
              try { ch.destroy(); } catch { }
              window[instanceKey] = null;
            } else {
              ch.data.labels = labels;
              ch.data.datasets[0].data = realFull;
              ch.data.datasets[1].data = p10Full;
              ch.data.datasets[2].data = p90Full;
              ch.data.datasets[3].data = p50Full;

              // importante: para que Chart recalcule bien los callbacks
              ch.update();
              setTimeout(() => { try { ch.resize(); ch.update(); } catch { } }, 80);
              return;
            }
          }

          // ‚úÖ CREAR
          window[instanceKey] = new Chart(ctx, {
            type: "line",
            data: {
              labels,
              datasets: [
                // 0) Real
                {
                  label: "Hist√≥rico (real)",
                  data: realFull,
                  tension: 0.3,
                  pointRadius: 2,
                  borderColor: "#02c7ca",
                  backgroundColor: "rgba(2,199,202,0.08)",
                  fill: true,
                  spanGaps: true,
                  order: 1
                },

                // 1) p10
                {
                  label: "p10 (modelo)",
                  data: p10Full,
                  tension: 0.3,
                  pointRadius: 0,
                  borderWidth: 2,

                  // ‚úÖ color estable en leyenda
                  borderColor: "rgba(255,255,255,0.35)",
                  backgroundColor: "rgba(0,0,0,0)",
                  fill: false,
                  spanGaps: true,
                  order: 2,

                  segment: {
                    borderColor: (seg) => {
                      const i = seg.p0DataIndex ?? 0;
                      const a = alphaFor(i, { min: 0.05, max: 0.35, power: 1.2 });
                      return `rgba(255,255,255,${a})`;
                    }
                  }
                },

                // 2) p90 con fill hacia p10
                {
                  label: "Banda p10‚Äìp90",
                  data: p90Full,
                  tension: 0.3,
                  pointRadius: 0,
                  borderWidth: 2,

                  // ‚úÖ leyenda estable
                  borderColor: "rgba(255,255,255,0.35)",

                  // ‚úÖ AQU√ç est√° la magia: el fill necesita backgroundColor propio
                  backgroundColor: (c) => {
                    const i = c.dataIndex ?? 0;
                    const a = alphaFor(i, { min: 0.02, max: 0.36, power: 1.25 });
                    return `rgba(255,255,255,${a})`;
                  },

                  fill: { target: 1 }, // hacia p10
                  spanGaps: true,      // importante para que la banda no se rompa por nulls
                  order: 3,

                  segment: {
                    borderColor: (seg) => {
                      const i = seg.p0DataIndex ?? 0;
                      const a = alphaFor(i, { min: 0.05, max: 0.35, power: 1.2 });
                      return `rgba(255,255,255,${a})`;
                    }
                  }
                },

                // 3) p50
                {
                  label: "Forecast p50 (modelo)",
                  data: p50Full,
                  tension: 0.3,
                  pointRadius: 0,
                  borderWidth: 3,

                  // ‚úÖ leyenda estable
                  borderColor: "rgba(204,163,0,1)",
                  backgroundColor: "rgba(204,163,0,0.08)",
                  fill: false,
                  spanGaps: true,
                  order: 4,

                  segment: {
                    borderColor: (seg) => {
                      const i = seg.p0DataIndex ?? 0;
                      const a = alphaFor(i, { min: 0.12, max: 1, power: 1.3 });
                      return `rgba(204,163,0,${a})`;
                    }
                  }
                }
              ]
            },

            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: { mode: "index", intersect: false },

              animation: { duration: 450, easing: "easeOutQuart" },

              clip: 0,

              plugins: {
                legend: isHUD ? { display: false } : {
                  position: "top",
                  labels: { color: "#E5E7EB" }
                },
                title: {
                  display: !isHUD,
                  text: "Pron√≥stico (p10‚Äìp50‚Äìp90) sobre toda la serie",
                  color: "#E5E7EB"
                },
                tooltip: { mode: "index", intersect: false }
              },
              layout: {
                padding: isHUD
                  ? { left: 6, right: 8, top: 2, bottom: 6 }
                  : { left: 10, right: 16, top: 8, bottom: 8 }
              },
              scales: {
                x: {
                  ticks: {
                    color: "#CBD5E1",
                    maxRotation: isHUD ? 0 : 45,
                    minRotation: isHUD ? 0 : 30,
                    font: isHUD ? { size: 10 } : undefined
                  },
                },
                y: {
                  beginAtZero: true,
                  ticks: { color: "#CBD5E1", precision: 0 },
                  grid: { color: "rgba(255,255,255,0.08)" }
                }
              }
            }
          });

          setTimeout(() => {
            try { window[instanceKey]?.resize(); window[instanceKey]?.update(); } catch { }
          }, 80);

        } catch (e) {
          console.error("‚ùå renderGraficaForecastPro fall√≥:", e);
        }

        // Helpers locales
        function toNum(v) { const n = Number(v); return Number.isFinite(n) ? n : 0; }
        function mean(arr) { return arr.length ? arr.reduce((s, x) => s + x, 0) / arr.length : 0; }
        function round2(x) { return Math.round((toNum(x)) * 100) / 100; }
        function isFiniteNum(x) { return typeof x === "number" && Number.isFinite(x); }
      }


      function renderAccionForecast(pro) {
        const box = document.getElementById("accionForecast");
        if (!box) return;

        const rec = pro?.recomendacion || {};
        const riesgo = rec?.riesgo || {};
        const motivos = Array.isArray(rec?.motivos) ? rec.motivos : [];

        const modelo = pro?.log?.modelo_solicitado ?? "‚Äî";
        const horizon = pro?.log?.horizon ?? "‚Äî";

        box.innerHTML = `
    <div class="flex items-start justify-between gap-3">
      <div>
        <p class="text-sm text-white/70">üìå Acci√≥n recomendada</p>
        <p class="text-xl font-bold text-white mt-1">${escapeHtml(rec.accion ?? "‚Äî")}</p>
        <p class="text-sm text-white/80 mt-2">
          Entrega sugerida: <span class="font-semibold">${escapeHtml(rec.entrega_sugerida ?? "‚Äî")}</span>
        </p>
        <p class="text-xs text-white/60 mt-2">
          Riesgo: <span class="text-white/90 font-semibold">${escapeHtml(riesgo.nivel ?? "‚Äî")}</span>
          ${riesgo.detalle ? ` ‚Ä¢ ${escapeHtml(riesgo.detalle)}` : ""}
        </p>
      </div>
      <div class="text-xs text-white/60 text-right">
        <p>Modelo: <span class="text-white/90">${escapeHtml(modelo)}</span></p>
        <p>Horizonte: <span class="text-white/90">${escapeHtml(horizon)}</span></p>
      </div>
    </div>

    ${motivos.length ? `
      <div class="mt-3 rounded-2xl bg-white/5 border border-white/10 p-3">
        <p class="text-xs text-white/60 mb-2">Motivos</p>
        <ul class="list-disc pl-5 text-sm text-white/85">
          ${motivos.map(m => `<li>${escapeHtml(m.text ?? m.code ?? "")}</li>`).join("")}
        </ul>
      </div>
    ` : ""}
  `;
      }

      function renderMetricasYExplicabilidad(pro) {
        const met = document.getElementById("metricasForecast");
        const exp = document.getElementById("explicabilidadForecast");
        if (!met || !exp) return;

        const b = pro?.backtest || {};
        met.innerHTML = [
          ["MAPE", b.mape != null ? `${b.mape}%` : "‚Äî"],
          ["MAE", b.mae != null ? b.mae : "‚Äî"],
          ["RMSE", b.rmse != null ? b.rmse : "‚Äî"],
        ].map(([t, v]) => `
    <div class="rounded-2xl p-3 bg-black/30 border border-white/10">
      <p class="text-xs text-white/60">${escapeHtml(t)}</p>
      <p class="text-lg font-bold text-white">${escapeHtml(v)}</p>
    </div>
  `).join("");

        const explain = pro?.explain || null;
        exp.textContent = explain ? JSON.stringify(explain, null, 2) : "Sin explicabilidad disponible (backend no la envi√≥).";
      }


      function renderEvidenciaForecast(pro) {
        const wrap = document.getElementById("evidenciaForecast");
        if (!wrap) return;

        const ev = pro?.evidencia || {};
        const blocks = Object.entries(ev);

        if (!blocks.length) {
          wrap.innerHTML = `<div class="text-white/60 text-sm">Sin evidencia disponible.</div>`;
          return;
        }

        wrap.innerHTML = blocks.map(([key, obj]) => {
          const source = obj?.source ?? "‚Äî";
          const keys = obj?.keys ? JSON.stringify(obj.keys, null, 2) : "";
          const rows = Array.isArray(obj?.rows) ? obj.rows : [];

          return `
      <div class="rounded-2xl p-3 bg-black/30 border border-white/10">
        <div class="flex items-center justify-between gap-3">
          <p class="text-sm font-semibold text-white">${escapeHtml(key)}</p>
          <span class="text-xs text-white/60">Fuente: ${escapeHtml(source)}</span>
        </div>
        ${keys ? `<pre class="mt-2 text-[11px] text-white/70 overflow-x-auto">${escapeHtml(keys)}</pre>` : ""}
        ${rows.length ? `
          <div class="mt-2 rounded-2xl border border-white/10 overflow-hidden">
            <div class="max-h-[220px] overflow-auto">
              <pre class="p-2 text-[11px] text-white/70">${escapeHtml(JSON.stringify(rows.slice(0, 50), null, 2))}</pre>
            </div>
          </div>
        ` : `<p class="mt-2 text-xs text-white/60">Sin filas (backend no envi√≥ rows).</p>`}
      </div>
    `;
        }).join("");
      }


      function renderEntregasForecast(pro) {
        const wrap = document.getElementById("tablaEntregasForecast");
        if (!wrap) return;

        const rows = Array.isArray(pro?.entregas) ? pro.entregas : [];
        if (!rows.length) {
          wrap.innerHTML = `<div class="text-white/60 text-sm">Sin plan de entregas (backend no lo envi√≥).</div>`;
          return;
        }

        wrap.innerHTML = `
    <div class="rounded-2xl border border-white/10 overflow-hidden">
      <table class="w-full text-xs text-left">
        <thead class="bg-black/30 text-white">
          <tr>
            <th class="p-2">Unidad</th>
            <th class="p-2 text-right">Consumo Est.</th>
            <th class="p-2 text-right">Stock</th>
            <th class="p-2 text-right">Cobertura</th>
            <th class="p-2 text-right">Entrega</th>
            <th class="p-2">Motivo</th>
          </tr>
        </thead>
        <tbody class="bg-white/5 text-white">
          ${rows.map(r => `
            <tr class="border-t border-white/10">
              <td class="p-2">${escapeHtml(r.unidad ?? "")}</td>
              <td class="p-2 text-right">${escapeHtml(r.consumo_estimado ?? "‚Äî")}</td>
              <td class="p-2 text-right">${escapeHtml(r.stock ?? "‚Äî")}</td>
              <td class="p-2 text-right">${escapeHtml(r.cobertura_meses != null ? `${r.cobertura_meses}m` : "‚Äî")}</td>
              <td class="p-2 text-right font-semibold">${escapeHtml(r.entrega_sugerida ?? "‚Äî")}</td>
              <td class="p-2 text-white/70">${escapeHtml(r.motivo ?? "")}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
  `;
      }


      function renderLogsForecast(pro) {
        const wrap = document.getElementById("logsForecast");
        if (!wrap) return;

        // Muestra primero el log ‚Äúcompacto‚Äù (si existe) y si no, todo el objeto pro
        const payload = pro?.log ? pro.log : pro;

        wrap.textContent = JSON.stringify(payload, null, 2);
      }

      function fmtNum(x, d = 2) {
        const n = Number(x);
        if (!Number.isFinite(n)) return "‚Äî";
        return n.toFixed(d);
      }

      function fmtPct(x, d = 1) {
        const n = Number(x);
        if (!Number.isFinite(n)) return "‚Äî";
        return `${n.toFixed(d)}%`;
      }

      function delta(a, b) {
        const na = Number(a), nb = Number(b);
        if (!Number.isFinite(na) || !Number.isFinite(nb)) return null;
        return nb - na;
      }

      function deltaPct(a, b) {
        const na = Number(a), nb = Number(b);
        if (!Number.isFinite(na) || !Number.isFinite(nb) || na === 0) return null;
        return ((nb - na) / na) * 100;
      }

      function arrow(d) {
        if (d == null) return "";
        if (d > 0) return "‚ñ≤";
        if (d < 0) return "‚ñº";
        return "‚Ä¢";
      }

      function badgeDelta(a, b, unit = "") {
        const d = delta(a, b);
        const p = deltaPct(a, b);

        const aTxt = (a == null ? "‚Äî" : a);
        const bTxt = (b == null ? "‚Äî" : b);

        let sub = "";
        if (p != null) sub = `${arrow(p)} ${fmtPct(p)}`;
        else if (d != null) sub = `${arrow(d)} ${fmtNum(d)}${unit}`;

        return { aTxt, bTxt, sub };
      }

      function renderGraficaEscenarioCompare(basePro, scenPro) {
        const canvas = document.getElementById("graficaEscenarioCompare");
        if (!canvas) return;

        if (!window.Chart) {
          console.warn("‚ö†Ô∏è Chart.js no est√° cargado (escenario)");
          return;
        }

        const ctx = canvas.getContext("2d");
        if (!ctx) return;

        const base = basePro?.series || basePro || {};
        const scen = scenPro?.series || scenPro || {};

        const labels = (scen.fc_labels?.length ? scen.fc_labels : (base.fc_labels || [])) || [];
        const baseP50 = (base.p50 || []).slice(0, labels.length).map(v => {
          const n = Number(v);
          return Number.isFinite(n) ? n : null; // ‚úÖ null, no 0
        });
        const scenP50 = (scen.p50 || []).slice(0, labels.length).map(v => {
          const n = Number(v);
          return Number.isFinite(n) ? n : null; // ‚úÖ null, no 0
        });

        if (!labels.length) {
          console.warn("‚ö†Ô∏è Sin fc_labels para comparar en escenarios");
          return;
        }

        // Asegura tama√±o (por si el tab estaba hidden)
        canvas.style.display = "block";
        canvas.style.width = "100%";
        canvas.style.height = "260px";
        canvas.height = 260;

        // =========================
        // ‚úÖ RANGO DIN√ÅMICO (NO 0)
        // =========================
        const all = [...baseP50, ...scenP50].filter(v => typeof v === "number" && Number.isFinite(v));
        const minV = Math.min(...all);
        const maxV = Math.max(...all);

        // padding relativo + m√≠nimo absoluto para evitar zoom extremo cuando todo es igual
        const span = Math.max(1e-9, (maxV - minV));
        const padRel = span * 0.15;         // 15% del rango
        const padAbs = Math.max(1, maxV * 0.01); // 1% del nivel (m√≠nimo 1)

        const pad = Math.max(padRel, padAbs);
        const suggestedMin = Math.max(0, minV - pad);
        const suggestedMax = maxV + pad;

        // ‚úÖ MORPH: si ya existe, actualiza y anima (no destruir)
        if (window.graficaEscenarioCompareInstance) {
          const ch = window.graficaEscenarioCompareInstance;
          ch.data.labels = labels;
          ch.data.datasets[0].data = baseP50;
          ch.data.datasets[1].data = scenP50;

          // aplica rango din√°mico
          ch.options.scales.y.beginAtZero = false;
          ch.options.scales.y.min = suggestedMin;   // ‚úÖ forzado
          ch.options.scales.y.max = suggestedMax;   // ‚úÖ forzado

          ch.update();
          setTimeout(() => { try { ch.resize(); ch.update(); } catch { } }, 80);
          return;
        }

        // ‚úÖ Crear SOLO una vez
        window.graficaEscenarioCompareInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Base (p50)",
                data: baseP50,
                tension: 0.3,
                pointRadius: 2,
                borderWidth: 2
              },
              {
                label: "Escenario (p50)",
                data: scenP50,
                tension: 0.3,
                pointRadius: 2,
                borderWidth: 3
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: "index", intersect: false },

            // ‚úÖ morph suave
            animation: { duration: 450, easing: "easeOutQuart" },
            transitions: {
              active: { animation: { duration: 450 } },
              resize: { animation: { duration: 0 } }
            },

            plugins: {
              legend: { labels: { color: "#E5E7EB" } },
              tooltip: { mode: "index", intersect: false }
            },
            scales: {
              x: { ticks: { color: "#CBD5E1" }, grid: { color: "rgba(255,255,255,0.08)" } },
              y: {
                beginAtZero: false,
                min: suggestedMin,   // ‚úÖ forzado
                max: suggestedMax,   // ‚úÖ forzado
                ticks: { color: "#CBD5E1", precision: 0 },
                grid: { color: "rgba(255,255,255,0.08)" }
              }
            }
          }
        });

        // Nudge por tab hidden->visible
        setTimeout(() => {
          try {
            window.graficaEscenarioCompareInstance?.resize();
            window.graficaEscenarioCompareInstance?.update();
          } catch { }
        }, 80);
      }

      // ---------- Chart: Regresi√≥n m√≥vil + suavizado (pron√≥stico) ----------
      function graficarRegresionLineal(labelsHist, valoresHist) {
        console.groupCollapsed("üìà [Forecast] graficarRegresionLineal");

        const labelsRecortados = Array.isArray(labelsHist) ? [...labelsHist] : [];
        const valoresRecortados = Array.isArray(valoresHist)
          ? valoresHist.map(v => (Number.isFinite(Number(v)) ? Number(v) : 0))
          : [];

        console.log("labels =", labelsRecortados);
        console.log("valores =", valoresRecortados);

        const canvas = document.getElementById("graficaForecastLinea");
        if (!canvas) {
          console.warn("‚ö†Ô∏è No existe #graficaForecastLinea");
          console.groupEnd();
          return;
        }

        // canvas con tama√±o real (si no: 0px => nada visible)
        canvas.style.display = "block";
        canvas.style.width = "100%";
        canvas.style.height = "360px";
        canvas.height = 360;

        const ctx = canvas.getContext("2d");

        if (window.graficaRegresionInstance) {
          window.graficaRegresionInstance.destroy();
          window.graficaRegresionInstance = null;
        }

        if (!labelsRecortados.length || !valoresRecortados.length || labelsRecortados.length !== valoresRecortados.length) {
          console.warn("‚ö†Ô∏è datos insuficientes o desalineados");
          ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
          const tabla = document.getElementById("tablaForecast");
          if (tabla) tabla.innerHTML = `<div class="text-white/70 text-sm">Sin datos suficientes para pron√≥stico.</div>`;
          console.groupEnd();
          return;
        }

        const N = Math.min(5, Math.max(2, valoresRecortados.length));
        const maxPendiente = 2;

        const prediccion = valoresRecortados.map((_, i) => {
          if (i < N) return null;

          const ySegmento = valoresRecortados.slice(i - N, i);
          const xSegmento = ySegmento.map((_, j) => j);

          let { pendiente, intercepto } = calcularRegresionLineal(xSegmento, ySegmento);

          if (!Number.isFinite(pendiente)) pendiente = 0;
          if (!Number.isFinite(intercepto)) intercepto = ySegmento.reduce((a, b) => a + b, 0) / ySegmento.length;

          if (Math.abs(pendiente) > maxPendiente) pendiente = Math.sign(pendiente) * maxPendiente;

          const out = pendiente * (N - 1) + intercepto;
          return Math.round(out * 100) / 100;
        });

        const ultimosY = valoresRecortados.slice(-N);
        const ultimosX = ultimosY.map((_, j) => j);

        let { pendiente: finPend, intercepto: finInt } = calcularRegresionLineal(ultimosX, ultimosY);
        if (!Number.isFinite(finPend)) finPend = 0;
        if (!Number.isFinite(finInt)) finInt = ultimosY.reduce((a, b) => a + b, 0) / ultimosY.length;
        if (Math.abs(finPend) > maxPendiente) finPend = Math.sign(finPend) * maxPendiente;

        const predFuturo = [];
        const labelsForecast = [];

        const ultima = labelsRecortados[labelsRecortados.length - 1];
        const m = String(ultima).match(/^(\d{4})-(\d{2})(?:-(\d{2}))?$/);
        const ultimaFecha = m ? new Date(Number(m[1]), Number(m[2]) - 1, 1) : new Date();

        const horizon = Number(window.FORECAST_DEFAULT_HORIZON ?? 6);
        for (let i = 1; i <= horizon; i++) {
          const index = ultimosX.length + i - 1;
          const pred = Math.max(0, finPend * index + finInt);
          predFuturo.push(Math.round(pred * 100) / 100);

          const nueva = new Date(ultimaFecha);
          nueva.setMonth(nueva.getMonth() + i);
          labelsForecast.push(`${nueva.getFullYear()}-${String(nueva.getMonth() + 1).padStart(2, "0")}`);
        }

        const allLabels = [...labelsRecortados, ...labelsForecast];
        const seriePrediccion = [...prediccion, ...predFuturo];

        // suavizado exponencial
        const alpha = 0.6;
        const suavizado = [];

        const firstIdx = seriePrediccion.findIndex(v => v !== null && v !== undefined && Number.isFinite(Number(v)));
        let seed = firstIdx >= 0 ? Number(seriePrediccion[firstIdx]) : valoresRecortados[0];
        if (!Number.isFinite(seed)) seed = 0;

        for (let i = 0; i < seriePrediccion.length; i++) {
          if (i === 0) {
            suavizado.push(Math.round(seed * 100) / 100);
            continue;
          }
          const prev = suavizado[i - 1] ?? seed;
          const raw = seriePrediccion[i];
          const actual = raw === null || raw === undefined ? prev : Number(raw);
          const val = alpha * (Number.isFinite(actual) ? actual : prev) + (1 - alpha) * prev;
          suavizado.push(Math.round(val * 100) / 100);
        }

        console.log("seriePrediccion =", seriePrediccion);
        console.log("suavizado =", suavizado);

        // ‚úÖ IMPORTANT√çSIMO:
        // Para que "Suavizado" quede encima, se pinta AL FINAL (√∫ltimo dataset)
        // y adem√°s order alto.
        window.graficaRegresionInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels: allLabels,
            datasets: [
              {
                label: "Hist√≥rico",
                data: [...valoresRecortados, ...Array(3).fill(null)],
                borderColor: "#029597",
                backgroundColor: "rgba(2,149,151,0.12)",
                fill: true,
                tension: 0.3,
                pointRadius: 2,
                spanGaps: true,
                order: 1
              },
              {
                label: "Regresi√≥n m√≥vil limitada (5 meses)",
                data: seriePrediccion,
                borderColor: "#02c7ca",
                backgroundColor: "rgba(2,199,202,0.10)",
                borderDash: [4, 4],
                fill: true,
                tension: 0.3,
                pointRadius: 2,
                spanGaps: true,
                order: 2
              },
              {
                label: "Suavizado",
                data: suavizado,
                borderColor: "#cca300",
                backgroundColor: "rgba(204,163,0,0.10)",
                borderDash: [1, 1],
                fill: false,        // üëà clave: no tapes
                tension: 0.35,
                pointRadius: 2,
                borderWidth: 3,     // üëà dominante
                spanGaps: true,
                order: 99           // üëà encima
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,

            plugins: {
              legend: {
                position: "top",
                labels: {
                  color: "#E5E7EB",

                  // ‚úÖ FIX: Chart.js NO pasa "chart" como par√°metro aqu√≠.
                  // Usa function() para tener acceso a this.chart.
                  sort: function (a, b) {
                    const ds = this?.chart?.data?.datasets || [];
                    const da = ds[a.datasetIndex] || {};
                    const db = ds[b.datasetIndex] || {};
                    return (da.order ?? 0) - (db.order ?? 0);
                  }
                }
              },
              title: {
                display: true,
                text: "Pron√≥stico con regresi√≥n m√≥vil suavizada",
                color: "#E5E7EB"
              },
              tooltip: { mode: "index", intersect: false }
            },

            interaction: { mode: "nearest", axis: "x", intersect: false },

            scales: {
              x: {
                ticks: { color: "#CBD5E1", maxRotation: 45, minRotation: 30 },
                grid: { color: "rgba(255,255,255,0.08)" }
              },
              y: {
                beginAtZero: true,
                ticks: { color: "#CBD5E1", precision: 0 },
                grid: { color: "rgba(255,255,255,0.08)" },
                afterDataLimits(scale) {
                  scale.max = scale.max * 1.1;
                }
              }
            }
          }
        });

        // Nudge por layout tard√≠o (modal m√≥vil)
        setTimeout(() => {
          try {
            window.graficaRegresionInstance?.resize();
            window.graficaRegresionInstance?.update();
          } catch (e) {
            console.warn("‚ö†Ô∏è nudge update/resize fall√≥:", e);
          }
        }, 80);

        // Tabla (glass)
        const tabla = document.getElementById("tablaForecast");
        if (tabla) {
          const fmt = (v) => (v === null || v === undefined || v === "" ? "" : String(v));
          tabla.innerHTML = `
      <div class="rounded-2xl border border-white/10 overflow-hidden">
        <table class="w-full text-xs text-left">
          <thead class="bg-black/30 text-white">
            <tr>
              <th class="p-2">Mes</th>
              <th class="p-2 text-right">Real</th>
              <th class="p-2 text-right">Regresi√≥n</th>
              <th class="p-2 text-right">Suavizado</th>
            </tr>
          </thead>
          <tbody class="bg-white/5 text-white">
            ${allLabels.map((mes, i) => {
            const real = valoresRecortados[i] !== undefined ? valoresRecortados[i] : "";
            const reg = seriePrediccion[i] !== undefined ? seriePrediccion[i] : "";
            const sua = suavizado[i] !== undefined ? suavizado[i] : "";
            return `
                <tr class="border-t border-white/10">
                  <td class="p-2">${escapeHtml(mes)}</td>
                  <td class="p-2 text-right">${fmt(real)}</td>
                  <td class="p-2 text-right">${fmt(reg)}</td>
                  <td class="p-2 text-right">${fmt(sua)}</td>
                </tr>
              `;
          }).join("")}
          </tbody>
        </table>
      </div>
    `;
        }

        console.groupEnd();
      }


      function aislarGrupo(ref) {
        const todos = document.querySelectorAll(".grupo-referencia");
        todos.forEach(g => g.style.display = "none");

        const seleccionado = document.getElementById(`grupo-${ref}`);
        if (seleccionado) seleccionado.style.display = "block";
      }
      function exportarRegresionExcel() {
        const tabla = document.querySelector("#tablaForecast table");
        if (!tabla) return;

        const rows = Array.from(tabla.querySelectorAll("tr")).map(row =>
          Array.from(row.querySelectorAll("td, th")).map(cell => cell.textContent)
        );

        const ws = XLSX.utils.aoa_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Pron√≥stico");

        XLSX.writeFile(wb, "Pronostico_Regresion_Centrum.xlsx");
      }

      async function exportarRegresionPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF("p", "mm", "a4");

        const fondo = new Image();
        fondo.src = "membretada_medinova.png"; // aseg√∫rate de tenerla accesible

        fondo.onload = () => {
          doc.addImage(fondo, "PNG", 0, 0, 210, 297);

          const logo = new Image();
          logo.src = "centrum.png";

          logo.onload = () => {
            const anchoLogo = 40;
            const altoLogo = 40 * (529 / 729);
            doc.addImage(logo, "PNG", 160, 10, anchoLogo, altoLogo);

            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text("Pron√≥stico de Consumo - Regresi√≥n y Suavizado", 105, 25 + altoLogo, { align: "center" });

            const canvas = document.getElementById("graficaForecastLinea");
            const imgData = canvas.toDataURL("image/png");
            doc.addImage(imgData, "PNG", 10, 40 + altoLogo, 190, 60);

            const tabla = document.querySelector("#tablaForecast table");
            const rows = Array.from(tabla.querySelectorAll("tr")).map(row =>
              Array.from(row.querySelectorAll("td, th")).map(cell => cell.textContent)
            );

            const columnas = ["Mes", "Unidades reales", "Regresi√≥n", "Suavizado"];
            const cuerpo = rows.slice(1).map(row => row.slice(0, 4));

            doc.autoTable({
              head: [columnas],
              body: cuerpo,
              startY: 105 + altoLogo,
              theme: "grid",
              headStyles: {
                fillColor: [13, 148, 136], // teal-900
                textColor: 255,
                fontStyle: "bold"
              },
              bodyStyles: {
                textColor: [0, 0, 0]
              },
              styles: {
                font: "helvetica",
                fontSize: 8,
                halign: "center",
                cellPadding: 1,
                lineColor: [180, 180, 180],
                lineWidth: 0.2
              },
              margin: { top: 105 + altoLogo }
            });

            // Pie de p√°gina
            const hoy = new Date();
            doc.setFontSize(8);
            doc.setTextColor(100);
            doc.text(`Generado el ${hoy.toLocaleDateString("es-MX")}`, 150, 290);

            doc.save("Pronostico_Regresion_Centrum.pdf");
          };
        };
      }

      // 1. Obtener mes l√≥gico como YYYY-MM
      function obtenerMesLogico(timestamp) {
        const fecha = new Date(Number(timestamp));
        const year = fecha.getFullYear();
        const mes = fecha.getDate() >= 25 ? fecha.getMonth() + 2 : fecha.getMonth() + 1;
        return `${year}-${String(mes).padStart(2, '0')}`;
      }
      // 2. Cargar dotaciones desde Supabase
      async function obtenerDotaciones() {
        try {
          const res = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/dotaciones?select=referencia,unidad,cantidad", {
            headers: {
              "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MjcxNjYsImV4cCI6MjA2MjAwMzE2Nn0.vxPo7XXaeKPa-jDQRA2jvOJ7dvJZDHRNZB7blbONNZo",
              "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MjcxNjYsImV4cCI6MjA2MjAwMzE2Nn0.vxPo7XXaeKPa-jDQRA2jvOJ7dvJZDHRNZB7blbONNZo"

            }
          });
          return await res.json();
        } catch (err) {
          console.error("Error cargando dotaciones:", err);
          return [];
        }
      }
      // 3. Calcular entregas por unidad y referencia
      function calcularEntregas(movimientos, ref) {
        const entregas = {};
        for (const mov of movimientos) {
          if (mov.referencia !== ref || mov.movimiento !== "salida") continue;
          const mesLogico = obtenerMesLogico(mov.fecha);
          const unidad = mov.unidad_destino || "SIN_UNIDAD";
          const clave = `${unidad}|${mesLogico}`;
          entregas[clave] = (entregas[clave] || 0) + 1;
        }
        return entregas;
      }
      // 4. Calcular consumo inferido y sugerido
      function inferirConsumo(entregas, dotaciones, ref) {
        const porUnidad = {};
        for (const clave in entregas) {
          const [unidad, mes] = clave.split("|");
          if (!porUnidad[unidad]) porUnidad[unidad] = {};
          porUnidad[unidad][mes] = entregas[clave];
        }

        const sugerencias = {};
        for (const unidad in porUnidad) {
          const meses = Object.keys(porUnidad[unidad]).sort();
          const consumos = [];
          for (let i = 1; i < meses.length; i++) {
            const ant = porUnidad[unidad][meses[i - 1]];
            const act = porUnidad[unidad][meses[i]];
            const cons = Math.max(0, act - ant);
            consumos.push(cons);
          }
          const prom = consumos.slice(-3).reduce((a, b) => a + b, 0) / 3;
          sugerencias[unidad] = Math.ceil((prom || 0) * 1.1);
        }

        const dotacionTotal = dotaciones.filter(d => d.referencia === ref)
          .reduce((a, d) => a + parseInt(d.cantidad), 0);

        return { sugerencias, dotacionTotal };
      }
      // 5. Verificar si inventario actual cubre la dotaci√≥n
      async function verificarStockVsDotacion(ref, dotacionTotal) {
        try {
          const res = await fetch(`https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/productos?select=referencia,cantidad&referencia=eq.${ref}`, {
            headers: {
              "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MjcxNjYsImV4cCI6MjA2MjAwMzE2Nn0.vxPo7XXaeKPa-jDQRA2jvOJ7dvJZDHRNZB7blbONNZo",
              "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MjcxNjYsImV4cCI6MjA2MjAwMzE2Nn0.vxPo7XXaeKPa-jDQRA2jvOJ7dvJZDHRNZB7blbONNZo"

            }
          });
          const productos = await res.json();
          const totalEnStock = productos.reduce((a, p) => a + parseInt(p.cantidad), 0);

          if (totalEnStock < dotacionTotal) {
            mostrarModal("‚ö†Ô∏è No hay suficiente inventario para abastecer dotaci√≥n autorizada", "#B00042");
          } else {
            mostrarModal("‚úÖ Inventario suficiente para dotaci√≥n", "#16a34a");
          }
        } catch (err) {
          console.error("Error verificando stock:", err);
        }
      }
      // 6. Hook para ejecutar todo al cambiar unidad en forecast
      async function alCambiarUnidadForecast(ref) {
        try {
          const movRes = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/TimeStamps?select=referencia,fecha,unidad_destino,movimiento&referencia=eq." + ref, {
            headers: {
              "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MjcxNjYsImV4cCI6MjA2MjAwMzE2Nn0.vxPo7XXaeKPa-jDQRA2jvOJ7dvJZDHRNZB7blbONNZo",
              "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MjcxNjYsImV4cCI6MjA2MjAwMzE2Nn0.vxPo7XXaeKPa-jDQRA2jvOJ7dvJZDHRNZB7blbONNZo"

            }
          });
          const movimientos = await movRes.json();
          if (!Array.isArray(movimientos)) throw new Error("Movimientos no v√°lidos");

          const dotaciones = await obtenerDotaciones();
          if (!Array.isArray(dotaciones)) throw new Error("Dotaciones no v√°lidas");

          const entregas = calcularEntregas(movimientos, ref);
          const { sugerencias, dotacionTotal } = inferirConsumo(entregas, dotaciones, ref);
          await verificarStockVsDotacion(ref, dotacionTotal);
        } catch (e) {
          console.error("Error ejecutando forecast extendido:", e);
        }
      }
      function solicitarCantidad(callback) {
        const cantidad = prompt("¬øCu√°ntas piezas deseas retirar?");
        const cantidadNum = parseInt(cantidad);
        if (!isNaN(cantidadNum) && cantidadNum > 0) {
          callback(cantidadNum);
        } else {
          mostrarModal("‚ö†Ô∏è Cantidad inv√°lida", "#d99b00");
        }
      }
      // Extender evento onchange
      const selectUnidadForecast = document.getElementById("unidadForecast");
      if (selectUnidadForecast) {
        selectUnidadForecast.addEventListener("change", () => {
          const ref = document.querySelector("#grupo-forecast-referencia")?.dataset?.ref;
          if (ref) alCambiarUnidadForecast(ref);
        });
      }

      function confiabilidadConvertida(original) {
        const resultado = {};
        for (const unidad in original) {
          for (const mes in original[unidad]) {
            if (!resultado[mes]) resultado[mes] = original[unidad][mes];
            else if (original[unidad][mes] === "‚ö†Ô∏è") resultado[mes] = "‚ö†Ô∏è";
          }
        }
        return { TOTAL: resultado };
      }
      function combinarUnidades(consumo) {
        const total = {};
        for (const unidad in consumo) {
          for (const mes in consumo[unidad]) {
            if (!total[mes]) total[mes] = 0;
            total[mes] += consumo[unidad][mes];
          }
        }
        return total;
      }

      async function descargarReporteForecast() {
        try {
          const res = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/reporte_forecast_global", {
            headers: {
              "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MjcxNjYsImV4cCI6MjA2MjAwMzE2Nn0.vxPo7XXaeKPa-jDQRA2jvOJ7dvJZDHRNZB7blbONNZo",
              "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MjcxNjYsImV4cCI6MjA2MjAwMzE2Nn0.vxPo7XXaeKPa-jDQRA2jvOJ7dvJZDHRNZB7blbONNZo"
            }
          });

          const data = await res.json();
          if (!data.resumen || !Array.isArray(data.resumen)) throw new Error("Datos inv√°lidos");

          const resumen = data.resumen;
          const meses = data.meses;

          const encabezados = [
            "UNIDAD", "REFERENCIA", "NOMBRE", "INV. OBJETIVO",
            ...meses.flatMap(m => [`ENTREGADO ${m}`, `CONSUMIDO ${m}`]),
            "PROMEDIO TRIMESTRAL", "PICO CONSUMO", "DOTACI√ìN SUGERIDA", "CONSUMO VS DOTACI√ìN"
          ];

          const filas = resumen.map(f => [
            f.unidad,
            f.referencia,
            f.nombre,
            f.inv_objetivo,
            ...meses.flatMap(m => [f[`entregado_${m}`] || 0, f[`consumido_${m}`] || 0]),
            f.promedio_trimestral,
            f.pico_consumo,
            f.dotacion_sugerida,
            f.consumo_vs_dotacion
          ]);

          const wb = XLSX.utils.book_new();
          const ws = XLSX.utils.aoa_to_sheet([encabezados, ...filas]);
          XLSX.utils.book_append_sheet(wb, ws, "Reporte Forecast");

          XLSX.writeFile(wb, "Reporte_Global_Forecast.xlsx");

        } catch (err) {
          console.error("Error al descargar reporte:", err);
          mostrarModal("‚ùå Error al generar el reporte.", "#b00042");
        }
      }
      //#endregion 888888888888888888888888888888888888888888888888888888888888888888 FORECAST 88888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
      function cerrarModalAsignarUnidades() {
        document.getElementById("modalAsignarUnidades").classList.add("hidden");
      }
      async function guardarUnidadesAsignadas() {
        const select = document.getElementById("selectUsuario");
        const nombre = select.value;
        const checkboxes = document.querySelectorAll("#listaUnidades input[type='checkbox']");
        const seleccionadas = Array.from(checkboxes)
          .filter(c => c.checked)
          .map(c => c.value);

        const errorDiv = document.getElementById("unidadAsignarError");

        if (seleccionadas.length === 0) {
          mostrarModal("‚ùå Debes seleccionar al menos una unidad.", "#B00042");
          return;
        }

        if (!nipAdmin) {
          mostrarModal("‚ùå No se detect√≥ NIP de administrador.", "#B00042");
          return;
        }

        const payload = {
          nip_admin: nipAdmin,
          nombre,
          nuevo_nip: "sin_cambio",
          nuevas_unidades: seleccionadas
        };

        try {
          const res = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/actualizar_nip", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          const data = await res.json();

          if (res.ok) {
            cerrarModalAsignarUnidades();
            mostrarModal("‚úÖ Unidades actualizadas correctamente", "#16a34a");
          } else {
            console.warn("Error desde Supabase:", data);
            mostrarModal("‚ùå " + (data.error || "Error al guardar unidades."), "#B00042");
          }

        } catch (err) {
          console.error("Error de red al guardar unidades:", err);
          mostrarModal("‚ùå Error de red al guardar unidades.", "#B00042");
        }
      }

      async function mostrarModalAsignarUnidades() {
        const modal = document.getElementById("modalAsignarUnidades");
        const select = document.getElementById("selectUsuario");
        const lista = document.getElementById("listaUnidades");
        if (!window.usuarioEsAdmin) {
          notificar("‚ùå Solo administradores pueden modificar unidades", "#B00042");
          return;
        }
        // Limpiar
        select.innerHTML = "";
        lista.innerHTML = "";

        // 1. Obtener usuarios desde Supabase
        try {
          const res = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/usuarios?select=nombre,unidades", {
            headers: {
              apikey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MjcxNjYsImV4cCI6MjA2MjAwMzE2Nn0.vxPo7XXaeKPa-jDQRA2jvOJ7dvJZDHRNZB7blbONNZo",
              Authorization: "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MjcxNjYsImV4cCI6MjA2MjAwMzE2Nn0.vxPo7XXaeKPa-jDQRA2jvOJ7dvJZDHRNZB7blbONNZo"
            }
          });

          const usuarios = await res.json();
          const usuariosFiltrados = usuarios.filter(u =>
            u.nombre !== "CONTROL_GLOBAL" && u.nombre !== "PIN_AUTO"
          );
          usuariosFiltrados.forEach(u => {
            const opt = document.createElement("option");
            opt.value = u.nombre;
            opt.textContent = u.nombre;
            opt.dataset.unidades = u.unidades || "";
            select.appendChild(opt);
          });

          select.onchange = () => {
            generarCheckboxesPara(select.value, select.selectedOptions[0].dataset.unidades);
          };

          // Dispara por default para el primero
          if (usuariosFiltrados.length) {
            generarCheckboxesPara(usuariosFiltrados[0].nombre, usuariosFiltrados[0].unidades);
          }

          modal.classList.remove("hidden");
        } catch (err) {
          console.error("Error al cargar usuarios:", err);
        }
      }

      function generarCheckboxesPara(nombre, unidadesStr) {
        const cont = document.getElementById("listaUnidades");
        cont.innerHTML = "";

        const unidadesActuales = unidadesStr
          ? unidadesStr.split(",").map(u => u.trim().toUpperCase())
          : [];

        for (const clave in unidadesDestino) {
          const label = document.createElement("label");
          label.className = "flex items-center gap-2";

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.value = clave;
          checkbox.checked = unidadesActuales.includes(clave);

          label.appendChild(checkbox);
          label.append(`${clave} - ${unidadesDestino[clave]}`);
          cont.appendChild(label);
        }
      }
      function actualizarTablaRegistros() {
        const tabla = document.getElementById("tablaRegistros");
        const contenedor = document.getElementById("tablaContenedora");
        const resumenDiv = document.getElementById("resumenEscaneos"); // ‚¨Ö nuevo

        if (!tabla) {
          console.warn("‚ö†Ô∏è No existe la tabla de registros a√∫n en el DOM.");
          return;
        }

        // Hacemos visible el contenedor si hay registros pendientes
        if (qrsPendientes.length > 0) {
          contenedor.classList.remove("hidden");
          setTimeout(() => contenedor.classList.remove("opacity-0"), 10);
        } else {
          contenedor.classList.add("opacity-0");
          setTimeout(() => contenedor.classList.add("hidden"), 500);
        }

        // Encabezado con columna extra de Timestamp
        tabla.innerHTML = `
    <thead>
      <tr>
        <th class="p-1">Referencia</th>
        <th class="p-1">Lote</th>
        <th class="p-1">Timestamp</th>
        <th class="p-1 text-center">Eliminar</th>
      </tr>
    </thead>
  `;

        // Filas de la tabla contenedora
        qrsPendientes.forEach((qr, index) => {
          const fila = document.createElement("tr");
          fila.dataset.index = index;
          fila.innerHTML = `
      <td class="p-1">${qr.referencia}</td>
      <td class="p-1">${qr.lote}</td>
      <td class="p-1">${qr.timestamp || ""}</td>

      <td class="p-1 text-center">
        <button onclick="eliminarFila(this)" class="bg-red-600 hover:bg-red-900 text-white px-2 rounded-xl">X</button>
      </td>
    `;
          tabla.appendChild(fila);
        });

        // === Generar resumen como tabla ===
        if (resumenDiv) {
          if (qrsPendientes.length > 0) {
            const conteo = {};
            qrsPendientes.forEach(q => {
              const clave = `${q.referencia}||${q.lote}`;
              conteo[clave] = (conteo[clave] || 0) + 1;
            });

            let html = `
      <strong>Resumen:</strong>
      <table class="w-full mt-2 border border-gray-300 text-sm text-center bg-white/80 rounded-xl overflow-hidden">
        <thead class="bg-teal-900 text-white">
          <tr>
            <th class="p-1">Referencia</th>
            <th class="p-1">Lote</th>
            <th class="p-1">Cantidad</th>
          </tr>
        </thead>
        <tbody>
    `;

            for (const clave in conteo) {
              const [ref, lote] = clave.split("||");
              html += `
        <tr>
          <td class="p-1">${ref}</td>
          <td class="p-1">${lote}</td>
          <td class="p-1 font-bold">${conteo[clave]}</td>
        </tr>
      `;
            }

            html += `
        </tbody>
      </table>
    `;

            resumenDiv.innerHTML = html;
            resumenDiv.classList.remove("hidden");
          } else {
            resumenDiv.classList.add("hidden");
          }
        }
      }


      //8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888

      async function enviarSupabase() {
        console.log("üü¢üöÄ [SUPABASE] Inicio de enviarSupabase()");

        // ‚úÖ Validaci√≥n de modo
        if (!modo || modo === "inactivo") {
          console.warn("‚ö†Ô∏è [SUPABASE] No se seleccion√≥ modo. Operaci√≥n cancelada.");
          mostrarModal("‚ö†Ô∏è Selecciona primero el modo", "#d99b00");
          return;
        }

        // ‚úÖ Validaci√≥n de datos pendientes
        if (qrsPendientes.length === 0) {
          console.warn("‚ö†Ô∏è [SUPABASE] No hay productos en qrsPendientes.");
          mostrarModal("‚ö†Ô∏è No hay productos para enviar", "#d99b00");
          return;
        }

        mostrarModal("üì§ Enviando datos...", "#0ea5e9");
        mostrarLoader();
        const registros = [];

        // ‚úÖ Procesar cada registro antes de enviarlo
        for (const r of qrsPendientes) {
          console.log("üîç [SUPABASE] Procesando registro:", r);

          const { referencia, lote, caducidad } = r;

          if (r.tipo !== "unidad") {
            console.log(`üì¶ [SUPABASE] Validando existencia del producto ${referencia} - Lote ${lote}`);
            const consultaProducto = await fetch(
              `https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/productos?referencia=eq.${referencia}&lote=eq.${lote}`,
              {
                headers: {
                  "apikey": API_KEY,
                  "Authorization": `Bearer ${API_KEY}`
                }
              }
            );

            console.log(`üåê [SUPABASE] Status consulta producto: ${consultaProducto.status}`);
            const productos = await consultaProducto.json();
            console.log("üì• [SUPABASE] Respuesta productos:", productos);

            if (productos.length === 0) {
              console.warn(`‚ö†Ô∏è [SUPABASE] Producto no existe, buscando en historicos: ${referencia}`);
              const historicoRes = await fetch(
                `https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/historicos?select=referencia,nombre,fabricante`,
                {
                  headers: {
                    "apikey": API_KEY,
                    "Authorization": `Bearer ${API_KEY}`
                  }
                }
              );

              const historico = await historicoRes.json();
              console.log("üìö [SUPABASE] Historico recibido:", historico);

              const normalizar = s => s.replace(/[^a-zA-Z0-9]/g, "").toUpperCase();
              const refClean = normalizar(referencia);
              const match = historico.find(h => normalizar(h.referencia) === refClean);

              const nombre = match?.nombre || "SIN NOMBRE";
              const fabricante = match?.fabricante || "SIN FABRICANTE";

              let caducidadFinal = null;
              if (caducidad && !isNaN(caducidad)) {
                try {
                  const fechaExcel = new Date((Number(caducidad) - 25569) * 86400 * 1000);
                  caducidadFinal = fechaExcel.toISOString().split("T")[0];
                  console.log(`üìÜ [SUPABASE] Caducidad convertida desde Excel: ${caducidadFinal}`);
                } catch (e) {
                  console.warn("‚ö†Ô∏è [SUPABASE] Error al convertir caducidad:", caducidad, e);
                }
              } else {
                caducidadFinal = caducidad || null;
              }

              const nuevo = {
                referencia,
                lote,
                nombre,
                fabricante,
                cantidad: 0,
                caducidad: caducidadFinal
              };

              console.log("üÜï [SUPABASE] Insertando nuevo producto en Supabase:", nuevo);
              await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/productos", {
                method: "POST",
                headers: {
                  "apikey": API_KEY,
                  "Authorization": `Bearer ${API_KEY}`,
                  "Content-Type": "application/json",
                  "Prefer": "return=minimal"
                },
                body: JSON.stringify(nuevo)
              });
            }
          }

          const base = {
            ...r,
            remision: remisionActual || null
          };

          if (window.pinAutorizadoPor && window.pinAutorizadoPor !== r.usuario) {
            base.pin_autorizado_por = window.pinAutorizadoPor;
            console.log("üîë [SUPABASE] PIN autorizado por:", window.pinAutorizadoPor);
          }

          registros.push(base);
        }

        console.log("‚úÖ [SUPABASE] Registros listos para enviar:", registros);

        // ‚úÖ Clasificaci√≥n de registros
        const normales = registros.filter(r => !r.tipo || r.tipo === "normal");
        const fracciones = registros.filter(r => r.tipo === "fraccion");
        const unidades = registros.filter(r => r.tipo === "unidad");

        console.log(`üì¶ [SUPABASE] Normales: ${normales.length}`, normales);
        console.log(`üì¶ [SUPABASE] Fraccionables: ${fracciones.length}`, fracciones);
        console.log(`üì¶ [SUPABASE] Unidades fraccionables: ${unidades.length}`, unidades);

        try {
          // ‚öôÔ∏è Funci√≥n de env√≠o ya instrumentada
          async function enviarYVerificar(url, datos, tipo) {
            console.log(`üöÄ [${tipo.toUpperCase()}] Enviando a:`, url);
            console.log(`üì¶ [${tipo.toUpperCase()}] Datos antes de enviar:`, datos);
            console.log(`üìú [${tipo.toUpperCase()}] JSON completo:`, JSON.stringify({ registros: datos }, null, 2));

            const res = await fetch(url, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ registros: datos })
            });

            console.log(`üåê [${tipo.toUpperCase()}] Status HTTP:`, res.status);

            const json = await res.json();
            console.log(`üì• [${tipo.toUpperCase()}] Respuesta JSON:`, json);

            const errores = json.resultados?.filter(r => r.status === "error");
            console.log(`üîç [${tipo.toUpperCase()}] Errores detectados:`, errores);

            if (errores?.length > 0) {
              console.warn(`‚ùå [${tipo.toUpperCase()}] Se encontraron errores:`, errores);
              mostrarModal(`‚ùå Error al enviar productos (${tipo})`, "#B00042");
              ocultarLoader();
              throw new Error(`Errores en ${tipo}`);
            } else {
              console.log(`‚úÖ [${tipo.toUpperCase()}] Env√≠o exitoso.`);
            }
          }

          // üöö Env√≠os seg√∫n tipo
          if (normales.length > 0) {
            console.log("üü¢ [enviarSupabase] Enviando NORMALES:", normales);
            await enviarYVerificar(
              "https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/registrar_qr",
              normales,
              "normales"
            );
          }

          if (fracciones.length > 0) {
            console.log("üü¢ [enviarSupabase] Enviando FRACCIONABLES:", fracciones);
            await enviarYVerificar(
              "https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/registrar_qr_fraccionable",
              fracciones,
              "fraccionables"
            );
          }

          if (unidades.length > 0) {
            console.log("üü¢ [enviarSupabase] Enviando UNIDADES:", unidades);
            await enviarYVerificar(
              "https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/registrar_qr_unidad",
              unidades,
              "unidades fraccionables"
            );
          }

          mostrarModal("üì¶ Productos enviados correctamente", "#22c55e");
          console.log("üéâ [SUPABASE] TODOS los productos enviados correctamente.");
          qrsPendientes = [];
          actualizarTablaRegistros();
          window.pinAutorizadoPor = null;

        } catch (err) {
          console.error("‚ùå [SUPABASE] Error durante el env√≠o:", err);
        } finally {
          ocultarLoader();
          console.log("‚úÖ [SUPABASE] Loader ocultado y funci√≥n finalizada.");
        }
      }


      //8888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888

      function moverFilaAlInicio(fila) {
        try {
          const tbody = document.querySelector("#tablaCaptura tbody");
          if (!tbody || !fila) return;

          tbody.insertBefore(fila, tbody.firstChild); // mueve al inicio
          console.log("üîù Fila movida al inicio:", fila);
        } catch (e) {
          console.error("‚ùå Error al mover fila al inicio:", e);
        }
      }

      function agregarFila(ref, lote, estado) {
        const tabla = document.getElementById("tablaRegistros");
        const contenedor = document.getElementById("tablaContenedora");

        // Asegura que el contenedor est√© visible
        contenedor.classList.remove("hidden");
        setTimeout(() => contenedor.classList.remove("opacity-0"), 10);

        // Crea la fila
        const fila = document.createElement("tr");
        fila.innerHTML = `
      <td class='p-1'>${ref}</td>
      <td class='p-1'>${lote}</td>
      <td class='p-1'>${estado}</td>
      <td class='p-1 text-center'><button onclick='eliminarFila(this)' class='text-red-600'>‚úñ</button></td>
    `;
        tabla.appendChild(fila);
      }
      function normalizarTexto(texto) {
        return (texto || "")
          .toUpperCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/[^\w]/g, "");
      }
      async function solicitarNIP() {
        document.getElementById("modalNIP").classList.remove("hidden");
      }

      async function validarNIP() {
        mostrarLoader(true, "Validando NIP y cargando unidades‚Ä¶");
        try {
          const nip = document.getElementById("nipInput").value.trim();
          const res = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/validar_nip", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ nip })
          });
          const data = await res.json();

          if (!data?.nombre) {
            document.getElementById("nipError").classList.remove("hidden");
            return;
          }

          usuarioActivo = data.nombre;
          unidadesAsignadas = typeof data.unidades === "string" ? data.unidades.split(",").map(u => u.trim()) : [];

          // üî• Cargar cat√°logo de nombres de unidades din√°micamente
          await cargarCatalogoUnidades();

          document.getElementById("modalNIP").classList.add("hidden");
          cargarUnidades();

          // Cargar referencias y LUEGO intentar recuperar borrador (SOLO si no es modo preparaci√≥n)
          // if (modo !== "preparacion") {
          mostrarModalCaptura();
          setupModalCapturaElite();  // <- importante
          recuperarBorradorCaptura();
          // }
        } catch (error) {
          console.error("Error validando NIP:", error);
          alert("Error de conexi√≥n al validar NIP");
        } finally {
          mostrarLoader(false);
        }
      }

      function cargarUnidades() {
        const unidadSelect = document.getElementById("unidadCaptura");

        if (!unidadSelect) {
          console.error("‚ùå cargarUnidades(): #unidadCaptura no existe. (ModalCaptura incompleto o IDs borrados)");
          return;
        }

        if (!Array.isArray(unidadesAsignadas)) {
          console.error("‚ùå cargarUnidades(): unidadesAsignadas no es arreglo:", unidadesAsignadas);
          unidadSelect.innerHTML = `<option value="">(Error: unidades inv√°lidas)</option>`;
          return;
        }

        if (unidadesAsignadas.length === 0) {
          console.warn("‚ö†Ô∏è cargarUnidades(): usuario sin unidades asignadas");
          unidadSelect.innerHTML = `<option value="">(Sin unidades asignadas)</option>`;
          return;
        }

        unidadSelect.innerHTML =
          `<option value=""> - </option>` +
          unidadesAsignadas.map(u => {
            const nombre = (typeof catalogoUnidadesMap !== 'undefined' && catalogoUnidadesMap[u]) ||
              (typeof unidadesDestino !== 'undefined' && unidadesDestino[u]) ||
              (typeof unidadesFijas !== 'undefined' && unidadesFijas[u]) ||
              u;
            return `<option value="${u}">${nombre}</option>`;
          }).join("");

        console.log("‚úÖ cargarUnidades(): OK", unidadesAsignadas);
      }

      // =====================
      // ELITE: referencias por unidad (server-side + cache)
      // =====================

      // Debes tener esto definido en tu proyecto:
      const SUPABASE_URL = "https://ldjrpfsbpcfninntffoj.supabase.co";

      // Cache por unidad: Map<"C03129", Array<{referencia,nombre,unidad_medica,unidad_nombre}>>
      let cacheRefsUnidad = new Map();

      // Control para cancelar requests del typeahead
      let typeaheadTimer = null;
      let lastController = null;

      function norm(v) {
        return String(v || "").trim().toUpperCase();
      }

      // (Opcional) limpiar sugerencias UI
      function ocultarSugerencias() {
        const contenedor = document.getElementById("sugerenciasReferencia");
        if (!contenedor) return;
        contenedor.innerHTML = "";
        contenedor.classList.add("hidden");
      }

      // =====================
      // 1) Precargar SOLO la unidad seleccionada (opcional)
      // =====================
      async function precargarUnidadSiConviene(unidad) {
        unidad = norm(unidad);
        if (!unidad) return [];
        if (cacheRefsUnidad.has(unidad)) return cacheRefsUnidad.get(unidad);

        // Si prefieres NO precargar nada, comenta esta funci√≥n completa
        // y deja que el typeahead sea el √∫nico camino.

        const batchSize = 5000;
        const todas = [];
        let inicio = 0;

        while (true) {
          const url =
            `${SUPABASE_URL}/rest/v1/historicos` +
            `?select=unidad_medica,unidad_nombre,referencia,nombre` +
            `&unidad_medica=eq.${encodeURIComponent(unidad)}`;

          const res = await fetch(url, {
            headers: {
              apikey: API_KEY,
              Authorization: `Bearer ${API_KEY}`,
              "Content-Type": "application/json",
              "Range-Unit": "items",
              "Range": `${inicio}-${inicio + batchSize - 1}`,
            },
          });

          if (res.status === 416) break;

          if (!res.ok) {
            const txt = await res.text().catch(() => "");
            throw new Error(`HTTP ${res.status} - ${res.statusText} - ${txt}`);
          }

          const data = await res.json();
          todas.push(...data);

          if (data.length < batchSize) break;
          inicio += batchSize;
        }

        cacheRefsUnidad.set(unidad, todas);
        console.log(`‚úÖ Unidad ${unidad} precargada:`, todas.length);
        return todas;
      }

      // =====================
      // 2) Typeahead server-side (lo m√°s importante)
      // =====================
      async function buscarSugerenciasReferencia({ unidad, q, limit = 12 }) {
        unidad = norm(unidad);
        q = String(q || "").trim();

        // UX: m√≠nimo 2 caracteres para no spamear al servidor
        if (!unidad || q.length < 1) return [];

        // Cancela request anterior (evita resultados desfasados)
        if (lastController) lastController.abort();
        lastController = new AbortController();

        const like = `%${q}%`;

        const url =
          `${SUPABASE_URL}/rest/v1/historicos` +
          `?select=unidad_medica,unidad_nombre,referencia,nombre` +
          `&unidad_medica=eq.${encodeURIComponent(unidad)}` +
          `&or=(referencia.ilike.${encodeURIComponent(like)},nombre.ilike.${encodeURIComponent(like)})` +
          `&limit=${limit}`;

        const res = await fetch(url, {
          method: "GET",
          headers: {
            apikey: API_KEY,
            Authorization: `Bearer ${API_KEY}`,
            "Content-Type": "application/json",
          },
          signal: lastController.signal,
        });

        // Abort es normal, no es error real
        if (!res.ok) {
          const txt = await res.text().catch(() => "");
          throw new Error(`HTTP ${res.status} - ${res.statusText} - ${txt}`);
        }

        return await res.json();
      }

      // =====================
      // 3) Conectar a tu ModalCaptura
      // =====================

      // Llama esto UNA VEZ al iniciar tu app o al abrir el modal
      function setupModalCapturaElite() {
        const inputRef = document.getElementById("inputReferencia");
        const unidadEl = document.getElementById("unidadCaptura");
        const contenedor = document.getElementById("sugerenciasReferencia");

        if (!inputRef || !unidadEl || !contenedor) {
          console.warn("‚ö†Ô∏è No se encontraron elementos del modal captura (inputReferencia/unidadCaptura/sugerenciasReferencia)");
          return;
        }

        // Cuando cambias unidad: limpia input y sugerencias + (opcional) precarga esa unidad
        unidadEl.addEventListener("change", async () => {
          try {
            inputRef.value = "";
            ocultarSugerencias();

            const unidad = unidadEl.value;
            if (!unidad) return;

            // Opcional: precarga para navegar r√°pido si el usuario insiste en esa unidad
            // Si NO quieres precarga, comenta la l√≠nea de abajo.
            await precargarUnidadSiConviene(unidad);
          } catch (e) {
            console.error("‚ùå Error al preparar unidad:", e);
            mostrarModal("‚ùå No se pudo preparar la unidad (referencias).", "#b00042");
          }
        });

        // Typeahead en el input de referencia
        inputRef.addEventListener("input", () => {
          clearTimeout(typeaheadTimer);

          // Clear name display when typing
          const nameDisplay = document.getElementById("nombreSeleccionado");
          if (nameDisplay) {
            nameDisplay.textContent = "";
            nameDisplay.classList.add("hidden");
          }

          typeaheadTimer = setTimeout(async () => {
            const unidad = unidadEl.value;
            const texto = inputRef.value.trim();

            // Si no hay texto, oculta
            if (!texto) {
              ocultarSugerencias();
              return;
            }

            try {
              // ‚ö° Elite path: siempre server-side para exactitud y escala
              const sugerencias = await buscarSugerenciasReferencia({ unidad, q: texto, limit: 12 });

              contenedor.innerHTML = "";
              if (sugerencias.length === 0) {
                contenedor.classList.add("hidden");
                return;
              }

              contenedor.classList.remove("hidden");

              sugerencias.forEach((s) => {
                const div = document.createElement("div");
                div.className = "px-4 py-2 hover:bg-white/10 cursor-pointer";
                div.textContent = `${s.referencia} - ${s.nombre || ""}`;

                // Use onmousedown to trigger BEFORE the input's blur event
                div.onmousedown = (e) => {
                  e.preventDefault(); // Prevent default focus behavior if needed
                  inputRef.value = s.referencia;
                  contenedor.classList.add("hidden");

                  // Show Name
                  if (nameDisplay) {
                    nameDisplay.textContent = s.nombre || "";
                    nameDisplay.classList.remove("hidden");
                  }

                  // Clear suggestions immediately to avoid flicker/reappearance
                  contenedor.innerHTML = "";

                  // Move focus to next field
                  requestAnimationFrame(() => {
                    document.getElementById("inputCantidad")?.focus();
                  });
                };
                contenedor.appendChild(div);
              });
            } catch (e) {
              // Abort es normal
              if (String(e).includes("AbortError")) return;
              console.error("‚ùå Typeahead error:", e);
              contenedor.classList.add("hidden");
            }
          }, 180);
        });

        // UX: ocultar sugerencias al perder foco (opcional)
        inputRef.addEventListener("blur", () => setTimeout(ocultarSugerencias, 120));

        console.log("üöÄ ModalCaptura Elite listo");
      }

      function extraerLoteCadDeLlaves(qr) {
        if (!qr) return { lote: null, caducidad: null };

        // Quitamos espacios por si el lector los mete
        const limpio = qr.replace(/\s+/g, '');

        // Patr√≥n: {REF}//{LOTE}--{CADUCIDAD}...
        // Ej: {3030603MYB}//{S/L}--{2030-12-31}|T:30072099
        const match = limpio.match(/\{([^}]+)\}\/\/\{([^}]+)\}--\{?([^}|]+)\}?/);
        if (!match) {
          return { lote: null, caducidad: null };
        }

        return {
          lote: match[2] || null,        // S/L
          caducidad: match[3] || null    // 2030-12-31
        };
      }
      function actualizarDatosCaptura() {
        const filas = document.querySelectorAll("#tablaCaptura tbody tr");
        const modo = document.getElementById("modoCaptura")?.value || "inventario";

        datosCaptura = [];

        filas.forEach(fila => {
          // NEW ORDER:
          // [0] = (+) button (td)
          // [1] = Cantidad (td > input)
          // [2] = Lote (td > input)
          // [3] = Ref (td > text)
          // [4] = Nombre (td > text)
          // [5] = (x) button (td)

          // Fallback logic in case indices shift or we are in another mode?
          // Inventory mode has 6 columns.
          // Other modes might differ? No, 'agregarFilaCapturaUI' is used generally but 'Lote' is hidden.
          // BUT if 'Lote' is hidden, it's still in DOM? YES, updated logic uses 'hidden' class, not removal.
          // So children indices should be consistent: 0, 1, 2, 3, 4, 5.

          const celdaCantidad = fila.children[1];
          const celdaLote = fila.children[2];
          const celdaRef = fila.children[3];
          const celdaNombre = fila.children[4];

          const inputCantidad = celdaCantidad ? celdaCantidad.querySelector("input") : null;
          const inputLote = celdaLote ? celdaLote.querySelector("input") : null;
          const inputTx = fila.querySelector(".row-timestamps"); // New hidden input

          const cantidad = parseFloat(inputCantidad?.value || "0");
          const nombre = celdaNombre?.textContent.trim() || "";
          const referencia = celdaRef?.textContent.trim() || "";
          const lote = inputLote ? inputLote.value.trim().toUpperCase() : "";

          // Parse saved timestamps
          let timestamps = [];
          try {
            timestamps = inputTx ? JSON.parse(inputTx.value || "[]") : [];
          } catch (e) { timestamps = []; }

          // Log para verificar
          console.log("üì¶ fila ‚Üí ref:", referencia, "| nombre:", nombre, "| cantidad:", cantidad, "| lote:", lote);

          if (referencia && Number.isFinite(cantidad)) {
            const loteKey = lote && lote.length ? lote : "S/L";
            const detalle_lotes = { [loteKey]: cantidad };

            datosCaptura.push({
              referencia,
              nombre,
              cantidad,
              lote,
              timestamps,
              tipo: modo,
              detalle_lotes
            });
          }
        });

        // Guardar estado completo con metadatos
        const estado = {
          usuario: usuarioActivo,
          unidad: document.getElementById("unidadCaptura").value,
          modo: document.getElementById("modoCaptura").value,
          datos: datosCaptura,
          timestamp: Date.now()
        };
        localStorage.setItem("capturaPendiente", JSON.stringify(estado));

        console.log("üìù datosCaptura guardados (con metadatos):", estado);
      }
      function actualizarModoCaptura() {
        const toggle = document.getElementById("modoToggle");
        const texto = document.getElementById("modoTexto");
        const nuevoModo = toggle.checked ? "pruebas_facturadas" : "inventario";
        document.getElementById("modoCaptura").value = nuevoModo;

        const isPruebas = toggle.checked;

        // 1. Texto e √≠cono del modo
        texto.textContent = isPruebas ? "Pbas. fact." : "Inventario ";
        texto.className = isPruebas
          ? "font-bold text-xs uppercase tracking-wide text-rose-900 w-[70px] text-center"
          : "font-bold text-xs uppercase tracking-wide text-emerald-900 w-[70px] text-center";

        // Definir los grupos de colores
        const clasesInventario = ["from-teal-900", "to-emerald-800", "hover:from-teal-700", "hover:to-emerald-600", "shadow-emerald-900/40"];
        const clasesPruebas = ["from-rose-900", "to-red-800", "hover:from-rose-700", "hover:to-red-600", "shadow-rose-900/40"];
        // Clases a limpiar (union de ambos grupos + posibles residuos anteriores)
        const clasesLimpiar = [
          ...clasesInventario, ...clasesPruebas,
          "from-emerald-900", "to-teal-700", "hover:from-emerald-700", "hover:to-teal-500", // HTML Base
          "from-emerald-600", "to-teal-500", "hover:from-emerald-500", "hover:to-teal-400", // Old Vibrant Green
          "from-rose-600", "to-red-500", "hover:from-rose-500", "hover:to-red-400", // Old Vibrant Red
          "from-cyan-600", "to-blue-600", "hover:from-cyan-500", "hover:to-blue-500", "shadow-blue-500/30", // Old Blue
          "from-teal-600", "to-blue-600", "hover:from-teal-500", "hover:to-blue-500", "shadow-blue-500/30", // üëà Added: Current HTML state from user edit
          "shadow-rose-500/30", "to-orange-600", "hover:to-orange-500", "to-red-700", "hover:to-red-600" // Old Orange/Red variants
        ];

        // 2. Bot√≥n Agregar
        const btnAgregar = document.getElementById("btnAgregarCaptura");
        btnAgregar.classList.remove(...clasesLimpiar);

        if (isPruebas) {
          btnAgregar.classList.add(...clasesPruebas);
        } else {
          btnAgregar.classList.add(...clasesInventario);
        }

        // 3. Bot√≥n Enviar
        const btnEnviar = document.getElementById("btnEnviarCaptura");
        btnEnviar.classList.remove(...clasesLimpiar);

        if (isPruebas) {
          btnEnviar.textContent = "ENVIAR DATOS ‚ûî";
          btnEnviar.classList.add(...clasesPruebas);
        } else {
          btnEnviar.textContent = "ENVIAR DATOS ‚ûî";
          btnEnviar.classList.add(...clasesInventario);
        }

        // 4. Encabezado de tabla
        const encabezado = document.getElementById("tablaEncabezado");
        encabezado.classList.remove("bg-emerald-900", "bg-rose-900", "bg-[#06161d]");

        if (isPruebas) {
          encabezado.classList.add("bg-rose-900");
        } else {
          encabezado.classList.add("bg-[#06161d]");
        }

        // 5. Mostrar/Ocultar precarga de archivo (solo pruebas facturadas)
        const divArchivo = document.getElementById("divPrecargarArchivo");
        if (divArchivo) {
          if (isPruebas) {
            divArchivo.classList.remove("hidden");
          } else {
            divArchivo.classList.add("hidden");
          }
        }

        // 6. Toggle Lote column (NEW)
        const thLote = document.getElementById("thLote");
        if (thLote) {
          if (isPruebas) thLote.classList.add("hidden");
          else thLote.classList.remove("hidden"); // Visible in Inventory
        }
      }
      function mostrarModalCaptura() {
        document.getElementById("modalCaptura").classList.remove("hidden");
        actualizarModoCaptura();
      }

      function cerrarModalCaptura() {
        document.getElementById("modalCaptura").classList.add("hidden");
      }

      async function precargarArchivoCaptura() {
        const input = document.getElementById("archivoCaptura");
        const archivo = input?.files?.[0];

        // Nombre del archivo (UI)
        const nombre = document.getElementById("archivoCapturaNombre");
        if (nombre) nombre.textContent = archivo ? archivo.name : "Ning√∫n archivo";

        if (!archivo) {
          mostrarModal("‚ö†Ô∏è Selecciona un archivo .csv o .xlsx", "#d99b00");
          return;
        }

        try {
          const datos = await archivo.arrayBuffer();
          const workbook = XLSX.read(datos, { type: "array" });
          const hoja = workbook.Sheets[workbook.SheetNames[0]];
          const filas = XLSX.utils.sheet_to_json(hoja);

          if (!filas.length) {
            mostrarModal("‚ùå El archivo est√° vac√≠o.", "#B00042");
            return;
          }

          const tabla = document.querySelector("#tablaCaptura tbody");
          tabla.innerHTML = "";
          datosCaptura = [];

          filas.forEach(row => {
            const referencia = row.referencia || row.Referencia || row["N√∫mero de art√≠culo"];
            const nombre = row.nombre || row.Nombre || row["Descripci√≥n del art√≠culo"];
            const cantidad = parseFloat(row.cantidad || row.Cantidad || row["Cantidad Inventario"]);

            if (!referencia || isNaN(cantidad)) return;

            const tr = document.createElement("tr");
            tr.classList.add("completada");

            tr.innerHTML = `
          <td class="p-2 cantidad-td">
            <input
              type="number"
              step="0.1"
              min="0"
              max="999.9"
              value="${cantidad}"
              inputmode="decimal"
              class="cantidad-input input-cantidad"
              onchange="marcarComoCompletada(this)"
            />
          </td>
          <td class="p-2">${nombre || ""}</td>
          <td class="p-2">${referencia}</td>
          <td class="p-2 text-center">
            <button
              onclick='this.closest("tr").remove(); actualizarDatosCaptura()'
              class="text-rose-300 hover:text-rose-200">
              ‚úñ
            </button>
          </td>
        `;
            tabla.appendChild(tr);

            datosCaptura.push({
              referencia,
              nombre,
              cantidad,
              tipo: document.getElementById("modoCaptura").value
            });
          });

          document.getElementById("contenedorTabla").classList.remove("hidden");
          localStorage.setItem("capturaPendiente", JSON.stringify(datosCaptura));
          mostrarModal("‚úÖ Archivo cargado correctamente", "#065f46");

        } catch (err) {
          console.error("‚ùå Error al leer archivo:", err);
          mostrarModal("‚ùå Error al leer archivo", "#B00042");
        }
      }



      async function mostrarReferenciasUnidad() {
        const unidad = document.getElementById("unidadCaptura").value;
        const tabla = document.querySelector("#tablaCaptura tbody");
        const contenedorTabla = document.getElementById("contenedorTabla");

        if (!unidad) {
          mostrarModal("‚ö†Ô∏è Selecciona una unidad", "#d99b00");
          return;
        }

        try {
          mostrarLoader(true, "Cargando referencias de la unidad‚Ä¶");

          // ‚úÖ Trae SOLO esa unidad (paginado)
          const referencias = await precargarUnidadSiConviene(unidad);

          console.log("‚úÖ Referencias encontradas para esta unidad:", referencias.length);

          tabla.innerHTML = "";
          datosCaptura = [];

          const isInventario = (document.getElementById("modoCaptura").value === "inventario");
          referencias.forEach(r => agregarFilaCapturaUI(tabla, r.referencia, r.nombre, isInventario));

          contenedorTabla.classList.toggle("hidden", referencias.length === 0);

        } catch (e) {
          console.error("‚ùå Error mostrando referencias unidad:", e);
          mostrarModal("‚ùå No se pudieron cargar referencias de la unidad.", "#b00042");
        } finally {
          mostrarLoader(false);
        }
      }

      function agregarFilaCapturaUI(tabla, referencia, nombre, isInventario, loteVal = "") {
        const fila = document.createElement("tr");
        // Lote cell (hidden if not inventory)
        const loteDisplay = isInventario ? "" : "hidden";

        // NEW ORDER: (+) | Cantidad | Lote | Ref | Nombre | (x)
        fila.innerHTML = `
          <td class="p-2 text-center whitespace-nowrap">
            ${isInventario ? `
            <button onclick='agregarFilaExtra(this, "${referencia}", "${escapeHtml(nombre)}")' 
                    class="mr-2 text-emerald-400 hover:text-emerald-300 font-bold" title="Agregar otro lote">
              +
            </button>
            ` : ""}
          </td>

          <td class="p-2 cantidad-td">
            <input
              type="number"
              step="0.1"
              min="0"
              max="999.9"
              inputmode="decimal"
              placeholder="0.0"
              class="cantidad-input input-cantidad"
              onchange="marcarComoCompletada(this)"
            />
          </td>
          
          <td class="p-2 celda-lote ${loteDisplay}">
             <input type="text" 
                    class="input-lote input-lote-style" 
                    placeholder="Lote..."
                    value="${loteVal}"
             />
          </td>

          <td class="p-2 celda-ref text-right">${referencia}</td>
          
          <td class="p-2 celda-nombre">${nombre || ""}</td>
          
          <td class="p-2 text-center whitespace-nowrap">
            <button onclick='this.closest("tr").remove(); actualizarDatosCaptura()' class='text-red-600 font-bold'>‚úñ</button>
          </td>
          
          <!-- Hidden storage for timestamps associated with this row -->
          <input type="hidden" class="row-timestamps" value="[]" />
        `;
        tabla.appendChild(fila);
      }

      function agregarFilaExtra(btn, ref, nombre) {
        const tr = btn.closest("tr");
        // Insert after current row
        const nuevaFila = document.createElement("tr");

        // NEW ORDER: (+) | Cantidad | Lote | Ref | Nombre | (x)
        nuevaFila.innerHTML = `
          <td class="p-2 text-center whitespace-nowrap">
            <button onclick='agregarFilaExtra(this, "${ref}", "${escapeHtml(nombre)}")' 
                    class="mr-2 text-emerald-400 hover:text-emerald-300 font-bold" title="Agregar otro lote">
              +
            </button>
          </td>

          <td class="p-2 cantidad-td">
            <input
              type="number"
              step="0.1"
              min="0"
              max="999.9"
              inputmode="decimal"
              placeholder="0.0"
              class="cantidad-input input-cantidad"
              onchange="marcarComoCompletada(this)"
            />
          </td>
          
          <td class="p-2 celda-lote">
             <input type="text" 
                    class="input-lote w-full bg-black/20 border border-white/10 rounded px-1 py-1 text-xs text-white uppercase placeholder-white/30" 
                    placeholder="Lote..."
             />
          </td>

          <td class="p-2 celda-ref text-right">${ref}</td>
          
          <td class="p-2 celda-nombre">${nombre || ""}</td>
          
          <td class="p-2 text-center whitespace-nowrap">
            <button onclick='this.closest("tr").remove(); actualizarDatosCaptura()' class='text-red-600 font-bold'>‚úñ</button>
          </td>
          
          <!-- Hidden storage for timestamps associated with this row -->
          <input type="hidden" class="row-timestamps" value="[]" />
        `;

        // Insert after Current
        tr.after(nuevaFila);
      }


      async function procesarArchivoPruebasFacturadas(archivo, modo) {
        const reader = new FileReader();
        reader.onload = async (e) => {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });

          const relaciones = await obtenerRelacionesSupabase(); // Debe devolver un array [{ referencia, nombre_facturacion }]
          if (!relaciones.length) return mostrarModal("‚ùå No se pudieron cargar las relaciones.", "red");

          const hojaActual = workbook.SheetNames[0];
          const unidad = unidadesFijas[hojaActual];
          if (!unidad) return mostrarModal("‚ùå Unidad no reconocida: " + hojaActual, "red");

          const sheet = workbook.Sheets[hojaActual];
          const datos = XLSX.utils.sheet_to_json(sheet, { header: 1 });

          const nombreColumna = datos[0][0]; // Asumimos que la fila 0 tiene encabezado y columna A es relevante
          const filaInicial = 1; // Saltamos encabezado

          let coincidencias = 0;
          for (let i = filaInicial; i < datos.length; i++) {
            const nombreExcel = (datos[i][0] || "").toString().trim().toUpperCase();
            const cantidad = parseFloat(datos[i][1]);
            if (!nombreExcel || isNaN(cantidad)) continue;

            const rel = relaciones.find(r =>
              (r.nombre_facturacion || "").toUpperCase().trim() === nombreExcel
            );
            if (!rel) continue;

            // Buscar fila en tabla actual y actualizar
            const fila = [...document.querySelectorAll("#tablaCaptura tbody tr")].find(f =>
              f.children[0].textContent.trim() === rel.referencia
            );
            if (fila) {
              const input = fila.querySelector("input[type='number']");
              if (input) {
                input.value = cantidad;
                marcarComoCompletada(input);
                coincidencias++;
              }
            }
          }

          mostrarModal(`üìÑ Archivo cargado: ${coincidencias} coincidencias aplicadas.`, "green");
        };

        reader.readAsArrayBuffer(archivo);
      }

      async function obtenerRelacionesSupabase() {
        try {
          const res = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/relaciones?select=referencia,nombre_facturacion", {
            headers: {
              apikey: "API_KEY",
              Authorization: "Bearer API_KEY"
            }
          });
          if (!res.ok) throw new Error("Respuesta no v√°lida");
          return await res.json();
        } catch (e) {
          console.error("Error al obtener relaciones:", e);
          return [];
        }
      }
      function extraerTimestampPlano(qr) {
        if (!qr) return null;

        const limpio = qr
          .replace(/["']/g, "")
          .replace(/\*/g, "")
          .trim();

        const match = limpio.match(/T[:>]\s*([A-Za-z0-9\-]+)/i);
        return match ? match[1].trim() : null;
      }

      function extraerReferenciaPlano(qr) {
        if (!qr) return null;

        console.log("üîç extraerReferenciaPlano() input:", qr);

        // Limpiar comillas, asteriscos u otros adornos que vienen del lector
        const limpio = qr
          .replace(/["']/g, "")   // quita comillas
          .replace(/\*/g, "")     // quita asteriscos **
          .trim();

        console.log("üîç extraerReferenciaPlano() limpio:", limpio);

        // 1) Formato con llaves {3030603MYB}//{S/L}--{2030-12-31}|T:...
        const matchLlaves = limpio.match(/\{([^}]+)\}/);
        if (matchLlaves) {
          const ref = matchLlaves[1].trim();
          console.log("‚úÖ referencia por llaves:", ref);
          return ref;
        }

        // 2) Formato cl√°sico con R: o R>
        const matchR = limpio.match(/R[:>]\s*([A-Za-z0-9\-]+)/i);
        if (matchR) {
          const ref = matchR[1].trim();
          console.log("‚úÖ referencia por R:", ref);
          return ref;
        }

        console.warn("‚ö†Ô∏è extraerReferenciaPlano() no encontr√≥ referencia");
        return null;
      }

      function actualizarInventarioDetallado(referencia, lote, caducidad, deltaCantidad) {
        if (!referencia || !deltaCantidad) return;

        const loteKey = lote && lote.trim() ? lote.trim() : "S/L";
        const cadKey = caducidad && caducidad.trim() ? caducidad.trim() : "SIN_CAD";

        if (!inventarioDetallado[referencia]) {
          inventarioDetallado[referencia] = {};
        }
        if (!inventarioDetallado[referencia][loteKey]) {
          inventarioDetallado[referencia][loteKey] = {};
        }

        const actual = inventarioDetallado[referencia][loteKey][cadKey] || 0;
        inventarioDetallado[referencia][loteKey][cadKey] = actual + deltaCantidad;

        // (Opcional) log para revisar qu√© se va guardando
        console.log("üìä Inventario detallado actualizado:", referencia, loteKey, cadKey, "‚Üí", inventarioDetallado[referencia][loteKey][cadKey]);
      }
      async function manejarEscaneoInventario(contenido) { // ASYNC NOW
        try {
          console.log("üì• manejarEscaneoInventario() contenido bruto:", contenido);

          const modo = document.getElementById("modoCaptura")?.value;
          const unidad = document.getElementById("unidadCaptura")?.value;
          const timestamp = extraerTimestampPlano(contenido); // Extraemos timestamp si existe

          // 1. Validar contra Set Local (duplicado en sesion actual)
          if (timestamp && timestampsEscaneadosInventario.has(timestamp)) {
            mostrarModal("‚ö†Ô∏è Este QR ya fue escaneado en esta sesi√≥n.", "#d97706");
            sonidoError();
            return; // Stop
          }

          // 2. Validar contra BD 
          // Preparamos payload
          const referenciaRaw = extraerReferenciaPlano(contenido);
          if (!referenciaRaw) { mostrarModal("‚ùå No se detect√≥ referencia v√°lida.", "#B00042"); return; }
          const referenciaNormalizada = referenciaRaw.toString().trim().toUpperCase();


          let lote = null;
          let caducidad = null;

          const matchLote = contenido.match(/L[:>]\s*([A-Za-z0-9\-]+)/i);
          lote = matchLote ? matchLote[1].trim() : null;

          // Caducidad parsing
          const matchCad = contenido.match(/C[:>]\s*(\d{4}-\d{2}-\d{2})/i); // Example regex
          caducidad = matchCad ? matchCad[1] : null;

          // Validation Call
          mostrarLoader(true, "Validando QR...");
          try {
            // Construct payload for validating single item
            const payloadVal = {
              registros: [{
                referencia: referenciaNormalizada,
                lote: lote || "S/L",
                timestamp: timestamp || Date.now(), // Fallback if no timestamp?
                modo: "inventario" // Always 'entrada' for uniqueness check as agreed
              }]
            };

            const respVal = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/validar_qr", {
              method: "POST",
              headers: { "Content-Type": "application/json", "Authorization": "Bearer " + API_KEY },
              body: JSON.stringify(payloadVal)
            });

            const dataVal = await respVal.json();
            ocultarLoader();

            const resItem = dataVal.resultados?.[0]; // Get first result
            if (resItem) {
              if (resItem.status === "repetido") {
                mostrarModal("‚ùå Este QR ya existe en el sistema (Repetido).", "#B00042");
                sonidoError();
                return;
              }
              if (resItem.status === "error") {
                mostrarModal("‚ùå Error validando: " + (resItem.mensaje || "?"), "#B00042");
                return;
              }
              // If status 'ok' or 'nuevo_producto' -> Proceed
            }
          } catch (e) {
            console.error("Error validar_qr", e);
            ocultarLoader();
            mostrarModal("‚ö†Ô∏è Error conectando con validador. Se proceder√° localmente.", "#d97706");
            // Fallback: Proceed? Or Block? Proceeding is risky but robust for offline.
            // Taking risk to proceed.
          }

          // Proceed with local update logic...


          console.log("üìå modoCaptura:", modo, " | unidadCaptura:", unidad);

          if (modo !== "inventario") {
            mostrarModal("‚ö†Ô∏è Cambia a modo INVENTARIO para usar el lector QR de inventario.", "#d99b00");
            return;
          }

          if (!unidad) {
            mostrarModal("‚ö†Ô∏è Selecciona una unidad antes de escanear.", "#d99b00");
            return;
          }

          // 1) Obtener datos con tu parser actual
          const datos = extraerDatosQR(contenido) || {};
          console.log("üß© extraerDatosQR() ‚Üí", datos);

          referencia = datos.referencia || extraerReferenciaPlano(contenido);
          lote = datos.lote || lote; // Use parsed lote if available, otherwise from datos
          caducidad = datos.caducidad || caducidad; // Use parsed caducidad if available, otherwise from datos
          // timestamp = datos.timestamp || extraerTimestampPlano(contenido); // Already extracted above

          console.log("üéØ referencia preliminar:", referencia, "| lote:", lote, "| caducidad:", caducidad, "| timestamp:", timestamp);

          if (!referencia) {
            mostrarModal("‚ùå No se encontr√≥ la referencia en el QR.", "#B00042");
            return;
          }

          // 2) Bloquear si el timestamp ya se escane√≥ antes
          if (timestamp) {
            console.log("‚è± timestamp detectado:", timestamp);
            if (timestampsEscaneadosInventario.has(timestamp)) {
              console.warn("‚õî timestamp ya escaneado:", timestamp);
              mostrarModal("‚õî Esta etiqueta ya fue escaneada anteriormente.", "#B00042");
              return;
            }
          } else {
            console.warn("‚ö†Ô∏è QR sin timestamp, no se puede validar duplicado por T:");
          }

          // const referenciaNormalizada = referencia.toString().trim().toUpperCase(); // Already calculated above
          console.log("üéØ referencia normalizada:", referenciaNormalizada);

          // 3) Buscar en la tabla de captura
          const filas = document.querySelectorAll("#tablaCaptura tbody tr");
          console.log("üìä Filas actuales en tablaCaptura:", filas.length);

          let encontrada = false;
          let refExisteEnTabla = false;
          let nombreAsociado = "";

          const loteScanned = lote ? lote.toString().trim().toUpperCase() : "";

          // Primero intentamos encontrar match exacto o "claimable"
          for (const fila of filas) {
            // NEW ORDER: (+) [0], Cant [1], Lote [2], Ref [3], Nombre [4], (x) [5]
            const refFila = fila.children[3]?.textContent.trim();
            const refFilaNorm = (refFila ?? "").toString().trim().toUpperCase();

            if (refFilaNorm === referenciaNormalizada) {
              refExisteEnTabla = true;
              nombreAsociado = fila.children[4]?.textContent.trim();

              const inputLote = fila.children[2]?.querySelector("input");
              const loteFila = inputLote ? inputLote.value.trim().toUpperCase() : "";

              // MATCH LOGIC:
              // 1. Exact match: Lote scan == Lote fila
              // 2. Claim match: Lote scan exits AND Lote fila is empty
              // 3. No-Lot match: Lote scan empty AND Lote fila empty

              const isExactMatch = (loteScanned === loteFila);
              const isClaimable = (loteScanned !== "" && loteFila === "");

              if (isExactMatch || isClaimable) {
                const inputCantidad = fila.children[1]?.querySelector("input");
                if (inputCantidad) {
                  const actual = parseFloat(inputCantidad.value) || 0;
                  const nueva = actual + 1;
                  inputCantidad.value = nueva.toString();

                  // If claimed, update lot
                  if (isClaimable && inputLote) {
                    inputLote.value = loteScanned;
                  }

                  marcarComoCompletada(inputCantidad);
                  encontrada = true;
                  moverFilaAlInicio(fila);

                  // Add TS to row storage
                  if (timestamp) {
                    const inputTx = fila.querySelector(".row-timestamps");
                    let txArr = [];
                    try { txArr = JSON.parse(inputTx?.value || "[]"); } catch (e) { }
                    txArr.push(timestamp);
                    if (inputTx) inputTx.value = JSON.stringify(txArr);
                    // Global set
                    timestampsEscaneadosInventario.add(timestamp);
                  }

                  // Registrar inventario detallado ...
                  if (typeof actualizarInventarioDetallado === "function") {
                    actualizarInventarioDetallado(referencia, loteScanned || loteFila, caducidad, 1);
                  }

                  // Registrar timestamp
                  // This is now handled by the block above
                }
                break; // Stop searching if found
              }
            }
          }

          if (!encontrada) {
            if (refExisteEnTabla) {
              // Existe la referencia pero con OTRO lote. Crear NUEVA fila para este lote.
              const tbody = document.querySelector("#tablaCaptura tbody");

              // Usamos la funcion que creamos (o inline logic si no esta disponible, pero asumimos que esta)
              if (typeof agregarFilaCapturaUI === "function") {
                agregarFilaCapturaUI(tbody, referencia, nombreAsociado, true, loteScanned);

                // La fila se agrego al final, obtenemos la ultima
                const nuevaFila = tbody.lastElementChild;

                // Set cantidad to 1
                const inputCantidad = nuevaFila.querySelector(".input-cantidad");
                if (inputCantidad) {
                  inputCantidad.value = "1";
                  marcarComoCompletada(inputCantidad);
                }

                // Add TS to row storage
                if (timestamp) {
                  const inputTx = nuevaFila.querySelector(".row-timestamps");
                  let txArr = [timestamp];
                  if (inputTx) inputTx.value = JSON.stringify(txArr);
                  timestampsEscaneadosInventario.add(timestamp);
                }

                moverFilaAlInicio(nuevaFila);
                if (typeof actualizarInventarioDetallado === "function") {
                  actualizarInventarioDetallado(referencia, loteScanned, caducidad, 1);
                }
                // This is now handled by the block above
                // if (timestamp) timestampsEscaneadosInventario.add(timestamp);

                console.log("‚úÖ Nueva fila creada para Lote:", loteScanned);
                encontrada = true; // Handled
              } else {
                console.error("‚ùå agregarFilaCapturaUI no definida");
              }

            } else {
              // No existe la referencia en absoluto
              console.warn("‚ö†Ô∏è Referencia no encontrada en tablaCaptura. Unidad actual:", unidad);
              mostrarModal("‚ùå Esta referencia no est√° en la tabla de la unidad seleccionada.", "#B00042");
              return;
            }
          }

          // (Opcional) actualizar inputs visibles
          const inputRef = document.getElementById("inputReferencia");
          if (inputRef) inputRef.value = referencia;
          const inputCant = document.getElementById("inputCantidad");
          if (inputCant) inputCant.value = "1";

          console.log("üéØ Escaneo inventario final:", { referencia, lote, caducidad, timestamp });

        } catch (err) {
          console.error("üí• Error en manejarEscaneoInventario:", err);
          mostrarModal("‚ùå Error al procesar el QR de inventario.", "#B00042");
        }
      }


      function agregarFilaCaptura() {
        const refInput = document.getElementById("inputReferencia");
        const cantInput = document.getElementById("inputCantidad");
        const loteInput = document.getElementById("inputLoteManual");
        const unidad = document.getElementById("unidadCaptura").value;

        const ref = refInput.value.trim();
        const cantidad = parseFloat(cantInput.value);
        const lote = loteInput ? loteInput.value.trim().toUpperCase() : "";

        if (!ref || isNaN(cantidad)) {
          mostrarModal("‚ö†Ô∏è Faltan datos (Referencia o Cantidad)", "#d99b00");
          return;
        }

        // Verificaci√≥n de asignaci√≥n de referencia a la unidad
        // Si tienes "precargarUnidadSiConviene", podr√≠as usar cacheRefsUnidad, 
        // pero por seguridad usamos referenciasPorUnidad si est√° lleno, o omitimos check si es server-side only
        // Asumiremos que si el usuario escribe algo manual, confiamos o verificamos vs typeahead list?
        // Dejemos validaci√≥n b√°sica si referenciasPorUnidad tiene datos.
        if (Array.isArray(referenciasPorUnidad) && referenciasPorUnidad.length > 0) {
          const normUnidad = normalizarTexto(unidad);
          const coincide = referenciasPorUnidad.some(r =>
            r.referencia === ref && normalizarTexto(r.unidad_medica) === normUnidad
          );
          // Si no coincide y estamos estrictos?
          // Por ahora dejamos pasar si no tenemos la lista completa cargada (Elite mode)
          // If Elite mode used local cache:
          // const cache = cacheRefsUnidad.get(normUnidad);
          // if (cache && !cache.some(r => r.referencia === ref)) ...
        }

        const filas = document.querySelectorAll("#tablaCaptura tbody tr");
        let encontrada = false;

        // B√∫squeda de fila existente: Coincidir REF y LOTE
        for (const fila of filas) {
          // NEW ORDER: [0](+) | [1]Cant | [2]Lote | [3]Ref | [4]Nombre
          const celdaRef = fila.children[3];
          if (!celdaRef) continue;

          const refFila = celdaRef.textContent.trim();

          if (refFila === ref) {
            // Checar lote
            const celdaLote = fila.children[2];
            const inputLote = celdaLote ? celdaLote.querySelector("input") : null;
            const loteFila = inputLote ? inputLote.value.trim().toUpperCase() : "";

            // Match logic:
            // 1. Exact match (Lote input == Lote fila)
            // 2. Claim match (Lote input exists, Lote fila empty) -> Updates fila to this lot
            const matchExacto = (lote === loteFila);
            const matchClaim = (lote !== "" && loteFila === "");

            if (matchExacto || matchClaim) {
              const celdaCantidad = fila.children[1];
              const inputCantidad = celdaCantidad ? celdaCantidad.querySelector("input") : null;

              if (inputCantidad) {
                const actual = parseFloat(inputCantidad.value) || 0;
                inputCantidad.value = (actual + cantidad).toFixed(1).replace(/\.0$/, ''); // avoid .0

                // Update lot if claiming
                if (matchClaim && inputLote) inputLote.value = lote;

                marcarComoCompletada(inputCantidad);
                encontrada = true;

                // Move to top
                moverFilaAlInicio(fila);
                break;
              }
            }
          }
        }

        if (!encontrada) {
          // Crear nueva fila
          // Necesitamos el nombre... si tenemos cache, buscarlo. Si no, "Agregado Manual"
          let nombre = "Agregado Manual";
          // Try to find name in cache
          if (typeof cacheRefsUnidad !== "undefined") {
            const cache = cacheRefsUnidad.get(normalizarTexto(unidad));
            const match = cache?.find(r => r.referencia === ref);
            if (match) nombre = match.nombre;
          } else if (Array.isArray(referenciasPorUnidad)) {
            const match = referenciasPorUnidad.find(r => r.referencia === ref);
            if (match) nombre = match.nombre;
          }

          const tbody = document.querySelector("#tablaCaptura tbody");
          const isInventario = true; // Manual add usually implies inventory mode or context
          agregarFilaCapturaUI(tbody, ref, nombre, isInventario, lote);

          // Update quantity of new row
          const nuevaFila = tbody.lastElementChild;
          const inputCantidad = nuevaFila.querySelector(".input-cantidad");
          if (inputCantidad) {
            inputCantidad.value = cantidad;
            marcarComoCompletada(inputCantidad);
          }
          moverFilaAlInicio(nuevaFila);
        }

        // Limpiar inputs
        refInput.value = "";
        cantInput.value = "";
        if (loteInput) loteInput.value = "";
        refInput.focus();

        // Hide suggestions
        const sug = document.getElementById("sugerenciasReferencia");
        if (sug) sug.classList.add("hidden");
      }
      function cerrarModalNIP() {
        document.getElementById("modalNIP").classList.add("hidden");
      }

      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          cerrarModalNIP();
        }
      });
      function agruparCapturaPorReferencia(registros) {
        const map = new Map();

        for (const r of registros) {
          const ref = String(r.referencia || "").trim();
          if (!ref) continue;

          const entry = map.get(ref) || {
            referencia: ref,
            nombre: r.nombre || "",
            cantidad: 0,
            lote: "", // ya no importa como "principal"
            timestamps: [],
            tipo: r.tipo,
            detalle_lotes: {}
          };

          entry.cantidad += Number(r.cantidad) || 0;

          const dl = r.detalle_lotes || {};
          for (const [lote, cant] of Object.entries(dl)) {
            entry.detalle_lotes[lote] = (Number(entry.detalle_lotes[lote]) || 0) + (Number(cant) || 0);
          }

          if (Array.isArray(r.timestamps)) entry.timestamps.push(...r.timestamps);

          map.set(ref, entry);
        }

        return Array.from(map.values());
      }
      function aplicarFiltrosTabla() {
        const ocultarCompletados = document.getElementById("checkboxFilas")?.checked;
        const ocultarLotes = document.getElementById("checkboxFilasLote")?.checked;

        const filas = document.querySelectorAll("#tablaCaptura tbody tr");
        filas.forEach(fila => {
          let debeOcultar = false;

          if (ocultarCompletados && fila.classList.contains("completada")) {
            debeOcultar = true;
          }

          if (ocultarLotes && fila.classList.contains("lote-completo")) {
            debeOcultar = true;
          }

          fila.style.display = debeOcultar ? "none" : "";
        });
      }

      function marcarComoCompletada(input) {
        const fila = input.closest("tr");
        const cantidad = parseFloat(input.value);

        // Check Lote input
        const inputLote = fila.querySelector(".input-lote"); // using class we added, or indices
        const loteVal = inputLote ? inputLote.value.trim() : "";

        // 1. Check Completada (Quantity > 0)
        if (!isNaN(cantidad) && cantidad > 0) {
          fila.classList.add("completada");
        } else {
          fila.classList.remove("completada");
        }

        // 2. Check Lote Completo (Quantity > 0 AND Lote filled)
        if (!isNaN(cantidad) && cantidad > 0 && loteVal.length > 0) {
          fila.classList.add("lote-completo");
        } else {
          fila.classList.remove("lote-completo");
        }

        // 3. Re-apply filters immediately
        aplicarFiltrosTabla();

        // üî• IMPORTANT: Use the centralized saver to ensure metadata (user, unit, etc) is saved correctly
        // instead of manual/partial saving that breaks restoration.
        if (typeof actualizarDatosCaptura === "function") {
          actualizarDatosCaptura();
        }
      }

      async function enviarCapturaBase() {
        if (!datosCaptura.length) return alert("No hay datos que enviar.");

        const unidad = document.getElementById("unidadCaptura").value;
        const usuario = usuarioActivo;
        const modo = document.getElementById("modoCaptura").value; // "inventario" o "pruebas_facturadas"
        const mes = parseInt(document.getElementById("mesCaptura").value);
        const anio = document.getElementById("anioCaptura").value;
        const tipoCorte = document.getElementById("toggleTipoCaptura").checked ? "25" : "10";

        if (!unidad || !usuario || !mes || !anio) {
          mostrarModal("‚ùå Faltan datos necesarios (usuario, unidad, mes o a√±o).", "#b00042");
          return;
        }

        // Construir nombre de columna, ej. "10_6_2025"
        const columna = `${tipoCorte}_${mes}_${anio}`;

        mostrarLoader(true, "Enviando datos al servidor‚Ä¶");
        const registrosAgrupados = agruparCapturaPorReferencia(datosCaptura);
        try {
          const payload = {
            unidad,
            usuario,
            registros: registrosAgrupados,
            columna,
            tabla: (modo === "inventario") ? "historicos" : "pruebas_facturadas"
          };

          console.log("üì§ Enviando:", JSON.stringify(payload));
          console.log("üß™ registros sample:", payload.registros.slice(0, 3));
          const res = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/guardar_captura", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          const resultado = await res.json();
          if (res.ok && resultado.status === "ok") {
            mostrarModal("‚úÖ Datos enviados correctamente.", "#00B000");
            datosCaptura = [];
            document.querySelector("#tablaCaptura tbody").innerHTML = "";
            localStorage.removeItem("capturaPendiente");
          } else {
            mostrarModal("‚ùå Error al enviar: " + (resultado.error || "desconocido"), "#B00042");
          }
        } catch (err) {
          console.error("‚ùå Error de conexi√≥n:", err);
          mostrarModal("‚ùå Error de conexi√≥n al enviar.", "#B00042");
        } finally {
          mostrarLoader(false);
        }
      }

      function cerrarModalCaducidad() {
        document.getElementById("modalCaducidad").classList.add("hidden");
      }

      function calcularDiasRestantes(fecha) {
        if (!fecha || fecha === "S/C" || fecha === "0" || fecha === 0 || fecha === "000") return Infinity;

        let fechaCad = null;

        // Serial de Excel v√°lido
        if (!isNaN(fecha)) {
          const serial = parseInt(fecha, 10);
          if (serial > 1000) {
            fechaCad = new Date(1900, 0, serial - 2);
          }
        }

        // Formato YYYY-MM-DD
        if (!fechaCad && /^\d{4}-\d{2}-\d{2}$/.test(fecha)) {
          const [anio, mes, dia] = fecha.split("-").map(Number);
          fechaCad = new Date(anio, mes - 1, dia);
        }

        // Formato DD/MM/YYYY
        if (!fechaCad && /^\d{2}\/\d{2}\/\d{4}$/.test(fecha)) {
          const [dia, mes, anio] = fecha.split("/").map(Number);
          fechaCad = new Date(anio, mes - 1, dia);
        }

        // Si sigue sin poderse interpretar, retorna infinito
        if (!fechaCad || isNaN(fechaCad.getTime())) return Infinity;

        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);
        const diff = fechaCad - hoy;
        return Math.floor(diff / (1000 * 60 * 60 * 24));
      }


      function formatearCaducidad(fecha) {
        let fechaCad = null;
        if (!isNaN(fecha)) {
          const serial = parseInt(fecha, 10);
          if (serial > 1000) fechaCad = new Date(1900, 0, serial - 2);
        } else if (/^\d{4}-\d{2}-\d{2}$/.test(fecha)) {
          const [anio, mes, dia] = fecha.split("-").map(Number);
          fechaCad = new Date(anio, mes - 1, dia);
        } else if (/^\d{2}\/\d{2}\/\d{4}$/.test(fecha)) {
          const [dia, mes, anio] = fecha.split("/").map(Number);
          fechaCad = new Date(anio, mes - 1, dia);
        }
        if (!fechaCad) return "-";

        const dd = String(fechaCad.getDate()).padStart(2, "0");
        const mm = String(fechaCad.getMonth() + 1).padStart(2, "0");
        const yyyy = fechaCad.getFullYear();
        return `${dd}/${mm}/${yyyy}`;
      }

      async function mostrarAlertasCaducidad() {
        console.log("‚ñ∂ Iniciando mostrarAlertasCaducidad()");

        const cont = document.getElementById("contenidoCaducidad");
        const modal = document.getElementById("modalCaducidad");

        try {
          // Loader opcional si lo tienes
          if (typeof mostrarLoader === "function") mostrarLoader(true);

          const res = await fetch(
            "https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/productos?select=referencia,nombre,fabricante,lote,caducidad,cantidad",
            {
              headers: {
                "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MjcxNjYsImV4cCI6MjA2MjAwMzE2Nn0.vxPo7XXaeKPa-jDQRA2jvOJ7dvJZDHRNZB7blbONNZo",            // üëà NO uses service_role en frontend
                "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkanJwZnNicGNmbmlubnRmZm9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MjcxNjYsImV4cCI6MjA2MjAwMzE2Nn0.vxPo7XXaeKPa-jDQRA2jvOJ7dvJZDHRNZB7blbONNZo"
              }
            }
          );

          console.log("‚úÖ Fetch ejecutado", res.status);

          const data = await res.json();
          console.log("‚úÖ Respuesta recibida:", data);

          if (!Array.isArray(data)) {
            console.error("‚ùå ERROR: La respuesta no es un array:", data);
            cont.innerHTML = `<div class="space-card p-4 rounded-2xl border border-white/10 text-white/80">
        ‚ùå Respuesta inv√°lida del servidor.
      </div>`;
            modal.classList.remove("hidden");
            return;
          }

          const proximos = data
            .map(p => ({ ...p, diasRestantes: calcularDiasRestantes(p.caducidad) }))
            .filter(p => Number.isFinite(p.diasRestantes) && p.diasRestantes <= 30)
            .sort((a, b) => a.diasRestantes - b.diasRestantes);

          if (!proximos.length) {
            cont.innerHTML = `
        <div class="space-card p-5 rounded-2xl border border-white/10 text-center">
          <div class="text-emerald-200 font-extrabold">‚úÖ No hay productos pr√≥ximos a caducar</div>
          <div class="text-xs text-white/60 mt-1">Rango: pr√≥ximos 30 d√≠as</div>
        </div>
      `;
            modal.classList.remove("hidden");
            return;
          }

          const pill = (dias) => {
            if (dias <= 7) return `<span class="cadu-pill cadu-pill--danger">‚õî URGENTE ¬∑ ${dias} d√≠as</span>`;
            if (dias <= 15) return `<span class="cadu-pill cadu-pill--warn">‚ö†Ô∏è PRONTO ¬∑ ${dias} d√≠as</span>`;
            return `<span class="cadu-pill cadu-pill--ok">‚úÖ OK ¬∑ ${dias} d√≠as</span>`;
          };

          const esc = (v) => (typeof escapeHtml === "function")
            ? escapeHtml(v)
            : String(v ?? "").replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;");

          const header = `
      <div class="space-card p-4 rounded-2xl border border-white/10 mb-3">
        <div class="flex flex-wrap items-center justify-between gap-2">
          <div class="font-extrabold text-white/90">‚ö†Ô∏è Productos pr√≥ximos a caducar</div>
          <div class="text-xs text-white/60">${proximos.length} encontrados (‚â§ 30 d√≠as)</div>
        </div>
        <div class="text-xs text-white/60 mt-1">
          En m√≥vil puedes deslizar horizontalmente la tabla.
        </div>
      </div>
    `;

          let rows = "";
          for (const p of proximos) {
            rows += `
        <tr>
          <td>
            <div class="font-bold text-white/90">${esc(p.referencia)}</div>
            <span class="cadu-sub">${esc(p.nombre || "")}</span>
            <span class="cadu-sub">${esc(p.fabricante || "")}</span>
          </td>
          <td class="whitespace-nowrap">${esc(p.lote || "S/L")}</td>
          <td class="whitespace-nowrap">${esc(formatearCaducidad(p.caducidad))}</td>
          <td class="whitespace-nowrap">${pill(p.diasRestantes)}</td>
          <td class="whitespace-nowrap text-right">${esc(p.cantidad ?? "")}</td>
        </tr>
      `;
          }

          cont.innerHTML = `
      ${header}
      <div class="cadu-table-wrap">
        <table class="cadu-table">
          <thead>
            <tr>
              <th>Producto</th>
              <th>Lote</th>
              <th>Caducidad</th>
              <th>Estado</th>
              <th class="text-right">Cantidad</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;

          modal.classList.remove("hidden");
        } catch (err) {
          console.error("‚ùå Error cargando productos urgentes:", err);
          cont.innerHTML = `
      <div class="space-card p-5 rounded-2xl border border-rose-400/20 bg-rose-900/20 text-white/85">
        ‚ùå Error al cargar datos. Revisa conexi√≥n o permisos.
        <div class="text-xs text-white/60 mt-1">${String(err?.message || err)}</div>
      </div>
    `;
          modal.classList.remove("hidden");
        } finally {
          if (typeof ocultarLoader === "function") ocultarLoader();
          else if (typeof mostrarLoader === "function") mostrarLoader(false);
        }
      }

      // Asignar el evento al bot√≥n una vez cargue todo
      document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("btnAlertasCaducidad").addEventListener("click", mostrarAlertasCaducidad);
      });
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          const modal = document.getElementById("modalCaducidad");
          if (modal && !modal.classList.contains("hidden")) {
            cerrarModalCaducidad();
          }
        }
      });

      // Abre el modal y prepara el selector:
      window.abrirModalReporteMensual = function () {
        console.log("üü¢ abrirModalReporteMensual ejecutado");

        const modal = document.getElementById("modalReporteMensual");
        if (!modal) {
          console.error("‚ùå No se encontr√≥ el modalReporteMensual");
          return;
        }

        // ‚úÖ Fuerza centrado SIEMPRE (por si en el HTML falt√≥ flex)
        modal.classList.add("flex", "items-center", "justify-center");
        modal.classList.remove("hidden");

        // (Opcional pero recomendado) padding para m√≥viles
        modal.classList.add("p-4");

        inicializarSelectorMesAnio();

        console.log("‚úÖ Modal de reporte mensual abierto correctamente");
      };

      window.cerrarModalReporteMensual = function () {
        console.log("üîí Cerrando modal de reporte");
        const modal = document.getElementById("modalReporteMensual");
        if (!modal) return;

        modal.classList.add("hidden");
        // puedes dejar estas puestas siempre, pero si quieres limpiar:
        // modal.classList.remove("flex", "items-center", "justify-center");
      };

      window.generarReporteMensual = async function () {
        console.log("üöÄ Iniciando generaci√≥n de reporte");

        const mes = document.getElementById("inputMesMes")?.value;
        const anio = document.getElementById("inputMesAnio")?.value;

        if (!mes || !anio) {
          mostrarModal("‚ö†Ô∏è Selecciona mes y a√±o", "#d99b00");
          return;
        }

        cerrarModalReporteMensual();
        mostrarModal("‚è≥ Generando reporte...", "#0ea5e9");

        const mesSeleccionado = `${anio}-${mes}`; // "2026-02"
        const mesNum = parseInt(mes, 10);
        const anioNum = parseInt(anio, 10);

        // Columnas (se mantienen como est√°n)
        const colInventarioCorte = `10_${mesNum}_${anioNum}`;       // inventario intermedio
        const colPruebasFacturadas = `25_${mesNum}_${anioNum}`;     // pruebas del mes (corte 25)

        const proyectos = {
          "CHIH IMSS B.S.": ["C03126", "C03127", "C03128", "C03129", "C03130", "C03131", "C03132", "C03133", "C03134", "C03135"],
          "CHIH IMSS_BIENESTAR LAB.": ["C03122", "C03123", "C03124"],
          "CHIH SS LAB.": ["C03415", "C03416", "C03417", "C03418", "C03419", "C03420", "C03421", "C03422", "C03423", "C03424",
            "C03425", "C03426", "C03427", "C03428", "C03429", "C03430", "C03431", "C03432", "C03433", "C03434", "C03435", "C03436",
            "C03437", "C03438", "C03439", "C03440", "C03441", "C03442", "C03443", "C03444", "C03445", "C03446", "C03447", "C03448",
            "C03449", "C03450", "C03451"]
        };

        try {
          const headers = { apikey: API_KEY, Authorization: `Bearer ${API_KEY}` };

          // 1) Traer gasto mensual calculado (RPC)
          const gastoRes = await fetch(
            "https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/rpc/calcular_gasto_producto_mensual",
            {
              method: "POST",
              headers: { ...headers, "Content-Type": "application/json" },
              body: JSON.stringify({ p_mes: mesNum, p_anio: anioNum })
            }
          );

          if (!gastoRes.ok) {
            const t = await gastoRes.text();
            throw new Error(`RPC gasto failed: ${gastoRes.status} ${t}`);
          }

          const gastoRows = await gastoRes.json();
          console.log("üì• gastoRows:", gastoRows?.length);

          // 2) Traer metadata de historicos (NO todo el hist√≥rico)
          //    OJO: aqu√≠ traemos solo lo que usas en el excel + inventario del 10 del mes (intermedio)
          //    Si no existe esa columna todav√≠a, vendr√° null y lo tratamos como 0.
          const historicosRes = await fetch(
            `https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/historicos?select=unidad_medica,unidad_nombre,referencia,nombre,fabricante,presentacion,rendimiento,costo,inventario_objetivo,"${colInventarioCorte}"`,
            { headers }
          );

          if (!historicosRes.ok) {
            const t = await historicosRes.text();
            throw new Error(`historicos fetch failed: ${historicosRes.status} ${t}`);
          }

          const historicosMeta = await historicosRes.json();
          console.log("üì• historicosMeta:", historicosMeta?.length);

          // 3) Traer pruebas facturadas (idealmente solo columna del 25 del mes)
          const pruebasRes = await fetch(
            `https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/pruebas_facturadas?select=unidad_medica,referencia,"${colPruebasFacturadas}"`,
            { headers }
          );

          if (!pruebasRes.ok) {
            const t = await pruebasRes.text();
            throw new Error(`pruebas_facturadas fetch failed: ${pruebasRes.status} ${t}`);
          }

          const pruebasFacturadas = await pruebasRes.json();
          console.log("üì• pruebasFacturadas:", pruebasFacturadas?.length);

          // 4) Indexar para O(1) (no m√°s .find() en loop)
          const key = (u, r) => `${u}||${(r ?? "").toString().trim()}`;

          const metaByKey = new Map();
          for (const h of historicosMeta) {
            metaByKey.set(key(h.unidad_medica, h.referencia), h);
          }

          const pruebasByKey = new Map();
          for (const p of pruebasFacturadas) {
            pruebasByKey.set(key(p.unidad_medica, p.referencia), p);
          }

          // 5) Construir filas desde gastoRows (que ya define el universo del reporte mensual)
          const filas = [];

          for (const g of gastoRows) {
            const cliente = g.unidad_medica;
            const ref = g.referencia;
            const k = key(cliente, ref);

            const h = metaByKey.get(k) || {};
            const p = pruebasByKey.get(k) || {};

            const proyecto = Object.entries(proyectos).find(([_, arr]) => arr.includes(cliente))?.[0] || "";
            const lineadenegocio = proyecto === "CHIH IMSS B.S." ? "BANCO SANGRE" : "LABORATORIO";

            const inventarioInicial = Number(g.inv_inicial_25 || 0);
            const inventarioCorte = Number(h[colInventarioCorte] || g.inv_intermedio_10 || 0); // preferimos historicos real del 10
            const inventarioFinal = Number(g.inv_final_25 || 0);

            const io = Number(h.inventario_objetivo || 0);
            const costoUnitario = Number(h.costo || 0);

            const entregadoInicial = Number(g.entregas_10 || 0); // entregas del 10 del mes
            const entregadoCorte = Number(g.entregas_25 || 0);   // entregas del 25 del mes

            const productoSurtirInicial = io - inventarioInicial;
            const productoSurtirCorte = io - inventarioCorte;

            // Consumo INV 10 (periodo 25(prev)->10)
            const consumoInv10 = Number(g.gasto_periodo_25a10 || 0);

            // Producto consumido mensual (25(prev)->25(actual))
            const productoConsumido = Number(g.gasto_mensual || 0);

            const costoConsumido = productoConsumido * costoUnitario;
            const rendimiento = Number(h.rendimiento || 0);
            const pruebasConsumidas = productoConsumido * rendimiento;

            const pruebasFact = Number(p[colPruebasFacturadas] || 0);

            // remisiones a√∫n vac√≠as (como lo tienes)
            const remisionInicial = "";
            const remisionCorte = "";

            filas.push([
              proyecto,
              cliente,
              lineadenegocio,
              h.fabricante || "",
              h.unidad_nombre || "",
              ref,
              h.nombre || "",
              h.presentacion || "",
              h.rendimiento || "",
              costoUnitario,
              io,
              io * costoUnitario,
              inventarioInicial,
              productoSurtirInicial,
              entregadoInicial,
              remisionInicial,
              inventarioCorte,
              consumoInv10,
              "",
              productoSurtirCorte,
              entregadoCorte,
              remisionCorte,
              inventarioFinal,
              productoConsumido,
              costoConsumido,
              pruebasConsumidas,
              pruebasFact
            ]);
          }

          // 6) Generaci√≥n Excel
          const wb = XLSX.utils.book_new();
          const ws = XLSX.utils.aoa_to_sheet([
            ["Proyecto", "Cliente", "Lineadenegocio", "Proveedor", "Unidad Medica", "Clave de Producto", "Producto", "Unidad",
              "Rendimiento", "Costo Unitario", "IO", "Costo IO", "Inventario Inicial", "Producto a surtir inicial", "Entregado inicial",
              "Remision inicial", "Inventario Corte", "Consumo INV 10", "Justificar si quieren que se pida", "Producto a surtir corte",
              "Entregado corte", "Remision corte", "Inventario Final", "Producto consumido", "Costo consumido", "Pruebas consumidas",
              "Pruebas facturadas"],
            ...filas
          ]);
          XLSX.utils.book_append_sheet(wb, ws, "Reporte");

          const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
          const blob = new Blob([wbout], { type: "application/octet-stream" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `Reporte_Mensual_${mesSeleccionado}.xlsx`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          mostrarModal("‚úÖ Reporte descargado", "#16a34a");
        } catch (err) {
          console.error("‚ùå Error durante generaci√≥n:", err);
          mostrarModal("‚ùå Error al generar el reporte", "#B00042");
        }
      };

      document.getElementById("btnSubirRemision").addEventListener("click", async () => {
        const archivo = document.getElementById("inputArchivoRemision")?.files?.[0];
        const numeroRemision = document.getElementById("inputRemision")?.value.trim();
        const unidadDestino = document.getElementById("inputUnidad")?.value.trim();
        const nip = document.getElementById("inputNIP")?.value.trim();
        const resultado = document.getElementById("resultadoCargaArchivo");

        console.log("üì§ Cargar remisi√≥n SAP ‚Üí click");

        // Limpia estado anterior
        if (resultado) {
          resultado.textContent = "";
          resultado.classList.remove("text-green-600", "text-red-600");
        }

        // ‚úÖ Validaciones con modal (no alert)
        if (!archivo) {
          console.warn("‚ùå No se seleccion√≥ archivo");
          mostrarModal("‚ùå Selecciona un archivo .xlsx", "#B00042");
          return;
        }

        if (!archivo.name.toLowerCase().endsWith(".xlsx")) {
          console.warn("‚ùå Archivo inv√°lido:", archivo.name);
          mostrarModal("‚ùå El archivo debe ser .xlsx", "#B00042");
          return;
        }

        if (!numeroRemision) {
          console.warn("‚ùå Falta n√∫mero de remisi√≥n");
          mostrarModal("‚ùå Escribe el n√∫mero de remisi√≥n", "#B00042");
          return;
        }

        if (!unidadDestino) {
          console.warn("‚ùå Falta unidad destino");
          mostrarModal("‚ùå Especifica la unidad destino", "#B00042");
          return;
        }

        if (!nip) {
          console.warn("‚ùå Falta NIP");
          mostrarModal("‚ùå Ingresa tu NIP", "#B00042");
          return;
        }

        const formData = new FormData();
        formData.append("file", archivo);
        formData.append("numero_remision", numeroRemision);
        formData.append("unidad_destino", unidadDestino);
        formData.append("usuario_carga", nip);

        console.log("üì¶ FormData listo:", {
          archivo: archivo.name,
          numeroRemision,
          unidadDestino,
          usuario: nip
        });

        try {
          const res = await fetch(
            "https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/cargar_remision_sap",
            { method: "POST", body: formData }
          );

          const texto = await res.text();
          console.log("üì® Respuesta servidor:", res.status, texto);

          if (res.ok) {
            if (resultado) resultado.classList.add("text-green-600");
            if (resultado) resultado.textContent = `‚úÖ ${texto}`;

            mostrarModal("‚úÖ Remisi√≥n cargada correctamente", "#065f46");

            await cargarTablaRemisionSAP(numeroRemision); // sync tabla
          } else {
            if (resultado) resultado.classList.add("text-red-600");
            if (resultado) resultado.textContent = `‚ùå Error: ${texto}`;

            mostrarModal(`‚ùå Error al cargar remisi√≥n`, "#B00042");
          }
        } catch (e) {
          console.error("‚ùå Error comunicaci√≥n SAP:", e);

          if (resultado) resultado.classList.add("text-red-600");
          if (resultado) resultado.textContent = "‚ùå Error en la comunicaci√≥n con el servidor.";

          mostrarModal("‚ùå Error de conexi√≥n con el servidor", "#B00042");
        }
      });





      async function consultarEstadoBloqueo() {
        const res = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/usuarios?nombre=eq.CONTROL_GLOBAL", {
          headers: { "apikey": API_KEY }
        });

        const data = await res.json();

        if (data.length === 0) {
          console.warn("‚ö†Ô∏è No se encontr√≥ el usuario CONTROL_GLOBAL");
          return false;
        }

        const emailControl = data[0].email || "";
        const estado = emailControl.includes("bloqueo_remision:true");

        return estado;
      }

      async function cargarEstadoBloqueo() {
        const contenedor = document.getElementById("seccionBloqueoRemision");
        const btn = document.getElementById("btnBloqueoRemision");

        if (!contenedor || !btn) {
          console.warn("‚ö†Ô∏è Elementos de bloqueo no encontrados en el DOM");
          return;
        }

        if (!usuarioAdmin) {
          contenedor.classList.add("hidden");
          return;
        }

        contenedor.classList.remove("hidden");

        const estadoActual = await consultarEstadoBloqueo();

        btn.textContent = estadoActual
          ? "üîí Bloqueo por remisi√≥n ACTIVADO"
          : "üîì Bloqueo por remisi√≥n DESACTIVADO";

        btn.onclick = async () => {
          await cambiarEstadoBloqueo(!estadoActual);
          await cargarEstadoBloqueo(); // Refresca visual despu√©s de cambiar
        };
      }


      async function cambiarEstadoBloqueo(nuevoEstado) {
        await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/usuarios?nombre=eq.CONTROL_GLOBAL", {
          method: "PATCH",
          headers: {
            "apikey": API_KEY,
            "Authorization": `Bearer ${API_KEY}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            email: `bloqueo_remision:${nuevoEstado ? 'true' : 'false'}`
          })
        });
      }

      window.addEventListener("DOMContentLoaded", () => {
        const inputQR = document.getElementById("inputQR");

        if (inputQR) {
          inputQR.addEventListener("keyup", async function (event) {
            if (event.key === "Enter") {
              const contenido = event.target.value.trim();

              if (contenido) {
                // Divisi√≥n por coma o punto y coma (permite flexibilidad)
                const codigos = contenido.split(/[,;]+/);

                for (let codigo of codigos) {
                  const limpio = codigo.trim();
                  if (limpio) {
                    try {
                      await procesarQR(limpio);
                    } catch (err) {
                      console.error(`‚ùå Error al procesar QR m√∫ltiple: ${limpio}`, err);
                    }
                  }
                }

                inputQR.value = "";
                inputQR.focus();
              }
            }
          });
        }
      });

      async function mostrarPinDinamicoAdmin() {
        const pin = await generarPinDinamico();
        const el = document.getElementById("valorPinDinamicoSolo");
        if (el) el.textContent = pin;
      }

      function verMovimientos(referencia) {
        filtroReferenciaGlobal = referencia;

        const modal = document.getElementById("modalMovimientos");
        if (modal) modal.classList.remove("hidden");

        const cantidad = document.getElementById("cantidadMovimientos")?.value || "50";
        const fechaInicio = document.getElementById("fechaInicio")?.value;
        const fechaFin = document.getElementById("fechaFin")?.value;
        const loteSeleccionado = document.getElementById("selectLote")?.value;

        let url = `https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/TimeStamps?referencia=eq.${encodeURIComponent(referencia)}&select=usuario,movimiento,fecha_str,lote,remision,unidad_destino,fecha,pin_autorizado_por,timestamp,ts_eliminado`;

        const filtros = [];
        if (fechaInicio) filtros.push(`fecha=gte.${new Date(fechaInicio).getTime()}`);
        if (fechaFin) filtros.push(`fecha=lte.${new Date(fechaFin).getTime() + 86400000 - 1}`);
        if (loteSeleccionado) filtros.push(`lote=eq.${encodeURIComponent(loteSeleccionado)}`);
        if (filtros.length) url += `&${filtros.join("&")}`;
        url += `&order=fecha.desc`;

        fetch(url, {
          headers: { "apikey": API_KEY, "Authorization": `Bearer ${API_KEY}` }
        })
          .then(res => {
            if (!res.ok) throw new Error("No se pudo obtener movimientos");
            return res.json();
          })
          .then(data => {
            const contenedor = document.getElementById("movimientosContenido");
            const selectLote = document.getElementById("selectLote");

            if (selectLote && referencia !== selectLote.dataset.referencia) {
              const lotesUnicos = [...new Set(data.map(m => m.lote))].filter(Boolean);
              selectLote.innerHTML = `<option value="">Todos</option>` +
                lotesUnicos.map(l => `<option value="${l}">${l}</option>`).join("");
              selectLote.dataset.referencia = referencia;
            }

            if (!data.length) {
              contenedor.innerHTML = "<p class='text-sm text-center text-gray-600'>No hay movimientos registrados.</p>";
              return;
            }

            const grupos = {};
            for (const m of data) {
              const clave = `${m.remision || "-"}||${m.lote || "-"}||${m.unidad_destino || "-"}`;
              if (!grupos[clave]) grupos[clave] = [];
              grupos[clave].push(m);
            }

            let html = `<table class="w-full text-sm text-left border mt-2 rounded-xl overflow-hidden">
        <thead class="bg-teal-900 text-white text-center">
          <tr>
            <th class="p-2">üìÇ</th>
            <th class="p-2">Fecha</th>
            <th class="p-2">Usuario</th>
            <th class="p-2">Lote</th>
            <th class="p-2">Remisi√≥n</th>
            <th class="p-2">Unidad Destino</th>
            <th class="p-2">Cantidad</th>
            <th class="p-2 whitespace-normal w-32">Excedente<br>Autorizado por</th>
          </tr>
        </thead>
        <tbody class="text-black text-center">`;

            let i = 0;
            for (const [clave, movimientos] of Object.entries(grupos)) {
              const [remision, lote, unidad] = clave.split("||");
              const primero = movimientos[0];
              const unidadNombre = unidadesDestino[unidad] || unidad || "-";
              const autorizado = movimientos.find(m => m.pin_autorizado_por)?.pin_autorizado_por || " ";
              const id = i++;

              html += `<tr class="bg-gray-100">
          <td class="p-2">
            <button id="btnToggle-${id}" onclick="toggleSubtabla('${id}')" class="text-xs px-1.5 py-0.5 rounded-full border border-gray-400 hover:bg-gray-200">‚ñ∂</button>
          </td>
          <td class="p-2">${primero.fecha_str || "-"}</td>
          <td class="p-2">${primero.usuario || "-"}</td>
          <td class="p-2">${lote}</td>
          <td class="p-2">${remision}</td>
          <td class="p-2">${unidadNombre}</td>
          <td class="p-2">${movimientos.length}</td>
          <td class="p-2 text-red-800 font-bold">${autorizado}</td>
        </tr>`;

              html += `<tr id="subtabla-${id}" class="hidden bg-white"><td colspan="8" class="p-0">
          <table class="w-full text-xs text-center">
            <thead class="bg-gray-200 text-gray-700">
              <tr>
                <th class="p-1">Fecha</th>
                <th class="p-1">NS</th>
                <th class="p-1">Movimiento</th>
                <th class="p-1">¬øExcedente?</th>
              </tr>
            </thead>
            <tbody>`;
              for (const m of movimientos) {
                const nsBase = m.timestamp || m.ts_eliminado;
                const ns = nsBase ? String(nsBase).slice(-8) : "-";
                const excedente = m.pin_autorizado_por
                  ? `<span class="text-red-800 font-bold">S√≠</span>`
                  : `<span class="text-gray-400 font-bold">No</span>`;

                html += `<tr>
            <td class="p-1">${m.fecha_str || "-"}</td>
            <td class="p-1">${ns}</td>
            <td class="p-1">${m.movimiento || "-"}</td>
            <td class="p-1">${excedente}</td>
          </tr>`;
              }
              html += `</tbody></table></td></tr>`;
            }

            html += "</tbody></table>";
            contenedor.innerHTML = html;
          })
          .catch(err => {
            console.error("Error al cargar movimientos:", err);
            document.getElementById("movimientosContenido").innerHTML =
              "<p class='text-sm text-center text-red-600'>Error al obtener movimientos.</p>";
          });
      }



      function toggleSubtabla(id) {
        const sub = document.getElementById("subtabla-" + id);
        const btn = document.getElementById("btnToggle-" + id);

        if (!sub || !btn) {
          console.warn("üîç No se encontr√≥ subtabla o bot√≥n para:", id);
          return;
        }

        const visible = !sub.classList.contains("hidden");
        sub.classList.toggle("hidden");
        btn.textContent = visible ? "‚ñ∂" : "‚ñº";
      }



      document.addEventListener("DOMContentLoaded", () => {
        const mesSelect = document.getElementById("mesCaptura");
        const anioSelect = document.getElementById("anioCaptura");

        const meses = [
          "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
          "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
        ];

        // Generar meses
        meses.forEach((mes, i) => {
          const opt = document.createElement("option");
          opt.value = i + 1;
          opt.textContent = mes;
          mesSelect.appendChild(opt);
        });

        // Generar a√±os desde 2023 hasta 2028
        const a√±oActual = new Date().getFullYear();
        for (let a = a√±oActual - 1; a <= a√±oActual + 3; a++) {
          const opt = document.createElement("option");
          opt.value = a;
          opt.textContent = a;
          anioSelect.appendChild(opt);
        }

        /* L√≥gica para seleccionar Mes, A√±o y Tipo Corte (10/25) autom√°ticamente */
        const hoy = new Date();
        const dia = hoy.getDate();
        let mes = hoy.getMonth() + 1; // 1-12
        let anio = hoy.getFullYear();
        let esCorte25 = false; // false = 10, true = 25

        if (dia >= 10 && dia <= 24) {
          // D√≠a 10 al 24 -> Columna 10_mm_aaaa (Mes actual)
          esCorte25 = false;
        } else if (dia >= 25) {
          // D√≠a 25 en adelante -> Columna 25_mm_aaaa (Mes actual)
          esCorte25 = true;
        } else {
          // D√≠a 1 al 9 -> Columna 25_mm_aaaa (Mes ANTERIOR)
          // Ejemplo: 1 de Feb -> 25_1_2026
          esCorte25 = true;
          mes = mes - 1;
          if (mes === 0) {
            mes = 12;
            anio = anio - 1;
          }
        }

        // Asignar valores
        mesSelect.value = mes;
        anioSelect.value = anio;

        // Asignar toggle de corte (si existe)
        const toggle = document.getElementById("toggleTipoCaptura");
        if (toggle) {
          toggle.checked = esCorte25;
          // Actualizar UI del toggle si la funci√≥n est√° disponible
          if (typeof actualizarTextoTipoCaptura === "function") {
            actualizarTextoTipoCaptura();
          }
        }


      });

      function recuperarBorradorCaptura() {
        const respaldo = localStorage.getItem("capturaPendiente");
        if (!respaldo) return;

        try {
          const estado = JSON.parse(respaldo);
          const datos = Array.isArray(estado) ? estado : (estado.datos || []);
          const usuarioGuardado = estado.usuario || null;

          // 1. Validar usuario (Seguridad) - Case insensitive
          const uGuardado = (usuarioGuardado || "").toUpperCase().trim();
          const uActivo = (usuarioActivo || "").toUpperCase().trim();

          if (uGuardado && uActivo && uGuardado !== uActivo) {
            console.warn("‚ö†Ô∏è Borrador pertenece a otro usuario:", uGuardado, "vs", uActivo);
            return;
          }

          if (Array.isArray(datos) && datos.length > 0) {
            // USAR NUEVO MODAL ESTILIZADO
            mostrarModalConfirmacionRecuperacion(
              () => { // Confirmar
                restaurarContextoYDatos(estado);
              },
              () => { // Cancelar/Descartar
                localStorage.removeItem("capturaPendiente");
              }
            );
          }
        } catch (e) {
          console.error("Error al leer borrador", e);
        }
      }

      function restaurarContextoYDatos(estado) {
        const datos = Array.isArray(estado) ? estado : (estado.datos || []);
        let unidadGuardada = estado.unidad || null; // Convertimos a let para poder inferir
        const modoGuardado = estado.modo || "inventario";

        console.log("üõ† RESTAURANDO:", { unidadGuardada, modoGuardado, datosTotal: datos.length });

        // 0. Inferir unidad si falta (para borradores antiguos o incompletos)
        if (!unidadGuardada && datos.length > 0 && Array.isArray(referenciasPorUnidad)) {
          const refMuestra = datos[0].referencia; // Tomamos la primera referencia
          const match = referenciasPorUnidad.find(r => r.referencia == refMuestra); // Buscamos en cat√°logo

          if (match && match.unidad_medica) {
            unidadGuardada = match.unidad_medica;
            console.log("üß† Unidad inferida por referencia:", unidadGuardada);
          }
        }

        // 1. Restaurar Contexto (Unidad)
        if (unidadGuardada) {
          const unidadSelect = document.getElementById("unidadCaptura");
          if (unidadSelect) {
            // Verificar si la unidad existe en el select
            const opcion = Array.from(unidadSelect.options).find(o => o.value === unidadGuardada);
            if (opcion) {
              unidadSelect.value = unidadGuardada;
              // Forzar carga de referencias
              mostrarReferenciasUnidad();
            } else {
              console.warn("‚ö†Ô∏è Unidad guardada no encontrada en el selector:", unidadGuardada);
            }
          }
        }

        // 2. Restaurar Contexto (Modo)
        if (modoGuardado) {
          const toggle = document.getElementById("modoToggle");
          const esPruebas = (modoGuardado === "pruebas_facturadas");
          if (toggle && toggle.checked !== esPruebas) {
            toggle.checked = esPruebas;
            if (typeof actualizarModoCaptura === "function") actualizarModoCaptura();
          }
        }

        // 3. Restaurar Datos (con espera un poco m√°s larga y reintento)
        // Usamos una l√≥gica m√°s agresiva: Limpiar tabla y RECONSTRUIR TODO desde los datos guardados.
        setTimeout(() => {
          datosCaptura = datos;

          // Limpiar tabla actual para evitar dupes visuales si ya se pint√≥ algo
          const tabla = document.querySelector("#tablaCaptura tbody");
          tabla.innerHTML = "";

          let recuperadosCount = 0;
          const isInventario = (modoGuardado === "inventario");

          datos.forEach(d => {
            // Recrear fila usando la funci√≥n UI
            // agregarFilaCapturaUI(tabla, referencia, nombre, isInventario, loteVal="")
            agregarFilaCapturaUI(tabla, d.referencia, d.nombre, isInventario, d.lote || "");

            // Buscar la √∫ltima fila agregada para setear cantidad y timestamps
            const nuevaFila = tabla.lastElementChild;
            if (nuevaFila) {
              const inputCantidad = nuevaFila.querySelector(".input-cantidad");
              if (inputCantidad) {
                inputCantidad.value = d.cantidad;
                marcarComoCompletada(inputCantidad);
              }

              // Restore timestamps
              const inputTx = nuevaFila.querySelector(".row-timestamps");
              if (inputTx && Array.isArray(d.timestamps)) {
                inputTx.value = JSON.stringify(d.timestamps);
                // Add to global set too?
                d.timestamps.forEach(ts => timestampsEscaneadosInventario.add(ts));
              }

              recuperadosCount++;
            }
          });

          // Toggle empty state
          const contenedorTabla = document.getElementById("contenedorTabla");
          contenedorTabla.classList.toggle("hidden", recuperadosCount === 0);

          console.log(`‚úÖ Recuperados final: ${recuperadosCount}`);

          if (recuperadosCount > 0) {
            document.getElementById("contenedorTabla").classList.remove("hidden");
            mostrarModal(`‚úÖ Sesi√≥n restaurada, registros recuperados.`, "#065f46");
          } else {
            mostrarModal("‚ö†Ô∏è No se pudieron vincular los datos guardados con la tabla actual.", "#d99b00");
          }

        }, 500); // 500ms wait
      }

      function mostrarModalConfirmacionRecuperacion(onConfirm, onCancel) {
        // Crear elementos del modal din√°micamente
        const backdrop = document.createElement("div");
        backdrop.className = "fixed inset-0 flex items-center justify-center z-[100] bg-black/80 backdrop-blur-sm transition-opacity duration-300 opacity-0";

        const card = document.createElement("div");
        // Use space-card for consistency
        card.className = "space-card border border-white/10 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95 transition-all duration-300 translate-y-4";

        card.innerHTML = `
            <div class="text-4xl mb-4 text-center">üìÇ</div>
            <h3 class="text-xl font-bold text-white text-center mb-2">Recuperar trabajo</h3>
            <p class="text-sm text-white/70 text-center mb-6">
                Hola <b>${escapeHtml(usuarioActivo || "usuario")}</b>, encontramos datos pendientes de tu √∫ltima sesi√≥n.<br>
                ¬øDeseas restaurarlos para continuar?
            </p>
            <div class="grid grid-cols-2 gap-3">
                <button id="btnCancelarRecuperacion" class="px-4 py-3 rounded-xl bg-white/5 hover:bg-white/10 text-white/60 font-medium transition-colors">
                   Descartar
                </button>
                <button id="btnConfirmarRecuperacion" class="px-4 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white font-bold shadow-lg shadow-emerald-900/20 transition-all transform hover:scale-[1.02]">
                   Restaurar
                </button>
            </div>
        `;

        backdrop.appendChild(card);
        document.body.appendChild(backdrop);

        // Animaci√≥n de entrada
        requestAnimationFrame(() => {
          backdrop.classList.remove("opacity-0");
          card.classList.remove("scale-95", "translate-y-4");
          card.classList.add("scale-100", "translate-y-0");
        });

        // Eventos
        const btnSi = card.querySelector("#btnConfirmarRecuperacion");
        const btnNo = card.querySelector("#btnCancelarRecuperacion");

        const cerrar = () => {
          backdrop.classList.add("opacity-0");
          card.classList.add("scale-95", "translate-y-4");
          setTimeout(() => backdrop.remove(), 300);
        };

        btnSi.onclick = () => {
          cerrar();
          if (onConfirm) onConfirm();
        };

        btnNo.onclick = () => {
          cerrar();
          if (onCancel) onCancel();
        };
      }



      function actualizarTextoTipoCaptura() {
        const toggle = document.getElementById("toggleTipoCaptura");
        const texto = document.getElementById("textoTipoCaptura");
        const indicador = document.getElementById("indicadorTipoCaptura");

        const isCorte = toggle.checked;

        // Actualizar Texto
        texto.textContent = isCorte ? "Corte" : "Inicial";

        // Actualizar Color del Indicador
        if (indicador) {
          indicador.classList.remove("bg-teal-600", "bg-rose-700");
          if (isCorte) {
            indicador.classList.add("bg-rose-700");
          } else {
            indicador.classList.add("bg-teal-600");
          }
        }
      }
      async function verificarExistenciaYConfirmarEnvio() {
        const unidad = document.getElementById("unidadCaptura").value;
        const mes = document.getElementById("mesCaptura").value;
        const anio = document.getElementById("anioCaptura").value;
        const tipo = document.getElementById("modoCaptura").value;
        const tabla = tipo === "pruebas_facturadas" ? "pruebas_facturadas" : "historicos";
        const columna = calcularColumnaFecha(mes, anio);

        if (!unidad || !mes || !anio) return mostrarModal("‚ùå Faltan datos para verificar existencia", "red");

        try {
          const referencias = datosCaptura.map(d => `'${d.referencia}'`).join(",");
          const res = await fetch(`https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/${tabla}?select=referencia,${columna}&unidad_medica=eq.${unidad}&referencia=in.(${referencias})`, {
            headers: {
              apikey: "API_KEY",
              Authorization: "Bearer API_KEY"
            }
          });
          const existentes = await res.json();

          const hayCoincidencias = existentes.some(e => e[columna] !== null && e[columna] !== undefined);
          if (hayCoincidencias) {
            mostrarModalConfirmacionSobrescribir(() => {
              enviarCapturaBase(); // Ejecuta si acepta sobrescribir
            });
          } else {
            enviarCapturaBase(); // Si no hay conflicto, env√≠a directamente
          }
        } catch (err) {
          console.error("‚ùå Error verificando existencia:", err);
          mostrarModal("‚ùå No se pudo verificar existencia", "red");
        }
      }

      function mostrarModalConfirmacionSobrescribir(callback) {
        callbackSobrescribir = callback;
        document.getElementById("modalSobrescribir").classList.remove("hidden");
      }

      function aceptarSobrescritura() {
        document.getElementById("modalSobrescribir").classList.add("hidden");
        if (callbackSobrescribir) callbackSobrescribir();
        callbackSobrescribir = null;
      }

      function cerrarModalSobrescribir() {
        document.getElementById("modalSobrescribir").classList.add("hidden");
        callbackSobrescribir = null;
      }

      async function cargarTablaRemisionSAP(numeroRemision) {
        const res = await fetch(
          `https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/remisiones_pendientes?numero_remision=eq.${numeroRemision}`,
          {
            headers: {
              "apikey": API_KEY,
              "Authorization": `Bearer ${API_KEY}`
            }
          }
        );

        const data = await res.json();
        const cuerpo = document.getElementById("bodyRemisionSAP");
        cuerpo.innerHTML = "";

        avanceRemision = {};

        const campoAvance = (modoSeleccionado === "preparacion")
          ? "cantidad_preparada"
          : "cantidad_escaneada";

        data.forEach(item => {
          const clave = `${item.referencia}||${item.lote}`;
          const esc = Number(item?.[campoAvance] ?? 0);

          avanceRemision[clave] = {
            nombre: item.descripcion || "",
            escaneados: Number.isFinite(esc) ? esc : 0
          };

          const fila = document.createElement("tr");
          fila.innerHTML = `
            <td class="p-2">${item.referencia}</td>
            <td class="p-2">${item.descripcion || ""}</td>
            <td class="p-2">${item.lote || ""}</td>
            <td class="p-2 text-center">${Number(item?.[campoAvance] ?? 0)}</td>
          `;
          cuerpo.appendChild(fila);
        });

        document.getElementById("tablaRemisionSAP").classList.remove("hidden");
      }

      function actualizarTablaRemisionSAP() {
        const tbody = document.getElementById("bodyRemisionSAP");
        tbody.innerHTML = "";

        Object.entries(avanceRemision).forEach(([clave, info]) => {
          const [referencia, lote] = clave.split("||");

          if (ocultarValidados && info.escaneados > 0) return;

          const fila = document.createElement("tr");
          fila.className = info.escaneados > 0 ? "bg-emerald-200 text-emerald-800" : "";

          fila.innerHTML = `
      <td class="p-2">${referencia}</td>
      <td class="p-2">${info.nombre || ""}</td>
      <td class="p-2">${lote}</td>
      <td class="p-2 text-center">${info.escaneados}</td>
    `;

          tbody.appendChild(fila);
        });

        document.getElementById("tablaRemisionSAP").classList.remove("hidden");
      }

      document.getElementById("btnToggleFilasValidadas").addEventListener("click", () => {
        ocultarValidados = !ocultarValidados;
        document.getElementById("btnToggleFilasValidadas").textContent = ocultarValidados
          ? "Mostrar validados"
          : "Ocultar validados";
        actualizarTablaRemisionSAP();
      });
      function confirmarModoInventario() {
        document.getElementById("modalInventario").classList.remove("hidden");
      }



      function iniciarActualizacionAutomaticaPIN() {
        if (intervaloPin) clearInterval(intervaloPin);

        // Ejecutar inmediatamente
        actualizarPinYContador();

        // Calcular cu√°nto falta para el siguiente m√∫ltiplo exacto del intervalo
        const ahora = new Date();
        const minutos = ahora.getUTCMinutes();
        const segundos = ahora.getUTCSeconds();

        const minutosHastaProximo = INTERVALO_MINUTOS - (minutos % INTERVALO_MINUTOS);
        const msHastaProximo = (minutosHastaProximo * 60 - segundos) * 1000;

        // ‚è≥ Primera actualizaci√≥n al siguiente punto exacto (ej. HH:10:00, HH:20:00...)
        setTimeout(() => {
          actualizarPinYContador();
          intervaloPin = setInterval(actualizarPinYContador, INTERVALO_MINUTOS * 60000);
        }, msHastaProximo);
      }

      async function detectarAdminDesdePIN(pinIngresado) {
        const ahora = new Date();
        const yyyy = ahora.getUTCFullYear();
        const mm = String(ahora.getUTCMonth() + 1).padStart(2, "0");
        const dd = String(ahora.getUTCDate()).padStart(2, "0");
        const hh = String(ahora.getUTCHours()).padStart(2, "0");
        const bloque = Math.floor(ahora.getUTCMinutes() / 10);
        const clave = "medinova-secreto-2025";

        for (const admin of listaAdmins) {
          const base = `${admin.toLowerCase()}::${yyyy}-${mm}-${dd}-${hh}-${bloque}::${clave}`;
          const hash = await sha256(base);
          const pinGenerado = hash.substring(0, 6).toUpperCase();

          if (pinIngresado === pinGenerado) {
            return admin;
          }
        }

        return null;
      }

      //#region Basurero
      async function procesarBasurero(datos) {
        if (!datos || !datos.referencia || !datos.lote || !datos.timestamp) {
          mostrarModal("‚ùå C√≥digo inv√°lido para eliminar", "#6b7280");
          return;
        }

        inputQR?.focus(); // üëà Asegura que vuelva a enfocar despu√©s de eliminar

        const payload = {
          referencia: datos.referencia,
          lote: datos.lote,
          timestamp: datos.timestamp,
          usuario: usuario || "Basurero"
        };

        try {
          const res = await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/functions/v1/eliminar_etiqueta_basurero", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          const data = await res.json();
          console.log("üßæ Respuesta de eliminar_etiqueta_basurero:", data);

          if (data.status === "ok") {
            mostrarModal("‚ôªÔ∏è Etiqueta eliminada completamente", "#0f172a");

            try {
              await fetch("https://ldjrpfsbpcfninntffoj.supabase.co/rest/v1/registro_errores", {
                method: "POST",
                headers: {
                  "apikey": API_KEY,
                  "Authorization": `Bearer ${API_KEY}`,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  usuario: usuario || "Basurero",
                  referencia: datos.referencia,
                  lote: datos.lote,
                  fecha: new Date().toISOString(),
                  motivo: "borrado etiqueta",
                  modo: "borrar",
                  pin_ingresado: usuario || "Basurero",
                  valido: false,
                  timestamp: datos.timestamp
                })
              });
              console.log("üì¶ Registro de eliminaci√≥n guardado en registro_errores.");
            } catch (err) {
              console.warn("‚ö†Ô∏è No se pudo guardar en registro_errores:", err);
            }

            // ‚úÖ Limpiar y reactivar input de escaneo
            if (inputQR) {
              inputQR.value = "";
              inputQR.classList.remove("hidden");
              inputQR.focus();
            }
          }

        } catch (err) {
          console.error("‚ùå Error al contactar Supabase:", err);
          mostrarModal("‚ùå Error de red", "#B00042");
        }
      }
      //#endregion
      //#region Cerrar Sesion
      function cerrarSesion() {
        // üîÅ Limpiar estados
        usuario = null;
        nipAdmin = null;
        unidadSeleccionada = null;
        remisionActual = null;
        modo = "inactivo";
        modoSeleccionado = null;
        qrsPendientes = [];

        // ‚õîÔ∏è Ocultar bot√≥n cerrar sesi√≥n si existe
        const btnCerrar = document.getElementById("btnCerrarSesion");
        if (btnCerrar) btnCerrar.classList.add("hidden");

        // üßº Limpiar visual
        document.getElementById("usuarioActivo").textContent = "Selecciona un modo para iniciar";
        actualizarBotonModo("Inactivo", "bg-gray-500", "üîí");

        // üßΩ Limpiar campos
        document.getElementById("inputNIP").value = "";
        document.getElementById("inputUnidad").value = "";
        document.getElementById("inputRemision").value = "";

        // üß∫ Ocultar modales abiertos
        document.querySelectorAll(".fixed, .modal-modo, #modalPinUnidad").forEach(el => el.classList.add("hidden"));

        // üóëÔ∏è Vaciar tabla
        if (typeof actualizarTablaRegistros === "function") {
          actualizarTablaRegistros();
        }

        // ‚úÖ Mostrar confirmaci√≥n
        mostrarModal("üîí Sesi√≥n cerrada", "#6b7280");
      }
      //#endregion
      //=======================QC Command=======================
      //#region QC Command

      // =================================================================================================
      // üõ∞Ô∏èüß™ QC COMMAND (Supervisor de Calidad)
      // - Requiere tablas: qc_items (cat√°logo), qc_consumo (consumo)
      // - Usa productos (stock central/lotes/caducidad) + historicos (stock unidades por corte)
      // - FULL LOGGING (console + panel)
      // =================================================================================================

      (function initQCModule() {
        window.qcState = window.qcState || {
          catalogo: [],
          productosQC: [],
          historicosQC: [],
          consumoQC: [],
          computed: null,
          charts: { consumo: null, cobertura: null, caducidad: null },
          lastRunAt: null,
        };

        function qclog(msg, obj) {
          try {
            // ‚úÖ Solo consola (NO UI)
            if (obj !== undefined) console.log("üõ∞Ô∏è[QC]", msg, obj);
            else console.log("üõ∞Ô∏è[QC]", msg);
          } catch (_) { /* no-op */ }
        }
        // =========================
        // ‚òÄÔ∏è Sol Log√≠stico: Motor SVG
        // =========================

        // üé® Paleta √∫nica para el Sol (consistente con UI obsidiana/teal)
        const QC_SOL_PALETTE = [
          "#17A2A6", // teal primario
          "#0EA5E9", // sky
          "#38BDF8", // cyan claro
          "#1E40AF", // azul profundo
          "#388df8", // violeta (acento)
          "#EAB308", // √°mbar
          "#F59E0B"  // naranja (acento)
        ];

        function normalizeHex(hex) {
          const s = String(hex || "").trim();
          if (!s) return "";
          return s.startsWith("#") ? s.toUpperCase() : ("#" + s).toUpperCase();
        }

        function isPaletteColor(hex) {
          const h = normalizeHex(hex);
          return QC_SOL_PALETTE.includes(h);
        }

        function colorFromPalette(key) {
          const s = String(key || "");
          let hash = 0;
          for (let i = 0; i < s.length; i++) {
            hash = ((hash << 5) - hash) + s.charCodeAt(i);
            hash |= 0;
          }
          return QC_SOL_PALETTE[Math.abs(hash) % QC_SOL_PALETTE.length];
        }

        //#region ==========GRAFICO SOLAR==========
        // 1) Orden fijo (tu arreglo real)
        const REPRESENTACIONES_RADIALES = [
          { id: "CUU", nombre: "ALMAC√âN CHIHUAHUA", angulo: 330, color: "#17A2A6" },
          { id: "65", nombre: "ALMAC√âN JU√ÅREZ", angulo: 345, color: "#1E40AF" },
          { id: "66", nombre: "ALMAC√âN PARRAL", angulo: 315, color: "#EAB308" },

          { id: "BCS", nombre: "BAJA CALIFORNIA SUR", angulo: 250, color: "#0EA5E9" },
          { id: "DUR", nombre: "DURANGO", angulo: 305, color: "#38BDF8" },
          { id: "NAY", nombre: "NAYARIT", angulo: 270, color: "#17A2A6" },
          { id: "SIN", nombre: "SINALOA", angulo: 290, color: "#0EA5E9" },

          { id: "TAM", nombre: "TAMAULIPAS", angulo: 20, color: "#F59E0B" },
          { id: "COA", nombre: "COAHUILA", angulo: 350, color: "#A78BFA" },

          { id: "CHP", nombre: "CHIAPAS", angulo: 140, color: "#38BDF8" },
          { id: "OAX", nombre: "OAXACA", angulo: 165, color: "#17A2A6" },
          { id: "TAB", nombre: "TABASCO", angulo: 110, color: "#0EA5E9" },
          { id: "CAM", nombre: "CAMPECHE", angulo: 120, color: "#A78BFA" },
          { id: "QROO", nombre: "QUINTANA ROO", angulo: 90, color: "#38BDF8" },
          { id: "GRO", nombre: "GUERRERO", angulo: 200, color: "#0EA5E9" },
          { id: "EDOMEX", nombre: "EDO. DE M√âXICO", angulo: 230, color: "#EAB308" },
          { id: "HGO", nombre: "HIDALGO", angulo: 40, color: "#1E40AF" },
          // üî• agrega aqu√≠ las que quieras, siempre con angulo fijo
        ];

        // 2) Utilidades (m√≠nimas)
        function solLog(msg, obj) {
          try {
            // ‚úÖ Solo consola (NO UI)
            if (obj !== undefined) console.log("‚òÄÔ∏è[SOL]", msg, obj);
            else console.log("‚òÄÔ∏è[SOL]", msg);
          } catch (_) { /* no-op */ }
        }

        function svgEl(name) {
          return document.createElementNS("http://www.w3.org/2000/svg", name);
        }

        function polarToXY(cx, cy, r, deg) {
          const rad = (deg - 90) * Math.PI / 180; // 0¬∞ arriba
          return { x: cx + r * Math.cos(rad), y: cy + r * Math.sin(rad) };
        }

        function deg2rad(deg) { return (deg * Math.PI) / 180; }

        // arc flags for SVG
        function arcFlag(a0, a1) {
          let d = ((a1 - a0) % 360 + 360) % 360;
          return d > 180 ? 1 : 0;
        }

        // Donut-wedge path. IMPORTANT: uses same angle convention as polarToXY (0¬∞ arriba).
        function wedgePathD(cx, cy, r0, r1, a0, a1) {
          const A0 = a0 - 90;
          const A1 = a1 - 90;

          const p0o = { x: cx + r1 * Math.cos(deg2rad(A0)), y: cy + r1 * Math.sin(deg2rad(A0)) };
          const p1o = { x: cx + r1 * Math.cos(deg2rad(A1)), y: cy + r1 * Math.sin(deg2rad(A1)) };
          const p0i = { x: cx + r0 * Math.cos(deg2rad(A0)), y: cy + r0 * Math.sin(deg2rad(A0)) };
          const p1i = { x: cx + r0 * Math.cos(deg2rad(A1)), y: cy + r0 * Math.sin(deg2rad(A1)) };

          const laf = arcFlag(a0, a1);

          return [
            `M ${p0o.x.toFixed(2)} ${p0o.y.toFixed(2)}`,
            `A ${r1.toFixed(2)} ${r1.toFixed(2)} 0 ${laf} 1 ${p1o.x.toFixed(2)} ${p1o.y.toFixed(2)}`,
            `L ${p1i.x.toFixed(2)} ${p1i.y.toFixed(2)}`,
            `A ${r0.toFixed(2)} ${r0.toFixed(2)} 0 ${laf} 0 ${p0i.x.toFixed(2)} ${p0i.y.toFixed(2)}`,
            `Z`
          ].join(" ");
        }

        function computeMinAngleGap(data) {
          const angs = (data || []).map(d => Number(d.angulo)).filter(n => Number.isFinite(n));
          if (angs.length < 2) return 18;
          angs.sort((a, b) => a - b);
          let min = 360;
          for (let i = 0; i < angs.length; i++) {
            const a = angs[i];
            const b = angs[(i + 1) % angs.length] + (i === angs.length - 1 ? 360 : 0);
            min = Math.min(min, b - a);
          }
          return min;
        }

        function clamp01(x) { return Math.max(0, Math.min(1, x)); }

        // Escala bonita: sqrt (suave y legible)
        function scaleSqrt(v, vMax, Lmin = 18, Lmax = 240) {
          if (!vMax || vMax <= 0) return Lmin;
          const t = clamp01(v / vMax);
          return Lmin + (Lmax - Lmin) * Math.sqrt(t);
        }

        // Formato de n√∫mero
        function fmtNum(n) { return Number(n || 0).toLocaleString(); }
        function fmtMoney(n) { return "$" + Number(n || 0).toLocaleString() + " MXN"; }

        // 3) Builder del SVG completo (grid + hub + barras)
        function buildSolSVG(svg, { title = "ROMA ‚Ä¢ CDMX", subtitle = "", onBarClick = null }) {
          svg.innerHTML = "";

          // defs
          const defs = svgEl("defs");

          const filter = svgEl("filter");
          filter.setAttribute("id", "solGlow");
          filter.setAttribute("x", "-40%");
          filter.setAttribute("y", "-40%");
          filter.setAttribute("width", "180%");
          filter.setAttribute("height", "180%");
          const blur = svgEl("feGaussianBlur");
          blur.setAttribute("stdDeviation", "3");
          blur.setAttribute("result", "b");
          const merge = svgEl("feMerge");
          const mn1 = svgEl("feMergeNode"); mn1.setAttribute("in", "b");
          const mn2 = svgEl("feMergeNode"); mn2.setAttribute("in", "SourceGraphic");
          merge.appendChild(mn1); merge.appendChild(mn2);
          filter.appendChild(blur); filter.appendChild(merge);

          defs.appendChild(filter);
          svg.appendChild(defs);

          const cx = 450, cy = 450;

          // Grid
          const grid = svgEl("g");
          grid.setAttribute("opacity", "0.55");

          const rings = [140, 200, 260, 320, 380];
          rings.forEach((r, i) => {
            const c = svgEl("circle");
            c.setAttribute("cx", cx);
            c.setAttribute("cy", cy);
            c.setAttribute("r", r);
            c.setAttribute("fill", "none");
            c.setAttribute("stroke", i === 0 || i === rings.length - 1 ? "rgba(255,255,255,0.10)" : "rgba(255,255,255,0.07)");
            c.setAttribute("stroke-width", i === rings.length - 1 ? "1.4" : "1.2");
            grid.appendChild(c);
          });

          const vline = svgEl("line");
          vline.setAttribute("x1", cx); vline.setAttribute("y1", 70);
          vline.setAttribute("x2", cx); vline.setAttribute("y2", 830);
          vline.setAttribute("stroke", "rgba(255,255,255,0.05)");
          vline.setAttribute("stroke-width", "1");
          grid.appendChild(vline);

          const hline = svgEl("line");
          hline.setAttribute("x1", 70); hline.setAttribute("y1", cy);
          hline.setAttribute("x2", 830); hline.setAttribute("y2", cy);
          hline.setAttribute("stroke", "rgba(255,255,255,0.05)");
          hline.setAttribute("stroke-width", "1");
          grid.appendChild(hline);

          svg.appendChild(grid);

          // Hub
          const hub = svgEl("g");
          hub.setAttribute("filter", "url(#solGlow)");

          const hubCircle = svgEl("circle");
          hubCircle.setAttribute("cx", cx);
          hubCircle.setAttribute("cy", cy);
          hubCircle.setAttribute("r", 62);
          hubCircle.setAttribute("fill", "rgba(23,162,166,0.18)");
          hubCircle.setAttribute("stroke", "rgba(23,162,166,0.35)");
          hubCircle.setAttribute("stroke-width", "1.5");
          hub.appendChild(hubCircle);

          const dot = svgEl("circle");
          dot.setAttribute("cx", cx); dot.setAttribute("cy", cy); dot.setAttribute("r", 6);
          dot.setAttribute("fill", "rgba(255,255,255,0.85)");
          hub.appendChild(dot);

          const txt = svgEl("text");
          txt.setAttribute("x", cx);
          txt.setAttribute("y", cy + 2);
          txt.setAttribute("text-anchor", "middle");
          txt.setAttribute("fill", "rgba(255,255,255,0.82)");
          txt.setAttribute("font-size", "12");
          txt.setAttribute("font-weight", "700");
          txt.setAttribute("font-family", "system-ui");
          txt.textContent = title;
          hub.appendChild(txt);

          if (subtitle) {
            const st = svgEl("text");
            st.setAttribute("x", cx);
            st.setAttribute("y", cy + 18);
            st.setAttribute("text-anchor", "middle");
            st.setAttribute("fill", "rgba(255,255,255,0.55)");
            st.setAttribute("font-size", "11");
            st.setAttribute("font-family", "system-ui");
            st.textContent = subtitle;
            hub.appendChild(st);
          }

          svg.appendChild(hub);

          // Contenedor de barras
          const barras = svgEl("g");
          barras.setAttribute("id", "barras");
          svg.appendChild(barras);

          // Return API
          return {
            setBars: (bars, metricKey, opts = {}) => renderBars(barras, bars, metricKey, onBarClick, opts)
          };
        }

        function renderBars(g, data, metricKey, onBarClick, opts = {}) {
          const cx = 450, cy = 450;
          const R0 = 140;
          const Lmax = 240;

          g.innerHTML = "";

          const maxVal = Math.max(...data.map(d => Number(d[metricKey] || 0)));
          const minGap = computeMinAngleGap(data);
          const GAP_DEG = Math.max(1.2, Math.min(3, minGap * 0.12));
          const WEDGE_DEG = Math.max(3, Math.min(14, minGap - GAP_DEG));

          data.forEach(d => {
            const ang = Number(d.angulo || 0);
            const v = Number(d[metricKey] || 0);

            const L = scaleSqrt(v, maxVal, 18, Lmax);

            const a0 = ang - (WEDGE_DEG / 2);
            const a1 = ang + (WEDGE_DEG / 2);

            // Ghost wedge para ‚Äúllenar‚Äù el c√≠rculo (fondo)
            const ghost = svgEl("path");
            ghost.setAttribute("d", wedgePathD(cx, cy, R0, R0 + Lmax, a0, a1));
            ghost.setAttribute("fill", "rgba(255,255,255,0.04)");
            ghost.setAttribute("stroke", "rgba(255,255,255,0.03)");
            ghost.setAttribute("stroke-width", "1");
            ghost.setAttribute("pointer-events", "none");
            g.appendChild(ghost);

            // Tooltip nativo (texto)
            const tipText =
              `${d.nombre}\n` +
              `Stock: ${fmtNum(d.stock)}\n` +
              `Valor: ${fmtMoney(d.valor)}\n` +
              `Cad <30d: ${Number(d.cad30 || 0)}%`;

            // Wedge real
            const p = svgEl("path");
            p.setAttribute("d", wedgePathD(cx, cy, R0, R0 + L, a0, a1));
            const fillColor = isPaletteColor(d.color) ? normalizeHex(d.color) : colorFromPalette(d.id || d.nombre);
            p.setAttribute("fill", fillColor);
            p.setAttribute("fill-opacity", "0.90");
            p.setAttribute("stroke", "rgba(255,255,255,0.09)");
            p.setAttribute("stroke-width", "1");

            // title en wedge
            const titleP = svgEl("title");
            titleP.textContent = tipText;
            p.appendChild(titleP);

            // Hit area (m√°s f√°cil hover/click)
            const hit = svgEl("path");
            hit.setAttribute("d", wedgePathD(cx, cy, R0, R0 + Lmax, a0, a1)); // üëà mejor: hit grande (Lmax)
            hit.setAttribute("fill", "transparent");
            hit.setAttribute("stroke", "transparent");
            hit.setAttribute("stroke-width", "18");
            hit.style.cursor = (typeof onBarClick === "function") ? "pointer" : "default";

            // title tambi√©n en hit (para que el hover siempre lo agarre)
            const titleH = svgEl("title");
            titleH.textContent = tipText;
            hit.appendChild(titleH);

            if (typeof onBarClick === "function") {
              hit.addEventListener("click", () => onBarClick(d));
            }

            hit.addEventListener("mouseenter", () => {
              solLog("Hover", { id: d.id, nombre: d.nombre, stock: d.stock, valor: d.valor, cad30: d.cad30 });
            });
            hit.addEventListener("mouseleave", () => {
              // opcional
            });

            g.appendChild(p);
            g.appendChild(hit);
          });

          solLog("Render bars", { metricKey, count: data.length });
        }

        // =========================
        // Datos: fetch / mock (placeholder)
        // =========================

        // üî• Debe venir de Supabase: agregados por representaci√≥n
        // Forma esperada por cada representaci√≥n:
        // { id, nombre, angulo, color, stock, valor, cad30 }
        async function solFetchRepresentaciones() {
          // TODO: aqu√≠ conectamos a Supabase real.
          // Por ahora: demo usando tu arreglo + valores random
          return REPRESENTACIONES_RADIALES.map(r => ({
            ...r,
            stock: Math.floor(Math.random() * 2400) + 150,
            valor: Math.floor(Math.random() * 12000000) + 500000,
            cad30: Math.floor(Math.random() * 22),
            strokeWidth: 10
          }));
        }

        // üî• Debe venir de Supabase: agregados por unidad m√©dica dentro de una representaci√≥n
        // Forma esperada:
        // { id, nombre, angulo, color, stock, valor, cad30 }
        async function solFetchUnidadesDeRepresentacion(repId) {
          // TODO: Supabase real.
          // Demo: generamos 18 unidades con √°ngulos fijos alrededor del c√≠rculo (sin geo)
          const n = 18;
          const base = 360 / n;

          return Array.from({ length: n }).map((_, i) => ({
            id: `${repId}_UM_${i + 1}`,
            nombre: `Unidad ${i + 1} (${repId})`,
            angulo: (i * base + 10) % 360,
            color: "#38BDF8",
            stock: Math.floor(Math.random() * 700) + 30,
            valor: Math.floor(Math.random() * 3200000) + 150000,
            cad30: Math.floor(Math.random() * 18),
            strokeWidth: 8
          }));
        }

        // =========================
        // Controller: toggle + drilldown
        // =========================
        let solMetric = "stock"; // "stock" | "valor"
        let solAPI = null;
        let solDrillAPI = null;
        let solDataRep = [];
        let solDataUM = [];
        let solSelectedRep = null;

        async function solInit() {
          const svgN = document.getElementById("solNacional");
          const svgD = document.getElementById("solDrill");

          if (!svgN || !svgD) {
            solLog("No SVG targets found");
            return;
          }

          // build SVGs
          solAPI = buildSolSVG(svgN, {
            title: "ROMA  CDMX",
            subtitle: "Representaciones",
            onBarClick: async (rep) => {
              await solOpenDrill(rep);
            }
          });

          solDrillAPI = buildSolSVG(svgD, {
            title: "DRILLDOWN",
            subtitle: "Unidades m√©dicas",
            onBarClick: null // (opcional) segundo nivel
          });

          // hook toggle buttons
          const bS = document.getElementById("btnMetricStock");
          const bV = document.getElementById("btnMetricValor");
          if (bS && bV) {
            bS.addEventListener("click", () => solSetMetric("stock"));
            bV.addEventListener("click", () => solSetMetric("valor"));
          }

          // close drill
          const btnClose = document.getElementById("btnCerrarDrill");
          btnClose?.addEventListener("click", () => solCloseDrill());

          // initial fetch + render
          solDataRep = await solFetchRepresentaciones();
          solRenderMain();

          solLog("Sol init OK", { metric: solMetric, reps: solDataRep.length });
        }

        function solSetMetric(m) {
          solMetric = m;

          const bS = document.getElementById("btnMetricStock");
          const bV = document.getElementById("btnMetricValor");
          if (bS && bV) {
            const stockOn = (m === "stock");
            bS.classList.toggle("opacity-60", !stockOn);
            bV.classList.toggle("opacity-60", stockOn);
          }

          // re-render main + drill if open
          solRenderMain();
          if (solSelectedRep) solRenderDrill();

          solLog("Metric changed", { solMetric });
        }

        function solRenderMain() {
          const sub = document.getElementById("solSubtitulo");
          if (sub) sub.textContent = `Vista por representaci√≥n ‚Ä¢ m√©trica: ${solMetric === "stock" ? "Stock" : "Valor"}`;

          solAPI?.setBars(solDataRep, solMetric);
        }

        async function solOpenDrill(rep) {
          solSelectedRep = rep;

          const wrap = document.getElementById("solDrillWrap");
          const title = document.getElementById("solDrillTitle");
          if (wrap) wrap.classList.remove("hidden");
          if (title) title.textContent = `üè• ${rep.nombre} ‚Ä¢ Unidades m√©dicas (${solMetric === "stock" ? "Stock" : "Valor"})`;

          solDataUM = await solFetchUnidadesDeRepresentacion(rep.id);
          solRenderDrill();

          solLog("Open drill", { rep: rep.id, units: solDataUM.length });
        }

        function solRenderDrill() {
          const rep = solSelectedRep;
          if (!rep) return;

          const svgD = document.getElementById("solDrill");
          // Update hub text by rebuilding is overkill; simple: re-build once or just render bars.
          // Aqu√≠ solo renderizamos barras, y el t√≠tulo ya lo pusimos afuera.

          solDrillAPI?.setBars(solDataUM, solMetric);
        }

        function solCloseDrill() {
          solSelectedRep = null;
          solDataUM = [];
          const wrap = document.getElementById("solDrillWrap");
          wrap?.classList.add("hidden");
          solLog("Close drill");
        }

        //#endregion ======GRAFICO SOLAR============

        window.addEventListener("DOMContentLoaded", () => {
          try { solInit(); } catch (e) { solLog("Init error", { e: String(e?.message || e) }); }
        });
        function qcEsc(v) {
          return (typeof escapeHtml === "function") ? escapeHtml(v) : String(v ?? "");
        }

        function qcTodayISO() {
          const d = new Date();
          d.setHours(0, 0, 0, 0);
          return d.toISOString().slice(0, 10);
        }

        function qcAddDaysISO(iso, days) {
          const d = new Date(iso + "T00:00:00");
          d.setDate(d.getDate() + days);
          return d.toISOString().slice(0, 10);
        }

        function qcColumnaCorteVigente() {
          const now = new Date();
          const day = now.getDate();
          let month = now.getMonth() + 1;
          let year = now.getFullYear();
          let corte = 10;

          if (day < 10) {
            corte = 25;
            month -= 1;
            if (month <= 0) { month = 12; year -= 1; }
          } else if (day >= 25) {
            corte = 25;
          } else {
            corte = 10;
          }
          return `${corte}_${month}_${year}`;
        }

        async function qcEnsureChart() {
          const ok = await (typeof ensureChartJs === "function" ? ensureChartJs() : Promise.resolve(!!window.Chart));
          if (!ok) qclog("‚ùå Chart.js no disponible");
          return ok;
        }

        async function qcSbSelect(table, selectStr, opts = {}) {
          const sb = window.sb;
          if (!sb) {
            qclog("‚ùå Supabase client no disponible (window.sb)");
            return [];
          }
          let q = sb.from(table).select(selectStr);
          if (opts.eq) { for (const [k, v] of Object.entries(opts.eq)) q = q.eq(k, v); }
          if (opts.in) { for (const [k, arr] of Object.entries(opts.in)) q = q.in(k, arr); }
          if (opts.gte) { for (const [k, v] of Object.entries(opts.gte)) q = q.gte(k, v); }
          if (opts.lte) { for (const [k, v] of Object.entries(opts.lte)) q = q.lte(k, v); }
          if (opts.order) { q = q.order(opts.order.col, { ascending: opts.order.asc !== false }); }
          if (opts.limit) { q = q.limit(opts.limit); }
          const { data, error } = await q;
          if (error) {
            qclog(`‚ùå Supabase error en ${table}`, { error: String(error.message || error) });
            return [];
          }
          return Array.isArray(data) ? data : [];
        }

        function qcGetFilters() {
          const tipo = document.getElementById("qcTipo")?.value || "ALL";
          const almacen = document.getElementById("qcAlmacen")?.value || "ALL";
          const unidad = document.getElementById("qcUnidad")?.value || "ALL";
          const desde = document.getElementById("qcDesde")?.value || qcAddDaysISO(qcTodayISO(), -180);
          const hasta = document.getElementById("qcHasta")?.value || qcTodayISO();
          const soloCrit = !!document.getElementById("qcSoloCriticos")?.checked;
          const incluirCentral = !!document.getElementById("qcIncluirCentral")?.checked;
          return { tipo, almacen, unidad, desde, hasta, soloCrit, incluirCentral };
        }

        function qcSetDefaultDates() {
          const desdeEl = document.getElementById("qcDesde");
          const hastaEl = document.getElementById("qcHasta");
          if (desdeEl && !desdeEl.value) desdeEl.value = qcAddDaysISO(qcTodayISO(), -180);
          if (hastaEl && !hastaEl.value) hastaEl.value = qcTodayISO();
        }

        async function qcCargarUnidadesSelect() {
          try {
            const sel = document.getElementById("qcUnidad");
            if (!sel) return;
            // Si existe un selector global / caches de unidades, √∫salo. Si no, usa diccionario local.
            const entries = Object.entries(window.unidadesDestino || {}).filter(([k, _]) => String(k).trim());
            const opts = ["<option value=\"ALL\" selected>Todas</option>"];
            for (const [clave, nombre] of entries) {
              // omitimos almacenes que son CUU/65/66 si quieres separarlos
              opts.push(`<option value=\"${qcEsc(clave)}\">${qcEsc(clave)} ¬∑ ${qcEsc(nombre)}</option>`);
            }
            sel.innerHTML = opts.join("\n");
          } catch (e) {
            qclog("‚ùå Error cargando selector unidades", { err: String(e?.message || e) });
          }
        }

        // ---------- C√°lculos ----------
        function qcParseCaducidadToDate(fecha) {
          if (!fecha || fecha === "S/C" || fecha === "0" || fecha === 0) return null;
          // Excel serial
          if (!isNaN(fecha)) {
            const serial = parseInt(fecha, 10);
            if (serial > 1000) return new Date(1900, 0, serial - 2);
          }
          if (typeof fecha === "string") {
            if (/^\d{4}-\d{2}-\d{2}$/.test(fecha)) {
              const [y, m, d] = fecha.split("-").map(Number);
              return new Date(y, m - 1, d);
            }
            if (/^\d{2}\/\d{2}\/\d{4}$/.test(fecha)) {
              const [d, m, y] = fecha.split("/").map(Number);
              return new Date(y, m - 1, d);
            }
          }
          return null;
        }

        function qcDiasRestantes(fecha) {
          const dt = qcParseCaducidadToDate(fecha);
          if (!dt || isNaN(dt.getTime())) return Infinity;
          const hoy = new Date(); hoy.setHours(0, 0, 0, 0);
          dt.setHours(0, 0, 0, 0);
          return Math.floor((dt - hoy) / (1000 * 60 * 60 * 24));
        }

        function qcFmt2(n) {
          const x = Number(n);
          if (!Number.isFinite(x)) return "-";
          return x.toLocaleString("es-MX", { maximumFractionDigits: 2 });
        }

        function qcPillDias(dias) {
          if (dias === Infinity) return `<span class=\"cadu-pill\">S/C</span>`;
          if (dias <= 7) return `<span class=\"cadu-pill cadu-pill--danger\">‚õî ${dias}d</span>`;
          if (dias <= 30) return `<span class=\"cadu-pill cadu-pill--warn\">‚ö†Ô∏è ${dias}d</span>`;
          return `<span class=\"cadu-pill cadu-pill--ok\">‚úÖ ${dias}d</span>`;
        }

        function qcCompute({ catalogo, productosQC, historicosQC, consumoQC, filtros, columnaCorte }) {
          qclog("üß† Computando dashboard", { columnaCorte, filtros, nCat: catalogo.length, nProd: productosQC.length, nHist: historicosQC.length, nCon: consumoQC.length });

          // Normaliza cat√°logo
          const cat = (catalogo || []).map(x => ({
            referencia: String(x.referencia || "").trim(),
            tipo: String(x.tipo || "ALL").toUpperCase(),
            analito: x.analito ?? "",
            plataforma: x.plataforma_equipo ?? "",
            buffer_dias: Number(x.buffer_dias ?? 14),
          })).filter(x => x.referencia);

          // Index por referencia
          const catByRef = new Map();
          for (const it of cat) catByRef.set(it.referencia, it);

          // Filtra por tipo
          const allowedRefs = cat.filter(it => filtros.tipo === "ALL" || it.tipo === filtros.tipo).map(it => it.referencia);
          const allowedSet = new Set(allowedRefs);

          // Stock central: suma por ref (cantidad)
          const centralByRef = new Map();
          const lotesCentral = [];
          for (const p of (productosQC || [])) {
            const ref = String(p.referencia || "").trim();
            if (!allowedSet.has(ref)) continue;
            const cant = Number(p.cantidad ?? 0);
            if (cant <= 0) continue;
            centralByRef.set(ref, (centralByRef.get(ref) || 0) + cant);
            lotesCentral.push({
              referencia: ref,
              nombre: p.nombre ?? "",
              fabricante: p.fabricante ?? "",
              lote: p.lote ?? "",
              caducidad: p.caducidad ?? "",
              cantidad: cant,
              origen: "CENTRAL",
            });
          }

          // Stock unidades: historicos col -> cantidad
          const unidadesByRef = new Map(); // ref -> total
          const unidadesDetalle = []; // rows
          for (const h of (historicosQC || [])) {
            const ref = String(h.referencia || "").trim();
            if (!allowedSet.has(ref)) continue;
            const um = String(h.unidad_medica || h.unidad || "").trim();
            const val = Number(h[columnaCorte] ?? 0);
            if (!Number.isFinite(val) || val <= 0) continue;
            // filtro unidad
            if (filtros.unidad !== "ALL" && um !== filtros.unidad) continue;
            unidadesByRef.set(ref, (unidadesByRef.get(ref) || 0) + val);
            unidadesDetalle.push({ referencia: ref, unidad_medica: um, cantidad: val, origen: "UNIDAD" });
          }

          // Consumo: suma por ref y por mes
          const consumoByRef = new Map();
          const consumoMensual = new Map(); // yyyy-mm -> total
          const consumoMensualByTipo = new Map(); // yyyy-mm -> {IQC,EQC}
          for (const c of (consumoQC || [])) {
            const ref = String(c.referencia || "").trim();
            if (!allowedSet.has(ref)) continue;
            if (filtros.unidad !== "ALL" && String(c.unidad_medica || "").trim() !== filtros.unidad) continue;
            const tipo = String(c.tipo || "ALL").toUpperCase();
            if (filtros.tipo !== "ALL" && tipo !== filtros.tipo) continue;
            const cantidad = Number(c.cantidad ?? 0);
            if (!Number.isFinite(cantidad) || cantidad <= 0) continue;
            consumoByRef.set(ref, (consumoByRef.get(ref) || 0) + cantidad);
            const f = String(c.fecha || "").slice(0, 10);
            const ym = (f && f.length >= 7) ? f.slice(0, 7) : "S/F";
            consumoMensual.set(ym, (consumoMensual.get(ym) || 0) + cantidad);
            const bucket = consumoMensualByTipo.get(ym) || { IQC: 0, EQC: 0 };
            if (tipo === "EQC") bucket.EQC += cantidad; else bucket.IQC += cantidad;
            consumoMensualByTipo.set(ym, bucket);
          }

          // Rango d√≠as
          const daysRange = Math.max(1, Math.round((new Date(filtros.hasta + "T00:00:00") - new Date(filtros.desde + "T00:00:00")) / (1000 * 60 * 60 * 24)));
          const consumoTotal = Array.from(consumoByRef.values()).reduce((a, b) => a + b, 0);
          const consumoDiario = consumoTotal / daysRange;

          // Stock total por ref
          const stockTotalByRef = new Map();
          for (const ref of allowedRefs) {
            const central = filtros.incluirCentral ? (centralByRef.get(ref) || 0) : 0;
            const unid = unidadesByRef.get(ref) || 0;
            stockTotalByRef.set(ref, central + unid);
          }

          // Coverage global (d√≠as)
          const stockTotal = Array.from(stockTotalByRef.values()).reduce((a, b) => a + b, 0);
          const coberturaGlobal = consumoDiario > 0 ? (stockTotal / consumoDiario) : Infinity;

          // Ventanas caducidad (por lote central)
          const bins = { "0-7": 0, "8-15": 0, "16-30": 0, "31-90": 0, ">90": 0, "S/C": 0 };
          const critCad = [];
          for (const r of lotesCentral) {
            const d = qcDiasRestantes(r.caducidad);
            if (d === Infinity) { bins["S/C"] += 1; continue; }
            if (d <= 7) bins["0-7"] += 1;
            else if (d <= 15) bins["8-15"] += 1;
            else if (d <= 30) bins["16-30"] += 1;
            else if (d <= 90) bins["31-90"] += 1;
            else bins[">90"] += 1;
            if (d <= 30) critCad.push({ ...r, dias: d });
          }

          // Compra sugerida por ref
          const leadTimeDias = 14; // default (ajustable)
          const compra = [];
          const criticos = [];
          for (const ref of allowedRefs) {
            const stock = stockTotalByRef.get(ref) || 0;
            const cons = consumoByRef.get(ref) || 0;
            const consDiarioRef = cons / daysRange;
            const it = catByRef.get(ref) || { buffer_dias: 14, tipo: "ALL" };
            const buffer = Number(it.buffer_dias ?? 14);
            const target = consDiarioRef > 0 ? Math.ceil(consDiarioRef * (leadTimeDias + buffer)) : 0;
            const sugerido = Math.max(0, target - stock);
            const cobertura = consDiarioRef > 0 ? (stock / consDiarioRef) : Infinity;
            compra.push({ referencia: ref, tipo: it.tipo || "", stock, consumo: cons, cobertura, sugerido, buffer_dias: buffer });
            const coberturaCrit = cobertura !== Infinity && cobertura <= 14;
            if (coberturaCrit || sugerido > 0) {
              criticos.push({ referencia: ref, tipo: it.tipo || "", stock, consumo: cons, cobertura, sugerido, motivo: coberturaCrit ? "Cobertura baja" : "Reponer" });
            }
          }

          // Filtro s√≥lo cr√≠ticos
          const compraFiltrada = filtros.soloCrit ? compra.filter(x => x.sugerido > 0) : compra;
          const critFinal = filtros.soloCrit ? criticos : [...criticos];
          // A√±ade caducidades cr√≠ticas como √≠tems (por lote)
          for (const x of critCad) {
            critFinal.push({ referencia: x.referencia, tipo: catByRef.get(x.referencia)?.tipo || "", stock: x.cantidad, consumo: 0, cobertura: Infinity, sugerido: 0, motivo: `Caduca en ${x.dias}d`, lote: x.lote, caducidad: x.caducidad, origen: x.origen });
          }

          // Cobertura por almac√©n (simple): usamos central CUU/65/66 como "almacenes" + unidades como "UNIDADES"
          // Nota: central por almac√©n real requiere una tabla que relacione productos->almac√©n; aqu√≠ asumimos CENTRAL agregado.
          const coberturaPorAlmacen = [
            { key: "CENTRAL", label: "Central", stock: filtros.incluirCentral ? Array.from(centralByRef.values()).reduce((a, b) => a + b, 0) : 0 },
            { key: "UNIDADES", label: "Unidades", stock: Array.from(unidadesByRef.values()).reduce((a, b) => a + b, 0) },
          ].map(x => ({ ...x, cobertura: consumoDiario > 0 ? (x.stock / consumoDiario) : Infinity }));

          // Ordena
          compraFiltrada.sort((a, b) => (b.sugerido - a.sugerido) || (a.referencia.localeCompare(b.referencia)));
          critFinal.sort((a, b) => {
            const ac = a.cobertura ?? Infinity, bc = b.cobertura ?? Infinity;
            return (ac - bc) || (String(a.referencia).localeCompare(String(b.referencia)));
          });

          return {
            kpis: {
              stockTotal,
              consumoTotal,
              consumoDiario,
              coberturaGlobal,
              caducidadesCriticas: critCad.length,
              itemsReponer: compra.filter(x => x.sugerido > 0).length,
            },
            charts: {
              consumoMensualByTipo,
              coberturaPorAlmacen,
              cadBins: bins,
            },
            tablas: {
              criticos: critFinal,
              compra: compraFiltrada,
            },
            meta: { daysRange, columnaCorte }
          };
        }

        // ---------- Render ----------
        function qcRenderKPIs(kpis) {
          const wrap = document.getElementById("qcKPIs");
          if (!wrap) return;
          const card = (title, value, sub = "") => `
      <div class="space-card p-4">
        <div class="text-xs text-white/60">${qcEsc(title)}</div>
        <div class="text-2xl font-extrabold text-white/90 mt-1">${qcEsc(value)}</div>
        ${sub ? `<div class="text-xs text-white/55 mt-1">${qcEsc(sub)}</div>` : ""}
      </div>
    `;
          const cov = (kpis.coberturaGlobal === Infinity) ? "‚àû" : qcFmt2(kpis.coberturaGlobal);
          wrap.innerHTML = [
            card("Stock total QC", qcFmt2(kpis.stockTotal), "central + unidades"),
            card("Consumo (rango)", qcFmt2(kpis.consumoTotal), "unidades consumidas"),
            card("Consumo diario", qcFmt2(kpis.consumoDiario), "promedio"),
            card("Cobertura global (d√≠as)", cov, "stock / consumo"),
            card("Cr√≠ticos", qcFmt2(kpis.caducidadesCriticas + kpis.itemsReponer), "caducidad + reponer"),
          ].join("\n");
        }

        async function qcRenderCharts(ch) {
          const ok = await qcEnsureChart();
          if (!ok) return;
          const Chart = window.Chart;

          // Consumo mensual
          const c1 = document.getElementById("qcChartConsumo");
          if (c1) {
            const labels = Array.from(ch.consumoMensualByTipo.keys()).sort();
            const iqc = labels.map(k => ch.consumoMensualByTipo.get(k)?.IQC || 0);
            const eqc = labels.map(k => ch.consumoMensualByTipo.get(k)?.EQC || 0);
            const data = {
              labels,
              datasets: [
                { label: "IQC", data: iqc, tension: 0.25, order: 1 },
                { label: "EQC", data: eqc, tension: 0.25, order: 2 },
              ]
            };
            if (window.qcState.charts.consumo) window.qcState.charts.consumo.destroy();
            window.qcState.charts.consumo = new Chart(c1.getContext("2d"), {
              type: "line",
              data,
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: { labels: { color: "rgba(255,255,255,.75)" } },
                  tooltip: { enabled: true }
                },
                scales: {
                  x: { ticks: { color: "rgba(255,255,255,.6)" }, grid: { color: "rgba(255,255,255,.06)" } },
                  y: { ticks: { color: "rgba(255,255,255,.6)" }, grid: { color: "rgba(255,255,255,.06)" } },
                }
              }
            });
          }

          // Cobertura por almac√©n
          const c2 = document.getElementById("qcChartCobertura");
          if (c2) {
            const labels = ch.coberturaPorAlmacen.map(x => x.label);
            const vals = ch.coberturaPorAlmacen.map(x => (x.cobertura === Infinity ? 0 : x.cobertura));
            if (window.qcState.charts.cobertura) window.qcState.charts.cobertura.destroy();
            window.qcState.charts.cobertura = new Chart(c2.getContext("2d"), {
              type: "bar",
              data: { labels, datasets: [{ label: "D√≠as", data: vals, order: 1 }] },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { labels: { color: "rgba(255,255,255,.75)" } } },
                scales: {
                  x: { ticks: { color: "rgba(255,255,255,.6)" }, grid: { color: "rgba(255,255,255,.06)" } },
                  y: { ticks: { color: "rgba(255,255,255,.6)" }, grid: { color: "rgba(255,255,255,.06)" } },
                }
              }
            });
          }

          // Caducidades ventanas
          const c3 = document.getElementById("qcChartCaducidad");
          if (c3) {
            const labels = Object.keys(ch.cadBins);
            const vals = labels.map(k => ch.cadBins[k] || 0);
            if (window.qcState.charts.caducidad) window.qcState.charts.caducidad.destroy();
            window.qcState.charts.caducidad = new Chart(c3.getContext("2d"), {
              type: "doughnut",
              data: { labels, datasets: [{ label: "Lotes", data: vals }] },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { labels: { color: "rgba(255,255,255,.75)" } } }
              }
            });
          }
        }

        function qcRenderTablaCriticos(rows) {
          const wrap = document.getElementById("qcTablaCriticos");
          if (!wrap) return;

          if (!rows?.length) {
            wrap.innerHTML = `<div class="p-4 text-sm text-white/70">‚úÖ Sin cr√≠ticos con los filtros actuales.</div>`;
            return;
          }

          const head = `
      <table class="cadu-table">
        <thead>
          <tr>
            <th>Referencia</th>
            <th>Tipo</th>
            <th>Stock</th>
            <th>Cobertura</th>
            <th>Motivo</th>
          </tr>
        </thead>
        <tbody>
    `;

          const body = rows.slice(0, 120).map(r => {
            const cov = (r.cobertura === Infinity) ? "‚àû" : qcFmt2(r.cobertura);
            const motivo = r.motivo || "";
            return `
        <tr>
          <td class="whitespace-nowrap font-mono">${qcEsc(r.referencia)}</td>
          <td>${qcEsc(r.tipo || "")}</td>
          <td class="text-right">${qcFmt2(r.stock || 0)}</td>
          <td class="text-right">${qcEsc(cov)}</td>
          <td>${qcEsc(motivo)}${r.caducidad ? `<span class="cadu-sub">Lote ${qcEsc(r.lote || "")} ¬∑ ${qcEsc(r.caducidad)} ¬∑ ${qcPillDias(qcDiasRestantes(r.caducidad))}</span>` : ""}</td>
        </tr>
      `;
          }).join("\n");

          const foot = `</tbody></table>`;
          wrap.innerHTML = head + body + foot;
        }

        function qcRenderTablaCompra(rows) {
          const wrap = document.getElementById("qcTablaCompra");
          if (!wrap) return;
          if (!rows?.length) {
            wrap.innerHTML = `<div class="p-4 text-sm text-white/70">‚Äî Sin sugerencias de compra con los filtros actuales.</div>`;
            return;
          }
          const head = `
      <table class="cadu-table">
        <thead>
          <tr>
            <th>Referencia</th>
            <th>Tipo</th>
            <th>Stock</th>
            <th>Consumo</th>
            <th>Sugerido</th>
          </tr>
        </thead>
        <tbody>
    `;
          const body = rows.slice(0, 160).map(r => `
      <tr>
        <td class="whitespace-nowrap font-mono">${qcEsc(r.referencia)}</td>
        <td>${qcEsc(r.tipo || "")}</td>
        <td class="text-right">${qcFmt2(r.stock || 0)}</td>
        <td class="text-right">${qcFmt2(r.consumo || 0)}</td>
        <td class="text-right font-extrabold">${qcFmt2(r.sugerido || 0)}</td>
      </tr>
    `).join("\n");
          wrap.innerHTML = head + body + `</tbody></table>`;
        }

        // ---------- Orquestador ----------
        async function qc_refrescarDashboard() {
          const modal = document.getElementById("modalQC");
          if (modal && modal.classList.contains("hidden")) {
            // si est√° cerrado, no corremos por accidente
            qclog("‚è≠Ô∏è QC refresh ignorado (modal cerrado)");
            return;
          }

          loaderReset?.();
          mostrarLoader?.(true);
          try {
            qcSetDefaultDates();
            const filtros = qcGetFilters();
            const columnaCorte = qcColumnaCorteVigente();

            qclog("‚ñ∂ Iniciando QC refresh", { filtros, columnaCorte });
            loaderPush?.("QC: cargando cat√°logo (qc_items)");
            const catalogo = await qcSbSelect("qc_items", "referencia,tipo,analito,plataforma_equipo,buffer_dias");
            window.qcState.catalogo = catalogo;

            if (!catalogo.length) {
              qclog("‚ö†Ô∏è qc_items vac√≠o. El dashboard mostrar√° datos incompletos.");
            }

            // refs a consultar
            const refs = catalogo.map(x => String(x.referencia || "").trim()).filter(Boolean);
            const uniqueRefs = Array.from(new Set(refs));

            loaderPush?.("QC: cargando productos (stock central)");
            const productosQC = uniqueRefs.length
              ? await qcSbSelect("productos", "referencia,nombre,fabricante,lote,caducidad,cantidad", { in: { referencia: uniqueRefs } })
              : [];
            window.qcState.productosQC = productosQC;

            loaderPush?.("QC: cargando historicos (stock unidades)");
            const histSelect = `unidad_medica,referencia,${columnaCorte}`;
            const historicosQC = uniqueRefs.length
              ? await qcSbSelect("historicos", histSelect, { in: { referencia: uniqueRefs } })
              : [];
            window.qcState.historicosQC = historicosQC;

            loaderPush?.("QC: cargando consumo (qc_consumo)");
            const consumoQC = await qcSbSelect("qc_consumo", "fecha,unidad_medica,referencia,tipo,cantidad", {
              gte: { fecha: filtros.desde },
              lte: { fecha: filtros.hasta },
            });
            window.qcState.consumoQC = consumoQC;

            const computed = qcCompute({ catalogo, productosQC, historicosQC, consumoQC, filtros, columnaCorte });
            window.qcState.computed = computed;
            window.qcState.lastRunAt = new Date().toISOString();

            // Render
            qcRenderKPIs(computed.kpis);
            await qcRenderCharts(computed.charts);
            qcRenderTablaCriticos(computed.tablas.criticos);
            qcRenderTablaCompra(computed.tablas.compra);

            qclog("‚úÖ QC dashboard listo", { kpis: computed.kpis, meta: computed.meta });
          } catch (e) {
            qclog("‚ùå Error en QC refresh", { err: String(e?.message || e) });
            const t1 = document.getElementById("qcTablaCriticos");
            const t2 = document.getElementById("qcTablaCompra");
            if (t1) t1.innerHTML = `<div class="p-4 text-sm text-rose-200">‚ùå Error cargando QC: ${qcEsc(String(e?.message || e))}</div>`;
            if (t2) t2.innerHTML = `<div class="p-4 text-sm text-rose-200">‚ùå Error cargando QC: ${qcEsc(String(e?.message || e))}</div>`;
          } finally {
            ocultarLoader?.();
          }
        }

        function qc_exportarCSV() {
          try {
            const comp = window.qcState.computed;
            if (!comp) {
              qclog("‚è≠Ô∏è No hay datos para exportar (corre Refrescar)");
              return;
            }
            const rows1 = comp.tablas.compra || [];
            const rows2 = comp.tablas.criticos || [];
            const esc = (v) => {
              const s = String(v ?? "").replaceAll('"', '""');
              return `"${s}"`;
            };
            const head1 = ["referencia", "tipo", "stock", "consumo", "cobertura_dias", "sugerido"].map(esc).join(",");
            const csv1 = rows1.map(r => [r.referencia, r.tipo, r.stock, r.consumo, r.cobertura, r.sugerido].map(esc).join(",")).join("\n");
            const head2 = ["referencia", "tipo", "stock", "cobertura_dias", "motivo", "lote", "caducidad"].map(esc).join(",");
            const csv2 = rows2.map(r => [r.referencia, r.tipo, r.stock, r.cobertura, r.motivo || "", r.lote || "", r.caducidad || ""].map(esc).join(",")).join("\n");
            const out = [
              "# QC Command - Compra sugerida",
              head1,
              csv1,
              "",
              "# QC Command - Cr√≠ticos",
              head2,
              csv2,
              "",
              `# Meta: columnaCorte=${comp.meta?.columnaCorte || ""} daysRange=${comp.meta?.daysRange || ""}`,
            ].join("\n");

            const blob = new Blob([out], { type: "text/csv;charset=utf-8" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `qc_command_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            qclog("‚¨áÔ∏è CSV exportado");
          } catch (e) {
            qclog("‚ùå Error exportando CSV", { err: String(e?.message || e) });
          }
        }

        function abrirModalQC() {
          const modal = document.getElementById("modalQC");
          if (!modal) return;
          modal.classList.remove("hidden");
          modal.classList.add("flex");
          qcSetDefaultDates();
          qcCargarUnidadesSelect();
          qclog("üõ∞Ô∏è QC modal abierto");
          // Auto-refresh al abrir (primera vez o siempre)
          qc_refrescarDashboard();
        }

        function cerrarModalQC() {
          const modal = document.getElementById("modalQC");
          if (!modal) return;
          modal.classList.add("hidden");
          modal.classList.remove("flex");
          qclog("üõ∞Ô∏è QC modal cerrado");
        }

        // Exponer APIs globales
        window.abrirModalQC = abrirModalQC;
        window.cerrarModalQC = cerrarModalQC;
        window.qc_refrescarDashboard = qc_refrescarDashboard;
        window.qc_exportarCSV = qc_exportarCSV;

        // Listeners
        document.addEventListener("DOMContentLoaded", () => {
          if (window.__qc_dom_ready_bound) return;
          window.__qc_dom_ready_bound = true;
          qcSetDefaultDates();
          qcCargarUnidadesSelect();
          const btn = document.getElementById("btnQC");
          if (btn) btn.addEventListener("click", () => abrirModalQC());
          ["qcTipo", "qcAlmacen", "qcUnidad", "qcDesde", "qcHasta", "qcSoloCriticos", "qcIncluirCentral"].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener("change", () => qclog("üîÅ Filtro cambiado", { id, value: (el.type === "checkbox" ? el.checked : el.value) }));
          });
        });

        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            const modal = document.getElementById("modalQC");
            if (modal && !modal.classList.contains("hidden")) cerrarModalQC();
          }
        });
      })();
      //#endregion QC Command


    </script>

    <!-- ================= MAPA3D (HUD) ================= -->
    <style>
      /* ================= MAPA3D: show/hide elegante ================= */
      #mapa3dDemo {
        transition: opacity .28s ease, transform .28s ease, filter .28s ease;
        will-change: opacity, transform, filter;
      }

      #mapa3dDemo.map3d-hidden {
        opacity: 0;
        transform: translateY(18px) scale(.985);
        filter: blur(10px);
        pointer-events: none;
      }

      #mapa3dDemo.map3d-showing {
        opacity: 1;
        transform: translateY(0) scale(1);
        filter: blur(0);
        pointer-events: auto;
      }

      @media (prefers-reduced-motion: reduce) {
        #mapa3dDemo {
          transition: none !important;
        }

        #mapa3dDemo.map3d-hidden {
          transform: none;
          filter: none;
        }
      }

      /* HUD layout */
      #map3dWrap {
        position: relative;
        isolation: isolate;
      }

      #map3dCanvas {
        width: 100%;
        height: 100%;
        display: block;
        filter: contrast(1.06) saturate(1.05);
      }

      .map3d-hudVignette::after {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        z-index: 2;
        background:
          radial-gradient(860px 540px at 50% 45%, transparent 58%, rgba(0, 0, 0, .22) 88%),
          radial-gradient(1100px 680px at 50% 38%, rgba(0, 229, 255, .10), transparent 64%);
      }

      .map3d-topbar {
        position: absolute;
        left: 18px;
        right: 18px;
        top: 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        pointer-events: none;
        z-index: 30;
        color: rgba(255, 255, 255, .74);
        font-size: 12px;
        letter-spacing: .14em;
        text-transform: uppercase;
        text-shadow: 0 10px 28px rgba(0, 0, 0, .25);
      }

      .map3d-title {
        font-weight: 950;
        color: rgba(255, 255, 255, .90);
        letter-spacing: .18em;
      }

      .map3d-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(0, 0, 0, .22);
        border: 1px solid rgba(255, 255, 255, .10);
        box-shadow: 0 14px 40px rgba(0, 0, 0, .22);
        pointer-events: none;
      }

      .map3d-pill i {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        display: inline-block;
      }

      .map3d-rails {
        position: absolute;
        left: 14px;
        right: 14px;
        bottom: 14px;
        top: 48px;
        display: grid;
        grid-template-columns: 320px 1fr 360px;
        gap: 12px;
        pointer-events: none;
        z-index: 10;
      }

      @media (min-width: 1400px) {
        .map3d-rails {
          /* ‚úÖ Floating effect: Percentage based */
          left: -4%;
          right: -4%;
          grid-template-columns: 340px 1fr 380px;
        }
      }

      .map3d-rail {
        pointer-events: auto;
        height: 100%;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .map3d-card {
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, .10);
        background: rgba(10, 18, 24, 0.22);
        box-shadow: 0 18px 48px rgba(0, 0, 0, .34);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        overflow: visible;
        padding: 12px;
      }

      .map3d-btn {
        border-radius: 16px;
        padding: 10px 12px;
        font-weight: 900;
        color: #fff;
        background: linear-gradient(90deg, rgba(0, 229, 255, .18), rgba(59, 130, 246, .16));
        border: 1px solid rgba(0, 229, 255, .16);
        box-shadow: 0 18px 50px rgba(0, 0, 0, .38), 0 0 26px rgba(0, 229, 255, .10);
        cursor: pointer;
        user-select: none;
      }

      .map3d-btnGhost {
        border-radius: 16px;
        padding: 10px 12px;
        font-weight: 900;
        color: rgba(255, 255, 255, .90);
        background: rgba(255, 255, 255, .06);
        border: 1px solid rgba(255, 255, 255, .12);
        box-shadow: 0 14px 36px rgba(0, 0, 0, .28);
        cursor: pointer;
        user-select: none;
      }

      @media (max-width: 1100px) {
        .map3d-rails {
          grid-template-columns: 300px 1fr 320px;
        }
      }

      @media (max-width: 900px) {
        .map3d-rails {
          grid-template-columns: 1fr;
          grid-auto-rows: auto;
          gap: 10px;
          position: relative;
          /* Stack on mobile */
          left: auto;
          right: auto;
          top: auto;
          bottom: auto;
          pointer-events: auto;
        }
      }

      /* Collapse logic: Sideways + Tabs */
      .map3d-card {
        transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), min-height 0.3s ease, height 0.3s ease;
        overflow: hidden;
      }

      .map3d-card.collapsed .map3d-body,
      .map3d-card.collapsed .map3d-label,
      .map3d-card.collapsed .map3d-collapse-btn,
      .map3d-card.collapsed .flex,
      /* Hides headers */
      .map3d-card.collapsed>div:not(.map3d-tab-icon) {
        display: none !important;
      }

      /* When collapsed, it becomes a small tab */
      .map3d-card.collapsed {
        width: 42px !important;
        height: 42px !important;
        min-height: 0 !important;
        padding: 0 !important;
        background: rgba(0, 0, 0, 0.6);
        border-color: rgba(255, 255, 255, 0.2);
        cursor: pointer;
      }

      .map3d-tab-icon {
        display: none;
        width: 100%;
        height: 100%;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: rgba(255, 255, 255, 0.8);
      }

      .map3d-card.collapsed .map3d-tab-icon {
        display: flex;
      }

      .map3d-card.collapsed:hover {
        background: rgba(23, 162, 166, 0.2);
        border-color: rgba(23, 162, 166, 0.5);
      }

      /* Directional Alignment */
      .map3d-rail:first-child {
        align-items: flex-start;
      }

      .map3d-rail:last-child {
        align-items: flex-end;
      }
    </style>

    <section id="mapa3dDemo" class="hidden map3d-hidden w-full p-4 sm:p-6" aria-hidden="true">
      <div class="max-w-6xl mx-auto space-y-4">
        <div class="map3d-card flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
          <div>
            <div class="text-xs text-white/60 tracking-[.28em] uppercase">Mapa 3D ‚Ä¢ HUD</div>
            <div class="text-xl sm:text-2xl font-black tracking-wider text-white/90">Panel lateral + Canvas central
              (GLB)</div>
            <div class="text-sm text-white/60 mt-1">Selecciona un resultado para abrir este m√≥dulo y resaltar su UBI.
            </div>
          </div>
          <div class="flex flex-wrap gap-2">
            <button class="map3d-btnGhost" onclick="MAP3D_MODULES.renderAll(window.__MAP3D_LAST_META || {})">‚Üª
              Refresh</button>
            <button class="map3d-btnGhost"
              onclick="(typeof verForecast==='function' && window.__MAP3D_LAST_META?.referencia) ? verForecast(window.__MAP3D_LAST_META.referencia, window.__MAP3D_LAST_META.nombre, window.__MAP3D_LAST_META.fabricante) : null">üìà
              Forecast (modal)</button>
            <button class="map3d-btnGhost"
              onclick="(typeof verMovimientos==='function' && window.__MAP3D_LAST_META?.referencia) ? verMovimientos(window.__MAP3D_LAST_META.referencia) : null">üßæ
              Movimientos</button>
            <button class="map3d-btnGhost" type="button" onclick="MAP3D_UI.hide()">‚¨ÖÔ∏è Volver</button>
          </div>
        </div>

        <div id="map3dWrap" class="visible relative w-full h-[720px] sm:h-[760px]">
          <!-- ‚úÖ Removed overflow-hidden from wrapper -->

          <!-- ‚úÖ Canvas clip container -->
          <div id="map3dCanvasContainer" class="absolute inset-0 rounded-3xl overflow-hidden bg-black/40">
            <canvas id="map3dCanvas"></canvas>
          </div>

          <div class="map3d-topbar">
            <div class="map3d-title">WAREHOUSE REACTOR MAP</div>
            <div class="flex items-center gap-3">
              <span class="map3d-pill"><i
                  style="background:rgba(255,176,0,.9); box-shadow:0 0 18px rgba(255,176,0,.22)"></i><span
                  id="map3dBadge">Listo</span></span>
            </div>
          </div>

          <div class="map3d-rails">
            <div class="map3d-rail">
              <div class="map3d-card relative pr-24">
                <div class="text-[11px] text-white/60 tracking-[.24em] uppercase">Producto</div>
                <div class="mt-1">
                  <div class="text-lg font-black text-white/90" id="uiProdRef">‚Äî</div>
                  <div class="text-sm text-white/70 mt-1" id="uiProdNombre">‚Äî</div>
                  <div class="text-xs text-white/55 mt-1">Fabricante: <span class="text-white/75"
                      id="uiProdFabricante">‚Äî</span></div>
                </div>
                <div id="hudUbiBadge" class="
                    absolute top-2 right-2
                    rounded-lg
                    px-2 py-1
                    text-[11px]
                    backdrop-blur-md
                    border
                    shadow
                  ">
                  <div class="text-[10px] opacity-75 leading-none">UBI</div>
                  <div class="font-black text-[12px] leading-none" id="hudTarget">‚Äî</div>
                </div>
                <!-- Collapse Btn -->
                <button class="absolute top-2 left-2 map3d-collapse-btn" onclick="toggleMapModule(this)">‚àí</button>
                <div class="map3d-tab-icon" onclick="toggleMapModule(this)">üì¶</div>
              </div>

              <div class="map3d-card">
                <div class="flex justify-between items-center">
                  <div class="map3d-label">Consumo hist√≥rico</div>
                  <button class="map3d-collapse-btn" onclick="toggleMapModule(this)">‚àí</button>
                </div>
                <div class="map3d-body">
                  <div class="mt-2 relative w-full h-[160px]">
                    <canvas id="graficaForecastHUD" class="block w-full h-full"></canvas>
                  </div>
                  <div class="mt-2 text-[11px] text-white/55" id="graficaForecastHUDMeta">‚Äî</div>
                </div>
                <div class="map3d-tab-icon" onclick="toggleMapModule(this)">üìâ</div>
              </div>

              <div class="map3d-card">
                <div class="flex justify-between items-center">
                  <div class="map3d-label">Pron√≥stico</div>
                  <button class="map3d-collapse-btn" onclick="toggleMapModule(this)">‚àí</button>
                </div>
                <div class="map3d-body">
                  <div class="mt-2 relative w-full h-[140px]">
                    <canvas id="graficaForecastProHUD" class="block w-full h-full"></canvas>
                  </div>
                  <div class="mt-2 text-[11px] text-white/55" id="graficaForecastProHUDMeta">‚Äî</div>
                </div>
                <div class="map3d-tab-icon" onclick="toggleMapModule(this)">üìä</div>
              </div>
              <div class="map3d-card">
                <div class="flex justify-between items-center">
                  <div class="map3d-label">Lotes</div>
                  <button class="map3d-collapse-btn" onclick="toggleMapModule(this)">‚àí</button>
                </div>
                <div class="map3d-body">
                  <div class="mt-2 relative w-full h-[110px]">
                    <canvas id="graficaLotesPieHUD" class="block w-full h-full"></canvas>
                  </div>
                  <div class="mt-2" id="uiTablaLotesHUD"></div>
                </div>
                <div class="map3d-tab-icon" onclick="toggleMapModule(this)">üî¢</div>
              </div>
            </div>
            <div></div>

            <!-- RIGHT rail: m√≥dulos -->
            <div class="map3d-rail map3d-scope">
              <div class="map3d-card">
                <div class="flex justify-between items-center">
                  <div class="map3d-label">Plan de entrega</div>
                  <button class="map3d-collapse-btn" onclick="toggleMapModule(this)">‚àí</button>
                </div>
                <div class="map3d-body">
                  <div id="tablaEntregasForecastHUD" class="mt-2 text-sm"></div>
                </div>
                <div class="map3d-tab-icon" onclick="toggleMapModule(this)">üöö</div>
              </div>

              <div class="map3d-card min-h-[200px] md:min-h-[240px] lg:min-h-[320px] overflow-visible">
                <div class="flex items-center justify-between">
                  <div class="map3d-label">Inventario por representaci√≥n</div>
                  <div class="flex items-center gap-2">
                    <div class="text-[10px] text-white/40 mono" id="uiSolInvMetaHUD">‚Äî</div>
                    <button class="map3d-collapse-btn" onclick="toggleMapModule(this)">‚àí</button>
                  </div>
                </div>

                <div class="map3d-body">
                  <div class="mt-2 rounded-2xl border border-white/10 bg-black/20 relative sol-wrap-ov">
                    <svg id="solReactivoHUD" viewBox="0 0 420 420" preserveAspectRatio="xMidYMid meet"
                      class="w-full block h-[280px] sm:h-[320px] md:h-[360px] lg:h-[420px] svg-glow"></svg>


                    <div id="solReactivoTooltipHUD" class="hidden absolute z-10 pointer-events-none px-3 py-2 rounded-2xl
                            bg-black/70 border border-white/10 text-[12px] text-white/90
                            shadow-2xl backdrop-blur-xl">
                      <div class="font-bold" id="solReactivoTipTitleHUD"></div>
                      <div class="text-white/70" id="solReactivoTipSubHUD"></div>
                    </div>
                  </div>

                  <div class="mt-2 text-[11px] text-white/55">
                    Rayos = representaciones ‚Ä¢ Largo = % cumplimiento ‚Ä¢ Color = crit/low/ok
                  </div>
                </div>
                <div class="map3d-tab-icon" onclick="toggleMapModule(this)">üß™</div>
              </div>
            </div>
          </div>
        </div>

        <div id="map3dTip"
          class="hidden absolute z-50 pointer-events-none translate-x-2 translate-y-2 px-3 py-2 rounded-2xl bg-black/70 border border-white/10 text-[12px] text-white/90 shadow-2xl backdrop-blur-xl">
        </div>
      </div>

  </div>
  <!-- inputs ocultos para compatibilidad -->
  <div class="hidden">
    <input id="inRef" />
    <input id="inUbi" />
  </div>
  </section>

  <script>
    function toggleMapModule(btn) {
      const card = btn.closest(".map3d-card");
      if (card) {
        card.classList.toggle("collapsed");
        btn.textContent = card.classList.contains("collapsed") ? "+" : "‚àí";
      }
    }

    /* ================= MAP3D_UI (show/hide + openFromSearch) ================= */
    (function () {
      const TAG = "[MAP3D_UI]";
      const log = (msg, meta) => { try { (window.logx ? window.logx : console.log)(TAG, msg, meta || ""); } catch (_) { console.log(TAG, msg, meta || ""); } };

      const sec = () => document.getElementById("mapa3dDemo");
      const main = () => document.getElementById("mainUI");
      const results = () => document.getElementById("resultadoBusqueda");

      function showSection() {
        const el = sec(); if (!el) return;
        el.setAttribute("aria-hidden", "false");
        el.classList.remove("hidden");
        requestAnimationFrame(() => { el.classList.remove("map3d-hidden"); el.classList.add("map3d-showing"); });
        try { el.scrollIntoView({ behavior: "smooth", block: "start" }); } catch (_) { }
      }
      function hideSection() {
        const el = sec(); if (!el) return;
        el.setAttribute("aria-hidden", "true");
        el.classList.add("map3d-hidden");
        el.classList.remove("map3d-showing");
        const onEnd = (ev) => { if (ev.target !== el) return; el.removeEventListener("transitionend", onEnd); el.classList.add("hidden"); };
        el.addEventListener("transitionend", onEnd);
      }

      window.MAP3D_UI = window.MAP3D_UI || {};

      window.MAP3D_UI.show = function () {
        const m = main(); if (m) m.classList.add("hidden");
        const r = results(); if (r) { r.classList.add("hidden"); }
        showSection();
        // init (lazy)
        try { window.MAP3D?.init?.(); } catch (e) { log("MAP3D.init error", { err: String(e?.message || e) }); }
      };

      window.MAP3D_UI.hide = function () {
        hideSection();
        const m = main(); if (m) m.classList.remove("hidden");
        log("restoreUI", { mainUI: !!m });
      };

      window.MAP3D_UI.openFromSearch = function (payload) {
        const ref = String(payload?.referencia || payload?.ref || "").trim();
        const nombre = String(payload?.nombre || "").trim();
        const fabricante = String(payload?.fabricante || "").trim();
        const ubi = String(payload?.ubi || "").trim();
        // ‚úÖ guarda el meta global para refresh/botones
        window.__MAP3D_LAST_META = { ...payload, referencia: ref, nombre, fabricante, ubi };

        // ‚úÖ dispara m√≥dulos HUD
        try { window.MAP3D_MODULES?.renderAll(window.__MAP3D_LAST_META); } catch (e) { }
        // Compatibilidad global
        window.filtroReferenciaGlobal = ref || null;

        const inRef = document.getElementById("inRef");
        const inUbi = document.getElementById("inUbi");
        if (inRef) inRef.value = ref;
        if (inUbi) inUbi.value = ubi;

        const setTxt = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = (v && String(v).trim()) ? String(v).trim() : "‚Äî"; };
        setTxt("uiProdRef", ref);
        setTxt("uiProdNombre", nombre);
        setTxt("uiProdFabricante", fabricante);
        setTxt("hudTarget", ubi);

        log("openFromSearch", { ref, nombre, fabricante, ubi });

        window.MAP3D_UI.show();

        // highlight (si ya viene ubi, se usa directo; si no, se resuelve por Supabase)
        try {
          if (ubi) window.MAP3D?.highlightUbi?.(ubi);
          else window.MAP3D?.buscarPorReferencia?.(ref);
        } catch (e) {
          log("highlight error", { err: String(e?.message || e) });
        }
      };
    })();
  </script>

  <script type="module">
    /* ================= MAP3D (Three.js + GLB + highlight UBI) ================= */
    import * as THREE from "three";
    import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";
    import { EffectComposer } from "three/addons/postprocessing/EffectComposer.js";
    import { RenderPass } from "three/addons/postprocessing/RenderPass.js";
    import { UnrealBloomPass } from "three/addons/postprocessing/UnrealBloomPass.js";
    import { OutlinePass } from "three/addons/postprocessing/OutlinePass.js";
    import { ShaderPass } from "three/addons/postprocessing/ShaderPass.js";
    import { FXAAShader } from "three/addons/shaders/FXAAShader.js";
    import { OrbitControls } from "three/addons/controls/OrbitControls.js"; // ‚úÖ OrbitControls
    import { RoomEnvironment } from "three/addons/environments/RoomEnvironment.js";

    const TAG = "[MAP3D]";
    const log = (msg, meta) => { try { (window.logx ? window.logx : console.log)(TAG, msg, meta || ""); } catch (_) { console.log(TAG, msg, meta || ""); } };
    const badge = (t) => { const el = document.getElementById("map3dBadge"); if (el) el.textContent = t || "‚Äî"; };

    const ADDITIVE_BLOOM_SHADER = {
      uniforms: { tDiffuse: { value: null }, bloomTexture: { value: null } },
      vertexShader: `varying vec2 vUv; void main(){ vUv=uv; gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);} `,
      fragmentShader: `uniform sampler2D tDiffuse; uniform sampler2D bloomTexture; varying vec2 vUv; void main(){ vec4 base=texture2D(tDiffuse,vUv); vec4 bloom=texture2D(bloomTexture,vUv); gl_FragColor = base + bloom; }`
    };

    function isPickableSlotName(nameRaw) {
      const nm = String(nameRaw || "").trim().toUpperCase();
      if (!nm) return false;
      if (nm.includes("EDIFICIO")) return false;
      return /^[A-Z]{1,3}\d{1,3}$/.test(nm);
    }

    window.MAP3D = window.MAP3D || {
      _inited: false,
      canvas: null, renderer: null, scene: null, camera: null,
      composer: null, fxEnabled: true, staticMode: true,
      glbUrl: "./relaciones.glb",
      slots: new Map(),
      current: null,
      camTarget: new THREE.Vector3(5, 2, 3),
      camTargetDesired: new THREE.Vector3(5, 2, 3),
      camPosDesired: null,
      camLerp: 0.12,
      camLerpActive: false,
      raycaster: new THREE.Raycaster(),
      pointer: new THREE.Vector2(),
      viewBiasX: 0, viewBiasY: 0, // ‚úÖ Center properly (was 360)
      needsRender: true, lastFrame: 0, fpsCapMs: 1000 / 30, stop: false,

      init() {
        if (this._inited) return;
        this.canvas = document.getElementById("map3dCanvas");
        const wrap = document.getElementById("map3dWrap");
        if (!this.canvas || !wrap) {
          log("init abort (missing canvas/wrap)");
          return;
        }

        const rect = wrap.getBoundingClientRect();
        const w = Math.max(320, rect.width);
        const h = Math.max(320, rect.height);

        const renderer = new THREE.WebGLRenderer({ canvas: this.canvas, antialias: false, alpha: false, powerPreference: "high-performance" });
        renderer.setSize(w, h, false);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 1.35));
        renderer.outputColorSpace = THREE.SRGBColorSpace;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.08;

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050d12);
        scene.fog = new THREE.Fog(0x06151d, 22, 105);

        const pmremGenerator = new THREE.PMREMGenerator(renderer);
        scene.environment = pmremGenerator.fromScene(new RoomEnvironment(renderer), 0.04).texture;

        const camera = new THREE.PerspectiveCamera(32, w / h, 0.1, 200);
        camera.position.set(13, 23, 15);
        camera.lookAt(8, 7, 5);

        this._initialCamPos = camera.position.clone();
        this._initialCamTarget = new THREE.Vector3(5, 2, 3);
        this.camTarget.copy(this._initialCamTarget);
        this.camTargetDesired.copy(this._initialCamTarget);
        this.camPosDesired = camera.position.clone();

        // lights + grid
        scene.add(new THREE.AmbientLight(0xffffff, 0.05));
        const key = new THREE.DirectionalLight(0xeafcff, 0.85);
        key.position.set(16, 22, 14);
        scene.add(key);

        const rim = new THREE.DirectionalLight(0xffffcc, 2.6);
        rim.position.set(-12, 10, -18);
        scene.add(rim);

        const grid = new THREE.GridHelper(60, 60, 0x00e5ff, 0x00e5ff);
        grid.material.opacity = 0.13;
        grid.material.transparent = true;
        grid.position.y = 0.01;
        scene.add(grid);

        // ‚úÖ Orbit Controls
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.1; // Slightly sharper
        controls.maxDistance = 60;
        controls.minDistance = 2;
        controls.target.set(0, 0, 0); // ‚úÖ Fix pivot to center
        this.controls = controls;

        this.renderer = renderer;
        this.scene = scene;
        this.camera = camera;

        this.composer = this._setupFX(renderer, scene, camera, w, h);
        this._applyViewBias();

        // interactions
        wrap.addEventListener("pointermove", (e) => this._onPointerMove(e));
        wrap.addEventListener("pointerdown", (e) => this._onPointerDown(e));
        window.addEventListener("resize", () => this._onResize());

        // load GLB
        badge("Cargando GLB‚Ä¶");
        this._loadGLB(scene, this.glbUrl);

        const fxEl = document.getElementById("fxState");
        const rEl = document.getElementById("renderState");
        if (fxEl) fxEl.textContent = this.fxEnabled ? "ON" : "OFF";
        if (rEl) rEl.textContent = this.staticMode ? "STATIC" : "LOOP";

        this._inited = true;
        log("Init ok", { w, h, pixelRatio: renderer.getPixelRatio() });

        this._startLoop();
        this.requestRender();
      },

      requestRender() { this.needsRender = true; },

      _startLoop() {
        const loop = (t) => {
          if (this.stop) return;
          requestAnimationFrame(loop);

          if (!this.staticMode) {
            if ((t - this.lastFrame) < this.fpsCapMs) return;
            this.lastFrame = t;
            this.controls?.update(); // ‚úÖ
            this._render();
            return;
          }
          if (this.needsRender) {
            this.needsRender = false;
            this._render();
          }
        };
        requestAnimationFrame(loop);
      },

      _render() {
        if (!this.renderer || !this.scene || !this.camera) return;

        if (this.camLerpActive && this.camPosDesired) {
          this.camera.position.lerp(this.camPosDesired, this.camLerp);
          this.camTarget.lerp(this.camTargetDesired, this.camLerp);
          // this.camera.lookAt(this.camTarget); // ‚ùå Conflict with OrbitControls
          if (this.controls) this.controls.target.copy(this.camTarget); // ‚úÖ Synch controls

          const dp = this.camera.position.distanceTo(this.camPosDesired);
          const dt = this.camTarget.distanceTo(this.camTargetDesired);
          if (dp < 0.01 && dt < 0.01) this.camLerpActive = false;
          else this.needsRender = true;
        }
        // else {
        //   this.camera.lookAt(this.camTarget); // ‚ùå Conflict
        // }

        if (this.fxEnabled && this.composer) {
          if (this.composer.finalComposer) this.composer.finalComposer.render();
          else if (this.composer.composer) this.composer.composer.render();
          else this.renderer.render(this.scene, this.camera);
        } else {
          this.renderer.render(this.scene, this.camera);
        }
      },

      _setupFX(renderer, scene, camera, width, height) {
        // full composer (outline + bloom mix)
        const bloomComposer = new EffectComposer(renderer);
        bloomComposer.setSize(width, height);
        bloomComposer.renderToScreen = false;
        bloomComposer.addPass(new RenderPass(scene, camera));
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(width, height), 1.6, 0.5, 0.1);
        bloomComposer.addPass(bloomPass);

        const finalComposer = new EffectComposer(renderer);
        finalComposer.setSize(width, height);
        finalComposer.addPass(new RenderPass(scene, camera));

        const outlinePass = new OutlinePass(new THREE.Vector2(width, height), scene, camera);
        outlinePass.edgeStrength = 2.2;
        outlinePass.edgeGlow = 0.35;
        outlinePass.edgeThickness = 0.9;
        outlinePass.visibleEdgeColor.set(0xffb000);
        outlinePass.hiddenEdgeColor.set(0x00090c);
        finalComposer.addPass(outlinePass);

        const mixPass = new ShaderPass(ADDITIVE_BLOOM_SHADER);
        mixPass.material.uniforms["bloomTexture"].value = bloomComposer.renderTarget2.texture;
        finalComposer.addPass(mixPass);

        const fxaaPass = new ShaderPass(FXAAShader);
        fxaaPass.material.uniforms["resolution"].value.set(1 / width, 1 / height);
        finalComposer.addPass(fxaaPass);

        return { bloomComposer, finalComposer, outlinePass, bloomPass, mixPass, fxaaPass };
      },

      _applyViewBias() {
        if (!this.camera) return;
        const wrap = document.getElementById("map3dWrap");
        if (!wrap || typeof this.camera.setViewOffset !== "function") return;

        const r = wrap.getBoundingClientRect();
        const w = Math.max(320, Math.round(r.width));
        const h = Math.max(320, Math.round(r.height));
        const bx = Number.isFinite(this.viewBiasX) ? this.viewBiasX : 0;
        const by = Number.isFinite(this.viewBiasY) ? this.viewBiasY : 0;

        if (Math.abs(bx) < 0.5 && Math.abs(by) < 0.5) {
          this.camera.clearViewOffset();
          return;
        }
        this.camera.setViewOffset(w, h, Math.round(bx), Math.round(by), w, h);
      },

      setViewBias(x, y) {
        this.viewBiasX = Number(x) || 0;
        this.viewBiasY = Number(y) || 0;
        this._applyViewBias();
        this.requestRender();
        log("setViewBias", { x: this.viewBiasX, y: this.viewBiasY });
      },

      _loadGLB(scene, url) {
        const loader = new GLTFLoader();
        loader.load(url, (gltf) => {
          const model = gltf.scene;

          // normalize scale
          const box = new THREE.Box3().setFromObject(model);
          const size = new THREE.Vector3();
          box.getSize(size);
          const maxDim = Math.max(size.x || 1, size.y || 1, size.z || 1);
          const target = 22;
          const scale = target / maxDim;
          model.scale.setScalar(scale);

          // center
          const box2 = new THREE.Box3().setFromObject(model);
          const center = new THREE.Vector3();
          box2.getCenter(center);
          model.position.x += (0 - center.x);
          model.position.z += (0 - center.z);
          model.position.y += (0.02 - box2.min.y);

          scene.add(model);

          this.slots = new Map();
          model.traverse((obj) => {
            if (!obj?.isMesh) return;
            const raw = String(obj.name || "").trim();
            if (!isPickableSlotName(raw)) return;

            obj.userData = obj.userData || {};

            // ‚úÖ CRYSTAL / SCI-FI GLASS MATERIAL (High Gloss + Glow)
            const oldMat = obj.material;
            /* Refined Crystal Material: Elegant Nordic Glass */
            const crystalMat = new THREE.MeshPhysicalMaterial({
              color: 0xffffff,       // White surface

              // Emissive: Sophisticated deep cyan/slate, not neon.
              emissive: 0x063e45,
              emissiveIntensity: 1.8, // High intensity but darker color = rich glow

              transparent: true,
              opacity: 1.0,
              transmission: 1.0,

              thickness: 4.5,        // Slightly thicker for more refraction
              roughness: 0.08,       // Soft polish
              metalness: 0.15,       // Premium metallic hint
              ior: 1.6,

              // Attenuation: Deep ocean color
              attenuationColor: 0x2a5a60,
              attenuationDistance: 6.0,

              side: THREE.DoubleSide
            });

            obj.material = crystalMat;
            obj.userData.baseMaterial = crystalMat;

            obj.castShadow = true;
            obj.receiveShadow = true;
            this.slots.set(raw.toUpperCase(), obj);
          });

          badge("GLB cargado");
          log("Modelo GLB cargado", { url, slots: this.slots.size, sample: [...this.slots.keys()].slice(0, 12) });
          this.requestRender();
        }, undefined, (err) => {
          badge("GLB error (sin modelo)");
          log("Error cargando GLB", { url, err: String(err?.message || err) });
        });
      },

      resetView() {
        if (!this.camera) return;
        this.camera.position.copy(this._initialCamPos);
        this.camPosDesired = this._initialCamPos.clone();
        this.camTarget.copy(this._initialCamTarget);
        this.camTargetDesired.copy(this._initialCamTarget);
        this.camLerpActive = false;
        this.requestRender();
      },

      toggleFX() {
        this.fxEnabled = !this.fxEnabled;
        const fxEl = document.getElementById("fxState");
        if (fxEl) fxEl.textContent = this.fxEnabled ? "ON" : "OFF";
        this.requestRender();
      },

      toggleStatic() {
        this.staticMode = !this.staticMode;
        const rEl = document.getElementById("renderState");
        if (rEl) rEl.textContent = this.staticMode ? "STATIC" : "LOOP";
        this.requestRender();
      },

      focusCurrent() {
        if (this.current) this._focusOnMesh(this.current);
      },

      _focusOnMesh(mesh) {
        if (!mesh || !this.camera) return;
        const target = new THREE.Vector3();
        mesh.getWorldPosition(target);

        const currentTarget = this.camTarget.clone();
        const offset = this.camera.position.clone().sub(currentTarget);
        const dist = offset.length();
        const clamped = Math.max(8, Math.min(40, dist || 18));
        if (dist > 0.0001) offset.setLength(clamped);
        else offset.set(10, 16, 10);

        this.camTargetDesired.copy(target);
        this.camPosDesired = target.clone().add(offset);

        this.camLerpActive = true;
        this._applyViewBias();
        this.requestRender();
      },

      highlightUbi(ubiRaw) {
        const ubi = String(ubiRaw || "").trim().toUpperCase();
        if (!ubi) { badge("UBI vac√≠a"); return; }
        const mesh = this.slots.get(ubi);
        if (!mesh) { badge("UBI no existe: " + ubi); log("no slot", { ubi }); return; }

        // restore previous
        if (this.current && this.current !== mesh) {
          if (this.current.userData?.baseMaterial) this.current.material = this.current.userData.baseMaterial;
        }

        if (!mesh.userData.highlightMaterial) {
          const base = mesh.userData.baseMaterial || mesh.material;
          const m = base.clone();
          if (m.emissive) m.emissive = new THREE.Color(0xffb000);
          else m.emissive = new THREE.Color(0xffb000);
          m.emissiveIntensity = 6.0;
          m.transparent = true;
          m.opacity = 0.84;
          m.metalness = Math.max(m.metalness || 0, 0.3);
          m.roughness = Math.min(m.roughness || 0.6, 0.25);
          mesh.userData.highlightMaterial = m;
        }
        mesh.material = mesh.userData.highlightMaterial;
        this.current = mesh;

        const pickEl = document.getElementById("hudPick");
        if (pickEl) pickEl.textContent = ubi;

        if (this.composer?.outlinePass) this.composer.outlinePass.selectedObjects = [mesh];

        badge("Iluminado: " + ubi);
        log("highlightUbi", { ubi });
        this._focusOnMesh(mesh);
        this.requestRender();
      },

      async buscarPorReferencia(ref) {
        const el = document.getElementById("inRef"); // ‚úÖ necesario porque lo usas abajo

        const r = String(ref || el?.value || "").trim().toUpperCase();
        if (!r) { badge("Referencia vac√≠a"); return; }

        try {
          const sb = getSB(); // ‚úÖ usa cliente cacheado
          if (sb) {
            badge("Resolviendo UBI‚Ä¶");

            const { data, error } = await sb
              .from("relaciones")
              .select("ubi")
              .eq("referencia", r)
              .limit(1);

            if (error) throw error;

            const ubi = String(data?.[0]?.ubi || "").trim();

            // ‚úÖ feedback visual seguro (si existe el input)
            if (el) {
              el.style.opacity = (!ubi || ubi === "‚Äî") ? "0.65" : "1";
            }

            if (ubi && ubi !== "‚Äî") {
              this.highlightUbi(ubi);

              const t = document.getElementById("hudTarget");
              if (t) t.textContent = ubi;

              // si existe tu badge din√°mico por zona
              if (typeof updateHudUbiBadge === "function") {
                updateHudUbiBadge(ubi);
              }

              return;
            }
          }
        } catch (e) {
          log("buscarPorReferencia supabase error", { err: String(e?.message || e) });
        }

        badge("Sin UBI (ref)");
      },

      _getPointerNDC(e) {
        const wrap = document.getElementById("map3dWrap");
        if (!wrap) return null;
        const r = wrap.getBoundingClientRect();
        const x = ((e.clientX - r.left) / r.width) * 2 - 1;
        const y = -(((e.clientY - r.top) / r.height) * 2 - 1);
        return { x, y, r };
      },

      _pickSlot(e) {
        if (!this.camera) return null;
        const ndc = this._getPointerNDC(e);
        if (!ndc) return null;
        this.pointer.set(ndc.x, ndc.y);
        this.raycaster.setFromCamera(this.pointer, this.camera);
        const targets = this.slots?.size ? Array.from(this.slots.values()) : [];
        if (!targets.length) return null;
        const hits = this.raycaster.intersectObjects(targets, true);
        if (!hits?.length) return null;
        return hits[0].object;
      },

      _onPointerMove(e) {
        const tip = document.getElementById("map3dTip");
        if (!tip) return;
        const mesh = this._pickSlot(e);
        if (!mesh) { tip.classList.add("hidden"); return; }

        const wrap = document.getElementById("map3dWrap");
        if (!wrap) return;
        const rect = wrap.getBoundingClientRect();

        // Fix offset: map3dTip is absolute inside map3dWrap (relative)
        // so we must subtract the wrap's position from the client pointer.
        tip.style.left = (e.clientX - rect.left + 6) + "px";
        tip.style.top = (e.clientY - rect.top + 6) + "px";
        tip.innerHTML = `<div class="mt-1"><b style="color:rgba(255,176,0,.95)">${mesh.name}</b></div>`;
        tip.classList.remove("hidden");

        this.requestRender();
      },

      _onPointerDown(e) {
        const t = e.target;
        if (t && t.closest?.(".map3d-card")) return; // no clicks on UI
        const mesh = this._pickSlot(e);
        if (!mesh) { badge("Sin selecci√≥n"); return; }
        const ubi = String(mesh.name || "").trim().toUpperCase();
        if (ubi) this.highlightUbi(ubi);
      },

      _onResize() {
        const wrap = document.getElementById("map3dWrap");
        if (!wrap || !this.renderer || !this.camera) return;
        const r = wrap.getBoundingClientRect();
        const w = Math.max(320, r.width);
        const h = Math.max(320, r.height);

        this.renderer.setSize(w, h, false);
        this.camera.aspect = w / h;
        this.camera.updateProjectionMatrix();
        this._applyViewBias();

        if (this.composer) {
          if (this.composer.finalComposer) this.composer.finalComposer.setSize(w, h);
          if (this.composer.bloomComposer) this.composer.bloomComposer.setSize(w, h);
          if (this.composer.fxaaPass) this.composer.fxaaPass.material.uniforms["resolution"].value.set(1 / w, 1 / h);
          if (this.composer.outlinePass) this.composer.outlinePass.setSize(w, h);
        }
        this.requestRender();
      }
    };
  </script>
  <!-- ================= /MAPA3D (HUD) ================= -->


  <script>
    /* =========================================================
       MAP3D_MODULES (HUD)
       - Renderiza m√≥dulos laterales (Forecast hist/pro + Entregas + Lotes + Sol SVG)
       - HARDENED: evita que un ReferenceError deje MAP3D_MODULES en undefined
    ========================================================= */
    window.MAP3D_MODULES = window.MAP3D_MODULES || (function () {
      const TAG = "[MAP3D_MODULES]";
      const charts = window.__MAP3D_CHARTS || (window.__MAP3D_CHARTS = {});

      const log = (msg, obj) => {
        try { window.logx ? window.logx(TAG, msg, obj) : console.log(TAG, msg, obj || ""); }
        catch (_) { try { console.log(TAG, msg, obj || ""); } catch (__) { } }
      };

      const $ = (id) => document.getElementById(id);

      // ===============================
      // HUD: UBI badge (se usa tambi√©n desde MAP3D.buscarPorReferencia)
      // ===============================
      function updateHudUbiBadge(ubiRaw) {
        const el = $("hudUbiBadge");
        const t = $("hudTarget");
        if (!el || !t) return;

        const ubi = String(ubiRaw ?? t.textContent ?? "").trim();
        const zone = (ubi.match(/[A-Za-z]+/)?.[0] || "").toUpperCase();

        const theme = {
          E: { bg: "rgba(2,199,202,0.12)", bd: "rgba(2,199,202,0.35)", tx: "rgba(210,255,255,0.95)" },
          R: { bg: "rgba(204,163,0,0.12)", bd: "rgba(204,163,0,0.35)", tx: "rgba(255,245,205,0.95)" },
          I: { bg: "rgba(160,160,255,0.10)", bd: "rgba(160,160,255,0.35)", tx: "rgba(235,235,255,0.95)" },
          T: { bg: "rgba(255,255,255,0.06)", bd: "rgba(255,255,255,0.18)", tx: "rgba(255,255,255,0.92)" },
          DEFAULT: { bg: "rgba(255,255,255,0.06)", bd: "rgba(255,255,255,0.18)", tx: "rgba(255,255,255,0.92)" }
        };

        const c = theme[zone] || theme.DEFAULT;
        el.style.background = c.bg;
        el.style.borderColor = c.bd;
        el.style.color = c.tx;
      }

      // ‚úÖ IMPORTANTE: hazla global porque MAP3D.buscarPorReferencia() la llama.
      // (si no es global, truena con ReferenceError y te rompe el flujo)
      window.updateHudUbiBadge = window.updateHudUbiBadge || updateHudUbiBadge;

      function setMeta(id, text) {
        const el = $(id);
        if (el) el.textContent = text ?? "‚Äî";
      }

      function destroyChart(id) {
        try { if (charts[id]) { charts[id].destroy(); delete charts[id]; } } catch (_) { }
      }

      function ensureCanvasSize(cv) {
        if (!cv) return;
        const r = cv.getBoundingClientRect();
        const w = Math.max(260, Math.round(r.width || 0));
        const h = Math.max(120, Math.round(r.height || 0));
        if (cv.width !== w) cv.width = w;
        if (cv.height !== h) cv.height = h;
      }

      // Mant√©n un registro independiente por canvas para evitar charts ‚Äúfantasma‚Äù
      window.__HUD_CHARTS = window.__HUD_CHARTS || {};

      function renderLineChart(canvasId, labels, values, metaId) {
        try {
          const cv = $(canvasId);
          if (!cv) throw new Error(`No existe #${canvasId}`);

          ensureCanvasSize(cv);

          if (!window.Chart) {
            // Fallback sin Chart.js
            const ctx = cv.getContext("2d");
            if (ctx) {
              ctx.clearRect(0, 0, cv.width, cv.height);
              ctx.fillStyle = "rgba(255,255,255,.70)";
              ctx.font = "12px ui-monospace, Menlo, Monaco, Consolas, monospace";
              ctx.fillText("Chart.js no disponible", 14, 22);
            }
            if (metaId) setMeta(metaId, "Chart.js no disponible");
            return;
          }

          const Chart = window.Chart;
          const L = (labels || []).map(x => String(x));
          const V = (values || []).map(x => Number(x) || 0);
          const n = Math.min(L.length, V.length);
          const labelsN = L.slice(0, n);
          const valuesN = V.slice(0, n);

          if (window.__HUD_CHARTS[canvasId]) {
            try { window.__HUD_CHARTS[canvasId].destroy(); } catch (_) { }
            window.__HUD_CHARTS[canvasId] = null;
          }

          const ctx = cv.getContext("2d");
          if (!ctx) throw new Error("No hay 2D context");

          const maxV = valuesN.reduce((m, x) => Math.max(m, x), 0);

          const ch = new Chart(ctx, {
            type: "line",
            data: {
              labels: labelsN,
              datasets: [{
                label: "",
                data: valuesN,
                tension: 0.35,
                pointRadius: 0,
                borderWidth: 2,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              animation: false,
              plugins: { legend: { display: false } },
              scales: {
                x: { ticks: { maxTicksLimit: 6 } },
                y: { beginAtZero: true, suggestedMax: maxV > 0 ? maxV * 1.15 : 10 }
              }
            }
          });

          window.__HUD_CHARTS[canvasId] = ch;
          if (metaId) setMeta(metaId, `OK ‚Ä¢ n=${n} ‚Ä¢ max=${Math.round(maxV)}`);

          log("Chart OK", { canvasId, n, maxV });
        } catch (err) {
          log("Chart FAIL", { canvasId, err: String(err?.message || err) });
          if (metaId) setMeta(metaId, "Error render chart");
        }
      }

      function renderPieFallback(canvasId, lotes) {
        const cv = $(canvasId);
        if (!cv) return;
        ensureCanvasSize(cv);

        if (!window.Chart) {
          const ctx = cv.getContext("2d");
          if (ctx) {
            ctx.clearRect(0, 0, cv.width, cv.height);
            ctx.fillStyle = "rgba(255,255,255,.70)";
            ctx.font = "12px ui-monospace, Menlo, Monaco, Consolas, monospace";
            ctx.fillText(`Lotes: ${(lotes || []).length}`, 14, 22);
          }
          return;
        }

        const Chart = window.Chart;
        destroyChart(canvasId);

        const ctx = cv.getContext("2d");
        const rows = Array.isArray(lotes) ? lotes : [];
        const labels = rows.map(r => String(r.lote || "‚Äî"));
        const data = rows.map(r => Number(r.cantidad || 0));

        charts[canvasId] = new Chart(ctx, {
          type: "doughnut",
          data: { labels, datasets: [{ data, borderWidth: 0 }] },
          options: { responsive: false, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
      }

      function pickSeries(obj) {
        if (!obj) return null;

        // Nuevo: series con hist_labels/hist_values o fc_labels/fc_values
        if (obj.hist_labels && obj.hist_values) return { labels: obj.hist_labels, values: obj.hist_values };
        if (obj.fc_labels && obj.fc_values) return { labels: obj.fc_labels, values: obj.fc_values };

        const candidates = [
          ["labels", "values"],
          ["labels", "data"],
          ["x", "y"],
          ["x", "values"],
          ["dates", "values"],
          ["fechas", "valores"],
          ["meses", "consumo"],
          ["meses", "valores"],
          ["t", "y"],
        ];

        for (const [lk, vk] of candidates) {
          const labels = obj[lk];
          const values = obj[vk];
          if (Array.isArray(labels) && Array.isArray(values) && labels.length && values.length) {
            return { labels, values };
          }
        }

        if (Array.isArray(obj) && obj.length) {
          const first = obj[0] || {};
          if (typeof first === "object") {
            const getL = (p) => p.label ?? p.x ?? p.date ?? p.fecha ?? p.mes ?? p.t;
            const getV = (p) => p.value ?? p.y ?? p.v ?? p.consumo ?? p.cantidad;
            const labels = obj.map(getL);
            const values = obj.map(getV).map(n => Number(n) || 0);
            if (labels.some(x => x != null)) return { labels, values };
          }
        }

        return null;
      }

      async function fetchPro(ref) {
        if (typeof window.fetchForecastProData === "function") {
          return await window.fetchForecastProData(ref, {
            unidad: "TOTAL",
            horizon: Number(window.FORECAST_DEFAULT_HORIZON ?? 6),
            modelo: "auto",
            merma_pct: Number(window.FORECAST_DEFAULT_MERMA_PCT ?? 5),
            factor_vol_pct: 0
          });
        }

        const base = (window.SUPABASE_URL || "https://ldjrpfsbpcfninntffoj.supabase.co");
        const url = `${base}/functions/v1/forecast_producto?ref=${encodeURIComponent(ref)}&unidad=TOTAL&horizon=6&modelo=auto&merma_pct=5&factor_vol_pct=0`;
        const r = await fetch(url);
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return await r.json();
      }

      function renderEntregasSimple(containerId, entregas) {
        const wrap = $(containerId);
        if (!wrap) return;

        const rows = Array.isArray(entregas) ? entregas : [];
        if (!rows.length) {
          wrap.innerHTML = `<div class="text-white/60 text-sm">Sin entregas (backend no envi√≥).</div>`;
          return;
        }

        wrap.innerHTML = `
      <div class="rounded-2xl border border-white/10 overflow-hidden">
        <table class="w-full text-[11px] text-left">
          <thead class="bg-black/30 text-white/90">
            <tr>
              <th class="p-2">Fecha</th>
              <th class="p-2 text-right">Cant.</th>
              <th class="p-2 text-right">Merma</th>
            </tr>
          </thead>
          <tbody class="bg-white/5 text-white/85">
            ${rows.slice(0, 10).map(r => {
          const f = String(r.fecha ?? r.date ?? r.mes ?? "‚Äî");
          const c = Number(r.cantidad ?? r.qty ?? r.entrega ?? 0);
          const m = Number(r.merma ?? r.merma_cant ?? 0);
          return `
                <tr class="border-t border-white/10">
                  <td class="p-2 mono">${f}</td>
                  <td class="p-2 text-right mono">${isFinite(c) ? Math.round(c) : "‚Äî"}</td>
                  <td class="p-2 text-right mono">${isFinite(m) ? Math.round(m) : "‚Äî"}</td>
                </tr>
              `;
        }).join("")}
          </tbody>
        </table>
      </div>
    `;
      }

      // ===============================
      // FORECAST (HUD)
      // ===============================
      async function renderForecast(ref) {
        const refClean = String(ref || "").trim();
        if (!refClean) {
          renderLineChart("graficaForecastHUD", ["‚Äî"], [0], "graficaForecastHUDMeta");
          renderLineChart("graficaForecastProHUD", ["‚Äî"], [0], "graficaForecastProHUDMeta");
          const wrap = $("tablaEntregasForecastHUD");
          if (wrap) wrap.innerHTML = `<div class="text-white/60 text-sm">Sin referencia.</div>`;
          return;
        }

        setMeta("graficaForecastHUDMeta", "Cargando‚Ä¶");
        setMeta("graficaForecastProHUDMeta", "Cargando‚Ä¶");
        const entregasWrap = $("tablaEntregasForecastHUD");
        if (entregasWrap) entregasWrap.innerHTML = `<div class="text-white/60 text-sm">Cargando‚Ä¶</div>`;

        try {
          const data = await fetchPro(refClean);

          // HIST
          const series = data?.pro?.series || null;
          const hist =
            pickSeries(series ? { hist_labels: series.hist_labels, hist_values: series.hist_values } : null) ||
            pickSeries(data?.hist) ||
            pickSeries(data?.series?.hist) ||
            pickSeries(data?.series) ||
            pickSeries(data?.pro?.hist) ||
            pickSeries(data?.pro) ||
            null;

          if (hist) renderLineChart("graficaForecastHUD", hist.labels, hist.values, "graficaForecastHUDMeta");
          else {
            renderLineChart("graficaForecastHUD", ["‚Äî"], [0], "graficaForecastHUDMeta");
            setMeta("graficaForecastHUDMeta", "Sin serie hist√≥rica (no encontrada en respuesta).");
          }

          // ENTREGAS
          const entregas = data?.pro?.entregas || data?.entregas || data?.pro?.plan_entrega || [];
          renderEntregasSimple("tablaEntregasForecastHUD", entregas);

          // PRO
          const proSeriesObj = data?.pro?.series || data?.series || null;

          if (
            proSeriesObj?.fc_labels?.length &&
            (proSeriesObj?.p50?.length || proSeriesObj?.p10?.length || proSeriesObj?.p90?.length)
          ) {
            // ‚úÖ Si existe tu renderer PRO, √∫salo; si no, fallback a p50
            if (typeof window.renderGraficaForecastPro === "function") {
              window.renderGraficaForecastPro(proSeriesObj, "graficaForecastProHUD");
              setMeta("graficaForecastProHUDMeta", "OK ‚Ä¢ PRO (p10‚Äìp50‚Äìp90)");
            } else {
              const labels = proSeriesObj.fc_labels;
              const p50 = proSeriesObj.p50 || proSeriesObj.p10 || proSeriesObj.p90 || [];
              renderLineChart("graficaForecastProHUD", labels, p50, "graficaForecastProHUDMeta");
              setMeta("graficaForecastProHUDMeta", "PRO sin renderer; mostrando p50 fallback.");
            }
          } else {
            // Fallback: entregas como serie simple
            if (Array.isArray(entregas) && entregas.length) {
              const labels = [];
              const values = [];
              for (let i = 0; i < entregas.length; i++) {
                const e = entregas[i] || {};
                const lab = String(e.mes ?? e.fecha ?? e.periodo ?? e.label ?? e.timestamp ?? `T+${i + 1}`);
                const vRaw = e.cantidad ?? e.cantidad_sugerida ?? e.entrega_sugerida ?? e.entrega ?? e.unidades ?? e.qty ?? e.valor ?? e.sugerida ?? e.suggested ?? e.plan ?? 0;
                const v = Number(vRaw);
                labels.push(lab);
                values.push(Number.isFinite(v) ? v : 0);
              }
              renderLineChart("graficaForecastProHUD", labels, values, "graficaForecastProHUDMeta");
              setMeta("graficaForecastProHUDMeta", "Serie PRO no disponible; mostrando entregas como fallback.");
            } else {
              renderLineChart("graficaForecastProHUD", ["‚Äî"], [0], "graficaForecastProHUDMeta");
              setMeta("graficaForecastProHUDMeta", "Sin serie PRO y sin entregas.");
            }
          }

          log("Forecast HUD OK", { ref: refClean, hasHist: !!hist, entregas: (entregas || []).length });
        } catch (err) {
          log("Forecast HUD FAIL", { ref: refClean, err: String(err?.message || err) });
          setMeta("graficaForecastHUDMeta", "Error");
          setMeta("graficaForecastProHUDMeta", "Error");
          const wrap = $("tablaEntregasForecastHUD");
          if (wrap) wrap.innerHTML = `<div class="text-rose-200 text-sm">Error cargando forecast.</div>`;
        }
      }

      // ===============================
      // LOTES (HUD)
      // ===============================
      async function renderLotes(ref) {
        const refClean = String(ref || "").trim();
        const wrap = $("uiTablaLotesHUD");
        if (wrap) wrap.innerHTML = `<div class="text-white/60 text-sm">Cargando lotes‚Ä¶</div>`;

        try {
          const SB_KEY = window.API_KEY || window.SUPABASE_ANON_KEY;
          const base = (window.SUPABASE_URL || "https://ldjrpfsbpcfninntffoj.supabase.co");
          const url = `${base}/rest/v1/productos?select=referencia,lote,caducidad,cantidad&referencia=eq.${encodeURIComponent(refClean)}`;
          const r = await fetch(url, { headers: { apikey: SB_KEY, Authorization: `Bearer ${SB_KEY}` } });
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          const rows = await r.json();

          if (!Array.isArray(rows) || !rows.length) {
            if (wrap) wrap.innerHTML = `<div class="text-white/60 text-sm">Sin lotes.</div>`;
            renderPieFallback("graficaLotesPieHUD", []);
            return;
          }

          if (wrap) {
            wrap.innerHTML = `
          <div class="rounded-2xl border border-white/10 overflow-hidden">
            <table class="w-full text-[11px] text-left">
              <thead class="bg-black/30 text-white/90">
                <tr>
                  <th class="p-2">Lote</th>
                  <th class="p-2 text-right">Cant.</th>
                  <th class="p-2">Cad.</th>
                </tr>
              </thead>
              <tbody class="bg-white/5 text-white/85">
                ${rows.slice(0, 8).map(l => `
                  <tr class="border-t border-white/10">
                    <td class="p-2 mono">${String(l.lote || "‚Äî")}</td>
                    <td class="p-2 text-right mono">${Number(l.cantidad || 0)}</td>
                    <td class="p-2 mono">${String(l.caducidad || "S/C")}</td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          </div>
        `;
          }

          renderPieFallback("graficaLotesPieHUD", rows);
          log("Lotes HUD OK", { ref: refClean, n: rows.length });
        } catch (err) {
          log("Lotes HUD FAIL", { ref: refClean, err: String(err?.message || err) });
          if (wrap) wrap.innerHTML = `<div class="text-rose-200 text-sm">Error cargando lotes.</div>`;
          renderPieFallback("graficaLotesPieHUD", []);
        }
      }

      // ===============================
      // ‚òÄÔ∏è SOL REACTIVO HUD (SVG)
      // ===============================
      function solLog(...a) { try { console.log("[SOL_HUD]", ...a); } catch { } }
      function solWarn(...a) { try { console.warn("[SOL_HUD]", ...a); } catch { } }
      function solErr(...a) { try { console.error("[SOL_HUD]", ...a); } catch { } }
      function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }
      function toNum(v) { const n = Number(v); return Number.isFinite(n) ? n : 0; }
      function mean(arr) { return arr?.length ? arr.reduce((s, x) => s + x, 0) / arr.length : 0; }

      function clearSvg(svg) { while (svg.firstChild) svg.removeChild(svg.firstChild); }

      function ensureSolSvgBase(svg) {
        if (!svg.getAttribute("viewBox")) svg.setAttribute("viewBox", "0 0 420 420");
        svg.setAttribute("preserveAspectRatio", "xMidYMid meet");
      }

      function createSvgEl(tag, attrs = {}) {
        const el = document.createElementNS("http://www.w3.org/2000/svg", tag);
        for (const [k, v] of Object.entries(attrs)) el.setAttribute(k, String(v));
        return el;
      }

      function renderSolEmpty(ref) {
        const svg = $("solReactivoHUD");
        if (!svg) return;
        clearSvg(svg);
        ensureSolSvgBase(svg);

        const t = createSvgEl("text", {
          x: "210", y: "210",
          "text-anchor": "middle",
          "font-size": "12",
          fill: "rgba(255,255,255,.65)"
        });
        t.textContent = ref ? "Sol: sin datos para graficar" : "Sin referencia";
        svg.appendChild(t);

        const meta = $("uiSolInvMetaHUD");
        if (meta) meta.textContent = "‚Äî";
      }

      function buildSolHud(svg, payload) {
        const cx = 210, cy = 210;
        const innerR = 52;
        const baseR = 86;
        const maxRay = 112;
        const rayW = 5.2;

        const labels = payload.labels || [];
        const values = (payload.values || []).map(toNum);
        const infoByLabel = payload.infoByLabel || {};
        const vMax = 100;
        const vMean = mean(values) || 0;

        clearSvg(svg);
        ensureSolSvgBase(svg);

        // üî• Clave para que el blur no se ‚Äúrecorte‚Äù
        try { svg.style.overflow = "visible"; } catch (_) { }
        svg.setAttribute("overflow", "visible");

        // =========================
        // DEFS (gradientes + glow blur real)
        // =========================
        const defs = createSvgEl("defs");

        // Core gradient
        const coreGrad = createSvgEl("radialGradient", { id: "solCoreGrad", cx: "50%", cy: "50%", r: "55%" });
        coreGrad.appendChild(createSvgEl("stop", { offset: "0%", "stop-color": "#ffffff", "stop-opacity": "0.85" }));
        coreGrad.appendChild(createSvgEl("stop", { offset: "55%", "stop-color": "rgb(2,199,202)", "stop-opacity": "0.35" }));
        coreGrad.appendChild(createSvgEl("stop", { offset: "100%", "stop-color": "#000000", "stop-opacity": "0" }));
        defs.appendChild(coreGrad);

        // ‚úÖ Glow Blur REAL (no ‚Äúdoble trazo‚Äù)
        // Nota: regi√≥n enorme para que no se corte el blur
        function makeSoftGlowFilter(id, stdDev, brightness = 1.25) {
          const f = createSvgEl("filter", {
            id,
            filterUnits: "userSpaceOnUse",
            x: "-200",
            y: "-200",
            width: "800",
            height: "800"
          });

          const blur = createSvgEl("feGaussianBlur", {
            in: "SourceGraphic",
            stdDeviation: String(stdDev),
            result: "b"
          });
          f.appendChild(blur);

          // ‚ÄúSube‚Äù el brillo del blur para que se note m√°s
          const cm = createSvgEl("feColorMatrix", {
            in: "b",
            type: "matrix",
            values: `${brightness} 0 0 0 0
               0 ${brightness} 0 0 0
               0 0 ${brightness} 0 0
               0 0 0 1 0`,
            result: "bb"
          });
          f.appendChild(cm);

          // const merge = createSvgEl("feMerge");
          // merge.appendChild(createSvgEl("feMergeNode", { in: "bb" }));
          // merge.appendChild(createSvgEl("feMergeNode", { in: "SourceGraphic" }));
          // f.appendChild(merge);

          defs.appendChild(f);
        }

        // üî• Valores altos = blur grande y visible
        makeSoftGlowFilter("solSoftGlowOk", 4.6, 1.45);
        makeSoftGlowFilter("solSoftGlowWarn", 5.4, 1.65);
        makeSoftGlowFilter("solSoftGlowCrit", 6.4, 1.95);

        svg.appendChild(defs);

        // Fondo
        svg.appendChild(createSvgEl("circle", {
          cx, cy, r: 160,
          fill: "rgba(2,199,202,0.04)",
          stroke: "rgba(255,255,255,0.06)",
          "stroke-width": "1"
        }));

        // Anillos
        const r25 = baseR + maxRay * 0.25;
        const r50 = baseR + maxRay * 0.50;
        const r75 = baseR + maxRay * 0.75;
        const r100 = baseR + maxRay * 1.00;

        [
          { r: r25, stroke: "rgba(255,255,255,0.10)", sw: "1", dash: "3 8" },
          { r: r50, stroke: "rgba(255,255,255,0.12)", sw: "1", dash: "3 8" },
          { r: r75, stroke: "rgba(255,255,255,0.13)", sw: "1", dash: "2 6" },
          { r: r100, stroke: "rgba(2,199,202,0.23)", sw: "1.2", dash: "2 6" }
        ].forEach((cfg) => {
          svg.appendChild(createSvgEl("circle", {
            cx, cy, r: cfg.r,
            fill: "none",
            stroke: cfg.stroke,
            "stroke-width": cfg.sw,
            "stroke-dasharray": cfg.dash
          }));
        });

        // =========================
        // RAYOS
        // =========================
        const gRays = createSvgEl("g", { id: "solRays" });
        const N = Math.min(labels.length, values.length);
        const meta = $("uiSolInvMetaHUD");

        // Color A: Abastecimiento (para el n√∫cleo s√≥lido)
        function getColSupply(pct) {
          if (pct < 35) return "rgb(196,4,46)";   // Rojo (0-34%)
          if (pct < 75) return "rgb(219,195,13)"; // Amarillo (35-74%)
          return "rgb(22,201,165)";               // Verde (75-100%)
        }

        // Color B: Caducidad (para el glow externo)
        function getColExpiration(dias) {
          if (dias <= 30) return "rgb(196,4,46)";   // Rojo
          if (dias <= 60) return "rgb(219,195,13)"; // Amarillo
          return "rgb(22,201,165)";                 // Verde
        }

        function glowFilterForDays(dias) {
          if (dias <= 30) return "url(#solSoftGlowCrit)";
          if (dias <= 60) return "url(#solSoftGlowWarn)";
          return "url(#solSoftGlowOk)";
        }

        if (!N) {
          solWarn("Sin datos N=0");
          svg.appendChild(gRays);
        } else {
          for (let i = 0; i < N; i++) {
            const val = clamp(toNum(values[i]), 0, 140);
            const pct = val; // Mantener largo basado en pct (abastecimiento)

            const t = clamp(val / vMax, 0, 1.0);
            const ang = (-90 + (i * 360 / N)) * Math.PI / 180;
            const len = maxRay * t;

            const r0 = baseR;
            const r1 = baseR + len;

            const x0 = cx + Math.cos(ang) * r0;
            const y0 = cy + Math.sin(ang) * r0;
            const x1 = cx + Math.cos(ang) * r1;
            const y1 = cy + Math.sin(ang) * r1;

            const info = infoByLabel[labels[i]] || {};
            // Usar minDays para el color del GLOW
            const dias = (typeof info.minDays === "number") ? info.minDays : 9999;

            const colCore = getColSupply(pct);
            const colGlow = getColExpiration(dias);

            // Glow layer: color basado en CADUCIDAD
            const glowW = (rayW + (t * 23.4));
            const glowOp = 0.80;

            const glow = createSvgEl("line", {
              x1: x0.toFixed(2),
              y1: y0.toFixed(2),
              x2: x1.toFixed(2),
              y2: y1.toFixed(2),
              stroke: colGlow, // üëà Color Caducidad
              "stroke-width": String(glowW),
              "stroke-linecap": "round",
              "stroke-opacity": String(glowOp),
              "pointer-events": "none",
              filter: glowFilterForDays(dias)
            });

            // Core layer: color basado en ABASTECIMIENTOS
            const coreW = (rayW + (t * 3.4));
            const coreOp = (pct < 60) ? 0.98 : (pct < 90) ? 0.95 : 0.92;

            const line = createSvgEl("line", {
              x1: x0.toFixed(2),
              y1: y0.toFixed(2),
              x2: x1.toFixed(2),
              y2: y1.toFixed(2),
              stroke: colCore, // üëà Color Supply
              "stroke-width": String(coreW),
              "stroke-linecap": "round",
              "stroke-opacity": String(coreOp),
              "pointer-events": "stroke",
              "data-label": String(labels[i]),
              "data-pct": String(Math.round(pct)),
              "data-inv": info.inv != null ? String(info.inv) : "",
              "data-dot": info.dot != null ? String(info.dot) : "",
              "data-col": info.col != null ? String(info.col) : ""
            });

            gRays.appendChild(glow);
            gRays.appendChild(line);
          }

          svg.appendChild(gRays);
          solLog("Rays painted", { N, sample: labels.slice(0, 6), values: values.slice(0, 6) });
        }

        // =========================
        // CORE
        // =========================
        svg.appendChild(createSvgEl("circle", {
          cx, cy, r: innerR,
          fill: "rgba(0,0,0,0.25)",
          stroke: "rgba(255,255,255,0.12)",
          "stroke-width": "1.2"
        }));

        svg.appendChild(createSvgEl("circle", {
          cx, cy, r: innerR + 18,
          fill: "url(#solCoreGrad)"
        }));

        const tTitle = createSvgEl("text", {
          x: cx, y: cy - 6,
          "text-anchor": "middle",
          "font-size": "12",
          fill: "rgba(255,255,255,0.72)",
          "font-weight": "700"
        });
        tTitle.textContent = "SOL";
        svg.appendChild(tTitle);

        const tVal = createSvgEl("text", {
          x: cx, y: cy + 14,
          "text-anchor": "middle",
          "font-size": "20",
          fill: "rgba(255,255,255,0.94)",
          "font-weight": "900"
        });
        tVal.textContent = `${Math.round(vMean)}%`;
        svg.appendChild(tVal);

        const tSub = createSvgEl("text", {
          x: cx, y: cy + 32,
          "text-anchor": "middle",
          "font-size": "10",
          fill: "rgba(255,255,255,0.55)"
        });
        tSub.textContent = "promedio";
        svg.appendChild(tSub);

        // =========================
        // INTERACCIONES (igual que antes)
        // =========================
        svg.onpointermove = null;
        svg.onpointerleave = null;
        svg.onclick = null;

        const tip = document.getElementById("solReactivoTooltipHUD");
        const tipTitle = document.getElementById("solReactivoTipTitleHUD");
        const tipSub = document.getElementById("solReactivoTipSubHUD");

        function showTooltip(e, target) {
          if (!tip || !tipTitle || !tipSub) return;
          const lab = target.getAttribute("data-label");
          const pct = target.getAttribute("data-pct");
          const inv = target.getAttribute("data-inv");
          const dot = target.getAttribute("data-dot");
          const col = target.getAttribute("data-col");

          let subStr = "";
          if (inv && dot) subStr += `inv ${inv} / dot ${dot}`;
          else if (inv) subStr += `inv ${inv}`;
          else if (dot) subStr += `dot ${dot}`;
          if (col) subStr += (subStr ? " ‚Ä¢ " : "") + `corte ${col}`;

          tipTitle.textContent = (lab && pct) ? `${lab} ‚Ä¢ ${pct}%` : (lab || "");
          tipSub.textContent = subStr || "";
          tip.classList.remove("hidden");

          const wrap = svg.closest(".rounded-2xl");
          const svgRect = svg.getBoundingClientRect();
          const wrapRect = wrap ? wrap.getBoundingClientRect() : svgRect;

          let x = e.clientX - wrapRect.left;
          let y = e.clientY - wrapRect.top;
          x = clamp(x, 2, (wrapRect.width || 420) - 2 - 180);
          y = clamp(y, 2, (wrapRect.height || 320) - 2 - 60);
          tip.style.left = x + "px";
          tip.style.top = y + "px";
        }

        function hideTooltip() {
          if (tip) tip.classList.add("hidden");
        }

        svg.onpointermove = (e) => {
          const target = e.target;
          if (!(target && target.tagName === "line" && target.getAttribute("data-label"))) {
            if (meta) meta.textContent = "‚Äî";
            hideTooltip();
            return;
          }
          const lab = target.getAttribute("data-label");
          const pct = target.getAttribute("data-pct");
          const inv = target.getAttribute("data-inv");
          const dot = target.getAttribute("data-dot");
          const col = target.getAttribute("data-col");

          let metaStr = "";
          if (lab) metaStr += lab;
          if (pct) metaStr += (metaStr ? " ‚Ä¢ " : "") + `${pct}%`;
          if (inv) metaStr += (metaStr ? " ‚Ä¢ " : "") + `inv ${inv}`;
          if (dot) metaStr += (inv ? " / " : " ‚Ä¢ ") + `dot ${dot}`;
          if (col) metaStr += (metaStr ? " ‚Ä¢ " : "") + col;

          if (meta) meta.textContent = metaStr || "‚Äî";
          showTooltip(e, target);
        };

        svg.onpointerleave = () => {
          if (meta) meta.textContent = "‚Äî";
          hideTooltip();
        };

        svg.onclick = (e) => {
          const target = e.target;
          if (!(target && target.tagName === "line" && target.getAttribute("data-label"))) return;

          const lab = target.getAttribute("data-label");
          const pct = target.getAttribute("data-pct");
          window.__SOL_REACTIVO_LAST_UNIT = lab;

          if (typeof window.SOL_REACTIVO_UNIDAD_OPEN === "function") {
            window.SOL_REACTIVO_UNIDAD_OPEN({
              unidad: lab,
              referencia: (payload.ref || ""),
              pct: pct,
              info: infoByLabel[lab]
            });
          }
          solLog("Ray click", { unidad: lab, pct });
        };
      }

      // ========= NUEVO: SOL_REACTIVO_REAL ==========
      window.SOL_REACTIVO_REAL = window.SOL_REACTIVO_REAL || (function () {
        const base = (window.SUPABASE_URL || "https://ldjrpfsbpcfninntffoj.supabase.co");
        function getSbHeaders() {
          const k = window.API_KEY || window.SUPABASE_ANON_KEY;
          return { apikey: k, Authorization: `Bearer ${k}` };
        }
        function colKeysDescending(maxKeys = 120) {
          // Alterna cortes 25_<m>_<y> y 10_<m>_<y> hacia atr√°s desde hoy
          const keys = [];
          const now = new Date();
          let year = now.getFullYear();
          let month = now.getMonth() + 1;
          let day = now.getDate();
          let corte;
          if (day >= 25) corte = 25;
          else corte = 10;
          for (let i = 0; i < maxKeys; ++i) {
            keys.push(`${corte}_${month}_${year}`);
            if (corte === 25) {
              corte = 10;
            } else {
              corte = 25;
              month -= 1;
              if (month <= 0) { month = 12; year -= 1; }
            }
          }
          return keys;
        }
        function pickLatestValue(row, colKeys) {
          for (const col of colKeys) {
            if (row[col] != null && isFinite(row[col]) && Number(row[col]) >= 0) {
              return { col, value: Number(row[col]) };
            }
          }
          return null;
        }
        async function fetchDotacionesByRef(ref) {
          const k = window.API_KEY || window.SUPABASE_ANON_KEY;
          const url = `${base}/rest/v1/dotaciones?select=unidad,referencia,cantidad,producto&referencia=eq.${encodeURIComponent(ref)}`;
          const r = await fetch(url, { headers: getSbHeaders() });
          if (!r.ok) throw new Error(`Dotaciones HTTP ${r.status}`);
          return await r.json();
        }
        async function fetchConsumosMensualesByRef(ref) {
          const k = window.API_KEY || window.SUPABASE_ANON_KEY;
          const url = `${base}/rest/v1/consumos_mensuales?select=*&referencia=eq.${encodeURIComponent(ref)}`;
          const r = await fetch(url, { headers: getSbHeaders() });
          if (!r.ok) throw new Error(`Consumos HTTP ${r.status}`);
          return await r.json();
        }
        async function fetchLotesByRef(ref) {
          const k = window.API_KEY || window.SUPABASE_ANON_KEY;
          // Ajusta las columnas seg√∫n tu tabla "productos". Asumimos: referencia, lote, caducidad, cantidad, ubi (o unidad)
          const url = `${base}/rest/v1/productos?select=referencia,lote,caducidad,cantidad,ubi,ubicacion&referencia=eq.${encodeURIComponent(ref)}`;
          const r = await fetch(url, { headers: getSbHeaders() });
          if (!r.ok) throw new Error(`Productos/Lotes HTTP ${r.status}`);
          return await r.json();
        }
        async function computeAbastecimiento(ref) {
          // Carga dotaciones, consumos Y lotes (para caducidad)
          const [dots, consRows, lotesRows] = await Promise.all([
            fetchDotacionesByRef(ref),
            fetchConsumosMensualesByRef(ref),
            fetchLotesByRef(ref).catch(e => { console.warn("Lotes fetch err", e); return []; })
          ]);
          const colKeys = colKeysDescending();
          // Map unidad -> dot, inv, col, producto
          const dotByUnidad = {};
          for (const d of dots) {
            const uni = String(d.unidad || "").trim();
            if (!uni) continue;
            dotByUnidad[uni] = { dot: toNum(d.cantidad), producto: d.producto };
          }
          const infoByLabel = {};
          const units = new Set();

          // 1) Consumo/Inv Real (CSV mensual)
          for (const row of consRows) {
            const uni = String(row.unidad || row.unidad_medica || "").trim();
            if (!uni) continue;
            const pick = pickLatestValue(row, colKeys);
            if (!infoByLabel[uni]) infoByLabel[uni] = { unidad: uni, minDays: Infinity };
            if (pick) {
              infoByLabel[uni].inv = pick.value;
              infoByLabel[uni].col = pick.col;
            }
            units.add(uni);
          }

          // 2) Dotaciones
          for (const uni in dotByUnidad) {
            if (!infoByLabel[uni]) infoByLabel[uni] = { unidad: uni, minDays: Infinity };
            infoByLabel[uni].dot = dotByUnidad[uni].dot;
            infoByLabel[uni].producto = dotByUnidad[uni].producto;
            units.add(uni);
          }

          // 3) Lotes (Caducidad)
          for (const l of lotesRows) {
            // Normalizar unidad: ubi o ubicacion
            const uRaw = l.ubi || l.ubicacion || "";
            // Intenta matchear con las units del set (que vienen de dot/consumo)
            // Ojo: la tabla 'productos' puede tener nombres de ubi distintos o "almacen".
            // Hacemos un match simple: si la ubi contiene la string de la unidad (o al rev√©s)
            // O asume igualdad exacta tras trim/upper.
            let targetUni = null;
            const uClean = String(uRaw).trim();

            // Estrategia simple: igualdad exacta o contenencia si units tiene pocas
            if (units.has(uClean)) {
              targetUni = uClean;
            } else {
              // Si no match directo, intenta buscar si alguna unit conocida "es" esta ubi
              // (esto puede ser fr√°gil, pero para HUD suele coincidir "HG ...")
              // Si no encuentra, a√±ade la unit nueva (si tiene stock y es relevante)
              if (toNum(l.cantidad) > 0) {
                targetUni = uClean;
                units.add(uClean);
              }
            }

            if (targetUni) {
              if (!infoByLabel[targetUni]) infoByLabel[targetUni] = { unidad: targetUni, minDays: Infinity };
              // Calc dias
              if (toNum(l.cantidad) > 0) {
                const dias = calcularDiasRestantes(l.caducidad);
                if (dias < infoByLabel[targetUni].minDays) {
                  infoByLabel[targetUni].minDays = dias;
                }
              }
            }
          }

          // Calcular pct abastecimiento y formatear payload
          for (const uni of units) {
            const info = infoByLabel[uni] || {};
            const dot = toNum(info.dot);
            const inv = toNum(info.inv);
            let pct = null;
            if (dot > 0 && isFinite(inv)) {
              pct = clamp((inv / dot) * 100, 0, 140);
            }
            info.pct = pct != null ? pct : null;

            // Si no se hall√≥ minDays (Infinity), ponerle uno alto para "verde"
            if (info.minDays === Infinity || info.minDays == null) info.minDays = 9999;

            infoByLabel[uni] = info;
          }
          // Filtrar y ordenar labels
          let labels = Array.from(units);
          // Unidades con pct definidos primero, luego las que no
          labels.sort((a, b) => {
            const ia = infoByLabel[a], ib = infoByLabel[b];
            const aValid = ia && typeof ia.pct === "number";
            const bValid = ib && typeof ib.pct === "number";
            if (aValid && !bValid) return -1;
            if (!aValid && bValid) return 1;
            return String(a).localeCompare(String(b));
          });

          // Omitir irrelevantes (sin dot, inv, ni lotes activos)
          labels = labels.filter(l => {
            const inf = infoByLabel[l];
            /* mostrar si tiene dot, inv o si tiene stock en lotes (minDays < 9999 indica que evaluamos un lote) */
            const hasActivity = (inf.dot > 0 || (inf.inv != null && isFinite(inf.inv)) || (inf.minDays < 9000));
            return hasActivity;
          });

          const values = labels.map(l => {
            const info = infoByLabel[l];
            return (info && typeof info.pct === "number") ? info.pct : 0;
          });

          return {
            ref,
            labels,
            values,
            infoByLabel
          };
        };
        async function render(ref) {
          const svg = $("solReactivoHUD");
          if (!svg) {
            solWarn("No existe #solReactivoHUD");
            return;
          }
          if (!ref) {
            renderSolEmpty('');
            return;
          }
          try {
            const payload = await computeAbastecimiento(ref);
            if (!payload.labels || !payload.labels.length) {
              renderSolEmpty(ref);
              const meta = $("uiSolInvMetaHUD");
              if (meta) meta.textContent = "Sin datos registrados";
              return;
            }
            buildSolHud(svg, payload);
          } catch (e) {
            solErr("Error en SOL_REACTIVO_REAL.render", e);
            renderSolEmpty(ref);
            const meta = $("uiSolInvMetaHUD");
            if (meta) meta.textContent = "‚ùå error";
          }
        }
        return {
          getSbHeaders,
          colKeysDescending,
          pickLatestValue,
          fetchDotacionesByRef,
          fetchConsumosMensualesByRef,
          computeAbastecimiento,
          render
        };
      })();

      // ===============================
      // renderSol(ref): ahora usa SOL_REACTIVO_REAL
      // ===============================
      async function renderSol(ref) {
        console.groupCollapsed("‚òÄÔ∏è [SOL_HUD] renderSol");
        console.log("ref =", ref);
        const svg = $("solReactivoHUD");
        if (!svg) {
          console.warn("No existe #solReactivoHUD");
          console.groupEnd();
          return;
        }
        const meta = $("uiSolInvMetaHUD");
        if (meta) meta.textContent = " ";
        const cleanRef = String(ref ?? "").trim();
        if (!cleanRef) {
          renderSolEmpty("");
          console.groupEnd();
          return;
        }
        try {
          if (window.SOL_REACTIVO_REAL && typeof window.SOL_REACTIVO_REAL.render === "function") {
            await window.SOL_REACTIVO_REAL.render(cleanRef);
            console.groupEnd();
            return;
          }
          renderSolEmpty(cleanRef);
          if (meta) meta.textContent = "SOL_REACTIVO_REAL no disponible";
          console.groupEnd();
        } catch (err) {
          solErr("Error renderSol:", err);
          renderSolEmpty(cleanRef);
          const m = $("uiSolInvMetaHUD");
          if (m) m.textContent = "‚ùå error";
          console.groupEnd();
        }
      }

      // ===============================
      // ORQUESTADOR: renderAll(meta)
      // ===============================
      async function renderAll(meta = {}) {
        const ref = String(meta?.referencia || meta?.ref || "").trim();
        const ubi = String(meta?.ubi || "").trim();

        log("renderAll", { ref, ubi, meta });

        // Actualiza badge por zona si ya hay UBI
        try { if (ubi) updateHudUbiBadge(ubi); } catch (_) { }

        // M√≥dulos (no deben tumbar la app si uno falla)
        try { await renderForecast(ref); } catch (e) { log("renderForecast fail", { err: String(e?.message || e) }); }
        try { await renderLotes(ref); } catch (e) { log("renderLotes fail", { err: String(e?.message || e) }); }
        try { await renderSol(ref); } catch (e) { log("renderSol fail", { err: String(e?.message || e) }); }
      }

      // Exponer API
      return { renderAll, renderForecast, renderLotes, renderSol, updateHudUbiBadge };
    })();
  </script>

  <script>
    /* =========================================================
       Hook: cuando se abre MAP3D desde b√∫squeda, dispara m√≥dulos
    ========================================================= */
    (function () {
      const patch = () => {
        if (!window.MAP3D_UI || typeof window.MAP3D_UI.openFromSearch !== "function") return false;
        if (window.MAP3D_UI.__modulesPatched) return true;

        const original = window.MAP3D_UI.openFromSearch;
        window.MAP3D_UI.openFromSearch = function (payload) {
          const out = original.apply(this, arguments);
          try {
            window.MAP3D_MODULES?.renderAll(payload || {});
          } catch (err) {
            try { window.logx?.("[MAP3D_MODULES]", "hook fail", { err: String(err?.message || err) }); } catch (_) { }
          }
          return out;
        };
        window.MAP3D_UI.__modulesPatched = true;
        return true;
      };

      // intenta de inmediato y tambi√©n al DOMContentLoaded por si el orden cambia
      patch();
      document.addEventListener("DOMContentLoaded", patch);
    })();
  </script>

</body>

</html>